{
  "hash": "e56dd1f8c6e8ba67c8778baefae397cb",
  "result": {
    "markdown": "---\ntitle: \"On tabulizer and living in dark times\"\ndescription: \"It was the best of times, it was the worst of times. It was the age of lovely ropensci tools, it was the age of internally displaced transgender people in the United States. It was indeed the season of light and the season of darkness\"\ndate: \"2023-06-15\"\ncategories: [\"R\", \"Data Wrangling\"]\n---\n\n\n<!--------------- my typical setup ----------------->\n\n\n\n\n\n<!--------------- post begins here ----------------->\n\n\n## To make cheese, we must first create the universe\n\nAndrew Collier has us covered:\n\nhttps://datawookie.dev/blog/2018/02/installing-rjava-on-ubuntu/\n\nInstall the java runtime environment and the java development kit.\n\n``` bash\nsudo apt-get install -y default-jre default-jdk\n```\n\nNext we have to make sure R knows where to find Java:\n\n``` bash\nsudo R CMD javareconf\n```\n\nOnly now may we install the package:\n\n``` r\ninstall.packages(\"rJava\")\n```\n\nYou will need to restart RStudio after doing this, apparently.\n\n## Let there be tabulizer\n\nhttps://docs.ropensci.org/tabulizer/\n\n``` r\nremotes::install_github(c(\"ropensci/tabulizerjars\", \"ropensci/tabulizer\"))\n```\n\nLet's see if it's working\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(tabulizer)\npdf_file <- system.file(\"examples\", \"data.pdf\", package = \"tabulizer\")\npdf_tabs <- extract_tables(pdf_file)\nstr(pdf_tabs)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nList of 4\n $ : chr [1:32, 1:10] \"mpg\" \"21.0\" \"21.0\" \"22.8\" ...\n $ : chr [1:7, 1:5] \"Sepal.Length\" \"5.1\" \"4.9\" \"4.7\" ...\n $ : chr [1:7, 1:6] \"\" \"145\" \"146\" \"147\" ...\n $ : chr [1:15, 1] \"supp\" \"VC\" \"VC\" \"VC\" ...\n```\n:::\n:::\n\n\nWe have a list of tables:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmat <- pdf_tabs[[1]]\nmat[1:10, ]\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n      [,1]   [,2]  [,3]    [,4]  [,5]   [,6]    [,7]    [,8] [,9] [,10] \n [1,] \"mpg\"  \"cyl\" \"disp\"  \"hp\"  \"drat\" \"wt\"    \"qsec\"  \"vs\" \"am\" \"gear\"\n [2,] \"21.0\" \"6\"   \"160.0\" \"110\" \"3.90\" \"2.620\" \"16.46\" \"0\"  \"1\"  \"4\"   \n [3,] \"21.0\" \"6\"   \"160.0\" \"110\" \"3.90\" \"2.875\" \"17.02\" \"0\"  \"1\"  \"4\"   \n [4,] \"22.8\" \"4\"   \"108.0\" \"93\"  \"3.85\" \"2.320\" \"18.61\" \"1\"  \"1\"  \"4\"   \n [5,] \"21.4\" \"6\"   \"258.0\" \"110\" \"3.08\" \"3.215\" \"19.44\" \"1\"  \"0\"  \"3\"   \n [6,] \"18.7\" \"8\"   \"360.0\" \"175\" \"3.15\" \"3.440\" \"17.02\" \"0\"  \"0\"  \"3\"   \n [7,] \"18.1\" \"6\"   \"225.0\" \"105\" \"2.76\" \"3.460\" \"20.22\" \"1\"  \"0\"  \"3\"   \n [8,] \"14.3\" \"8\"   \"360.0\" \"245\" \"3.21\" \"3.570\" \"15.84\" \"0\"  \"0\"  \"3\"   \n [9,] \"24.4\" \"4\"   \"146.7\" \"62\"  \"3.69\" \"3.190\" \"20.00\" \"1\"  \"0\"  \"4\"   \n[10,] \"22.8\" \"4\"   \"140.8\" \"95\"  \"3.92\" \"3.150\" \"22.90\" \"1\"  \"0\"  \"4\"   \n```\n:::\n:::\n\n\nUse the first row to set the column names:\n\n\n::: {.cell}\n\n```{.r .cell-code}\ncolnames(mat) <- mat[1, ]\nmat <- mat[-1, ]\nmat[1:10, ]\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n      mpg    cyl disp    hp    drat   wt      qsec    vs  am  gear\n [1,] \"21.0\" \"6\" \"160.0\" \"110\" \"3.90\" \"2.620\" \"16.46\" \"0\" \"1\" \"4\" \n [2,] \"21.0\" \"6\" \"160.0\" \"110\" \"3.90\" \"2.875\" \"17.02\" \"0\" \"1\" \"4\" \n [3,] \"22.8\" \"4\" \"108.0\" \"93\"  \"3.85\" \"2.320\" \"18.61\" \"1\" \"1\" \"4\" \n [4,] \"21.4\" \"6\" \"258.0\" \"110\" \"3.08\" \"3.215\" \"19.44\" \"1\" \"0\" \"3\" \n [5,] \"18.7\" \"8\" \"360.0\" \"175\" \"3.15\" \"3.440\" \"17.02\" \"0\" \"0\" \"3\" \n [6,] \"18.1\" \"6\" \"225.0\" \"105\" \"2.76\" \"3.460\" \"20.22\" \"1\" \"0\" \"3\" \n [7,] \"14.3\" \"8\" \"360.0\" \"245\" \"3.21\" \"3.570\" \"15.84\" \"0\" \"0\" \"3\" \n [8,] \"24.4\" \"4\" \"146.7\" \"62\"  \"3.69\" \"3.190\" \"20.00\" \"1\" \"0\" \"4\" \n [9,] \"22.8\" \"4\" \"140.8\" \"95\"  \"3.92\" \"3.150\" \"22.90\" \"1\" \"0\" \"4\" \n[10,] \"19.2\" \"6\" \"167.6\" \"123\" \"3.92\" \"3.440\" \"18.30\" \"1\" \"0\" \"4\" \n```\n:::\n:::\n\n\nLoad some data-wrangling packages:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(dplyr)\nlibrary(tidyr)\nlibrary(tibble)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nmat |> \n  as_tibble() |>\n  mutate(across(everything(), as.numeric))\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# A tibble: 31 × 10\n     mpg   cyl  disp    hp  drat    wt  qsec    vs    am  gear\n   <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl>\n 1  21       6  160    110  3.9   2.62  16.5     0     1     4\n 2  21       6  160    110  3.9   2.88  17.0     0     1     4\n 3  22.8     4  108     93  3.85  2.32  18.6     1     1     4\n 4  21.4     6  258    110  3.08  3.22  19.4     1     0     3\n 5  18.7     8  360    175  3.15  3.44  17.0     0     0     3\n 6  18.1     6  225    105  2.76  3.46  20.2     1     0     3\n 7  14.3     8  360    245  3.21  3.57  15.8     0     0     3\n 8  24.4     4  147.    62  3.69  3.19  20       1     0     4\n 9  22.8     4  141.    95  3.92  3.15  22.9     1     0     4\n10  19.2     6  168.   123  3.92  3.44  18.3     1     0     4\n# ℹ 21 more rows\n```\n:::\n:::\n\n\n## Real life examples never work right the first time\n\nhttps://www.erininthemorning.com/p/us-internal-refugee-crisis-130-260k\n\nThe data source is this article:\n\nhttps://www.dataforprogress.org/blog/2023/6/8/lgbtq-adults-do-not-feel-safe-and-do-not-think-the-democratic-party-is-doing-enough-to-protect-their-rights\n\nThe summary tables from the survey are in a linked pdf file, saved locally as `dfp_lgbtq_survey.pdf`. Try to automatically extract tables from page 2: \n\n\n::: {.cell}\n\n```{.r .cell-code}\ndfp_pdf <- \"dfp_lgbtq_survey.pdf\"\ndfp_tabs <- extract_tables(dfp_pdf, pages = 2)\ndfp_tabs\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n[[1]]\n     [,1] [,2] [,3] [,4] [,5] [,6] [,7] [,8] [,9] [,10] [,11]\n[1,] \"79\" \"85\" \"82\" \"70\" \"87\" \"89\" \"77\" \"79\" \"83\" \"69\"  \"80\" \n[2,] \"17\" \"12\" \"13\" \"29\" \"7\"  \"6\"  \"19\" \"14\" \"15\" \"27\"  \"17\" \n\n[[2]]\n     [,1]       [,2]      [,3]       [,4]       [,5]    [,6]     [,7]  \n[1,] \"Response\" \"Topline\" \"African\"  \"or\"       \"White\" \"Female\" \"Male\"\n[2,] \"\"         \"\"        \"\"         \"\"         \"\"      \"\"       \"\"    \n[3,] \"\"         \"\"        \"American\" \"Latino/a​\" \"\"      \"\"       \"\"    \n     [,8]     [,9]          [,10]         [,11] [,12] [,13] [,14] [,15]\n[1,] \"\"       \"\"            \"identify as\" \"\"    \"\"    \"\"    \"\"    \"65+\"\n[2,] \"binary\" \"transgender\" \"\"            \"24\"  \"39\"  \"54\"  \"64\"  \"\"   \n[3,] \"\"       \"\"            \"transgender\" \"\"    \"\"    \"\"    \"\"    \"\"   \n```\n:::\n:::\n\n\nOkay, no good. Let's do it manually.\n\n## It's a whole journey sometimes\n\n\n::: {.cell}\n\n```{.r .cell-code}\nget_page_dims(dfp_pdf)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n[[1]]\n[1] 595 842\n\n[[2]]\n[1] 595 842\n\n[[3]]\n[1] 595 842\n```\n:::\n:::\n\n\nLittle bit of tinkering and guessing, but once you get the coordinates about right, it parses the table reasonably well. Not perfect, but we can work with this!\n\n\n::: {.cell}\n\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nmat <- extract_tables(\n  file = dfp_pdf, \n  pages = 2, \n  guess = FALSE,\n  area = list(c(250, 0, 450, 595))\n)[[1]]\n\nmat\n```\n:::\n\n::: {.cell .column-page}\n::: {.cell-output .cell-output-stdout}\n```\n      [,1]                                [,2]      [,3]       [,4]       [,5]    [,6]     [,7]   [,8]     [,9]            [,10]         [,11] [,12] [,13] [,14] [,15]\n [1,] \"\"                                  \"\"        \"Black or\" \"Hispanic\" \"\"      \"\"       \"\"     \"\"       \"\"              \"Does not\"    \"\"    \"\"    \"\"    \"\"    \"\"   \n [2,] \"\"                                  \"\"        \"\"         \"\"         \"\"      \"\"       \"\"     \"Non-\"   \"Identifies as\" \"\"            \"18-\" \"25-\" \"40-\" \"55-\" \"\"   \n [3,] \"Response\"                          \"Topline\" \"African\"  \"or\"       \"White\" \"Female\" \"Male\" \"\"       \"\"              \"identify as\" \"\"    \"\"    \"\"    \"\"    \"65+\"\n [4,] \"\"                                  \"\"        \"\"         \"\"         \"\"      \"\"       \"\"     \"binary\" \"transgender\"   \"\"            \"24\"  \"39\"  \"54\"  \"64\"  \"\"   \n [5,] \"\"                                  \"\"        \"American\" \"Latino/​a\" \"\"      \"\"       \"\"     \"\"       \"\"              \"transgender\" \"\"    \"\"    \"\"    \"\"    \"\"   \n [6,] \"Yes, I have considered moving\"     \"\"        \"\"         \"\"         \"\"      \"\"       \"\"     \"\"       \"\"              \"\"            \"\"    \"\"    \"\"    \"\"    \"\"   \n [7,] \"\"                                  \"27\"      \"24\"       \"28\"       \"27\"    \"26\"     \"20\"   \"44\"     \"43\"            \"24\"          \"41\"  \"28\"  \"18\"  \"17\"  \"17\" \n [8,] \"out of my community or state\"      \"\"        \"\"         \"\"         \"\"      \"\"       \"\"     \"\"       \"\"              \"\"            \"\"    \"\"    \"\"    \"\"    \"\"   \n [9,] \"No, I have not considered\"         \"\"        \"\"         \"\"         \"\"      \"\"       \"\"     \"\"       \"\"              \"\"            \"\"    \"\"    \"\"    \"\"    \"\"   \n[10,] \"moving out of my community or\"     \"61\"      \"57\"       \"59\"       \"64\"    \"60\"     \"75\"   \"37\"     \"40\"            \"65\"          \"43\"  \"60\"  \"74\"  \"80\"  \"70\" \n[11,] \"state\"                             \"\"        \"\"         \"\"         \"\"      \"\"       \"\"     \"\"       \"\"              \"\"            \"\"    \"\"    \"\"    \"\"    \"\"   \n[12,] \"I have already moved out of my\"    \"\"        \"\"         \"\"         \"\"      \"\"       \"\"     \"\"       \"\"              \"\"            \"\"    \"\"    \"\"    \"\"    \"\"   \n[13,] \"community or state as a result of\" \"5\"       \"6\"        \"4\"        \"3\"     \"3\"      \"3\"    \"13\"     \"8\"             \"4\"           \"8\"   \"4\"   \"2\"   \"1\"   \"9\"  \n[14,] \"anti-LGBTQ+ legislation\"           \"\"        \"\"         \"\"         \"\"      \"\"       \"\"     \"\"       \"\"              \"\"            \"\"    \"\"    \"\"    \"\"    \"\"   \n[15,] \"Not sure\"                          \"7\"       \"14\"       \"8\"        \"6\"     \"11\"     \"3\"    \"6\"      \"8\"             \"7\"           \"9\"   \"8\"   \"7\"   \"2\"   \"4\"  \n[16,] \"Weighted N\"                        \"1,036\"   \"93\"       \"217\"      \"632\"   \"426\"    \"368\"  \"135\"    \"166\"           \"870\"         \"249\" \"425\" \"186\" \"93\"  \"83\" \n```\n:::\n:::\n\n\n\nSplit-apply-combine. First the split:\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# split into a list of matrices, each corresponding to a row \n# in the final table\nmat <- lapply(\n  list(1:5, 6:8, 9:11, 12:14, 15, 16), \n  \\(rows) {\n    if(length(rows) == 1) return(matrix(mat[rows,], nrow = 1))\n    mat[rows,]\n  }\n)\n\n# convert each matrix into a character vector for the row\nmat <- lapply(\n  mat, \n  \\(x) {\n    apply(x, 2, \\(y) {as.vector(paste(y, collapse = \" \"))})\n  }\n)\n\n# combine back into a character matrix\nmat <- matrix(unlist(mat), nrow = length(mat), byrow = TRUE) \nmat\n```\n:::\n\n::: {.cell .column-page}\n::: {.cell-output .cell-output-stdout}\n```\n     [,1]                                                                                       [,2]          [,3]                          [,4]                     [,5]        [,6]         [,7]       [,8]             [,9]                           [,10]                                [,11]       [,12]       [,13]       [,14]       [,15]    \n[1,] \"  Response  \"                                                                             \"  Topline  \" \"Black or  African  American\" \"Hispanic  or  Latino/​a\" \"  White  \" \"  Female  \" \"  Male  \" \" Non-  binary \" \" Identifies as  transgender \" \"Does not  identify as  transgender\" \" 18-  24 \" \" 25-  39 \" \" 40-  54 \" \" 55-  64 \" \"  65+  \"\n[2,] \"Yes, I have considered moving  out of my community or state\"                              \" 27 \"        \" 24 \"                        \" 28 \"                   \" 27 \"      \" 26 \"       \" 20 \"     \" 44 \"           \" 43 \"                         \" 24 \"                               \" 41 \"      \" 28 \"      \" 18 \"      \" 17 \"      \" 17 \"   \n[3,] \"No, I have not considered moving out of my community or state\"                            \" 61 \"        \" 57 \"                        \" 59 \"                   \" 64 \"      \" 60 \"       \" 75 \"     \" 37 \"           \" 40 \"                         \" 65 \"                               \" 43 \"      \" 60 \"      \" 74 \"      \" 80 \"      \" 70 \"   \n[4,] \"I have already moved out of my community or state as a result of anti-LGBTQ+ legislation\" \" 5 \"         \" 6 \"                         \" 4 \"                    \" 3 \"       \" 3 \"        \" 3 \"      \" 13 \"           \" 8 \"                          \" 4 \"                                \" 8 \"       \" 4 \"       \" 2 \"       \" 1 \"       \" 9 \"    \n[5,] \"Not sure\"                                                                                 \"7\"           \"14\"                          \"8\"                      \"6\"         \"11\"         \"3\"        \"6\"              \"8\"                            \"7\"                                  \"9\"         \"8\"         \"7\"         \"2\"         \"4\"      \n[6,] \"Weighted N\"                                                                               \"1,036\"       \"93\"                          \"217\"                    \"632\"       \"426\"        \"368\"      \"135\"            \"166\"                          \"870\"                                \"249\"       \"425\"       \"186\"       \"93\"        \"83\"     \n```\n:::\n:::\n\n\n\nConvert first row to column names:\n\n\n::: {.cell}\n\n```{.r .cell-code}\ncolnames(mat) <- mat[1, ]\nmat <- mat[-1, ]\n```\n:::\n\n'\nNow load handy packages:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(dplyr)\nlibrary(tidyr)\nlibrary(tibble)\nlibrary(janitor)\n```\n:::\n\n\nConvert to tibble with clean names:\n\n\n\n::: {.cell}\n\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\ndat <- mat |> \n  as_tibble() |>\n  clean_names() |>\n  rename(\n    \"black\" = \"black_or_african_american\",\n    \"hispanic\" = \"hispanic_or_latino_a\", \n    \"trans\" = \"identifies_as_transgender\",\n    \"not_trans\" = \"does_not_identify_as_transgender\"\n  ) |>\n  mutate(across(!response, \\(x) {as.numeric(gsub(\",\", \"\", x))}))\n\ndat\n```\n:::\n\n::: {.cell .column-page}\n::: {.cell-output .cell-output-stdout}\n```\n# A tibble: 5 × 15\n  response                        topline black hispanic white female  male non_binary trans not_trans x18_24 x25_39 x40_54 x55_64   x65\n  <chr>                             <dbl> <dbl>    <dbl> <dbl>  <dbl> <dbl>      <dbl> <dbl>     <dbl>  <dbl>  <dbl>  <dbl>  <dbl> <dbl>\n1 Yes, I have considered moving …      27    24       28    27     26    20         44    43        24     41     28     18     17    17\n2 No, I have not considered movi…      61    57       59    64     60    75         37    40        65     43     60     74     80    70\n3 I have already moved out of my…       5     6        4     3      3     3         13     8         4      8      4      2      1     9\n4 Not sure                              7    14        8     6     11     3          6     8         7      9      8      7      2     4\n5 Weighted N                         1036    93      217   632    426   368        135   166       870    249    425    186     93    83\n```\n:::\n:::\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}