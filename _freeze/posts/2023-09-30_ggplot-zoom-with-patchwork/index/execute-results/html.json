{
  "hash": "d8f84ac76e8542583103b2a84ba8ed70",
  "result": {
    "markdown": "---\ntitle: \"The blood witch problem: Bespoke faceting and axis scaling in ggplot2 with patchwork\"\ndescription: \"Managing axis scale limits in ggplot2 with patchwork, using fake data that is so obviously a thinly-veiled metaphor for pediatric dosing simulations in pharmacometric modelling\"\ndate: \"2023-09-30\"\n--- \n\n\n<!--------------- my typical setup ----------------->\n\n\n\n\n\n<!--------------- post begins here ----------------->\n\n\n\n::: {.cell layout-align=\"center\"}\n\n:::\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nlibrary(ggplot2)\nlibrary(dplyr)\n```\n:::\n\n\nThe basic idea is we want some violin plots, where the potion strength is the x-axis variable, the mana exposure is the y-axis variable, and we want to stratify this by species and training stage variables. As a first thought, we might use `facet_wrap()` to stratify:\n\n\n::: {.cell .column-screen-inset layout-align=\"center\"}\n\n```{.r .cell-code}\nggplot(mana, aes(potion, exposure)) + \n  geom_violin() + \n  facet_wrap(~ stage + species, nrow = 1)\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-4-1.png){fig-align='center' width=1440}\n:::\n:::\n\n\nOkay, bad idea. Perhaps a cleaner approach is to use `facet_wrap()` to stratify by species, and use the fill aesthetic to colour the violins by training stage:\n\n\n::: {.cell .column-screen-inset layout-align=\"center\"}\n\n```{.r .cell-code}\nggplot(mana, aes(potion, exposure, fill = species)) + \n  geom_violin() + \n  facet_wrap(~ stage, nrow = 1)\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-5-1.png){fig-align='center' width=1440}\n:::\n:::\n\n\nA little better, but we still have a lot of blank spaces because this is not a factorial design: the nature of the data precludes that. No problem, we can fix this by setting `scales = \"free_x\"` when we facet the plot. That way, a particular potion strength will only appear on the x-axis for a particular facet if there is actually data for the corresponding stage:\n\n\n::: {.cell .column-screen-inset layout-align=\"center\"}\n\n```{.r .cell-code}\nggplot(mana, aes(potion, exposure, fill = species)) + \n  geom_violin() + \n  facet_wrap(~ stage, nrow = 1, scales = \"free_x\") \n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-6-1.png){fig-align='center' width=1440}\n:::\n:::\n\n\nHm. Better, but there's still a spacing problem. Three of the panels have two violins, and one of them has four, so the widths of violins aren't scaled identically on the x-axis across facets, making it hard to compare. Okay, maybe `facet_grid()` can solve this for us?\n\n\n::: {.cell .column-screen-inset layout-align=\"center\"}\n\n```{.r .cell-code}\nggplot(mana, aes(potion, exposure, fill = species)) + \n  geom_violin() + \n  facet_grid(~ stage, space = \"free_x\", scales = \"free_x\") \n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-7-1.png){fig-align='center' width=1440}\n:::\n:::\n\n\nIt's better, but it's not quite right: because there are no hobbits among the mages, the scaling of the violins in the fourth panel are still double the width of those in the other three panels. \n\nOkay, so maybe we go back to our original strategy of facetting by `stage` and `species` rather than having the fill do the work, but instead of using `facet_wrap()` we can use `facet_grid()`:\n\n\n::: {.cell .column-screen-inset layout-align=\"center\"}\n\n```{.r .cell-code}\nggplot(mana, aes(potion, exposure)) + \n  geom_violin() + \n  facet_grid(~ stage + species, space = \"free_x\", scales = \"free_x\") \n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-8-1.png){fig-align='center' width=1440}\n:::\n:::\n\n\nGetting closer. \n\nThe panel labels are a little unpleasant though. Facetting by two variables doesn't always produce the nicest strip labels. Okay, no problem. Some data wrangling to the rescue:\n\n\n::: {.cell .column-screen-inset layout-align=\"center\"}\n\n```{.r .cell-code}\nmana <- mana |> \n  mutate(\n    species_stage = factor(\n      paste(species, stage),\n      levels = c(\n        \"hobbit novice\", \"hobbit initiate\", \"hobbit graduate\",\n        \"elf novice\", \"elf initiate\", \"elf graduate\", \"elf mage\"\n      )\n    )\n  )\n  \nggplot(mana, aes(potion, exposure)) + \n  geom_violin() + \n  facet_grid(~ species_stage, space = \"free_x\", scales = \"free_x\")\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-9-1.png){fig-align='center' width=1440}\n:::\n:::\n",
    "supporting": [
      "index_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}