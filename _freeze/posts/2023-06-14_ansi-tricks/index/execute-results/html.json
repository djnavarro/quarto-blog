{
  "hash": "11e269700a0dc4cecc92db46f5bc4410",
  "result": {
    "markdown": "---\ntitle: \"A little ANSI trickery\"\ndescription: \"Fun and games with asciicast and cli\"\ndate: \"2023-06-14\"\ncategories: [\"R\"]\n---\n\n\n<!--------------- my typical setup ----------------->\n\n\n\n\n\n<!--------------- post begins here ----------------->\n\n\n\n\n\n\nOn mastodon today I wrote cute little [post](https://fosstodon.org/@djnavarro/110540314955265024) showing what my R startup message currently looks like:\n\n<p align=\"center\" style=\"padding: 10px;\">\n<iframe src=\"https://fosstodon.org/@djnavarro/110540314955265024/embed\" class=\"mastodon-embed\" style=\"max-width: 100%; border: 0\" width=\"400\" allowfullscreen=\"allowfullscreen\"></iframe><script src=\"https://fosstodon.org/embed.js\" async=\"async\"></script>\n</p>\n\nIn the replies, I included the code showing how to generate the rainbow strip that appears at the bottom of the startup message. Calling this `rainbow_strip()` function from the R console will give you the result you're looking for:\n\n\n::: {.cell hash='index_cache/html/unnamed-chunk-3_527e641a2214b46c26543852ceae8538'}\n\n```{.r .cell-code}\nrainbow_strip <- function() {\n  c(\"#e50000\", \"#ff8d00\", \"#ffee00\", \"#028121\", \"#004cff\", \"#770088\") |>\n    purrr::map(cli::make_ansi_style) |>\n    purrr::walk(~ cat(.x(paste0(rep(\"\\u2583\", 6), collapse = \"\"))))\n}\n```\n:::\n\n\n\n\nThe code isn't very complicated, but it does rely on a few tricks. The most important trick is the one that occurs on the second line, in which I use the [cli](about:blank) package to define a set of six styles, each of which colours the text in one of the colours from the LGBTIQ+ pride flag.^[In the post on Mastodon I used `crayon::make_style\n()` rather than `cli::make_ansi_style()`, but they do the same thing. After I wrote the post I remembered that the crayon package has been superseded by cli, so it's generally better to use the cli version instead.] Each of these six styles is then applied to the UTF-8 character^[In the source code I use `\"\\u2583\"` to produce the UTF-8 character `\"▃\"`.] string `\"▃▃▃▃▃▃\"`  and the results are concatenated in the output. It's very pretty. But suppose I wanted to reproduce the style out output within a quarto document like this one. Alas, it does not work:\n\n\n::: {.cell hash='index_cache/html/unnamed-chunk-5_46d48e1489e413e9fbd81014cc0ab12f'}\n\n```{.r .cell-code}\nrainbow_strip()\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n▃▃▃▃▃▃▃▃▃▃▃▃▃▃▃▃▃▃▃▃▃▃▃▃▃▃▃▃▃▃▃▃▃▃▃▃\n```\n:::\n:::\n\n\nHm. Well that's annoying. But just to be sure, let's try it again.\n\n\n::: {.cell hash='index_cache/html/unnamed-chunk-6_d87467b6413116321fd86361fb0a5448'}\n\n```{.r .cell-code}\nrainbow_strip()\n```\n\n\n<div class=\"asciicast\" style=\"color: #B9C0CB;font-family: 'Fira Code',Monaco,Consolas,Menlo,'Bitstream Vera Sans Mono','Powerline Symbols',monospace;line-height: 1.300000\"><pre>\n<span style=\"color:#e50000;\">▃▃▃▃▃▃</span><span style=\"color:#ff8d00;\">▃▃▃▃▃▃</span><span style=\"color:#ffee00;\">▃▃▃▃▃▃</span><span style=\"color:#028121;\">▃▃▃▃▃▃</span><span style=\"color:#004cff;\">▃▃▃▃▃▃</span><span style=\"color:#770088;\">▃▃▃▃▃▃</span>                                            \n</pre></div>\n:::\n\n\nSay what? It works the second time, but not the first? Peculiar. Someone -- possibly me?^[Definitely me.] -- must be engaged in some trickery that isn't obvious from first inspection. \n\n## The trickery revealed\n\nIf you were to take a look at the source code for this quarto document, the thing you'd immediately notice is that while both of these two code chunks contain R code, one of them is explicitly an R chunk and the other is... not. Here's the first one again, with the quarto code chunk shown:\n\n\n::: {.cell hash='index_cache/html/unnamed-chunk-7_9ff7cfcf39d3ab6ad43ce5e86d808d3e'}\n\n````{.cell-code}\n```{{r}}\nrainbow_strip()\n```\n````\n\n::: {.cell-output .cell-output-stdout}\n```\n▃▃▃▃▃▃▃▃▃▃▃▃▃▃▃▃▃▃▃▃▃▃▃▃▃▃▃▃▃▃▃▃▃▃▃▃\n```\n:::\n:::\n\n\nThe second one, however, is tagged as an \"asciicast\" code chunk. It still executes the R code, but something extra is going on when the code runs, because now it works...\n\n\n\n\n::: {.cell hash='index_cache/html/unnamed-chunk-9_7ad14db0db3e31d6ce1fdcfe4ff75ef8'}\n\n````{.cell-code}\n```{{asciicast}}\nrainbow_strip()\n```\n````\n\n\n<div class=\"asciicast\" style=\"color: #B9C0CB;font-family: 'Fira Code',Monaco,Consolas,Menlo,'Bitstream Vera Sans Mono','Powerline Symbols',monospace;line-height: 1.300000\"><pre>\n<span style=\"color:#e50000;\">▃▃▃▃▃▃</span><span style=\"color:#ff8d00;\">▃▃▃▃▃▃</span><span style=\"color:#ffee00;\">▃▃▃▃▃▃</span><span style=\"color:#028121;\">▃▃▃▃▃▃</span><span style=\"color:#004cff;\">▃▃▃▃▃▃</span><span style=\"color:#770088;\">▃▃▃▃▃▃</span>                                            \n</pre></div>\n:::\n\n\nThe thing that makes this all work is the [asciicast](https://r-lib.github.io/asciicast/) package. Typically, the asciicast package is used to create screencast from R code. I've used it before on this blog, actually. When I wrote the [\"pretty little CLIs\"](/pretty-little-clis/) post about the cli package, I used asciicast to create all the animations that appear in the post. However, you can also use asciicast in conjunction with the [knitr](https://yihui.org/knitr/) engine that powers the code execution in quarto.^[I mean, that's assuming you're using knitr as the engine, which I am in this post. There's nothing stopping you from using jupyter as the execution engine, which I've done in the past for python-focused posts.]\n\nHere's the code chunk I used to set this up:\n\n\n::: {.cell hash='index_cache/html/unnamed-chunk-10_4ee48529d0ad4038a19b9cefe4f55973'}\n\n````{.cell-code}\n```{{r}}\nknitr::opts_chunk$set(\n  collapse = FALSE,\n  comment = \"\",\n  out.width = \"100%\",\n  cache = TRUE,\n  asciicast_knitr_output = \"html\"\n)\n\nasciicast::init_knitr_engine(\n  echo = TRUE,\n  echo_input = FALSE,\n  same_process = TRUE,\n  startup = quote({\n    library(cli)\n    options(\n      cli.num_colors = cli::truecolor,\n      asciicast_theme = list(background = c(255, 255, 255))\n    )\n    set.seed(1)\n  })\n)\n```\n````\n:::\n\n\nThe first command sets the knitr options for R code chunks. The important line here is the one that sets `asciicast_knitr_output = \"html\"`, which ensures that asciicast produces HTML output. If you don't set this, the output from asciicast chunks will be rendered as images rather than HTML. The second line does what you might expect: calling `asciicast::init_knitr_engine()` initialises the asciicast knitr engine.\n\nHere's a simple tibble rendered in the usual way:\n\n\n::: {.cell hash='index_cache/html/unnamed-chunk-11_ec2770162def72a97644482677f07fe9'}\n\n```{.r .cell-code}\ntibble::tibble(x = 1:3, y = letters[1:3])\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# A tibble: 3 × 2\n      x y    \n  <int> <chr>\n1     1 a    \n2     2 b    \n3     3 c    \n```\n:::\n:::\n\n\nHere's the same tibble rendered with the asciicast knitr engine:\n\n\n::: {.cell hash='index_cache/html/unnamed-chunk-12_f40c4c812e2316c935a543c45e07c79e'}\n\n```{.r .cell-code}\ntibble::tibble(x = 1:3, y = letters[1:3])\n```\n\n\n<div class=\"asciicast\" style=\"color: #B9C0CB;font-family: 'Fira Code',Monaco,Consolas,Menlo,'Bitstream Vera Sans Mono','Powerline Symbols',monospace;line-height: 1.300000\"><pre>\n<span style=\"color: #999999;\"># A tibble: 3 × 2</span>                                                               \n      x y                                                                       \n  <span style=\"font-style: italic;color: #999999;\">&lt;int&gt;</span> <span style=\"font-style: italic;color: #999999;\">&lt;chr&gt;</span>                                                                   \n<span style=\"color: #c2c2c2;\">1</span>     1 a                                                                       \n<span style=\"color: #c2c2c2;\">2</span>     2 b                                                                       \n<span style=\"color: #c2c2c2;\">3</span>     3 c                                                                       \n</pre></div>\n:::\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}