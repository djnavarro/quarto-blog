{
  "hash": "5abb7b9a8d5647a5d52314f04e31349e",
  "result": {
    "markdown": "---\ntitle: \"A little ANSI trickery\"\ndescription: \"Fun and games with asciicast and cli. There's really not much to this one except a little bit of personal entertainment\"\ndate: \"2023-06-14\"\ncategories: [\"R\"]\nformat: \n  html:\n    css: style-tweaks.css\nimage: flag.png\nimage-alt: \"The LGBT rainbow flag\"\n---\n\n\n<!--------------- my typical setup ----------------->\n\n\n\n\n\n<!--------------- post begins here ----------------->\n\n\n\n\n\n\nOn mastodon today I wrote cute little [post](https://fosstodon.org/@djnavarro/110540314955265024) showing what my R startup message currently looks like:\n\n<p align=\"center\" style=\"padding: 10px;\">\n<iframe src=\"https://fosstodon.org/@djnavarro/110540314955265024/embed\" class=\"mastodon-embed\" style=\"max-width: 100%; border: 0\" width=\"400\" allowfullscreen=\"allowfullscreen\"></iframe><script src=\"https://fosstodon.org/embed.js\" async=\"async\"></script>\n</p>\n\nIn the replies, I included the code showing how to generate the rainbow strip that appears at the bottom of the startup message. Calling this `rainbow_strip()` function from the R console will give you the result you're looking for:\n\n\n::: {.cell hash='index_cache/html/unnamed-chunk-3_527e641a2214b46c26543852ceae8538'}\n\n```{.r .cell-code}\nrainbow_strip <- function() {\n  c(\"#e50000\", \"#ff8d00\", \"#ffee00\", \"#028121\", \"#004cff\", \"#770088\") |>\n    purrr::map(cli::make_ansi_style) |>\n    purrr::walk(~ cat(.x(paste0(rep(\"\\u2583\", 6), collapse = \"\"))))\n}\n```\n:::\n\n\n\n\nThe code isn't very complicated, but it does rely on a few tricks. The most important trick is the one that occurs on the second line, in which I use the [cli](about:blank) package to define a set of six styles, each of which colours the text in one of the colours from the LGBTIQ+ pride flag.^[In the post on Mastodon I used `crayon::make_style\n()` rather than `cli::make_ansi_style()`, but they do the same thing. After I wrote the post I remembered that the crayon package has been superseded by cli, so it's generally better to use the cli version instead.] Each of these six styles is then applied to the UTF-8 character^[In the source code I use `\"\\u2583\"` to produce the [UTF-8 block character](https://www.w3schools.com/charsets/ref_utf_block.asp) `\"▃\"`.] string `\"▃▃▃▃▃▃\"`  and the results are concatenated in the output. It's very pretty. But suppose I wanted to reproduce the style out output within a quarto document like this one. Alas, it does not work, because information about text colour is not preserved in the output when the document is rendered:\n\n\n::: {.cell hash='index_cache/html/unnamed-chunk-5_46d48e1489e413e9fbd81014cc0ab12f'}\n\n```{.r .cell-code}\nrainbow_strip()\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n▃▃▃▃▃▃▃▃▃▃▃▃▃▃▃▃▃▃▃▃▃▃▃▃▃▃▃▃▃▃▃▃▃▃▃▃\n```\n:::\n:::\n\n\nHm. Well that's annoying, but hardly surprising to anyone familiar with R markdown or quarto. But just to be sure, let's try it again, shall we?\n\n\n::: {.cell hash='index_cache/html/unnamed-chunk-6_d87467b6413116321fd86361fb0a5448'}\n\n```{.r .cell-code}\nrainbow_strip()\n```\n\n\n<div class=\"asciicast\" style=\"color: #B9C0CB;font-family: 'Fira Code',Monaco,Consolas,Menlo,'Bitstream Vera Sans Mono','Powerline Symbols',monospace;line-height: 1.300000\"><pre>\n<span style=\"color:#e50000;\">▃▃▃▃▃▃</span><span style=\"color:#ff8d00;\">▃▃▃▃▃▃</span><span style=\"color:#ffee00;\">▃▃▃▃▃▃</span><span style=\"color:#028121;\">▃▃▃▃▃▃</span><span style=\"color:#004cff;\">▃▃▃▃▃▃</span><span style=\"color:#770088;\">▃▃▃▃▃▃</span>                                            \n</pre></div>\n:::\n\n\nSay what? It works the second time, but not the first? Peculiar. Someone -- possibly me?^[Definitely me.] -- must be engaged in some trickery that isn't obvious from first inspection. \n\n## The trick revealed\n\nIf you were to take a look at the source code for this quarto document, the thing you'd immediately notice is that while both of these two code chunks contain R code, one of them is explicitly an R chunk and the other is... not. Here's the first one again, with the quarto code fencing shown:\n\n\n::: {.cell hash='index_cache/html/unnamed-chunk-7_9ff7cfcf39d3ab6ad43ce5e86d808d3e'}\n\n````{.cell-code}\n```{{r}}\nrainbow_strip()\n```\n````\n\n::: {.cell-output .cell-output-stdout}\n```\n▃▃▃▃▃▃▃▃▃▃▃▃▃▃▃▃▃▃▃▃▃▃▃▃▃▃▃▃▃▃▃▃▃▃▃▃\n```\n:::\n:::\n\n\nThe second one, however, is tagged as an \"asciicast\" code chunk. It still executes R code, but something extra is going on when the code runs, because now the output now preserves the text colour:\n\n\n\n\n::: {.cell hash='index_cache/html/unnamed-chunk-9_7ad14db0db3e31d6ce1fdcfe4ff75ef8'}\n\n````{.cell-code}\n```{{asciicast}}\nrainbow_strip()\n```\n````\n\n\n<div class=\"asciicast\" style=\"color: #B9C0CB;font-family: 'Fira Code',Monaco,Consolas,Menlo,'Bitstream Vera Sans Mono','Powerline Symbols',monospace;line-height: 1.300000\"><pre>\n<span style=\"color:#e50000;\">▃▃▃▃▃▃</span><span style=\"color:#ff8d00;\">▃▃▃▃▃▃</span><span style=\"color:#ffee00;\">▃▃▃▃▃▃</span><span style=\"color:#028121;\">▃▃▃▃▃▃</span><span style=\"color:#004cff;\">▃▃▃▃▃▃</span><span style=\"color:#770088;\">▃▃▃▃▃▃</span>                                            \n</pre></div>\n:::\n\n\nTo be clear, there's nothing special about my `rainbow_strip()` function here. You can see the same thing happening with any R function that produces coloured text in the output. For example, when printing a tibble at the R console you would normally expect to see the less important parts of the output printed in a muted grey colour. However, when we create a tibble in a quarto document the shading disappears:\n\n\n::: {.cell hash='index_cache/html/unnamed-chunk-10_f85063e517b34ea041cf40e854bbc883'}\n\n```{.r .cell-code}\n# this is an R chunk\ntibble::tibble(x = 1:3, y = letters[1:3])\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# A tibble: 3 × 2\n      x y    \n  <int> <chr>\n1     1 a    \n2     2 b    \n3     3 c    \n```\n:::\n:::\n\n\nThe shading reappears when the same code is executed with the asciicast knitr engine:\n\n\n::: {.cell hash='index_cache/html/unnamed-chunk-11_5dbfd9c141f4d7dd19c3ebcd98104930'}\n\n```{.r .cell-code}\n# this is an asciicast chunk\ntibble::tibble(x = 1:3, y = letters[1:3])\n```\n\n\n<div class=\"asciicast\" style=\"color: #B9C0CB;font-family: 'Fira Code',Monaco,Consolas,Menlo,'Bitstream Vera Sans Mono','Powerline Symbols',monospace;line-height: 1.300000\"><pre>\n<span style=\"color: #999999;\"># A tibble: 3 × 2</span>                                                               \n      x y                                                                       \n  <span style=\"font-style: italic;color: #999999;\">&lt;int&gt;</span> <span style=\"font-style: italic;color: #999999;\">&lt;chr&gt;</span>                                                                   \n<span style=\"color: #c2c2c2;\">1</span>     1 a                                                                       \n<span style=\"color: #c2c2c2;\">2</span>     2 b                                                                       \n<span style=\"color: #c2c2c2;\">3</span>     3 c                                                                       \n</pre></div>\n:::\n\n\n\n\nThe thing that makes this all work is the [asciicast](https://r-lib.github.io/asciicast/) package. Typically, the asciicast package is used to create screencast from R code. I've used it before on this blog, actually. When I wrote the [\"pretty little CLIs\"](/pretty-little-clis/) post about the cli package, I used asciicast to create all the animations that appear in the post. However, you can also use asciicast in conjunction with the [knitr](https://yihui.org/knitr/) engine that powers the code execution in quarto.^[I mean, that's assuming you're using knitr as the engine, which I am in this post. There's nothing stopping you from using jupyter as the execution engine, which I've done in the past for python-focused posts.] Here's the code chunk I used to set it up for the current post:\n\n\n::: {.cell hash='index_cache/html/unnamed-chunk-12_1c8f46d5cfb498fd1529ce59a6e87d85'}\n\n````{.cell-code}\n```{{r}}\nknitr::opts_chunk$set(\n  collapse = FALSE,\n  comment = \"\",\n  out.width = \"100%\",\n  cache = TRUE,\n  asciicast_knitr_output = \"html\"\n)\n\nasciicast::init_knitr_engine(\n  echo = TRUE,\n  echo_input = FALSE,\n  same_process = TRUE,\n  startup = quote({\n    library(cli)\n    options(\n      cli.num_colors = cli::truecolor,\n      asciicast_theme = list(background = c(255, 255, 255))\n    )\n    set.seed(1)\n  })\n)\n```\n````\n:::\n\n\nThe first command sets the knitr options for R code chunks. The important line here is the one that sets `asciicast_knitr_output = \"html\"`, which ensures that asciicast produces HTML output. If you don't set this, the output from asciicast chunks will be rendered as images rather than HTML. The second line does what you might expect: calling `asciicast::init_knitr_engine()` initialises the asciicast knitr engine.\n\n## The trick explained\n\nIn case you don't already know this stuff, it's probably worth explaining why the text colour in R output usually vanishes when R code is executed within a quarto or R markdown document. In fact, when I wrote the \"pretty little CLIs\" post I talked about precisely this: \n\n> The R console is a terminal, and its behaviour doesn’t always translate nicely to HTML. Part of the magic of the rmarkdown package is that most of the time it is able to capture terminal output and translate it seamlessly into HTML, and we mere mortal users never notice how clever this is. However, when dealing with cli output, we run into cases where this breaks down and the law of leaky abstractions comes into play: text generated at the R console does not follow the same rules as text inserted into an HTML document, and R Markdown sometimes needs a little help when transforming one to the other.\n\nAs regards colour:\n\n> The colours and symbols used by cli, and supported in the R console, rely on [ANSI escape codes](https://en.wikipedia.org/wiki/ANSI_escape_code), but those escape codes aren’t recognised in HTML\n\nIn that post I used the [fansi](https://github.com/brodieG/fansi) package to write a knitr hook that translated the relevant ANSI characters into HTML, thereby preserving the colour information. In essence, the asciicast package allows me to do the same thing here. \n\nFun!\n\n::: {.tight-text} \n\n\n::: {.cell hash='index_cache/html/unnamed-chunk-13_896aa2e8360efa56344722b235d6ac55'}\n\n```{.r .cell-code}\nrainbow_flag <- function() {\n  c(\"#e50000\", \"#ff8d00\", \"#ffee00\", \"#028121\", \"#004cff\", \"#770088\") |>\n    purrr::map(cli::make_ansi_style) |>\n    purrr::walk(~ cat(.x(c(paste0(rep(\"\\u2588\", 18), collapse = \"\"), \"\\n\"))))\n}\n\nrainbow_flag()\n```\n\n\n<div class=\"asciicast\" style=\"color: #B9C0CB;font-family: 'Fira Code',Monaco,Consolas,Menlo,'Bitstream Vera Sans Mono','Powerline Symbols',monospace;line-height: 1.300000\"><pre>\n<span style=\"color:#e50000;\">██████████████████</span>                                                              \n<span style=\"color:#ff8d00;\">██████████████████</span>                                                              \n<span style=\"color:#ffee00;\">██████████████████</span>                                                              \n<span style=\"color:#028121;\">██████████████████</span>                                                              \n<span style=\"color:#004cff;\">██████████████████</span>                                                              \n<span style=\"color:#770088;\">██████████████████</span>                                                              \n</pre></div>\n:::\n\n\n:::\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}