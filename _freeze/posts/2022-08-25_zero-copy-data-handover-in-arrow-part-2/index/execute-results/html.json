{
  "hash": "2dc70adc92bcd63df1132c21671d72f2",
  "result": {
    "markdown": "---\ntitle: 'Zero-copy data handover between R and Python, using Arrow and rpy2'\ndescription: ''\ndate: '2022-08-28'\ncategories:\n  - Apache Arrow\n  - R\n  - Python\nimage: img/cover.jpg\n---\n\n<!-- \ncover img: https://unsplash.com/photos/k39RGHmLoV8\nartist: Claudio Schwarz\nlicence: unsplash free-to-use \n-->\n\n<!-- \nAT THE TERMINAL:\n\nquarto render ~/GitHub/sites/quarto-blog/posts/2022-08-25_zero-copy-data-handover-in-arrow-part-2/index.qmd --execute-daemon-restart\n\n-->\n\nhttps://rpy2.github.io/\n\nhttps://rviews.rstudio.com/2022/05/25/calling-r-from-python-with-rpy2/\n\nhttps://arrow.apache.org/docs/python/integration/python_r.html\n\ninstalling rpy2\n\n``` \npip install rpy2\npip install rpy2-arrow\n```\n\ninstalling pyarrow\n\n```\nconda install pyarrow\n```\n\n```\nconda install pandas\n```\n\n\n## Check my pyarrow\n\n::: {.cell execution_count=1}\n``` {.python .cell-code}\n# python\nimport sys\nprint(sys.version)\nprint(sys.executable)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n3.9.12 (main, Apr  5 2022, 06:56:58) \n[GCC 7.5.0]\n/home/danielle/miniconda3/bin/python\n```\n:::\n:::\n\n\n::: {.cell execution_count=2}\n``` {.python .cell-code}\n# python\nimport pyarrow\npyarrow.__version__\n```\n\n::: {.cell-output .cell-output-display execution_count=2}\n```\n'8.0.0'\n```\n:::\n:::\n\n\n## Panda to Arrow Table\n\nhttps://cdhrdatasys.anu.edu.au/tobecontinued/ \n\n::: {.cell execution_count=3}\n``` {.python .cell-code}\nimport pandas\npandas.__version__\n```\n\n::: {.cell-output .cell-output-display execution_count=3}\n```\n'1.4.3'\n```\n:::\n:::\n\n\n::: {.cell execution_count=4}\n``` {.python .cell-code}\nfiction = pandas.read_csv(\"newspaper-fiction.csv\", low_memory = False)\nfiction.head()\n```\n\n::: {.cell-output .cell-output-display execution_count=4}\n```{=html}\n<div>\n<style scoped>\n    .dataframe tbody tr th:only-of-type {\n        vertical-align: middle;\n    }\n\n    .dataframe tbody tr th {\n        vertical-align: top;\n    }\n\n    .dataframe thead th {\n        text-align: right;\n    }\n</style>\n<table border=\"1\" class=\"dataframe\">\n  <thead>\n    <tr style=\"text-align: right;\">\n      <th></th>\n      <th>Trove ID</th>\n      <th>Common Title</th>\n      <th>Publication Title</th>\n      <th>Start Date</th>\n      <th>End Date</th>\n      <th>Additional Info</th>\n      <th>Length</th>\n      <th>Curated Dataset</th>\n      <th>Identified Sources</th>\n      <th>Publication Source</th>\n      <th>...</th>\n      <th>Other Names</th>\n      <th>Publication Author</th>\n      <th>Gender</th>\n      <th>Nationality</th>\n      <th>Nationality Details</th>\n      <th>Author Details</th>\n      <th>Inscribed Gender</th>\n      <th>Inscribed Nationality</th>\n      <th>Signature</th>\n      <th>Name Category</th>\n    </tr>\n  </thead>\n  <tbody>\n    <tr>\n      <th>0</th>\n      <td>1</td>\n      <td>The Mystery of Edwin Drood</td>\n      <td>The Mystery of Edwin Drood</td>\n      <td>1871-03-04</td>\n      <td>1871-06-03</td>\n      <td>NaN</td>\n      <td>0.0</td>\n      <td>Y</td>\n      <td>LCVF</td>\n      <td>NaN</td>\n      <td>...</td>\n      <td>NaN</td>\n      <td>Dickens, Charles</td>\n      <td>Male</td>\n      <td>British</td>\n      <td>NaN</td>\n      <td>LCVF</td>\n      <td>Male</td>\n      <td>British</td>\n      <td>NaN</td>\n      <td>Attributed</td>\n    </tr>\n    <tr>\n      <th>1</th>\n      <td>2</td>\n      <td>The Mystery of Edwin Drood</td>\n      <td>The Mystery of Edwin Drood</td>\n      <td>1871-03-07</td>\n      <td>1871-05-16</td>\n      <td>NaN</td>\n      <td>0.0</td>\n      <td>Y</td>\n      <td>LCVF</td>\n      <td>NaN</td>\n      <td>...</td>\n      <td>NaN</td>\n      <td>Dickens, Charles</td>\n      <td>Male</td>\n      <td>British</td>\n      <td>NaN</td>\n      <td>LCVF</td>\n      <td>Male</td>\n      <td>British</td>\n      <td>NaN</td>\n      <td>Attributed</td>\n    </tr>\n    <tr>\n      <th>2</th>\n      <td>3</td>\n      <td>Sporting Recollections in Various Countries</td>\n      <td>Sporting Recollections in Various Countries</td>\n      <td>1847-06-16</td>\n      <td>1847-07-07</td>\n      <td>NaN</td>\n      <td>0.0</td>\n      <td>Y</td>\n      <td>WPEDIA</td>\n      <td>Sunday Times</td>\n      <td>...</td>\n      <td>NaN</td>\n      <td>Viardot, M. Louis</td>\n      <td>Male</td>\n      <td>French</td>\n      <td>NaN</td>\n      <td>WPEDIA</td>\n      <td>Male</td>\n      <td>British</td>\n      <td>NaN</td>\n      <td>Attributed</td>\n    </tr>\n    <tr>\n      <th>3</th>\n      <td>4</td>\n      <td>Brownie's Triumph</td>\n      <td>The Jewels</td>\n      <td>1880-05-08</td>\n      <td>1880-08-14</td>\n      <td>NaN</td>\n      <td>0.0</td>\n      <td>Y</td>\n      <td>TJW</td>\n      <td>NaN</td>\n      <td>...</td>\n      <td>Sarah Elizabeth Forbush Downs; Downs, Mrs Geor...</td>\n      <td>Unattributed</td>\n      <td>Female</td>\n      <td>American</td>\n      <td>NaN</td>\n      <td>WPEDIA</td>\n      <td>Uninscribed</td>\n      <td>British</td>\n      <td>NaN</td>\n      <td>Unattributed</td>\n    </tr>\n    <tr>\n      <th>4</th>\n      <td>5</td>\n      <td>The Forsaken Bride</td>\n      <td>Abandoned</td>\n      <td>1880-08-21</td>\n      <td>1880-12-18</td>\n      <td>Fiction. From English, American and Other Peri...</td>\n      <td>0.0</td>\n      <td>Y</td>\n      <td>TJW</td>\n      <td>NaN</td>\n      <td>...</td>\n      <td>Sarah Elizabeth Forbush Downs; Downs, Mrs Geor...</td>\n      <td>Unattributed</td>\n      <td>Female</td>\n      <td>American</td>\n      <td>NaN</td>\n      <td>WPEDIA</td>\n      <td>Uninscribed</td>\n      <td>British</td>\n      <td>NaN</td>\n      <td>Unattributed</td>\n    </tr>\n  </tbody>\n</table>\n<p>5 rows Ã— 28 columns</p>\n</div>\n```\n:::\n:::\n\n\n::: {.cell execution_count=5}\n``` {.python .cell-code}\npyarrow_fiction = pyarrow.Table.from_pandas(fiction)\npyarrow_fiction\n```\n\n::: {.cell-output .cell-output-display execution_count=5}\n```\npyarrow.Table\nTrove ID: int64\nCommon Title: string\nPublication Title: string\nStart Date: string\nEnd Date: string\nAdditional Info: string\nLength: double\nCurated Dataset: string\nIdentified Sources: string\nPublication Source: string\nNewspaper ID: int64\nNewspaper: string\nNewspaper Common Title: string\nNewspaper Location: string\nNewspaper Type: string\nColony/State: string\nAuthor ID: int64\nAuthor: string\nOther Names: string\nPublication Author: string\nGender: string\nNationality: string\nNationality Details: string\nAuthor Details: string\nInscribed Gender: string\nInscribed Nationality: string\nSignature: string\nName Category : string\n----\nTrove ID: [[1,2,3,4,5,...,35491,35492,35493,35494,35495]]\nCommon Title: [[\"The Mystery of Edwin Drood\",\"The Mystery of Edwin Drood\",\"Sporting Recollections in Various Countries\",\"Brownie's Triumph\",\"The Forsaken Bride\",...,\"The Heart of Maureen\",\"His Lawful Wife\",\"Love's Reward\",\"Only a Flirt\",\"The Doctor's Protegee\"]]\nPublication Title: [[\"The Mystery of Edwin Drood\",\"The Mystery of Edwin Drood\",\"Sporting Recollections in Various Countries\",\"The Jewels\",\"Abandoned\",...,\"The Heart of Maureen\",\"His Lawful Wife\",\"Love's Reward\",\"Only a Flirt\",\"The Doctor's Protegee\"]]\nStart Date: [[\"1871-03-04\",\"1871-03-07\",\"1847-06-16\",\"1880-05-08\",\"1880-08-21\",...,\"1914-01-06\",\"1912-10-26\",\"1911-02-04\",\"1916-05-06\",\"1911-11-25\"]]\nEnd Date: [[\"1871-06-03\",\"1871-05-16\",\"1847-07-07\",\"1880-08-14\",\"1880-12-18\",...,\"1914-01-06\",\"1912-10-26\",\"1911-02-04\",\"1916-05-06\",\"1911-11-25\"]]\nAdditional Info: [[null,null,null,null,\"Fiction. From English, American and Other Periodicals\",...,\"Published by special arrangement. All rights reserved.\",\"Published by special arrangement. All rights reserved.\",\"Published by special arrangement. All rights reserved.\",\"All  Rights Reserved\",\"Published by special arrangement. All rights reserved.\"]]\nLength: [[0,0,0,0,0,...,0,0,0,0,0]]\nCurated Dataset: [[\"Y\",\"Y\",\"Y\",\"Y\",\"Y\",...,\"N\",\"N\",\"N\",\"N\",\"N\"]]\nIdentified Sources: [[\"LCVF\",\"LCVF\",\"WPEDIA\",\"TJW\",\"TJW\",...,null,null,null,null,null]]\nPublication Source: [[null,null,\"Sunday Times\",null,null,...,null,null,null,null,null]]\n...\n```\n:::\n:::\n\n\n## Introducing rpy2\n\n::: {.cell execution_count=6}\n``` {.python .cell-code}\nimport rpy2.robjects as robjects\nfrom rpy2.robjects.packages import importr, data\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n\f\nR version 4.2.1 (2022-06-23)\n\n```\n:::\n\n::: {.cell-output .cell-output-stdout}\n```\nðŸŒˆ\n```\n:::\n:::\n\n\n::: {.cell execution_count=7}\n``` {.python .cell-code}\nbase = importr('base')\nbase.R_version_string\n```\n\n::: {.cell-output .cell-output-display execution_count=7}\n```{=html}\n\n        <span>StrVector with 1 elements.</span>\n        <table>\n        <tbody>\n          <tr>\n          \n            <td>\n            'R version 4.2.1 (2022-06-23)'\n            </td>\n          \n          </tr>\n        </tbody>\n        </table>\n        \n```\n:::\n:::\n\n\n## Passing Tables from Python to R\n\nhttps://rpy2.github.io/rpy2-arrow/version/main/html/index.html\n\n::: {.cell execution_count=8}\n``` {.python .cell-code}\nimport rpy2_arrow.pyarrow_rarrow as pyra\n\nrarrow_fiction = pyra.pyarrow_to_r_table(pyarrow_fiction)\nrarrow_fiction\n```\n\n::: {.cell-output .cell-output-display execution_count=8}\n```\n<rpy2.robjects.environments.Environment object at 0x7f55ed64f640> [RTYPES.ENVSXP]\nR classes: ('Table', 'ArrowTabular', 'ArrowObject', 'R6')\nn items: 36\n```\n:::\n:::\n\n\n## Calling R code \n\n::: {.cell execution_count=9}\n``` {.python .cell-code}\n%load_ext rpy2.ipython\n```\n:::\n\n\n::: {.cell execution_count=10}\n``` {.python .cell-code}\n%%R\nsuppressMessages({\n  library(dplyr)\n  library(arrow)\n})\n```\n:::\n\n\n::: {.cell execution_count=11}\n``` {.python .cell-code}\n%%R -i rarrow_fiction\ngender <- rarrow_fiction |> \n  count(Gender) |>\n  compute()\n  \ngender\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nTable\n```\n:::\n\n::: {.cell-output .cell-output-stdout}\n```\n\n```\n:::\n\n::: {.cell-output .cell-output-stdout}\n```\n6 rows x 2 columns\n$Gender <string>\n$n <int64>\n\nSee $metadata for additional Schema metadata\n```\n:::\n\n::: {.cell-output .cell-output-stdout}\n```\n\n```\n:::\n:::\n\n\n## Passing Tables from R to Python\n\n::: {.cell execution_count=12}\n``` {.python .cell-code}\nimport rpy2.robjects as robjects\nr_gender = robjects.r('gender')\nr_gender\n```\n\n::: {.cell-output .cell-output-display execution_count=12}\n```\n<rpy2.robjects.environments.Environment object at 0x7f55f88ff4c0> [RTYPES.ENVSXP]\nR classes: ('Table', 'ArrowTabular', 'ArrowObject', 'R6')\nn items: 36\n```\n:::\n:::\n\n\n::: {.cell execution_count=13}\n``` {.python .cell-code}\npy_gender = pyra.rarrow_to_py_table(r_gender)\npy_gender\n```\n\n::: {.cell-output .cell-output-display execution_count=13}\n```\npyarrow.Table\nGender: string\nn: int64\n----\nGender: [[\"Male\",\"Female\",\"Unknown\",\"Both\",\"Multiple\",null]]\nn: [[11299,6878,15083,106,176,31]]\n```\n:::\n:::\n\n\n## Back to Pandas\n\n::: {.cell execution_count=14}\n``` {.python .cell-code}\npanda_gender = pyarrow.Table.to_pandas(py_gender)\npanda_gender\n```\n\n::: {.cell-output .cell-output-display execution_count=14}\n```{=html}\n<div>\n<style scoped>\n    .dataframe tbody tr th:only-of-type {\n        vertical-align: middle;\n    }\n\n    .dataframe tbody tr th {\n        vertical-align: top;\n    }\n\n    .dataframe thead th {\n        text-align: right;\n    }\n</style>\n<table border=\"1\" class=\"dataframe\">\n  <thead>\n    <tr style=\"text-align: right;\">\n      <th></th>\n      <th>Gender</th>\n      <th>n</th>\n    </tr>\n  </thead>\n  <tbody>\n    <tr>\n      <th>0</th>\n      <td>Male</td>\n      <td>11299</td>\n    </tr>\n    <tr>\n      <th>1</th>\n      <td>Female</td>\n      <td>6878</td>\n    </tr>\n    <tr>\n      <th>2</th>\n      <td>Unknown</td>\n      <td>15083</td>\n    </tr>\n    <tr>\n      <th>3</th>\n      <td>Both</td>\n      <td>106</td>\n    </tr>\n    <tr>\n      <th>4</th>\n      <td>Multiple</td>\n      <td>176</td>\n    </tr>\n    <tr>\n      <th>5</th>\n      <td>None</td>\n      <td>31</td>\n    </tr>\n  </tbody>\n</table>\n</div>\n```\n:::\n:::\n\n\n",
    "supporting": [
      "index_files"
    ],
    "filters": [],
    "includes": {
      "include-in-header": [
        "<script src=\"https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js\" integrity=\"sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==\" crossorigin=\"anonymous\"></script>\n<script src=\"https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js\" integrity=\"sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==\" crossorigin=\"anonymous\"></script>\n<script type=\"application/javascript\">define('jquery', [],function() {return window.jQuery;})</script>\n"
      ]
    }
  }
}