<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.433">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Danielle Navarro">
<meta name="dcterms.date" content="2023-08-14">
<meta name="description" content="Yet another post in the ever-expanding series where Danielle teaches herself pharmacometric modelling, which I’m certain is thrilling to everyone">

<title>Notes from a data witch - Pharmacometric simulation with mrgsolve</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<style>

      .quarto-title-block .quarto-title-banner {
        background: #eeeeee;
      }
</style>

  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<link rel="stylesheet" href="../../styles.css">
<meta property="og:title" content="Notes from a data witch - Pharmacometric simulation with mrgsolve">
<meta property="og:description" content="Yet another post in the ever-expanding series where Danielle teaches herself pharmacometric modelling, which I’m certain is thrilling to everyone">
<meta property="og:image" content="https://blog.djnavarro.net/posts/2023-08-14_mrgsolve/danilo-alvesd-a7OdG45prSM-unsplash.jpg">
<meta property="og:site-name" content="Notes from a data witch">
<meta property="og:image:alt" content="Pink and blue pill against a blue background">
<meta name="twitter:title" content="Notes from a data witch - Pharmacometric simulation with mrgsolve">
<meta name="twitter:description" content="Yet another post in the ever-expanding series where Danielle teaches herself pharmacometric modelling, which I’m certain is thrilling to everyone">
<meta name="twitter:image" content="https://blog.djnavarro.net/posts/2023-08-14_mrgsolve/danilo-alvesd-a7OdG45prSM-unsplash.jpg">
<meta name="twitter:creator" content="@djnavarro">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image:alt" content="Pink and blue pill against a blue background">
</head>

<body class="floating nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../index.html" rel="" target="">
 <span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../index.xml" rel="" target="">
 <span class="menu-text">RSS</span></a>
  </li>  
</ul>
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-sites" role="button" data-bs-toggle="dropdown" aria-expanded="false" rel="" target="">
 <span class="menu-text">Sites</span>
    </a>
    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="nav-menu-sites">    
        <li>
    <a class="dropdown-item" href="https://djnavarro.net" rel="" target="">
 <span class="dropdown-text">Homepage</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="https://blog.djnavarro.net" rel="" target="">
 <span class="dropdown-text">Data science blog</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="https://art.djnavarro.net" rel="" target="">
 <span class="dropdown-text">Generative art</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="https://papers.djnavarro.net" rel="" target="">
 <span class="dropdown-text">Academic papers</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="https://djnavarro.net/sites" rel="" target="">
 <span class="dropdown-text">More…</span></a>
  </li>  
    </ul>
  </li>
</ul>
            <div class="quarto-navbar-tools">
</div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default toc-left page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <h1 class="title">Pharmacometric simulation with mrgsolve</h1>
                  <div>
        <div class="description">
          Yet another post in the ever-expanding series where Danielle teaches herself pharmacometric modelling, which I’m certain is thrilling to everyone
        </div>
      </div>
                          <div class="quarto-categories">
                <div class="quarto-category">R</div>
                <div class="quarto-category">Pharmacometrics</div>
              </div>
                  </div>
  </div>
    
  
  <div class="quarto-title-meta">

      <div>
      <div class="quarto-title-meta-heading">Author</div>
      <div class="quarto-title-meta-contents">
               <p><a href="https://djnavarro.net">Danielle Navarro</a> <a href="https://orcid.org/0000-0001-7648-6578" class="quarto-title-author-orcid"> <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAA2ZpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMC1jMDYwIDYxLjEzNDc3NywgMjAxMC8wMi8xMi0xNzozMjowMCAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wTU09Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9tbS8iIHhtbG5zOnN0UmVmPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvc1R5cGUvUmVzb3VyY2VSZWYjIiB4bWxuczp4bXA9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC8iIHhtcE1NOk9yaWdpbmFsRG9jdW1lbnRJRD0ieG1wLmRpZDo1N0NEMjA4MDI1MjA2ODExOTk0QzkzNTEzRjZEQTg1NyIgeG1wTU06RG9jdW1lbnRJRD0ieG1wLmRpZDozM0NDOEJGNEZGNTcxMUUxODdBOEVCODg2RjdCQ0QwOSIgeG1wTU06SW5zdGFuY2VJRD0ieG1wLmlpZDozM0NDOEJGM0ZGNTcxMUUxODdBOEVCODg2RjdCQ0QwOSIgeG1wOkNyZWF0b3JUb29sPSJBZG9iZSBQaG90b3Nob3AgQ1M1IE1hY2ludG9zaCI+IDx4bXBNTTpEZXJpdmVkRnJvbSBzdFJlZjppbnN0YW5jZUlEPSJ4bXAuaWlkOkZDN0YxMTc0MDcyMDY4MTE5NUZFRDc5MUM2MUUwNEREIiBzdFJlZjpkb2N1bWVudElEPSJ4bXAuZGlkOjU3Q0QyMDgwMjUyMDY4MTE5OTRDOTM1MTNGNkRBODU3Ii8+IDwvcmRmOkRlc2NyaXB0aW9uPiA8L3JkZjpSREY+IDwveDp4bXBtZXRhPiA8P3hwYWNrZXQgZW5kPSJyIj8+84NovQAAAR1JREFUeNpiZEADy85ZJgCpeCB2QJM6AMQLo4yOL0AWZETSqACk1gOxAQN+cAGIA4EGPQBxmJA0nwdpjjQ8xqArmczw5tMHXAaALDgP1QMxAGqzAAPxQACqh4ER6uf5MBlkm0X4EGayMfMw/Pr7Bd2gRBZogMFBrv01hisv5jLsv9nLAPIOMnjy8RDDyYctyAbFM2EJbRQw+aAWw/LzVgx7b+cwCHKqMhjJFCBLOzAR6+lXX84xnHjYyqAo5IUizkRCwIENQQckGSDGY4TVgAPEaraQr2a4/24bSuoExcJCfAEJihXkWDj3ZAKy9EJGaEo8T0QSxkjSwORsCAuDQCD+QILmD1A9kECEZgxDaEZhICIzGcIyEyOl2RkgwAAhkmC+eAm0TAAAAABJRU5ErkJggg=="></a></p>
            </div>
    </div>
      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">August 14, 2023</p>
      </div>
    </div>
    
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal sidebar-navigation floating overflow-auto">
    <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#a-simple-example" id="toc-a-simple-example" class="nav-link active" data-scroll-target="#a-simple-example">A simple example</a></li>
  <li><a href="#simulation-workflow" id="toc-simulation-workflow" class="nav-link" data-scroll-target="#simulation-workflow">Simulation workflow</a>
  <ul class="collapse">
  <li><a href="#the-model-library" id="toc-the-model-library" class="nav-link" data-scroll-target="#the-model-library">The model library</a></li>
  <li><a href="#building-models-from-file" id="toc-building-models-from-file" class="nav-link" data-scroll-target="#building-models-from-file">Building models from file</a></li>
  <li><a href="#model-objects" id="toc-model-objects" class="nav-link" data-scroll-target="#model-objects">Model objects</a></li>
  <li><a href="#event-objects" id="toc-event-objects" class="nav-link" data-scroll-target="#event-objects">Event objects</a></li>
  <li><a href="#danielle-briefly-loses-her-fking-mind" id="toc-danielle-briefly-loses-her-fking-mind" class="nav-link" data-scroll-target="#danielle-briefly-loses-her-fking-mind">Danielle briefly loses her f**king mind</a></li>
  <li><a href="#data-frames-as-event-schedules" id="toc-data-frames-as-event-schedules" class="nav-link" data-scroll-target="#data-frames-as-event-schedules">Data frames as event schedules</a></li>
  <li><a href="#simulation-times" id="toc-simulation-times" class="nav-link" data-scroll-target="#simulation-times">Simulation times</a></li>
  <li><a href="#simulation-code" id="toc-simulation-code" class="nav-link" data-scroll-target="#simulation-code">Simulation code</a></li>
  <li><a href="#simulation-output" id="toc-simulation-output" class="nav-link" data-scroll-target="#simulation-output">Simulation output</a></li>
  </ul></li>
  <li><a href="#model-specification" id="toc-model-specification" class="nav-link" data-scroll-target="#model-specification">Model specification</a>
  <ul class="collapse">
  <li><a href="#example-1-two-compartment-pk-model" id="toc-example-1-two-compartment-pk-model" class="nav-link" data-scroll-target="#example-1-two-compartment-pk-model">Example 1: Two compartment PK model</a></li>
  <li><a href="#example-2-two-compartment-population-pk-model" id="toc-example-2-two-compartment-population-pk-model" class="nav-link" data-scroll-target="#example-2-two-compartment-population-pk-model">Example 2: Two compartment population-PK model</a></li>
  <li><a href="#example-3-other-customisations" id="toc-example-3-other-customisations" class="nav-link" data-scroll-target="#example-3-other-customisations">Example 3: Other customisations</a></li>
  </ul></li>
  <li><a href="#resources" id="toc-resources" class="nav-link" data-scroll-target="#resources">Resources</a></li>
  <li><a href="#epilogue" id="toc-epilogue" class="nav-link" data-scroll-target="#epilogue">Epilogue</a></li>
  </ul>
</nav>
</nav>
<div id="quarto-sidebar-glass" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
    </div>
<!-- main -->
<main class="content quarto-banner-title-block" id="quarto-document-content">




<!-- 
cover art: https://unsplash.com/photos/a7OdG45prSM
licence: unsplash public
-->
<!--------------- my typical setup ----------------->
<!--------------- post begins here ----------------->
<p>Continuing my informal series of “Danielle learns <a href="https://blog.djnavarro.net/category/pharmacometrics">pharmacometric modelling</a>” posts, today I’ve decided to sit down and teach myself how to use the <a href="https://mrgsolve.org/">mrgsolve</a> package in R.</p>
<p>As I’m rapidly coming to realise, the world of pharmacometric modelling is an intersting space where there are a large number of domain-specific languages that have been designed to solve a particular subset of the modelling problems faced by analysts in the field, and R serves as a lingua franca that stitches them all together and makes it possible to write analysis scripts that call on multiple tools.<a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a></p>
<p>With that as the structure of the ecosystem, what you tend to find are packages that carve out a specific niche by building on top of some other tool. For this post, the niche we’re talking about is <strong>model-based simulation</strong>. In this context, it’s assumed that the analyst has a specific pharmacometric model in mind (e.g., one-compartment PK model,<a href="#fn2" class="footnote-ref" id="fnref2" role="doc-noteref"><sup>2</sup></a> two-compartment PK model, etc etc). We are not attempting to estimate parameters from data, nor are we runing a model testing exercise. The model is presumed to exist already, usually because the analyst has already done the model fitting exercise using their tool of choice.<a href="#fn3" class="footnote-ref" id="fnref3" role="doc-noteref"><sup>3</sup></a></p>
<p>Within the specific “model simulation” niche there are a number of R packages that people seem to use frequently. There’s the RxODE package<a href="#fn4" class="footnote-ref" id="fnref4" role="doc-noteref"><sup>4</sup></a> and its successor <a href="https://nlmixr2.github.io/rxode2/">rxode2</a>, for example, and mrgsolve falls within the same general niche. I didn’t have any specific reason for deciding to learn mrgsolve first: I had to start somewhere and this seems as good a place as any.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(mrgsolve)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="mrgsolve-hex.png" class="img-fluid figure-img" alt="Hex sticker image for the mrgsolve R package"></p>
</figure>
</div>
<section id="a-simple-example" class="level2">
<h2 class="anchored" data-anchor-id="a-simple-example">A simple example</h2>
<p>Okay, let’s get started. The mrgsolve package is build on top of an open source ODE solver,<a href="#fn5" class="footnote-ref" id="fnref5" role="doc-noteref"><sup>5</sup></a> but the user doesn’t need to call it directly. Instead, a model is constructed using a <strong>model specification file</strong> (more on that later) that is then compiled to C++. This compiled model is used to run simulations, and it’s this compiled model that calls the ODE solvers. As a example, let’s use this code taken from the <a href="https://mrgsolve.org/vignettes/01-get-started.html">get started</a> page, which uses <code>modlib()</code> to use one of the predefined model specifications that come bundled with mrgsolve:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>mod <span class="ot">&lt;-</span> <span class="fu">modlib</span>(<span class="st">"pk1"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Building pk1 ... done.</code></pre>
</div>
</div>
<p>In this code, <code>"pk1"</code> refers to the name of one of the model that comes bundled with mrgsolve… and there will be exactly zero pharmacometricians in this world that are surprised to discover that this is a one-compartment PK model with first-order absorption into the central compartment, and first-order elimination from the central compartment. If we print out the model object, we get a nice little summary:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>mod</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>

-----------------  source: pk1.cpp  -----------------

  project: /home/danielle/R...gsolve/models
  shared object: pk1-so-3fbc27212d78b 

  time:          start: 0 end: 24 delta: 1
                 add: &lt;none&gt;

  compartments:  EV CENT [2]
  parameters:    CL V KA [3]
  captures:      CP [1]
  omega:         0x0 
  sigma:         0x0 

  solver:        atol: 1e-08 rtol: 1e-08 maxsteps: 20k
------------------------------------------------------</code></pre>
</div>
</div>
<p>A few months ago very little of this would have made sense to me, but I’ve – apparently – become familiar enough with conventions in pharamacometrics that this now looks very easy to read. For this initial example, the bits that matter most are these:</p>
<ul>
<li><p>We have a list of compartments: CENT refers to the central compartment, and EV refers to an extravascular dosing compartment through which the drug is administered. Note that although there are two listed compartments, this is really a one-compartment model: the extravascular dosing compartments are a necessary part of the model formalism, but no more than that.</p></li>
<li><p>We have a list of parameters: clearance (CL) is a measure representing the volume of blood that can be fully cleared of the drug per unit time, volume of distribution (V) measures the size of the central compartment, and KA is the absorption rate constant governing how quickly the drug is absorbed from the extravascular compartment into the central compartment.</p></li>
<li><p>When running a simulation, the drug amounts in the compartments CENT and EV will be returned as part of the output. However, we can also specify other “captured” quantities, which in this case adds CP, the drug concentration in the central compartment.<a href="#fn6" class="footnote-ref" id="fnref6" role="doc-noteref"><sup>6</sup></a></p></li>
</ul>
<p>The parameter values (i.e.&nbsp;CL, V, KA) are part of the model specification, and you can see the values assigned to those parameters by calling <code>param()</code>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="fu">param</span>(mod)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
 Model parameters (N=3):
 name value . name value
 CL   1     | V    20   
 KA   1     | .    .    </code></pre>
</div>
</div>
<p>We see that our model assumes a clearance (CL) of 1, an aborption rate constant (KA) of 1, and a volume of distribution equal to 20. The mrgsolve package doesn’t keep track of units: it’s up to the user to make sure all the units are on the appropriate scale.</p>
<p>Note that the <code>param()</code> function is both the “getter” and the “setter” for model parameters: <code>param(mod)</code> returns a parameter list object containing the parameters of <code>mod</code>, whereas <code>param(mod, CL = 2, KA = 2)</code> returns a modified model object with updated parameters. Later in the post I’ll use <code>param()</code> to modify model parameters in this way.</p>
<p>Okay so now we have a model object <code>mod</code> that specifies all our pharmacokinetic assumptions. In order to run a simulation, we also need to provide an <strong>event schedule</strong> that provides dosing information, and we’ll also need to say something about the time points at which we want to simulate the various pharmacokinetic quantities of interest. You can do this in a few different ways but for the purposes of the initial example I’ll do it the same way that the “get started” vignette does, and use a pipe-friendly workflow:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>mod <span class="sc">|&gt;</span> </span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ev</span>(<span class="at">amt =</span> <span class="dv">100</span>, <span class="at">ii =</span> <span class="dv">24</span>, <span class="at">addl =</span> <span class="dv">9</span>) <span class="sc">|&gt;</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mrgsim</span>(<span class="at">start =</span> <span class="dv">0</span>, <span class="at">end =</span> <span class="dv">480</span>, <span class="at">delta =</span> <span class="fl">0.1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Model:  pk1 
Dim:    4802 x 5 
Time:   0 to 480 
ID:     1 
    ID time     EV   CENT     CP
1:   1  0.0   0.00  0.000 0.0000
2:   1  0.0 100.00  0.000 0.0000
3:   1  0.1  90.48  9.492 0.4746
4:   1  0.2  81.87 18.034 0.9017
5:   1  0.3  74.08 25.715 1.2858
6:   1  0.4  67.03 32.619 1.6309
7:   1  0.5  60.65 38.819 1.9409
8:   1  0.6  54.88 44.383 2.2191</code></pre>
</div>
</div>
<p>Here we take the <code>mod</code> object, pipe it to the <code>ev()</code> function that builds the event schedule, and then pipe the output to <code>mrgsim()</code> which then runs the simulation. In this code, the arguments to <code>ev()</code> are all very standard in the field:</p>
<ul>
<li><code>amt</code> is the amount of drug</li>
<li><code>ii</code> is the interdose interval</li>
<li><code>addl</code> is number of additional doses</li>
</ul>
<p>The arguments to <code>mrgsim()</code> are used to specify the time points:</p>
<ul>
<li><code>start</code> is the initial time point (I actually didn’t need to specify it in ths case because the default value is 0)</li>
<li><code>end</code> is the final time point</li>
<li><code>delta</code> is the step size (i.e., the amount of time between successive time points)</li>
</ul>
<p>The output here is a tabular data structure – not technically a data frame, but I’ll get to that – with sensible column names:</p>
<ul>
<li><code>ID</code> is a subject identifier (always 1 for this simple example)</li>
<li><code>time</code> is the time point for the simulated measurement</li>
<li><code>EV</code> is the drug amount in the extravascular compartment (e.g., the gut, if we’re talking about oral dosing)</li>
<li><code>CENT</code> is the drug amount in the central compartment</li>
<li><code>CP</code> is the drug concentration in the central compartment</li>
</ul>
<p>To help you get a sense of what the simulation results look like, the mrgsolve package provides a plot method for simulation results, so if I’d wanted to I could add a call to <code>plot()</code> at the end of the pipeline, and get this as the output:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>mod <span class="sc">|&gt;</span> </span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ev</span>(<span class="at">amt =</span> <span class="dv">100</span>, <span class="at">ii =</span> <span class="dv">24</span>, <span class="at">addl =</span> <span class="dv">9</span>) <span class="sc">|&gt;</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mrgsim</span>(<span class="at">start =</span> <span class="dv">0</span>, <span class="at">end =</span> <span class="dv">480</span>, <span class="at">delta =</span> <span class="fl">0.1</span>) <span class="sc">|&gt;</span></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">plot</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/unnamed-chunk-7-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Very nice.</p>
</section>
<section id="simulation-workflow" class="level2">
<h2 class="anchored" data-anchor-id="simulation-workflow">Simulation workflow</h2>
<p>Now things get a little messier. The mrgsolve package is designed to support several different kinds of workflow, which is of course a good thing, but very often the price of analytic flexibility is function complexity. It takes some effort to understand all the moving parts to the package, and the different ways in which mrgsolve functions can be called.<a href="#fn7" class="footnote-ref" id="fnref7" role="doc-noteref"><sup>7</sup></a></p>
<section id="the-model-library" class="level3">
<h3 class="anchored" data-anchor-id="the-model-library">The model library</h3>
<p>Let’s start by taking a closer look at the library of pre-specified models that come bundled with mrgsolve. They’re stored in a package folder whose location is accessible by calling <code>modlib()</code> with no arguments:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="fu">modlib</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "/home/danielle/R/x86_64-pc-linux-gnu-library/4.3/mrgsolve/models"</code></pre>
</div>
</div>
<p>As you can see, when called with no inputs <code>modlib()</code> doesn’t return a compiled model, and it simply returns the path to the model library folder. If you want a list of the models that come bundled with mrgsolve, you can call <code>modlib()</code> setting <code>list = TRUE</code>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="fu">modlib</span>(<span class="at">list =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>mrgsolve internal library:</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>  effect  tmdd  viral1  viral2  emax  irm1  irm2  irm3  irm4  pk1cmt  pk2cmt  pk3cmt  pk1  pk2  pk2iv  popex  pred1  pbpk  1005  nm-like</code></pre>
</div>
</div>
<p>Finally, if you want to build and use one of these model you can call <code>modlib()</code> and pass the name of the model you want as the <code>model</code> argument:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>mod <span class="ot">&lt;-</span> <span class="fu">modlib</span>(<span class="at">model =</span> <span class="st">"pk1"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Loading model from cache.</code></pre>
</div>
</div>
<p>It’s probably stating the obvious, but while the <code>modlib()</code> function works nicely as a tool to support analysts interactively, you probably wouldn’t call it as a developer. For instance, if you want to access the mrgsolve package folder that contains the models, you’d write code that makes very clear that you’re looking for a path (not trying to build a model). Something like this would work better:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>fs<span class="sc">::</span><span class="fu">path_package</span>(<span class="st">"mrgsolve"</span>, <span class="st">"models"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>/home/danielle/R/x86_64-pc-linux-gnu-library/4.3/mrgsolve/models</code></pre>
</div>
</div>
<p>Similarly, if you want to find the models in the model library folder, that’s easy enough to do with <code>fs::dir_ls()</code> and a simple regular expression. Easy done.</p>
</section>
<section id="building-models-from-file" class="level3">
<h3 class="anchored" data-anchor-id="building-models-from-file">Building models from file</h3>
<p>Along the same lines, building one of the bundled models using <code>modlib()</code> is a perfectly sensible thing to do when you’re just starting out and don’t want to write your own model specification files, but after a while you might want to pivot to a different workflow. To that end, there’s an <code>mread()</code> function – and related functions <code>mread_file()</code> and <code>mread_cache()</code> – that reads a model specification file and returns the model object linked to the compiled code. As an example, here’s how I’d use <code>mread()</code> to build the one-compartment model in the previous section:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>dir <span class="ot">&lt;-</span> fs<span class="sc">::</span><span class="fu">path_package</span>(<span class="st">"mrgsolve"</span>, <span class="st">"models"</span>)</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>mod <span class="ot">&lt;-</span> <span class="fu">mread</span>(<span class="at">model =</span> <span class="st">"pk1"</span>, <span class="at">project =</span> dir)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Building pk1 ... (waiting) ...
done.</code></pre>
</div>
</div>
<p>Optionally you can provide a file name for the model specification file that sits within the <code>project</code> folder, but in this case we don’t need to: if the <code>file</code> argument is unspecified <code>mread()</code> assumes that the file name is the same as the <code>model</code> name with file extension <code>.cpp</code>.<a href="#fn8" class="footnote-ref" id="fnref8" role="doc-noteref"><sup>8</sup></a></p>
</section>
<section id="model-objects" class="level3">
<h3 class="anchored" data-anchor-id="model-objects">Model objects</h3>
<p>The mrgsolve package is built using S4 classes and of the great many object oriented programming systems available in R that’s the one I’m least comfortable with.<a href="#fn9" class="footnote-ref" id="fnref9" role="doc-noteref"><sup>9</sup></a> But hey… I’ve just reread the <a href="https://adv-r.hadley.nz/s4.html">S4 chapter in Advanced R</a>, so let’s see how we go with this, shall we? First, I’ll be polite and explicitly load the methods package:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(methods)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Next let’s see what kind of object <code>mod</code> is and what methods are defined for it:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="fu">is</span>(mod)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "mrgmod"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="fu">methods</span>(<span class="at">class =</span> <span class="st">"mrgmod"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> [1] [              [[             $              all.equal     
 [5] as.environment as.list        blocks         cmtn          
 [9] data_set       ev_rx          ev             evd           
[13] idata_set      init           initialize     knobs         
[17] loadso         names          omat           param         
[21] req            Req            revar          see           
[25] show           smat           stime          summary       
[29] update         within         zero_re       
see '?methods' for accessing help and source code</code></pre>
</div>
</div>
<p>A lot of those methods are unsurprising. For example, the <code>show()</code> method is just the S4 analog of <code>print()</code>. When we print the <code>mod</code> object at the console we’re just calling its <code>show()</code> method:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="fu">show</span>(mod)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>

-----------------  source: pk1.cpp  -----------------

  project: /home/danielle/R...gsolve/models
  shared object: pk1-so-3fbc21a2b760d 

  time:          start: 0 end: 24 delta: 1
                 add: &lt;none&gt;

  compartments:  EV CENT [2]
  parameters:    CL V KA [3]
  captures:      CP [1]
  omega:         0x0 
  sigma:         0x0 

  solver:        atol: 1e-08 rtol: 1e-08 maxsteps: 20k
------------------------------------------------------</code></pre>
</div>
</div>
<p>But there are other methods that are kind of handy when inspecting a mrgmod object. For example, if we wanted to see the source code for the corresponding model specification file we could call the <code>see()</code> method:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="fu">see</span>(mod)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Model file:  pk1.cpp 
$PARAM @annotated
CL   :  1 : Clearance (volume/time)
V    : 20 : Central volume (volume)
KA   :  1 : Absorption rate constant (1/time)

$CMT  @annotated
EV   : Extravascular compartment
CENT : Central compartment

$GLOBAL
#define CP (CENT/V)

$PKMODEL ncmt = 1, depot = TRUE

$CAPTURE @annotated
CP : Plasma concentration (mass/volume)</code></pre>
</div>
</div>
<p>If we didn’t want quite that much detail, a <code>summary()</code> would have sufficed:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(mod)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Model: pk1
- Parameters: [3]
  CL, V, KA
- Compartments: [2]
  EV, CENT
- Captured: [1]
  CP
- Outputs: [3]
  EV, CENT, CP</code></pre>
</div>
</div>
<p>I don’t intend to do an exhaustive walk through of all the methods defined for mrgmod objects. That would be tiresome, and in any case I don’t even know what all of them do yet. But what I will mention is that many of the methods exist to provide public accessors for these internal slots of a mrgmod object. To illustrate, here’s a list of all the slot names:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="fu">slotNames</span>(mod)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> [1] "model"    "modfile"  "package"  "soloc"    "project"  "start"   
 [7] "end"      "delta"    "add"      "tscale"   "digits"   "quiet"   
[13] "verbose"  "debug"    "preclean" "atol"     "rtol"     "ss_rtol" 
[19] "ss_atol"  "maxsteps" "hmin"     "hmax"     "ixpr"     "mxhnil"  
[25] "shlib"    "funs"     "omega"    "sigma"    "request"  "param"   
[31] "init"     "capture"  "Icap"     "capL"     "Icmt"     "cmtL"    
[37] "args"     "fixed"    "advan"    "trans"    "mindt"    "code"    
[43] "annot"    "envir"    "plugin"   "ss_cmt"  </code></pre>
</div>
</div>
<p>Okay so one of the slots is called “param”, and denoted <code>@param</code> to remind us that it’s a slot of an S4 object.<a href="#fn10" class="footnote-ref" id="fnref10" role="doc-noteref"><sup>10</sup></a> Calling the <code>param()</code> method is the appropriate way to access the <code>@param</code> slot, for instance.<a href="#fn11" class="footnote-ref" id="fnref11" role="doc-noteref"><sup>11</sup></a> The <code>see()</code> method is slightly fancier, but it too is essentially an accessor function for the <code>@modelfile</code> and <code>@code</code> slots. If I were an extremely unwise woman who ignored all the best practices for S4 classes I could use a command like <code>cat(mod@code, sep = "\n")</code> and get roughly the same output. This is of course a terrible idea: the slots of an S4 object are considered internal details and not part of the package API. Accessing them directly is considered a faux pas and you have only yourself to blame if the developer later changes the structure of the slots and your code breaks.</p>
<p>Indeed, the <em>only</em> reason I’m talking about them here is that I find it helpful for building my own mental model of what mrgsolve does, which will become apparent in the next section when I tackle the puzzlingly magical behaviour of the <code>ev()</code> function.</p>
</section>
<section id="event-objects" class="level3">
<h3 class="anchored" data-anchor-id="event-objects">Event objects</h3>
<p>Model objects represent the underlying ODE system. They don’t store information about “interventions” (external forcers) on the system. In the pharmacokinetic context the main intervention we’re thinking about is dosing. An events object returned by <code>ev()</code> returns a event schedule that would be familiar to any pharmacometrician:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a>events <span class="ot">&lt;-</span> <span class="fu">ev</span>(<span class="at">amt =</span> <span class="dv">100</span>, <span class="at">ii =</span> <span class="dv">24</span>, <span class="at">addl =</span> <span class="dv">9</span>)</span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>events</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Events:
  time amt ii addl cmt evid
1    0 100 24    9   1    1</code></pre>
</div>
</div>
<p>The <code>events</code> object looks a lot like a data frame, but is technically an S4 object with class “ev”. However, an ev object has only two slots, one of which is <code>@data</code> and – as you’d expect – it stores the data set as a data frame internally. So… yeah, it’s basically a data frame, and since there are <code>as.data.frame()</code> and <code>as_tibble()</code> methods defined for ev objects, so you can coerce it to whatever your preferred form of tabular data object happens to be.<a href="#fn12" class="footnote-ref" id="fnref12" role="doc-noteref"><sup>12</sup></a> I’m a tibble girl myself so…</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a>tibble<span class="sc">::</span><span class="fu">as_tibble</span>(events)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 6
   time   amt    ii  addl   cmt  evid
  &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
1     0   100    24     9     1     1</code></pre>
</div>
</div>
<p>I’ll talk more about other ways to build fancier event schedules later, and you’ll see that it’s perfectly possible to use a simple data frame to specify an event schedule, but we’re not yet at the point where any of that is needed. Right now, all we’re trying to do is understand what happens in the simple simulation I showed at the start of this post.</p>
</section>
<section id="danielle-briefly-loses-her-fking-mind" class="level3">
<h3 class="anchored" data-anchor-id="danielle-briefly-loses-her-fking-mind">Danielle briefly loses her f**king mind</h3>
<p>Very soon I will move on to <code>mrgsim()</code>, the function that we use to run the simulation itself. Truly, we will get there soon. But we have one little matter to clear up first, related to the behaviour of <code>ev()</code>.</p>
<p>The previous section makes it look as if <code>ev()</code> is very simple, and viewed from the analyst perspective it really is quite simple. You use it to construct event schedules. However, <code>ev()</code> is not a simple function. It’s an S4 generic with dispatch on the first argument<a href="#fn13" class="footnote-ref" id="fnref13" role="doc-noteref"><sup>13</sup></a> and it returns a qualitatively different kind of object when called in a pipeline.</p>
<p>To understand the “Danielle briefly loses her f**king mind” aspect to this, let’s return to the model simulation pipeline that I lifted from the “Get Started” vignette and used at the start of the post:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a>mod <span class="sc">|&gt;</span> </span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ev</span>(<span class="at">amt =</span> <span class="dv">100</span>, <span class="at">ii =</span> <span class="dv">24</span>, <span class="at">addl =</span> <span class="dv">9</span>) <span class="sc">|&gt;</span></span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mrgsim</span>(<span class="at">end =</span> <span class="dv">480</span>, <span class="at">delta =</span> <span class="fl">0.1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Model:  pk1 
Dim:    4802 x 5 
Time:   0 to 480 
ID:     1 
    ID time     EV   CENT     CP
1:   1  0.0   0.00  0.000 0.0000
2:   1  0.0 100.00  0.000 0.0000
3:   1  0.1  90.48  9.492 0.4746
4:   1  0.2  81.87 18.034 0.9017
5:   1  0.3  74.08 25.715 1.2858
6:   1  0.4  67.03 32.619 1.6309
7:   1  0.5  60.65 38.819 1.9409
8:   1  0.6  54.88 44.383 2.2191</code></pre>
</div>
</div>
<p>If you’re expecting <code>ev()</code> to return an “ev” object – as indeed it would if I called <code>ev(amt = 100, ii = 24, addl = 9)</code> outside of a pipeline – this code makes absolutely no sense whatsoever. An “ev” object simply does not have the information required to run the simulations. Running a model-based simulation requires an actual model, and an “ev” object does not contain any slots that could possibly store a model object. So… something magical is happening. This code shouldn’t work, but it does???</p>
<p>I cried briefly. Then I read the <a href="https://mrgsolve.org/docs/reference/ev.html">documentation</a> properly. Then I cried some more.</p>
<p>After reading the documentation carefully, I now understand what’s going on here, but an explanation is required because if you don’t look closely it looks like magic.<a href="#fn14" class="footnote-ref" id="fnref14" role="doc-noteref"><sup>14</sup></a> When the first argument to <code>ev()</code> is a model object, it doesn’t return an event schedule. Instead, it returns another model object.<a href="#fn15" class="footnote-ref" id="fnref15" role="doc-noteref"><sup>15</sup></a></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ev</span>(mod, <span class="at">amt =</span> <span class="dv">100</span>, <span class="at">ii =</span> <span class="dv">24</span>, <span class="at">addl =</span> <span class="dv">9</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>

-----------------  source: pk1.cpp  -----------------

  project: /home/danielle/R...gsolve/models
  shared object: pk1-so-3fbc21a2b760d 

  time:          start: 0 end: 24 delta: 1
                 add: &lt;none&gt;

  compartments:  EV CENT [2]
  parameters:    CL V KA [3]
  captures:      CP [1]
  omega:         0x0 
  sigma:         0x0 

  solver:        atol: 1e-08 rtol: 1e-08 maxsteps: 20k
------------------------------------------------------</code></pre>
</div>
</div>
<p>Looking at the printed output, you might think that the output here is identical to the original model object <code>mod</code>, but in this case looks are deceiving. The new model stores the event schedule internally: it’s tucked away in the <code>@args</code> slot.<a href="#fn16" class="footnote-ref" id="fnref16" role="doc-noteref"><sup>16</sup></a> To illustrate, let’s assign the output to a variable:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a>mod_with_ev <span class="ot">&lt;-</span> <span class="fu">ev</span>(mod, <span class="at">amt =</span> <span class="dv">100</span>, <span class="at">ii =</span> <span class="dv">24</span>, <span class="at">addl =</span> <span class="dv">9</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now compare the pair:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a>mod<span class="sc">@</span>args</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>list()</code></pre>
</div>
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a>mod_with_ev<span class="sc">@</span>args</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>$events
Events:
  time amt ii addl cmt evid
1    0 100 24    9   1    1</code></pre>
</div>
</div>
<p>So now things become a little clearer. After seeing this, what you might – correctly! – conclude is that at the other end of the pipeline the <code>mrgsim()</code> function is aware that the event schedule might not be passed explicitly, and knows to check within the model object if that is the case. Knowing all this, we’re now in a position to understand what happens during a pipeline like this:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="fu">modlib</span>(<span class="st">"pk1"</span>, <span class="at">quiet =</span> <span class="cn">TRUE</span>) <span class="sc">|&gt;</span> </span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ev</span>(<span class="at">amt =</span> <span class="dv">100</span>, <span class="at">ii =</span> <span class="dv">24</span>, <span class="at">addl =</span> <span class="dv">9</span>) <span class="sc">|&gt;</span></span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mrgsim</span>(<span class="at">end =</span> <span class="dv">480</span>, <span class="at">delta =</span> <span class="fl">0.1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>It’s a clever trick, and I imagine it’s something that a lot of data analysts find super handy. That said, it’s probably not something I would use myself. I’m a simple girl who likes her coffee black and her data pipelines transparent, so I’d probably avoid this particular workflow and instead write code that looks more like this:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a><span class="co"># set up the simulation</span></span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a>dir    <span class="ot">&lt;-</span> fs<span class="sc">::</span><span class="fu">path_package</span>(<span class="st">"mrgsolve"</span>, <span class="st">"models"</span>)</span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a>mod    <span class="ot">&lt;-</span> <span class="fu">mread_file</span>(<span class="at">file =</span> <span class="st">"pk1.cpp"</span>, <span class="at">project =</span> dir, <span class="at">quiet =</span> <span class="cn">TRUE</span>)</span>
<span id="cb49-4"><a href="#cb49-4" aria-hidden="true" tabindex="-1"></a>events <span class="ot">&lt;-</span> <span class="fu">ev</span>(<span class="at">amt =</span> <span class="dv">100</span>, <span class="at">ii =</span> <span class="dv">24</span>, <span class="at">addl =</span> <span class="dv">9</span>)</span>
<span id="cb49-5"><a href="#cb49-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-6"><a href="#cb49-6" aria-hidden="true" tabindex="-1"></a><span class="co"># run the simulation</span></span>
<span id="cb49-7"><a href="#cb49-7" aria-hidden="true" tabindex="-1"></a>out <span class="ot">&lt;-</span> <span class="fu">mrgsim_e</span>(mod, <span class="at">events =</span> events, <span class="at">end =</span> <span class="dv">480</span>, <span class="at">delta =</span> <span class="fl">0.1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Notice that I called <code>mrgsim_e()</code> here rather than <code>mrgsim()</code>. Because mrgsolve recognises that sometimes developers might want to call simulation functions programmatically, it provides several restricted versions of <code>mrgsim()</code> that require input in a specific format. The sneaky “event-schedule-inside-the-model-object” piping trick I showed at the start of the post does not work with <code>mrgsim_e()</code>, which – at least to my mind – makes it a safer choice when running simulations programmatically. Later in this post you’ll see me pivot to using <code>mrgsim_d()</code>, for much the same reason.</p>
</section>
<section id="data-frames-as-event-schedules" class="level3">
<h3 class="anchored" data-anchor-id="data-frames-as-event-schedules">Data frames as event schedules</h3>
<p>In the last section I kind of wrapped myself up in knots trying to get a handle on what <code>ev()</code> does under the hood, and as you can probably tell I have some mixed feelings about it. Fortunately, you don’t have to use it at all if you don’t want to: the <code>mrgsim_d()</code> function takes regular data frame as the <code>data</code> argument, and which plays the same role as the <code>events</code> argument in <code>mrgsim_e()</code>. You can generate event schedules in data frame format using the <code>ev_expand()</code> function:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ev_expand</span>(<span class="at">amt =</span> <span class="dv">100</span>, <span class="at">ii =</span> <span class="dv">24</span>, <span class="at">addl =</span> <span class="dv">9</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  ID time amt ii addl cmt evid
1  1    0 100 24    9   1    1</code></pre>
</div>
</div>
<p>The output here looks the same, but this time the output is a regular data frame, and so to be defensive in our code we would call <code>mrgsim_d()</code> to run a simulation that <em>requires</em> a data frame as input:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a><span class="co"># set up the simulation</span></span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a>dir    <span class="ot">&lt;-</span> fs<span class="sc">::</span><span class="fu">path_package</span>(<span class="st">"mrgsolve"</span>, <span class="st">"models"</span>)</span>
<span id="cb52-3"><a href="#cb52-3" aria-hidden="true" tabindex="-1"></a>mod    <span class="ot">&lt;-</span> <span class="fu">mread_file</span>(<span class="at">file =</span> <span class="st">"pk1.cpp"</span>, <span class="at">project =</span> dir, <span class="at">quiet =</span> <span class="cn">TRUE</span>)</span>
<span id="cb52-4"><a href="#cb52-4" aria-hidden="true" tabindex="-1"></a>events <span class="ot">&lt;-</span> <span class="fu">ev_expand</span>(<span class="at">amt =</span> <span class="dv">100</span>, <span class="at">ii =</span> <span class="dv">24</span>, <span class="at">addl =</span> <span class="dv">9</span>)</span>
<span id="cb52-5"><a href="#cb52-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-6"><a href="#cb52-6" aria-hidden="true" tabindex="-1"></a><span class="co"># run the simulation</span></span>
<span id="cb52-7"><a href="#cb52-7" aria-hidden="true" tabindex="-1"></a>out <span class="ot">&lt;-</span> <span class="fu">mrgsim_d</span>(mod, <span class="at">data =</span> events, <span class="at">end =</span> <span class="dv">480</span>, <span class="at">delta =</span> <span class="fl">0.1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>As an aside, you might be wondering why this function is named <code>ev_expand()</code>. It’s not obvious from the example I showed above, but the <code>ev_expand()</code> function is essentially a convenience function that calls to <code>expand.grid()</code> to combine the levels of all variables input, with some extra syntactic sugar that auto-populates certain columns that are required for event schedule data sets. As an example, you might generate an event schedule defined for multiple subjects using a command like this:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ev_expand</span>(<span class="at">amt =</span> <span class="dv">100</span>, <span class="at">ii =</span> <span class="dv">24</span>, <span class="at">addl =</span> <span class="dv">9</span>, <span class="at">ID =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">6</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  ID time amt ii addl cmt evid
1  1    0 100 24    9   1    1
2  2    0 100 24    9   1    1
3  3    0 100 24    9   1    1
4  4    0 100 24    9   1    1
5  5    0 100 24    9   1    1
6  6    0 100 24    9   1    1</code></pre>
</div>
</div>
<p>Later in this post I’ll use <code>ev_expand()</code> in exactly this way.</p>
</section>
<section id="simulation-times" class="level3">
<h3 class="anchored" data-anchor-id="simulation-times">Simulation times</h3>
<p>We’re almost done unpacking the simple example, but I want to rewrite the code one last time. Until now, every time I’ve <code>mrgsim()</code> and its variants I’ve passed arguments <code>end</code> and <code>delta</code> as a way to override the default assumptions about what time points we would use when running our simulations. Internally, these arguments are used to construct a “tgrid” object that specifies the time points. We can construct this object explicitly by calling <code>tgrid()</code>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a><span class="fu">tgrid</span>(<span class="at">start =</span> <span class="dv">0</span>, <span class="at">end =</span> <span class="dv">480</span>, <span class="at">delta =</span> <span class="fl">0.1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>start:  0  end:    480  delta:  0.1  offset: 0  min:    0   max:    480 </code></pre>
</div>
</div>
<p>Using this knowledge, we can now write our simulation code like this:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a><span class="co"># set up the simulation</span></span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a>dir    <span class="ot">&lt;-</span> fs<span class="sc">::</span><span class="fu">path_package</span>(<span class="st">"mrgsolve"</span>, <span class="st">"models"</span>)</span>
<span id="cb57-3"><a href="#cb57-3" aria-hidden="true" tabindex="-1"></a>mod    <span class="ot">&lt;-</span> <span class="fu">mread_file</span>(<span class="at">file =</span> <span class="st">"pk1.cpp"</span>, <span class="at">project =</span> dir, <span class="at">quiet =</span> <span class="cn">TRUE</span>)</span>
<span id="cb57-4"><a href="#cb57-4" aria-hidden="true" tabindex="-1"></a>events <span class="ot">&lt;-</span> <span class="fu">ev_expand</span>(<span class="at">amt =</span> <span class="dv">100</span>, <span class="at">ii =</span> <span class="dv">24</span>, <span class="at">addl =</span> <span class="dv">9</span>)</span>
<span id="cb57-5"><a href="#cb57-5" aria-hidden="true" tabindex="-1"></a>times  <span class="ot">&lt;-</span> <span class="fu">tgrid</span>(<span class="at">start =</span> <span class="dv">0</span>, <span class="at">end =</span> <span class="dv">480</span>, <span class="at">delta =</span> <span class="fl">0.1</span>)</span>
<span id="cb57-6"><a href="#cb57-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-7"><a href="#cb57-7" aria-hidden="true" tabindex="-1"></a><span class="co"># run simulation</span></span>
<span id="cb57-8"><a href="#cb57-8" aria-hidden="true" tabindex="-1"></a>out <span class="ot">&lt;-</span> <span class="fu">mrgsim_d</span>(<span class="at">x =</span> mod, <span class="at">data =</span> events, <span class="at">tgrid =</span> times)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>For the simple example, calling <code>tgrid()</code> explicitly doesn’t by us much, but if you dive into the documentation a little you discover that there are tools for working with tgrid objects that allow you to define the simulation times in much richer ways than a simple grid. But I digress.</p>
</section>
<section id="simulation-code" class="level3">
<h3 class="anchored" data-anchor-id="simulation-code">Simulation code</h3>
<p>Taking a step back, it’s worth thinking a little about the code I’ve ended up with. The piped code I started with probably works nicely for some people, but it’s not my preferred way to do this. The way I think of these things, a simulation has three main inputs (model object, event schedule, simulation times), and I find the code easier to read when these three inputs are passed as three separate arguments. The syntax used to specify the original simulation pipeline is very compact…</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb58"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a>out <span class="ot">&lt;-</span> <span class="fu">modlib</span>(<span class="st">"pk1"</span>, <span class="at">quiet =</span> <span class="cn">TRUE</span>) <span class="sc">|&gt;</span> </span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ev</span>(<span class="at">amt =</span> <span class="dv">100</span>, <span class="at">ii =</span> <span class="dv">24</span>, <span class="at">addl =</span> <span class="dv">9</span>) <span class="sc">|&gt;</span></span>
<span id="cb58-3"><a href="#cb58-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mrgsim</span>(<span class="at">end =</span> <span class="dv">480</span>, <span class="at">delta =</span> <span class="fl">0.1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>…but that compactness comes at the expense of slightly obfuscating the inputs to <code>mrgsim()</code>. By way of contrast, this version of the code is considerably more verbose…</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb59"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a><span class="co"># this would normally be the project folder</span></span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a>dir <span class="ot">&lt;-</span> fs<span class="sc">::</span><span class="fu">path_package</span>(<span class="st">"mrgsolve"</span>, <span class="st">"models"</span>)</span>
<span id="cb59-3"><a href="#cb59-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-4"><a href="#cb59-4" aria-hidden="true" tabindex="-1"></a><span class="co"># define model, events, and times</span></span>
<span id="cb59-5"><a href="#cb59-5" aria-hidden="true" tabindex="-1"></a>mod    <span class="ot">&lt;-</span> <span class="fu">mread_file</span>(<span class="at">file =</span> <span class="st">"pk1.cpp"</span>, <span class="at">project =</span> dir, <span class="at">quiet =</span> <span class="cn">TRUE</span>)</span>
<span id="cb59-6"><a href="#cb59-6" aria-hidden="true" tabindex="-1"></a>events <span class="ot">&lt;-</span> <span class="fu">ev_expand</span>(<span class="at">amt =</span> <span class="dv">100</span>, <span class="at">ii =</span> <span class="dv">24</span>, <span class="at">addl =</span> <span class="dv">9</span>)</span>
<span id="cb59-7"><a href="#cb59-7" aria-hidden="true" tabindex="-1"></a>times  <span class="ot">&lt;-</span> <span class="fu">tgrid</span>(<span class="at">start =</span> <span class="dv">0</span>, <span class="at">end =</span> <span class="dv">480</span>, <span class="at">delta =</span> <span class="fl">0.1</span>)</span>
<span id="cb59-8"><a href="#cb59-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-9"><a href="#cb59-9" aria-hidden="true" tabindex="-1"></a><span class="co"># run simulation</span></span>
<span id="cb59-10"><a href="#cb59-10" aria-hidden="true" tabindex="-1"></a>out <span class="ot">&lt;-</span> <span class="fu">mrgsim_d</span>(<span class="at">x =</span> mod, <span class="at">data =</span> events, <span class="at">tgrid =</span> times)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>…but personally I find it a little easier to understand the structure of the simulation when its written like this. Other people might have different views though.</p>
</section>
<section id="simulation-output" class="level3">
<h3 class="anchored" data-anchor-id="simulation-output">Simulation output</h3>
<p>At this point the simulation is complete, so we can turn our attention to the output we’ve created. Here’s an example of the output returned by <code>mrgsim()</code> and its friends:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb60"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a>out</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Model:  pk1 
Dim:    4802 x 5 
Time:   0 to 480 
ID:     1 
    ID time     EV   CENT     CP
1:   1  0.0   0.00  0.000 0.0000
2:   1  0.0 100.00  0.000 0.0000
3:   1  0.1  90.48  9.492 0.4746
4:   1  0.2  81.87 18.034 0.9017
5:   1  0.3  74.08 25.715 1.2858
6:   1  0.4  67.03 32.619 1.6309
7:   1  0.5  60.65 38.819 1.9409
8:   1  0.6  54.88 44.383 2.2191</code></pre>
</div>
</div>
<p>As you’ve probably come to expect at this point, this is not technically a data frame, it’s an S4 object of class “mrgsims”, and can easily be coerced to a data frame using <code>as.data.frame()</code> or <code>as_tibble()</code>.</p>
<p>The mrgsolve package supplies a plot method for mrgsims objects that generates nice looking lattice plots, making it very easy to quickly produce helpful data visualisations:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb62"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(out)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/unnamed-chunk-35-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>The plot method allows you to <a href="https://mrgsolve.org/docs/reference/plot_mrgsims.html">customise the plot</a> in a fairly flexible way, but there are some limits to what you can do with this approach. It’s not a big drawback though. If additional customisation is needed it’s pretty easy to convert the output to a tibble and then using ggplot2 to create the specific visualisation you want:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb63"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb63-2"><a href="#cb63-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-3"><a href="#cb63-3" aria-hidden="true" tabindex="-1"></a>out <span class="sc">|&gt;</span></span>
<span id="cb63-4"><a href="#cb63-4" aria-hidden="true" tabindex="-1"></a>  tibble<span class="sc">::</span><span class="fu">as_tibble</span>() <span class="sc">|&gt;</span></span>
<span id="cb63-5"><a href="#cb63-5" aria-hidden="true" tabindex="-1"></a>  tidyr<span class="sc">::</span><span class="fu">pivot_longer</span>(</span>
<span id="cb63-6"><a href="#cb63-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">cols =</span> <span class="fu">c</span>(EV, CENT, CP), </span>
<span id="cb63-7"><a href="#cb63-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">names_to =</span> <span class="st">"variable"</span>, </span>
<span id="cb63-8"><a href="#cb63-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">values_to =</span> <span class="st">"value"</span></span>
<span id="cb63-9"><a href="#cb63-9" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span> </span>
<span id="cb63-10"><a href="#cb63-10" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb63-11"><a href="#cb63-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">variable =</span> dplyr<span class="sc">::</span><span class="fu">case_when</span>(</span>
<span id="cb63-12"><a href="#cb63-12" aria-hidden="true" tabindex="-1"></a>      variable <span class="sc">==</span> <span class="st">"EV"</span> <span class="sc">~</span> <span class="st">"Gut amount"</span>,</span>
<span id="cb63-13"><a href="#cb63-13" aria-hidden="true" tabindex="-1"></a>      variable <span class="sc">==</span> <span class="st">"CENT"</span> <span class="sc">~</span> <span class="st">"Central amount"</span>,</span>
<span id="cb63-14"><a href="#cb63-14" aria-hidden="true" tabindex="-1"></a>      variable <span class="sc">==</span> <span class="st">"CP"</span> <span class="sc">~</span> <span class="st">"Central concentration"</span></span>
<span id="cb63-15"><a href="#cb63-15" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb63-16"><a href="#cb63-16" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb63-17"><a href="#cb63-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(time, value)) <span class="sc">+</span> </span>
<span id="cb63-18"><a href="#cb63-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb63-19"><a href="#cb63-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span> variable, <span class="at">scales =</span> <span class="st">"free_y"</span>) <span class="sc">+</span> </span>
<span id="cb63-20"><a href="#cb63-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>() <span class="sc">+</span></span>
<span id="cb63-21"><a href="#cb63-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">strip.background =</span> <span class="fu">element_rect</span>(<span class="at">fill =</span> <span class="st">"white"</span>)) <span class="sc">+</span> </span>
<span id="cb63-22"><a href="#cb63-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb63-23"><a href="#cb63-23" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Drug amounts and concentrations over time"</span>,</span>
<span id="cb63-24"><a href="#cb63-24" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Time (hours)"</span>,</span>
<span id="cb63-25"><a href="#cb63-25" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="cn">NULL</span></span>
<span id="cb63-26"><a href="#cb63-26" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/unnamed-chunk-36-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</section>
</section>
<section id="model-specification" class="level2">
<h2 class="anchored" data-anchor-id="model-specification">Model specification</h2>
<p>Up till now I’ve been relying entirely on prespecified pharmacokinetic models included in the mrgsolve model library. That was a useful thing to do earlier in this post while discussing the mechanics of <code>mrgsim()</code>, <code>ev()</code>, <code>mread()</code>, <code>tgrid()</code> and so on, but in practice you really need to understand how models are specified. I’m not going to attempt a comprehensive discussion of this topic, but if you want more detail, the chapters in the user guide I found most relevant are:</p>
<ul>
<li>The <a href="https://mrgsolve.org/user-guide/specification.html">model specification chapter</a></li>
<li>The <a href="https://mrgsolve.org/user-guide/topics.html">topics chapter</a></li>
</ul>
<section id="example-1-two-compartment-pk-model" class="level3">
<h3 class="anchored" data-anchor-id="example-1-two-compartment-pk-model">Example 1: Two compartment PK model</h3>
<p>There are two ways to specify a model in mrgsolve: you can pass a string to <code>mread_code()</code>, or you can read it from a model specification file using <code>mread_file()</code>. I’ll be using the latter method here. By convention, model specification files use a “.cpp” file extension, but it’s important to recognise that despite that, a model specification file is not, strictly speaking, C++ code. A model specification consists of a set of code blocks, and only some of those code blocks contain C++ code. Some blocks use R syntax, and others are plain text.<a href="#fn17" class="footnote-ref" id="fnref17" role="doc-noteref"><sup>17</sup></a></p>
<p>In any case, the first model specification I wrote is contained in the <a href="example1.cpp">example1.cpp</a> file bundled with this post, and is a very modest tweak to one of the models distributed with the mrgsolve package. Here’s what the file looks like:</p>
<div class="cell" data-file="example1.cpp">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>example1.cpp</strong></pre>
</div>
<div class="sourceCode cell-code" id="cb64"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb64-1"><a href="#cb64-1"></a><span class="op">[</span>PROB<span class="op">]</span></span>
<span id="cb64-2"><a href="#cb64-2"></a></span>
<span id="cb64-3"><a href="#cb64-3"></a>This is a minor variation of the <span class="st">"pk2cmt"</span> model that is distributed as</span>
<span id="cb64-4"><a href="#cb64-4"></a>part of the mrgsolve internal model library<span class="op">.</span> It has a single extravascular</span>
<span id="cb64-5"><a href="#cb64-5"></a>dosing compartment <span class="op">(</span>the GUT<span class="op">),</span> a central compartment <span class="op">(</span>CENT<span class="op">),</span> <span class="kw">and</span> a</span>
<span id="cb64-6"><a href="#cb64-6"></a>peripheral compartment <span class="op">(</span>PERIPH<span class="op">).</span> Absorption from GUT is first order<span class="op">,</span></span>
<span id="cb64-7"><a href="#cb64-7"></a>whereas elimination from CENT follows Michaelis<span class="op">-</span>Menten kinetics<span class="op">.</span></span>
<span id="cb64-8"><a href="#cb64-8"></a></span>
<span id="cb64-9"><a href="#cb64-9"></a><span class="op">[</span>PARAM<span class="op">]</span> <span class="er">@</span>annotated</span>
<span id="cb64-10"><a href="#cb64-10"></a></span>
<span id="cb64-11"><a href="#cb64-11"></a>VC   <span class="op">:</span>  <span class="dv">20</span>  <span class="op">:</span> Central volume <span class="op">(</span>volume<span class="op">)</span></span>
<span id="cb64-12"><a href="#cb64-12"></a>Q    <span class="op">:</span>   <span class="dv">2</span>  <span class="op">:</span> Inter<span class="op">-</span>compartmental clearance <span class="op">(</span>volume<span class="op">/</span>time<span class="op">)</span></span>
<span id="cb64-13"><a href="#cb64-13"></a>VP   <span class="op">:</span>  <span class="dv">10</span>  <span class="op">:</span> Peripheral volume of distribution <span class="op">(</span>volume<span class="op">)</span></span>
<span id="cb64-14"><a href="#cb64-14"></a>KA   <span class="op">:</span> <span class="fl">0.5</span>  <span class="op">:</span> Absorption rate constant <span class="op">(</span><span class="dv">1</span><span class="op">/</span>time<span class="op">)</span></span>
<span id="cb64-15"><a href="#cb64-15"></a>VMAX <span class="op">:</span>   <span class="dv">1</span>  <span class="op">:</span> Maximum velocity of elimination <span class="op">(</span>mass<span class="op">/</span>time<span class="op">)</span></span>
<span id="cb64-16"><a href="#cb64-16"></a>KM   <span class="op">:</span>   <span class="dv">2</span>  <span class="op">:</span> Michaelis constant <span class="cf">for</span> elimination <span class="op">(</span>mass<span class="op">/</span>volume<span class="op">)</span></span>
<span id="cb64-17"><a href="#cb64-17"></a></span>
<span id="cb64-18"><a href="#cb64-18"></a><span class="op">[</span>CMT<span class="op">]</span> <span class="er">@</span>annotated</span>
<span id="cb64-19"><a href="#cb64-19"></a></span>
<span id="cb64-20"><a href="#cb64-20"></a>GUT    <span class="op">:</span> Drug amount in gut <span class="op">(</span>mass<span class="op">)</span></span>
<span id="cb64-21"><a href="#cb64-21"></a>CENT   <span class="op">:</span> Drug amount in central compartment <span class="op">(</span>mass<span class="op">)</span></span>
<span id="cb64-22"><a href="#cb64-22"></a>PERIPH <span class="op">:</span> Drug amount in peripherhal compartment <span class="op">(</span>mass<span class="op">)</span></span>
<span id="cb64-23"><a href="#cb64-23"></a></span>
<span id="cb64-24"><a href="#cb64-24"></a><span class="op">[</span>GLOBAL<span class="op">]</span></span>
<span id="cb64-25"><a href="#cb64-25"></a></span>
<span id="cb64-26"><a href="#cb64-26"></a><span class="pp">#define CP </span><span class="op">(</span>CENT<span class="pp"> </span><span class="op">/</span><span class="pp"> </span>VC<span class="op">)</span><span class="pp">          </span><span class="co">// concentration in central compartment</span></span>
<span id="cb64-27"><a href="#cb64-27"></a><span class="pp">#define CT </span><span class="op">(</span>PERIPH<span class="pp"> </span><span class="op">/</span><span class="pp"> </span>VP<span class="op">)</span><span class="pp">        </span><span class="co">// concentration in peripheral compartment</span></span>
<span id="cb64-28"><a href="#cb64-28"></a><span class="pp">#define CLNL </span><span class="op">(</span>VMAX<span class="pp"> </span><span class="op">/</span><span class="pp"> </span><span class="op">(</span>KM<span class="pp"> </span><span class="op">+</span><span class="pp"> </span>CP<span class="op">))</span><span class="pp"> </span><span class="co">// non-linear clearance, per MM kinetics</span></span>
<span id="cb64-29"><a href="#cb64-29"></a></span>
<span id="cb64-30"><a href="#cb64-30"></a><span class="op">[</span>ODE<span class="op">]</span></span>
<span id="cb64-31"><a href="#cb64-31"></a></span>
<span id="cb64-32"><a href="#cb64-32"></a>dxdt_GUT <span class="op">=</span> <span class="op">-</span>KA <span class="op">*</span> GUT<span class="op">;</span></span>
<span id="cb64-33"><a href="#cb64-33"></a>dxdt_CENT <span class="op">=</span> KA <span class="op">*</span> GUT <span class="op">-</span> <span class="op">(</span>CLNL <span class="op">+</span> Q<span class="op">)</span> <span class="op">*</span> CP  <span class="op">+</span> Q <span class="op">*</span> CT<span class="op">;</span></span>
<span id="cb64-34"><a href="#cb64-34"></a>dxdt_PERIPH <span class="op">=</span> <span class="op">(</span>Q <span class="op">*</span> CP<span class="op">)</span> <span class="op">-</span> <span class="op">(</span>Q <span class="op">*</span> CT<span class="op">);</span></span>
<span id="cb64-35"><a href="#cb64-35"></a></span>
<span id="cb64-36"><a href="#cb64-36"></a><span class="op">[</span>CAPTURE<span class="op">]</span> <span class="er">@</span>annotated</span>
<span id="cb64-37"><a href="#cb64-37"></a></span>
<span id="cb64-38"><a href="#cb64-38"></a>CP <span class="op">:</span> Plasma concentration <span class="op">(</span>mass<span class="op">/</span>time<span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<p>There are six code blocks in this file. I’ve specified them using square brackets (e.g., <code>[BLOCKNAME]</code>) because it reminds me of <a href="https://toml.io/en/">TOML</a>, but it’s also valid to use the dollar sign (e.g., <code>$BLOCKNAME</code>).<a href="#fn18" class="footnote-ref" id="fnref18" role="doc-noteref"><sup>18</sup></a> Block names are case insensitive: mrgsolve treats <code>[BLOCKNAME]</code> and <code>[blockname]</code> identically. The order in which you specify blocks doesn’t matter, but the order of statements within a block often does matter because some blocks are interpreted as C++ or R code.</p>
<p>The interpretation of these blocks is as follows:</p>
<ul>
<li><p>The <a href="https://mrgsolve.org/user-guide/specification.html#sec-block-prob"><code>[PROB]</code></a> block is purely used to specify comments or notes on the model. It has no functional effect. You’ll very often see this block written in markdown format.</p></li>
<li><p>The <a href="https://mrgsolve.org/user-guide/specification.html#sec-block-param"><code>[PARAM]</code></a> block is used to pass a list of parameter values to be used in the model. When parsing this code block, mrgsolve interprets the values as R expressions (evaluated at build time), so if you were to define the central compartment volume <code>VC</code> to be <code>sqrt(400)</code>, the resulting model would store <code>VC</code> as the numeric value <code>20</code> within the internal parameter list. Normally, parameters would be defined as a comma separated list of name-value pairs (e.g., <code>VC = 20, Q = 2, ...</code>), but when you use the <code>@annotated</code> option as I have done here, you can write <code>VC : 20 : Central volume (volume)</code>. This version of the syntax allows you to provide comments on how each parameter is interpreted. Many of the code blocks support the <code>@annotated</code> option, and in most cases I find myself strongly preferring the annotated syntax.</p></li>
<li><p>The <a href="https://mrgsolve.org/user-guide/specification.html#cmt-and-init"><code>[CMT]</code></a> block is used to specify compartment names, and much like the <code>[PARAM]</code> block it supports the <code>@annotated</code> keyword. By default, all compartments are presumed to be initialised with value 0. If you need to set different initial values for the drug amounts in each compartment, use an <code>[INIT]</code> block instead of a <code>[CMT]</code> block.</p></li>
<li><p>The <a href="https://mrgsolve.org/user-guide/specification.html#global"><code>[GLOBAL]</code></a> block is used to specify global variables and <a href="https://cplusplus.com/doc/tutorial/preprocessor/">preprocessor directives</a> in the C++ code that mrgsolve constructs from the model specification file. This block is, not surprisingly, interpreted as literal C++ code. In this example I’ve used the <code>#define</code> directive to indicate that the plasma concentration <code>CP</code> is simply an alias for <code>(CENT / VP)</code>, and similarly the tissue<a href="#fn19" class="footnote-ref" id="fnref19" role="doc-noteref"><sup>19</sup></a> concentration <code>CT</code> is an alias for <code>(PERIPH / VP)</code>, and so on.</p></li>
<li><p>The <a href="https://mrgsolve.org/user-guide/specification.html#sec-block-ode"><code>[ODE]</code></a> block is used to specify the differential equations that define the model. For every compartment in your model there is a corresponding <code>dxdt_</code> variable: for instance, if <code>CENT</code> denotes the drug amount in the central compartment, then there is automatically a variable <code>dxdt_CENT</code> that denotes its first derivative with respect to time, and you must specify the value for <em>all</em> compartment derivatives even if they are zero. The <code>[ODE]</code> block is interpreted as literal C++ code, and you can declare and initialise new variables within the <code>[ODE]</code> block if you want to. Note that you may sometimes see a <code>[DES]</code> code block instead of an <code>[ODE]</code> block. They’re the same thing: <code>[DES]</code> is an alias for <code>[ODE]</code>.</p></li>
<li><p>The <a href="https://mrgsolve.org/user-guide/specification.html#sec-block-capture"><code>[CAPTURE]</code></a> block is used to indicate variables that should be “captured” in the simulation and returned to the user in R when <code>mrgsim()</code> is called. The user guide doesn’t say so explicitly, but from what I can tell the compartment amount variables are always captured, and you don’t need to list those here. The only things you need to specify here are the <em>other</em> quantities that you want the simulation to return. It supports the <code>@annotated</code> keyword, and I’ve used that here because honestly my sanity dissolves very quickly when trying to read model specification files that don’t use the annotations.</p></li>
</ul>
<p>Okay, now that I’ve written my model specification file let’s pivot back to my R session and use it to run a simulation:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb65"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a><span class="co"># define model, events, and times</span></span>
<span id="cb65-2"><a href="#cb65-2" aria-hidden="true" tabindex="-1"></a>mod    <span class="ot">&lt;-</span> <span class="fu">mread_file</span>(<span class="at">file =</span> <span class="st">"example1.cpp"</span>, <span class="at">quiet =</span> <span class="cn">TRUE</span>)</span>
<span id="cb65-3"><a href="#cb65-3" aria-hidden="true" tabindex="-1"></a>events <span class="ot">&lt;-</span> <span class="fu">ev_expand</span>(<span class="at">amt =</span> <span class="dv">10</span>, <span class="at">ii =</span> <span class="dv">24</span>, <span class="at">addl =</span> <span class="dv">19</span>)</span>
<span id="cb65-4"><a href="#cb65-4" aria-hidden="true" tabindex="-1"></a>times  <span class="ot">&lt;-</span> <span class="fu">tgrid</span>(<span class="at">start =</span> <span class="dv">0</span>, <span class="at">end =</span> <span class="dv">960</span>, <span class="at">delta =</span> <span class="fl">0.2</span>)</span>
<span id="cb65-5"><a href="#cb65-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-6"><a href="#cb65-6" aria-hidden="true" tabindex="-1"></a><span class="co"># run simulation and plot results</span></span>
<span id="cb65-7"><a href="#cb65-7" aria-hidden="true" tabindex="-1"></a>out <span class="ot">&lt;-</span> <span class="fu">mrgsim_d</span>(mod, <span class="at">data =</span> events, <span class="at">tgrid =</span> times)</span>
<span id="cb65-8"><a href="#cb65-8" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(out)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/unnamed-chunk-38-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Yes, that all seems to work nicely. No, I did not have any solid justification for choosing these parameters. It’s just a toy.</p>
</section>
<section id="example-2-two-compartment-population-pk-model" class="level3">
<h3 class="anchored" data-anchor-id="example-2-two-compartment-population-pk-model">Example 2: Two compartment population-PK model</h3>
<p>The simulation in the previous section is relatively simple. It’s a one compartment model, there are no random effects or covariates, and the simulation involves only a single subject. The nonlinear clearance aspect is a little fancy, since <a href="https://en.wikipedia.org/wiki/Michaelis%E2%80%93Menten_kinetics">Michaelis-Menten kinetics</a> aren’t entirely simple, but apart from that there’s not much going on in this model.</p>
<p>Time to add some complexity. This time around I’ll build a standard two compartment model with first-order absorption and first-order elimination, but I’ll now allow random effects on all model parameters. Conventionally,<a href="#fn20" class="footnote-ref" id="fnref20" role="doc-noteref"><sup>20</sup></a> the variables in a population-PK model follow a uniform convention, and this is very often mirrored in software and analysis code. I’m now familiar enough with PK modelling that I’ve internalised these conventions, but since the audience of my blog is wider, here are the key ones:</p>
<ul>
<li>Population typical values are denoted with thetas (<span class="math inline">\(\theta\)</span>, <span class="math inline">\(\boldsymbol\theta\)</span>, <span class="math inline">\(\boldsymbol\Theta\)</span>)<a href="#fn21" class="footnote-ref" id="fnref21" role="doc-noteref"><sup>21</sup></a></li>
<li>Population scale parameters are denoted with omegas (<span class="math inline">\(\omega\)</span>, <span class="math inline">\(\boldsymbol\omega\)</span>, <span class="math inline">\(\boldsymbol\Omega\)</span>)</li>
<li>Random effect terms are denoted with etas (<span class="math inline">\(\eta\)</span>, <span class="math inline">\(\boldsymbol\eta\)</span>)</li>
<li>Variability of the measurement is denoted with sigmas (<span class="math inline">\(\sigma\)</span>, <span class="math inline">\(\boldsymbol\sigma\)</span>, <span class="math inline">\(\boldsymbol\Sigma\)</span>)</li>
</ul>
<p>With that little refresher out of the way, let’s have a look at the model specification file:</p>
<div class="cell" data-file="example2.cpp">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>example2.cpp</strong></pre>
</div>
<div class="sourceCode cell-code" id="cb66"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb66-1"><a href="#cb66-1"></a><span class="op">[</span>PROB<span class="op">]</span></span>
<span id="cb66-2"><a href="#cb66-2"></a></span>
<span id="cb66-3"><a href="#cb66-3"></a>This is a population<span class="op">-</span>PK two<span class="op">-</span>compartment model<span class="op">.</span></span>
<span id="cb66-4"><a href="#cb66-4"></a></span>
<span id="cb66-5"><a href="#cb66-5"></a><span class="op">[</span>PARAM<span class="op">]</span> <span class="er">@</span>annotated</span>
<span id="cb66-6"><a href="#cb66-6"></a></span>
<span id="cb66-7"><a href="#cb66-7"></a>TVVC   <span class="op">:</span> <span class="dv">20</span>  <span class="op">:</span> Typical value <span class="cf">for</span> VC <span class="op">(</span>volume<span class="op">)</span></span>
<span id="cb66-8"><a href="#cb66-8"></a>TVVP   <span class="op">:</span> <span class="dv">10</span>  <span class="op">:</span> Typical value <span class="cf">for</span> VP <span class="op">(</span>volume<span class="op">)</span></span>
<span id="cb66-9"><a href="#cb66-9"></a>TVKA   <span class="op">:</span>  <span class="dv">1</span>  <span class="op">:</span> Typical value <span class="cf">for</span> KA <span class="op">(</span><span class="dv">1</span><span class="op">/</span>time<span class="op">)</span></span>
<span id="cb66-10"><a href="#cb66-10"></a>TVCL   <span class="op">:</span>  <span class="dv">1</span>  <span class="op">:</span> Typical value <span class="cf">for</span> CL <span class="op">(</span>volume<span class="op">/</span>time<span class="op">)</span></span>
<span id="cb66-11"><a href="#cb66-11"></a>TVQ    <span class="op">:</span>  <span class="dv">2</span>  <span class="op">:</span> Typical value <span class="cf">for</span> Q <span class="op">(</span>volume<span class="op">/</span>time<span class="op">)</span></span>
<span id="cb66-12"><a href="#cb66-12"></a></span>
<span id="cb66-13"><a href="#cb66-13"></a><span class="op">[</span>OMEGA<span class="op">]</span> <span class="er">@</span>annotated</span>
<span id="cb66-14"><a href="#cb66-14"></a></span>
<span id="cb66-15"><a href="#cb66-15"></a>EVC   <span class="op">:</span>   <span class="dv">2</span> <span class="op">:</span> Variance of random effect on VC</span>
<span id="cb66-16"><a href="#cb66-16"></a>EVP   <span class="op">:</span>   <span class="dv">1</span> <span class="op">:</span> Variance of random effect on VP</span>
<span id="cb66-17"><a href="#cb66-17"></a>EKA   <span class="op">:</span> <span class="fl">0.1</span> <span class="op">:</span> Variance of random effect on KA</span>
<span id="cb66-18"><a href="#cb66-18"></a>ECL   <span class="op">:</span> <span class="fl">0.1</span> <span class="op">:</span> Variance of random effect on CL</span>
<span id="cb66-19"><a href="#cb66-19"></a>EQ    <span class="op">:</span> <span class="fl">0.1</span> <span class="op">:</span> Variance of random effect on Q</span>
<span id="cb66-20"><a href="#cb66-20"></a></span>
<span id="cb66-21"><a href="#cb66-21"></a><span class="op">[</span>MAIN<span class="op">]</span></span>
<span id="cb66-22"><a href="#cb66-22"></a></span>
<span id="cb66-23"><a href="#cb66-23"></a><span class="dt">double</span> VC <span class="op">=</span> TVVC <span class="op">*</span> exp<span class="op">(</span>EVC<span class="op">);</span> <span class="co">// central compartment volume</span></span>
<span id="cb66-24"><a href="#cb66-24"></a><span class="dt">double</span> VP <span class="op">=</span> TVVP <span class="op">*</span> exp<span class="op">(</span>EVP<span class="op">);</span> <span class="co">// peripheral compartment volume</span></span>
<span id="cb66-25"><a href="#cb66-25"></a><span class="dt">double</span> KA <span class="op">=</span> TVKA <span class="op">*</span> exp<span class="op">(</span>EKA<span class="op">);</span> <span class="co">// absorption rate constant</span></span>
<span id="cb66-26"><a href="#cb66-26"></a><span class="dt">double</span> CL <span class="op">=</span> TVCL <span class="op">*</span> exp<span class="op">(</span>ECL<span class="op">);</span> <span class="co">// clearance</span></span>
<span id="cb66-27"><a href="#cb66-27"></a><span class="dt">double</span> Q  <span class="op">=</span> TVQ  <span class="op">*</span> exp<span class="op">(</span>EQ<span class="op">);</span>  <span class="co">// intercompartmental clearance</span></span>
<span id="cb66-28"><a href="#cb66-28"></a></span>
<span id="cb66-29"><a href="#cb66-29"></a><span class="op">[</span>CMT<span class="op">]</span> <span class="er">@</span>annotated</span>
<span id="cb66-30"><a href="#cb66-30"></a></span>
<span id="cb66-31"><a href="#cb66-31"></a>GUT    <span class="op">:</span> Drug amount in gut <span class="op">(</span>mass<span class="op">)</span></span>
<span id="cb66-32"><a href="#cb66-32"></a>CENT   <span class="op">:</span> Drug amount in central compartment <span class="op">(</span>mass<span class="op">)</span></span>
<span id="cb66-33"><a href="#cb66-33"></a>PERIPH <span class="op">:</span> Drug amount in peripherhal compartment <span class="op">(</span>mass<span class="op">)</span></span>
<span id="cb66-34"><a href="#cb66-34"></a></span>
<span id="cb66-35"><a href="#cb66-35"></a><span class="op">[</span>GLOBAL<span class="op">]</span></span>
<span id="cb66-36"><a href="#cb66-36"></a></span>
<span id="cb66-37"><a href="#cb66-37"></a><span class="pp">#define CP </span><span class="op">(</span>CENT<span class="pp"> </span><span class="op">/</span><span class="pp"> </span>VC<span class="op">)</span><span class="pp">   </span><span class="co">// concentration in central compartment</span></span>
<span id="cb66-38"><a href="#cb66-38"></a><span class="pp">#define CT </span><span class="op">(</span>PERIPH<span class="pp"> </span><span class="op">/</span><span class="pp"> </span>VP<span class="op">)</span><span class="pp"> </span><span class="co">// concentration in peripheral compartment</span></span>
<span id="cb66-39"><a href="#cb66-39"></a></span>
<span id="cb66-40"><a href="#cb66-40"></a><span class="op">[</span>ODE<span class="op">]</span></span>
<span id="cb66-41"><a href="#cb66-41"></a></span>
<span id="cb66-42"><a href="#cb66-42"></a>dxdt_GUT    <span class="op">=</span> <span class="op">-(</span>KA <span class="op">*</span> GUT<span class="op">);</span></span>
<span id="cb66-43"><a href="#cb66-43"></a>dxdt_CENT   <span class="op">=</span>  <span class="op">(</span>KA <span class="op">*</span> GUT<span class="op">)</span> <span class="op">-</span> <span class="op">(</span>CL <span class="op">+</span> Q<span class="op">)</span> <span class="op">*</span> CP <span class="op">+</span> <span class="op">(</span>Q <span class="op">*</span> CT<span class="op">);</span></span>
<span id="cb66-44"><a href="#cb66-44"></a>dxdt_PERIPH <span class="op">=</span>  <span class="op">(</span>Q <span class="op">*</span> CP<span class="op">)</span> <span class="op">-</span> <span class="op">(</span>Q <span class="op">*</span> CT<span class="op">);</span></span>
<span id="cb66-45"><a href="#cb66-45"></a></span>
<span id="cb66-46"><a href="#cb66-46"></a><span class="op">[</span>CAPTURE<span class="op">]</span> <span class="er">@</span>annotated</span>
<span id="cb66-47"><a href="#cb66-47"></a></span>
<span id="cb66-48"><a href="#cb66-48"></a>CP <span class="op">:</span> Plasma concentration <span class="op">(</span>mass<span class="op">/</span>time<span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<p>Things to notice here:</p>
<ul>
<li><p>The <code>[PARAM]</code> block is essentially the same as last time. The only difference is that I’ve now given all the variables a “TV” prefix, to indicate that they now refer to the population typical value for the corresponding quantity (e.g., <code>TVCL</code> is the typical value for clearance <code>CL</code>). I would have preferred a different naming scheme, personally, but since this approach is pretty standard in the field I’ll adhere to it. In any case, these “typical value” variables collectively form the <span class="math inline">\(\boldsymbol\theta\)</span> vector of fixed effects in the model.</p></li>
<li><p>The purpose of the <a href="https://mrgsolve.org/user-guide/specification.html#sec-block-omega"><code>[OMEGA]</code></a> block to specify a variance-covariance matrix <span class="math inline">\(\boldsymbol\Omega\)</span>, such that the vector of random effects <span class="math inline">\(\boldsymbol\eta_i\)</span> for the <span class="math inline">\(i\)</span>-th simulated person is sampled from a multivariate normal distribution, <span class="math inline">\(\boldsymbol\eta_i \sim \mbox{Normal}(\boldsymbol{0}, \boldsymbol\Omega)\)</span>. By default, mrgsolve assumes that <span class="math inline">\(\boldsymbol\Omega\)</span> is a diagonal matrix, so all you need to do is specify the vector of variances along the main diagonal.<a href="#fn22" class="footnote-ref" id="fnref22" role="doc-noteref"><sup>22</sup></a> The <code>[OMEGA]</code> block supports the <code>@annotated</code> option, which I’ve used here to provide human-readable explanations of each of the terms. Note that the variable names I’ve used here are things like <code>ECL</code>, <code>EVP</code>, and so on: the “E” prefix is short for “ETA” and indicates that they refer to the value of the sampled random effect term (i.e., an <span class="math inline">\(\eta\)</span> value), not the variance itself (i.e., an <span class="math inline">\(\omega\)</span> value). In that sense I find it helpful to think of the <code>[OMEGA]</code> block as specifying the sampling scheme for the random effect terms, rather than literally a covariance matrix.</p></li>
<li><p>The <a href="https://mrgsolve.org/user-guide/specification.html#sec-block-main"><code>[MAIN]</code></a> block, as you might expect given the name, is interpreted with C++ syntax.<a href="#fn23" class="footnote-ref" id="fnref23" role="doc-noteref"><sup>23</sup></a> It serves multiple purposes, but what I’m using it for here is specifying relationships between variables. For instance, the code on line 26 defines the clearance <code>CL</code> for a specific subject as the product of the population typical value <code>TVCL</code> and the exponentiated random effect <code>exp(ECL)</code>.<a href="#fn24" class="footnote-ref" id="fnref24" role="doc-noteref"><sup>24</sup></a></p></li>
<li><p>The <code>[CMT]</code>, <code>[GLOBAL]</code>, <code>[ODE]</code>, and <code>[CAPTURE]</code> blocks are all more or less as they were before. The code is a little different because the model is different, but there’s no new concepts required to read these blocks.</p></li>
</ul>
<p>Now that we’ve talked through the code, let’s go back to R and run a simulation using this model. In the extract below I’ve run a small simulation with six individuals. They all have the same dosing schedule, but we end up with different data in each case because the model samples the random effect terms separately for each person:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb67"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a><span class="co"># define model, events, and times</span></span>
<span id="cb67-2"><a href="#cb67-2" aria-hidden="true" tabindex="-1"></a>mod    <span class="ot">&lt;-</span> <span class="fu">mread_file</span>(<span class="at">file =</span> <span class="st">"example2.cpp"</span>, <span class="at">quiet =</span> <span class="cn">TRUE</span>)</span>
<span id="cb67-3"><a href="#cb67-3" aria-hidden="true" tabindex="-1"></a>events <span class="ot">&lt;-</span> <span class="fu">ev_expand</span>(<span class="at">amt =</span> <span class="dv">10</span>, <span class="at">ii =</span> <span class="dv">24</span>, <span class="at">addl =</span> <span class="dv">11</span>, <span class="at">ID =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">6</span>)</span>
<span id="cb67-4"><a href="#cb67-4" aria-hidden="true" tabindex="-1"></a>times  <span class="ot">&lt;-</span> <span class="fu">tgrid</span>(<span class="at">start =</span> <span class="dv">0</span>, <span class="at">end =</span> <span class="dv">480</span>, <span class="at">delta =</span> <span class="fl">0.1</span>)</span>
<span id="cb67-5"><a href="#cb67-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-6"><a href="#cb67-6" aria-hidden="true" tabindex="-1"></a><span class="co"># run simulation and plot results</span></span>
<span id="cb67-7"><a href="#cb67-7" aria-hidden="true" tabindex="-1"></a>out <span class="ot">&lt;-</span> <span class="fu">mrgsim_d</span>(mod, <span class="at">data =</span> events, <span class="at">tgrid =</span> times)</span>
<span id="cb67-8"><a href="#cb67-8" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(out)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/unnamed-chunk-40-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>As before, I haven’t tried to choose model parameters in the principled way: I just wanted to make sure the code is functioning properly.</p>
</section>
<section id="example-3-other-customisations" class="level3">
<h3 class="anchored" data-anchor-id="example-3-other-customisations">Example 3: Other customisations</h3>
<p>I’ll go through one last example, just to illustrate some of the other things you can build into your model specification file. The code below specifies a one-compartment population-PK model, and it incorporates a few features that haven’t appeared in any of the examples so far. First, the code:</p>
<div class="cell" data-file="example3.cpp">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>example3.cpp</strong></pre>
</div>
<div class="sourceCode cell-code" id="cb68"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb68-1"><a href="#cb68-1"></a><span class="op">[</span>PROB<span class="op">]</span></span>
<span id="cb68-2"><a href="#cb68-2"></a></span>
<span id="cb68-3"><a href="#cb68-3"></a>This is an example adapted from the user guide <span class="st">"topics"</span> section<span class="op">.</span></span>
<span id="cb68-4"><a href="#cb68-4"></a></span>
<span id="cb68-5"><a href="#cb68-5"></a><span class="op">[</span>PARAM<span class="op">]</span> <span class="er">@</span>annotated</span>
<span id="cb68-6"><a href="#cb68-6"></a></span>
<span id="cb68-7"><a href="#cb68-7"></a>TVCL <span class="op">:</span> <span class="fl">1.1</span>   <span class="op">:</span> Typical clearance <span class="op">(</span>L<span class="op">/</span>hr<span class="op">)</span></span>
<span id="cb68-8"><a href="#cb68-8"></a>TVV  <span class="op">:</span> <span class="fl">35.6</span>  <span class="op">:</span> Typical volume of distribution <span class="op">(</span>L<span class="op">)</span></span>
<span id="cb68-9"><a href="#cb68-9"></a>TVKA <span class="op">:</span> <span class="fl">1.35</span>  <span class="op">:</span> Typical absorption rate constant <span class="op">(</span><span class="dv">1</span><span class="op">/</span>hr<span class="op">)</span></span>
<span id="cb68-10"><a href="#cb68-10"></a>WT   <span class="op">:</span> <span class="dv">70</span>    <span class="op">:</span> Weight <span class="op">(</span>kg<span class="op">)</span></span>
<span id="cb68-11"><a href="#cb68-11"></a>SEX  <span class="op">:</span> <span class="dv">0</span>     <span class="op">:</span> Sex coded as male <span class="op">=</span> <span class="dv">0</span><span class="op">,</span> female <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb68-12"><a href="#cb68-12"></a>WTCL <span class="op">:</span> <span class="fl">0.75</span>  <span class="op">:</span> Coefficient <span class="cf">for</span> the effect of weight on CL</span>
<span id="cb68-13"><a href="#cb68-13"></a>SEXV <span class="op">:</span> <span class="fl">0.878</span> <span class="op">:</span> Coefficient <span class="cf">for</span> the effect of sex <span class="op">=</span> <span class="dv">1</span> on V</span>
<span id="cb68-14"><a href="#cb68-14"></a></span>
<span id="cb68-15"><a href="#cb68-15"></a><span class="op">[</span>MAIN<span class="op">]</span></span>
<span id="cb68-16"><a href="#cb68-16"></a></span>
<span id="cb68-17"><a href="#cb68-17"></a><span class="dt">double</span> CL <span class="op">=</span> TVCL <span class="op">*</span> pow<span class="op">(</span>WT<span class="op">/</span><span class="dv">70</span><span class="op">,</span> WTCL<span class="op">)</span> <span class="op">*</span> exp<span class="op">(</span>ECL<span class="op">);</span></span>
<span id="cb68-18"><a href="#cb68-18"></a><span class="dt">double</span> V  <span class="op">=</span> TVV  <span class="op">*</span> pow<span class="op">(</span>SEXV<span class="op">,</span> SEX<span class="op">)</span> <span class="op">*</span> exp<span class="op">(</span>EV<span class="op">);</span></span>
<span id="cb68-19"><a href="#cb68-19"></a><span class="dt">double</span> KA <span class="op">=</span> TVKA <span class="op">*</span> exp<span class="op">(</span>EKA<span class="op">);</span></span>
<span id="cb68-20"><a href="#cb68-20"></a></span>
<span id="cb68-21"><a href="#cb68-21"></a><span class="op">[</span>OMEGA<span class="op">]</span> <span class="er">@</span>correlation <span class="er">@</span>block <span class="er">@</span>annotated</span>
<span id="cb68-22"><a href="#cb68-22"></a></span>
<span id="cb68-23"><a href="#cb68-23"></a>ECL <span class="op">:</span> <span class="fl">1.23</span>          <span class="op">:</span> Random effect on CL</span>
<span id="cb68-24"><a href="#cb68-24"></a>EV  <span class="op">:</span> <span class="fl">0.67</span> <span class="fl">0.4</span>      <span class="op">:</span> Random effect on V</span>
<span id="cb68-25"><a href="#cb68-25"></a>EKA <span class="op">:</span> <span class="fl">0.25</span> <span class="fl">0.87</span> <span class="fl">0.2</span> <span class="op">:</span> Random effect on KA</span>
<span id="cb68-26"><a href="#cb68-26"></a></span>
<span id="cb68-27"><a href="#cb68-27"></a><span class="op">[</span>SIGMA<span class="op">]</span> <span class="er">@</span>annotated</span>
<span id="cb68-28"><a href="#cb68-28"></a></span>
<span id="cb68-29"><a href="#cb68-29"></a>PROP<span class="op">:</span> <span class="fl">0.005</span>  <span class="op">:</span> Proportional residual error</span>
<span id="cb68-30"><a href="#cb68-30"></a>ADD <span class="op">:</span> <span class="fl">0.0001</span> <span class="op">:</span> Additive residual error</span>
<span id="cb68-31"><a href="#cb68-31"></a></span>
<span id="cb68-32"><a href="#cb68-32"></a><span class="op">[</span>CMT<span class="op">]</span> <span class="er">@</span>annotated</span>
<span id="cb68-33"><a href="#cb68-33"></a></span>
<span id="cb68-34"><a href="#cb68-34"></a>GUT  <span class="op">:</span> Dosing compartment <span class="op">(</span>mg<span class="op">)</span></span>
<span id="cb68-35"><a href="#cb68-35"></a>CENT <span class="op">:</span> Central compartment <span class="op">(</span>mg<span class="op">)</span></span>
<span id="cb68-36"><a href="#cb68-36"></a></span>
<span id="cb68-37"><a href="#cb68-37"></a><span class="op">[</span>PKMODEL<span class="op">]</span></span>
<span id="cb68-38"><a href="#cb68-38"></a></span>
<span id="cb68-39"><a href="#cb68-39"></a>ncmt <span class="op">=</span> <span class="dv">1</span><span class="op">,</span> depot <span class="op">=</span> TRUE</span>
<span id="cb68-40"><a href="#cb68-40"></a></span>
<span id="cb68-41"><a href="#cb68-41"></a><span class="op">[</span>TABLE<span class="op">]</span></span>
<span id="cb68-42"><a href="#cb68-42"></a></span>
<span id="cb68-43"><a href="#cb68-43"></a><span class="dt">double</span> CP <span class="op">=</span> CENT <span class="op">/</span> V<span class="op">;</span></span>
<span id="cb68-44"><a href="#cb68-44"></a><span class="dt">double</span> DV <span class="op">=</span> CP <span class="op">*</span> <span class="op">(</span><span class="dv">1</span> <span class="op">+</span> PROP<span class="op">)</span> <span class="op">+</span> ADD<span class="op">;</span></span>
<span id="cb68-45"><a href="#cb68-45"></a></span>
<span id="cb68-46"><a href="#cb68-46"></a><span class="op">[</span>CAPTURE<span class="op">]</span> <span class="er">@</span>annotated</span>
<span id="cb68-47"><a href="#cb68-47"></a></span>
<span id="cb68-48"><a href="#cb68-48"></a>CP <span class="op">:</span> True plasma concentration <span class="op">(</span>mg<span class="op">/</span>L<span class="op">)</span></span>
<span id="cb68-49"><a href="#cb68-49"></a>DV <span class="op">:</span> Observed plasma concentration <span class="op">(</span>mg<span class="op">/</span>L<span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<p>There’s a few things to note here.</p>
<ul>
<li><p>There is a binary-valued covariate <code>SEX</code><a href="#fn25" class="footnote-ref" id="fnref25" role="doc-noteref"><sup>25</sup></a> and a continuous covariate <code>WT</code> (weight) specified in the <code>[PARAM]</code> block. Coefficients specifying the effect of sex on distribution volume <code>SEXV</code> and the effect of weight on clearance <code>WTCL</code> are also included in the <code>[PARAM]</code> block. Although from a statistical perspective the value of the covariate that varies across person (<code>WT</code>) and the regression coefficient specifying an effect <code>WTCL</code> are very different kinds of thing, from a simulation perspective they’re both just numbers you can feed into the expressions in the <code>[MAIN]</code> block that define the pharmacokinetic quantities <code>CL</code>, <code>V</code>, and <code>KA</code>.</p></li>
<li><p>The <code>[OMEGA]</code> block now has correlated random effects. I’ve used the <code>@block</code> option to indicate that the off-diagonal elements are included in the code block, and the <code>@correlation</code> option to indicate that the off-diagonal elements are correlations (rather than covariances).</p></li>
<li><p>We now have sources of measurement error included in the model specification. The scale of the noise terms is set in the <a href="https://mrgsolve.org/user-guide/specification.html#sec-block-sigma"><code>[SIGMA]</code></a> code block, and for this model we include both proportional error (variability scales proportional to the true value) and additive error (constant variability of error). Note that the <code>[SIGMA]</code> block is used only to declare the variables and set their values. To actually incorporate the measurement error into the model code, we use the <code>[TABLE]</code> block.</p></li>
<li><p>The <a href="https://mrgsolve.org/user-guide/specification.html#sec-block-table"><code>[TABLE]</code></a> block contains C++ code that is executed at the end of each time step, before the simulation steps forward to the next point in time. At this point the drug amounts in each compartment have been computed, as have any time-point dependent stochastic terms (i.e., the noise terms specified in the <code>[SIGMA]</code> block), and we can use them to calculate other quantities. In this case, I’ve used the <code>[TABLE]</code> block to calculate the blood plasma concentration <code>CP</code>, and to calculate a hypothetical dependent variable <code>DV</code> that has noise added.</p></li>
<li><p>The <code>[ODE]</code> block has been replaced with a <a href="https://mrgsolve.org/user-guide/specification.html#pkmodel"><code>[PKMODEL]</code></a> block. This is used to indicate that mrgsolve should use analytic solutions rather than an ODE solver. As you might expect, this is only possible for a smallish subset of models that (a) have analytic solutions that (b) are known to mrgsolve. In this particular case the model is a standard one-compartment model, for which analytic solutions are available. The <code>ncmt = 1</code> part of this block indicates that it’s a one-compartment model, and the <code>depot = TRUE</code> part indicates that the dosing compartment (the gut, in this case) should be included in the model even though it’s not a “real” compartment. Additional information on how this code block is parsed is <a href="https://mrgsolve.org/docs/reference/PKMODEL.html">here</a>.</p></li>
</ul>
<p>To see all this at work, let’s run a small simulation. First, we’ll read the model specification file and compile the model:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb69"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a>mod <span class="ot">&lt;-</span> <span class="fu">mread_file</span>(<span class="at">file =</span> <span class="st">"example3.cpp"</span>, <span class="at">quiet =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Next, let’s take a look at the default parameters in this model. As you can see in the output, by default the subject is presumed to be a male who weighs 70kg:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb70"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a><span class="fu">param</span>(mod)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
 Model parameters (N=7):
 name value . name value
 SEX  0     | TVV  35.6 
 SEXV 0.878 | WT   70   
 TVCL 1.1   | WTCL 0.75 
 TVKA 1.35  | .    .    </code></pre>
</div>
</div>
<p>As usual, we’ll specify some dosing events and some time points at which the simulation will be evaluated. I’ll also set it up that we always simulate two subjects at whatever parameter values we feed into the simulation:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb72"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb72-1"><a href="#cb72-1" aria-hidden="true" tabindex="-1"></a>events <span class="ot">&lt;-</span> <span class="fu">ev_expand</span>(<span class="at">amt =</span> <span class="dv">10</span>, <span class="at">ii =</span> <span class="dv">48</span>, <span class="at">addl =</span> <span class="dv">3</span>, <span class="at">ID =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>)</span>
<span id="cb72-2"><a href="#cb72-2" aria-hidden="true" tabindex="-1"></a>times  <span class="ot">&lt;-</span> <span class="fu">tgrid</span>(<span class="at">start =</span> <span class="dv">0</span>, <span class="at">end =</span> <span class="dv">240</span>, <span class="at">delta =</span> <span class="fl">0.5</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Okay, now let’s run a simulation at the default parameter values. Here’s some data from two male subjects who both weigh 70kg:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb73"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a>out <span class="ot">&lt;-</span> <span class="fu">mrgsim_d</span>(mod, <span class="at">data =</span> events, <span class="at">tgrid =</span> times)</span>
<span id="cb73-2"><a href="#cb73-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(out, <span class="sc">~</span> CP <span class="sc">+</span> DV)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/unnamed-chunk-45-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>The <code>~ CP + DV</code> formula in the <code>plot()</code> command is used to control which variables are plotted. I don’t want to show everything in these plots: we’re showing the drug concentration in the central compartment <code>CP</code>, and the hypothetical dependent variable <code>DV</code> obtained by adding measurement error to the <code>CP</code> value.</p>
<p>But suppose we didn’t actually want to simulate a 70kg male, and instead we want a 60kg female. To specify this, we have to update the relevant parameters in the model:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb74"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb74-1"><a href="#cb74-1" aria-hidden="true" tabindex="-1"></a>mod <span class="ot">&lt;-</span> <span class="fu">param</span>(mod, <span class="at">SEX =</span> <span class="dv">1</span>, <span class="at">WT =</span> <span class="dv">60</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>So now our model parameters look like this:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb75"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb75-1"><a href="#cb75-1" aria-hidden="true" tabindex="-1"></a><span class="fu">param</span>(mod)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
 Model parameters (N=7):
 name value . name value
 SEX  1     | TVV  35.6 
 SEXV 0.878 | WT   60   
 TVCL 1.1   | WTCL 0.75 
 TVKA 1.35  | .    .    </code></pre>
</div>
</div>
<p>Simulating from the model at these parameter settings gives us this:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb77"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb77-1"><a href="#cb77-1" aria-hidden="true" tabindex="-1"></a>out <span class="ot">&lt;-</span> <span class="fu">mrgsim_d</span>(mod, <span class="at">data =</span> events, <span class="at">tgrid =</span> times)</span>
<span id="cb77-2"><a href="#cb77-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(out, <span class="sc">~</span> CP <span class="sc">+</span> DV)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/unnamed-chunk-48-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</section>
</section>
<section id="resources" class="level2">
<h2 class="anchored" data-anchor-id="resources">Resources</h2>
<p>Before wrapping up, some quick links to some resources:</p>
<ul>
<li><p>The <a href="https://mrgsolve.org/user-guide/">mrgsolve user guide</a> is probably not the place you want to start, because it very quickly dives in deep and talks about the domain specific language used to specify models, but once you’ve wrapped your head around the basics that’s the place to look for details.</p></li>
<li><p>The <a href="https://mrgsolve.org/vignettes/">mrgsolve vignettes</a> provide a nice place to start, but one thing you need to keep in mind is that the vignettes posted at <a href="https://mrgsolve.org/vignettes/">mrgsolve.org/vignettes</a> are not identical to the vignettes that appear on the pkgdown website (i.e., <a href="https://mrgsolve.org/docs/articles/">mrgsolve.org/docs/articles</a>), so it’s worth being careful to check which one you’re looking at!</p></li>
<li><p>Speaking of which, the <a href="https://mrgsolve.org/docs/">mrgsolve pkgdown site</a> provides all the usual documentation that you’d expect of an R package in the usual format. Function reference guides, some vignettes, links to github, etc., all that is there.</p></li>
<li><p>The <a href="https://mrgsolve.org/learn.html">learn mrgsolve</a> page on the mrgsolve website has links to presentations, courses, and other things that can be helpful in getting started.</p></li>
<li><p>Finally, there’s a <a href="https://mrgsolve.org/blog/">blog</a> associated with the package that has a variety of tips, tricks, updates and news.</p></li>
</ul>
</section>
<section id="epilogue" class="level2">
<h2 class="anchored" data-anchor-id="epilogue">Epilogue</h2>
<p>As with so many of my posts, I find that I’ve gotten to the end and I have no idea what else to say. I don’t write a post like this one to advocate for a package or a workflow, and I definitely don’t write these things to express opinions or whatever. I write because I enjoy writing and because the act of writing deepens my own understanding of a topic. Viewed from that perspective, writing this post has served its purpose so… mission accomplished?</p>


</section>


<div id="quarto-appendix" class="default"><section id="footnotes" class="footnotes footnotes-end-of-document" role="doc-endnotes"><h2 class="anchored quarto-appendix-heading">Footnotes</h2>

<ol>
<li id="fn1"><p>In this respect R is the unchallenged queen of languages in pharmacometrics. It’s very different to data science in the tech space, where Python is the lingua franca and R is seen as a second-class citizen. I have not yet seen a single example of anyone using Python for data analysis in this world. Judging from papers I’ve read, Julia has a small presence (e.g., you can use <a href="https://turing.ml/">Turing.jl</a> for building ODE models in Julia), but that’s the only time I’ve ever seen any statistical language other than R in this space.<a href="#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn2"><p>The acronym PK is universally used as shorthand for “pharmacokinetics”, and a PK model is one where the primary variable you’re interested in modelling is the plasma concentration over time for some drug. If you’re totally new to this space, the post I wrote on <a href="../../posts/2023-04-26_non-compartmental-analysis/">non-compartmental analysis</a> was written from a total-newbie perspective and spells out a lot the basic terminology used in PK modelling.<a href="#fnref2" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn3"><p>There are a <em>lot</em> of tools in this space: NONMEM is the oldest and most-widely used, but in addition there’s Stan/Torsten, Monolix, nlmixr, Phoenix NLME, and probably many others I don’t know about yet…<a href="#fnref3" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn4"><p>I can’t tell if the original package is still under active development or if it’s been deprecated. The <a href="https://nlmixrdevelopment.github.io/RxODE/">RxODE</a> package still appears on the nlmixr website and on GitHub, but the package is (at present?) archived on CRAN.<a href="#fnref4" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn5"><p>Specifically, it wraps the public domain Fortran library <a href="https://computing.llnl.gov/projects/odepack">ODEPACK</a>.<a href="#fnref5" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn6"><p>In this example it’s not very interesting because CP is just the ratio of CENT and V, and since V doesn’t change over time, the curves for CP and CENT look identical. That isn’t true for simulations with multiple sujects, however, since V can and does vary across individuals.<a href="#fnref6" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn7"><p>As an aside, one thing I’ve noticed in the software development world is that developers who don’t work in statistics have a tendency to get very worked up about R having all these hyper-flexible functions that can behave in wildly different ways in different contexts. While I do understand that annoyance, I also think it’s often misplaced. R is fundamentally a <em>statistical programming language</em> and the primary goal is to support analysts. It’s not trying to be Python, and it’s even less interested in being Rust. You wouldn’t think so from social media discussions – which are massively skewed towards developers – but the typical R user is someone working interactively at the console, constructing a script iteratively as they explore and work with the data set they’ve been tasked to analyse. In that context, the hyper-flexibility of a lot of R functions is designed for the convenience of the analyst, not the convenience as a developer.<a href="#fnref7" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn8"><p>Developers reading this are probably wondering where the model shared object ends up when compilation happens. By default <code>mread()</code> puts the compiled model in the R temp folder, but you can override this in a persistent way by setting the <code>"mrgsolve.soloc"</code> option, or overriding it in the call to <code>mread()</code> via the <code>soloc</code> argument. You can also suppress compilation if you want by setting <code>compile = FALSE</code>. But probably any devs reading this would likely discover that within 5 minutes of reading the documentation anyway so there’s no real need for me to mention it.<a href="#fnref8" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn9"><p>I mean… of the <em>widely-used</em> OOP systems, it’s the one I’m least comfortable with. The wild abandon with which R spawns new object oriented programming systems is… a lot to keep up with.<a href="#fnref9" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn10"><p>Why yes, this blog post is <em>also</em> an exercise in “Danielle reminds herself how S4 works and no she bloody well is not going to talk about multiple inheritance and multiple dispatch in S4 here she’s not that much of a masochist”.<a href="#fnref10" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn11"><p>As an aside, <code>param(mod)</code> returns an S4 object of class “parameter_list” which in turn has a <code>show()</code> method that provides that prettified looking table pf parameters, but from a practical perspective you might just want to coerce it to a regular list using <code>as.list(param(mod))</code>.<a href="#fnref11" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn12"><p>There is also an <code>as.ev()</code> function that allows conversion in the other direction.<a href="#fnref12" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn13"><p>More precisely, method dispatch takes place off the <code>x</code> argument which is the first argument to the <code>ev()</code> generic, but since we’re talking about pipelines here, the name isn’t as important as the position.<a href="#fnref13" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn14"><p>As a rule I don’t dislike “magic” code. I mean… it would be weird to be an R user and not appreciate its virtues. Lazy evaluation and non-standard evaluation in R are powerful tools, and are the basis of a lot of “magic” in R. They make life a lot easier for the analyst but it comes at the price of making life harder for the developer. Because of that I’ve ended up with a habit of trying to dig into the details every time I find R code that feels magical.<a href="#fnref14" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn15"><p>To be precise, <code>ev()</code> is an S4 generic with dispatch on the <code>x</code> argument. If <code>x</code> is missing, the relevant <code>ev()</code> method returns an “ev” object. However, if <code>x</code> has class “mrgmod”, the relevant method returns another “mrgmod” object. I’ll confess this makes me a little uneasy.<a href="#fnref15" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn16"><p>Oh look, that apparently-irrelevant excursion she did talking about the mrgmod object slots turns out to be relevant! It’s almost as if she’s written things before!<a href="#fnref16" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn17"><p>I’m guessing that the logic here is that, even though some code blocks use R syntax, and others aren’t interpreted as code at all, the model build process is such that eventually it all becomes C++, and a C++ compiler constructs the binary. There’s logic to it, but it does feel a bit disorienting seeing “.cpp” files that aren’t actually C++ source.<a href="#fnref17" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn18"><p>I suspect that the <code>$BLOCKNAME</code> format is actually canonical because that’s the version you see when model code is printed when calling <code>see()</code>, but I’m going to use <code>[BLOCKNAME]</code> throughout this post because I personally find it easier to read. <a href="https://dictionary.cambridge.org/dictionary/english/ymmv">YMMV</a>.<a href="#fnref18" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn19"><p>Confession: I’m not 100% certain that the “T” in “CT” stands for tissue, since I copied this line from one of the models in the mrgsolve model library, but I think it’s the right interpretation given that the central compartment amount is usually intended to refer to “amount of drug the blood, sort of” and the peripheral compartment is “amount of drug in body tissues, sort of”. The “sort of” is important though: pharamacokinetic compartments are abstractions, and are they only loosely related to the corresponding physiology.<a href="#fnref19" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn20"><p>As far as I can tell, most of these conventions are “for compatibility with NONMEM”, and I am very rapidly starting to read “for compatibility with NONMEM” with exactly the same level of jaundiced cynicism that I apply when I find base R documentation that explains that R does something absolutely unhinged “for compatibility with S”. I deeply admire the commitment to backward compatibility and/or notational consistency, but also oh sweet lord in heaven it is <strong>EXHAUSTING</strong>.<a href="#fnref20" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn21"><p>In the spirit of stating assumptions, I’ll also add this. As is typical in many (but not all) disciplines: italicised lower case denotes a scalar, bold italic lower case denotes a vector, bold upper case denotes a matrix.<a href="#fnref21" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn22"><p>I’m not going to discuss them here, but note that the <code>@block</code> option allows you to pass a complete variance-covariance matrix, and the <code>@correlation</code> option allows you to specify correlations instead of covariances on the off-diagonals. The user guide discusses these and several other options that are supported in the <code>[OMEGA]</code> block. Of particular note: there’s a section in the user guide on <code>[OMEGA]</code> shows you how to use <code>@block</code> and <code>@annotated</code> together.<a href="#fnref22" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn23"><p>The <code>[MAIN]</code> block is analogous to the NONMEM <code>$PK</code> block, and indeed <code>[PK]</code> is allowed as an alias for <code>[MAIN]</code> in mrgsolve model specification files.<a href="#fnref23" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn24"><p>For folks used to linear regression models and random effect terms that compose additively with the fixed effect, it’s worth noting that in PK models everything tends to be log-linear. For any particular PK quantity <span class="math inline">\(x\)</span>, the relationship takes the form <span class="math inline">\(\log x = \eta_x + \log \theta_x\)</span>.<a href="#fnref24" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn25"><p>I am absolutely <strong>not</strong> going to enter into any discussion of the respects in which sex is not strictly a binary variable, not in this post. There is a time and a place for that conversation, and this is neither that time nor that place. I mean, we’re talking about a category of statistical models that simplify the entire human body into “a couple of leaky buckets and a tinfoil ODE system”. They are extremely <strong>useful</strong> models, per George Box’s famous aphorism, but one does not ever presume they are biologically accurate. That would be absurd.<a href="#fnref25" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
</ol>
</section><section class="quarto-appendix-contents"><h2 class="anchored quarto-appendix-heading">Reuse</h2><div id="quarto-reuse" class="quarto-appendix-contents"><div><a rel="license" href="https://creativecommons.org/licenses/by/4.0/">https://creativecommons.org/licenses/by/4.0/</a></div></div></section><section class="quarto-appendix-contents"><h2 class="anchored quarto-appendix-heading">Citation</h2><div><div class="quarto-appendix-secondary-label">BibTeX citation:</div><pre class="sourceCode code-with-copy quarto-appendix-bibtex"><code class="sourceCode bibtex">@online{navarro2023,
  author = {Navarro, Danielle},
  title = {Pharmacometric Simulation with Mrgsolve},
  date = {2023-08-14},
  url = {https://blog.djnavarro.net/posts/2023-08-14_mrgsolve},
  langid = {en}
}
</code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre><div class="quarto-appendix-secondary-label">For attribution, please cite this work as:</div><div id="ref-navarro2023" class="csl-entry quarto-appendix-citeas" role="listitem">
Navarro, Danielle. 2023. <span>“Pharmacometric Simulation with
Mrgsolve.”</span> August 14, 2023. <a href="https://blog.djnavarro.net/posts/2023-08-14_mrgsolve">https://blog.djnavarro.net/posts/2023-08-14_mrgsolve</a>.
</div></div></section></div></main> <!-- /main -->
<!-- plausible -->
<script async="" defer="" data-domain="blog.djnavarro.net" src="https://plausible.io/js/plausible.js"></script>
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
      &nbsp;
    </div>   
    <div class="nav-footer-center">
      <ul class="footer-items list-unstyled">
    <li class="nav-item">
    <a class="nav-link" href="https://blog.djnavarro.net">blog.djnavarro.net</a>
  </li>  
</ul>
    </div>
    <div class="nav-footer-right">
      &nbsp;
    </div>
  </div>
</footer>



</body></html>