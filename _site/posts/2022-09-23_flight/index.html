<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.1.149">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Danielle Navarro">
<meta name="dcterms.date" content="2022-09-23">
<meta name="description" content="This post makes total sense, honest. I am definitely not in over my head. I’m waving hellow at you and totally not drowning. Et cetera.">

<title>Notes from a data witch - Building an Arrow Flight server</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1.6em;
  vertical-align: middle;
}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>
<style>
    .quarto-title-block .quarto-title-banner {
      background: #eeeeee;
    }
    </style>


<link rel="stylesheet" href="../../styles.css">
<meta property="og:title" content="Notes from a data witch - Building an Arrow Flight server">
<meta property="og:description" content="This post makes total sense, honest. I am definitely not in over my head. I’m waving hellow at you and totally not drowning. Et cetera.">
<meta property="og:image" content="https://blog.djnavarro.net/posts/2022-09-23_flight/img/biplane.jpg">
<meta property="og:site-name" content="Notes from a data witch">
<meta name="twitter:title" content="Notes from a data witch - Building an Arrow Flight server">
<meta name="twitter:description" content="This post makes total sense, honest. I am definitely not in over my head. I’m waving hellow at you and totally not drowning. Et cetera.">
<meta name="twitter:image" content="https://blog.djnavarro.net/posts/2022-09-23_flight/img/biplane.jpg">
<meta name="twitter:creator" content="@djnavarro">
<meta name="twitter:card" content="summary_large_image">
</head>

<body class="floating nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">Notes from a data witch</span>
    </a>
  </div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../about.html">Danielle Navarro</a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://twitter.com/djnavarro"><i class="bi bi-twitter" role="img" aria-label="twitter">
</i> 
 </a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/djnavarro"><i class="bi bi-github" role="img" aria-label="github">
</i> 
 </a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://djnavarro.net"><i class="bi bi-person-circle" role="img" aria-label="website">
</i> 
 </a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://art.djnavarro.net"><i class="bi bi-palette-fill" role="img" aria-label="art">
</i> 
 </a>
  </li>  
</ul>
              <div id="quarto-search" class="" title="Search"></div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default toc-left page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <h1 class="title">Building an Arrow Flight server</h1>
                  <div>
        <div class="description">
          This post makes total sense, honest. I am definitely not in over my head. I’m waving hellow at you and totally not drowning. Et cetera.
        </div>
      </div>
                          <div class="quarto-categories">
                <div class="quarto-category">Apache Arrow</div>
                <div class="quarto-category">Networking</div>
                <div class="quarto-category">R</div>
                <div class="quarto-category">Python</div>
              </div>
                  </div>
  </div>
    
  <div class="quarto-title-meta-author">
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-heading">Affiliation</div>
    
      <div class="quarto-title-meta-contents">
      <a href="https://djnavarro.net">Danielle Navarro</a> <a href="https://orcid.org/0000-0001-7648-6578" class="quarto-title-author-orcid"> <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAA2ZpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMC1jMDYwIDYxLjEzNDc3NywgMjAxMC8wMi8xMi0xNzozMjowMCAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wTU09Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9tbS8iIHhtbG5zOnN0UmVmPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvc1R5cGUvUmVzb3VyY2VSZWYjIiB4bWxuczp4bXA9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC8iIHhtcE1NOk9yaWdpbmFsRG9jdW1lbnRJRD0ieG1wLmRpZDo1N0NEMjA4MDI1MjA2ODExOTk0QzkzNTEzRjZEQTg1NyIgeG1wTU06RG9jdW1lbnRJRD0ieG1wLmRpZDozM0NDOEJGNEZGNTcxMUUxODdBOEVCODg2RjdCQ0QwOSIgeG1wTU06SW5zdGFuY2VJRD0ieG1wLmlpZDozM0NDOEJGM0ZGNTcxMUUxODdBOEVCODg2RjdCQ0QwOSIgeG1wOkNyZWF0b3JUb29sPSJBZG9iZSBQaG90b3Nob3AgQ1M1IE1hY2ludG9zaCI+IDx4bXBNTTpEZXJpdmVkRnJvbSBzdFJlZjppbnN0YW5jZUlEPSJ4bXAuaWlkOkZDN0YxMTc0MDcyMDY4MTE5NUZFRDc5MUM2MUUwNEREIiBzdFJlZjpkb2N1bWVudElEPSJ4bXAuZGlkOjU3Q0QyMDgwMjUyMDY4MTE5OTRDOTM1MTNGNkRBODU3Ii8+IDwvcmRmOkRlc2NyaXB0aW9uPiA8L3JkZjpSREY+IDwveDp4bXBtZXRhPiA8P3hwYWNrZXQgZW5kPSJyIj8+84NovQAAAR1JREFUeNpiZEADy85ZJgCpeCB2QJM6AMQLo4yOL0AWZETSqACk1gOxAQN+cAGIA4EGPQBxmJA0nwdpjjQ8xqArmczw5tMHXAaALDgP1QMxAGqzAAPxQACqh4ER6uf5MBlkm0X4EGayMfMw/Pr7Bd2gRBZogMFBrv01hisv5jLsv9nLAPIOMnjy8RDDyYctyAbFM2EJbRQw+aAWw/LzVgx7b+cwCHKqMhjJFCBLOzAR6+lXX84xnHjYyqAo5IUizkRCwIENQQckGSDGY4TVgAPEaraQr2a4/24bSuoExcJCfAEJihXkWDj3ZAKy9EJGaEo8T0QSxkjSwORsCAuDQCD+QILmD1A9kECEZgxDaEZhICIzGcIyEyOl2RkgwAAhkmC+eAm0TAAAAABJRU5ErkJggg=="></a>
    </div>
      <div class="quarto-title-meta-contents">
          <p class="affiliation">
              <a href="https://voltrondata.com">
              Voltron Data
              </a>
            </p>
        </div>
      </div>

  <div class="quarto-title-meta">

        
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">September 23, 2022</p>
      </div>
    </div>
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse sidebar-navigation floating overflow-auto">
    <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#the-what-and-why-of-arrow-flight" id="toc-the-what-and-why-of-arrow-flight" class="nav-link active" data-scroll-target="#the-what-and-why-of-arrow-flight">The what and why of Arrow Flight</a>
  <ul class="collapse">
  <li><a href="#prerequisites" id="toc-prerequisites" class="nav-link" data-scroll-target="#prerequisites">Prerequisites</a></li>
  </ul></li>
  <li><a href="#an-r-example" id="toc-an-r-example" class="nav-link" data-scroll-target="#an-r-example">An R example</a>
  <ul class="collapse">
  <li><a href="#the-flight-server" id="toc-the-flight-server" class="nav-link" data-scroll-target="#the-flight-server">The flight server</a></li>
  <li><a href="#the-flight-client" id="toc-the-flight-client" class="nav-link" data-scroll-target="#the-flight-client">The flight client</a></li>
  </ul></li>
  <li><a href="#unpacking-the-data-exchange-process" id="toc-unpacking-the-data-exchange-process" class="nav-link" data-scroll-target="#unpacking-the-data-exchange-process">Unpacking the data exchange process</a>
  <ul class="collapse">
  <li><a href="#unpacking-flight_put" id="toc-unpacking-flight_put" class="nav-link" data-scroll-target="#unpacking-flight_put">Unpacking flight_put()</a></li>
  <li><a href="#unpacking-flight_get" id="toc-unpacking-flight_get" class="nav-link" data-scroll-target="#unpacking-flight_get">Unpacking flight_get()</a></li>
  </ul></li>
  <li><a href="#a-python-example" id="toc-a-python-example" class="nav-link" data-scroll-target="#a-python-example">A Python example</a>
  <ul class="collapse">
  <li><a href="#a-tiny-flight-server" id="toc-a-tiny-flight-server" class="nav-link" data-scroll-target="#a-tiny-flight-server">A tiny flight server</a></li>
  <li><a href="#a-tiny-flight-client" id="toc-a-tiny-flight-client" class="nav-link" data-scroll-target="#a-tiny-flight-client">A tiny flight client</a></li>
  <li><a href="#initialisation" id="toc-initialisation" class="nav-link" data-scroll-target="#initialisation">Initialisation</a></li>
  <li><a href="#putting-a-table" id="toc-putting-a-table" class="nav-link" data-scroll-target="#putting-a-table">Putting a table</a></li>
  <li><a href="#getting-a-table" id="toc-getting-a-table" class="nav-link" data-scroll-target="#getting-a-table">Getting a table</a></li>
  <li><a href="#getting-information" id="toc-getting-information" class="nav-link" data-scroll-target="#getting-information">Getting information</a></li>
  <li><a href="#custom-actions" id="toc-custom-actions" class="nav-link" data-scroll-target="#custom-actions">Custom actions</a></li>
  <li><a href="#using-our-server" id="toc-using-our-server" class="nav-link" data-scroll-target="#using-our-server">Using our server</a></li>
  </ul></li>
  <li><a href="#further-down-the-rabbit-hole" id="toc-further-down-the-rabbit-hole" class="nav-link" data-scroll-target="#further-down-the-rabbit-hole">Further down the rabbit hole</a></li>
  <li><a href="#where-to-next" id="toc-where-to-next" class="nav-link" data-scroll-target="#where-to-next">Where to next?</a></li>
  </ul>
</nav>
</nav>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
    </div>
<!-- main -->
<main class="content quarto-banner-title-block page-columns page-full" id="quarto-document-content">




<!-- 
cover image: https://unsplash.com/photos/aWwFbn0ZW6A
credit: Hennie Stander
licence: open via unsplash licence
-->
<!--------------- my typical setup ----------------->
<!--------------- post begins here ----------------->
<p>This is a post about Arrow Flight. I will probably tell a whimsical anecdote to open this post. Or not. Who knows. Maybe I’ll leave the introductory paragraph like this. That would be pretty on-brand for me actually.</p>
<section id="the-what-and-why-of-arrow-flight" class="level2 page-columns page-full">
<h2 class="anchored" data-anchor-id="the-what-and-why-of-arrow-flight">The what and why of Arrow Flight</h2>
<p>The central idea behind flight is deceptively simple: it provides a standard protocol for transferring Arrow data over a network. But to understand why this is a Big Deal, you need to have a good sense of what the Arrow ecosystem is all about. For that, I found it helpful to go all the way back<a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a> to the <a href="https://arrow.apache.org/blog/2019/10/13/introducing-arrow-flight/">original announcement of flight by Wes McKinney</a>. Here’s how he explained the motivation:</p>
<blockquote class="blockquote">
<p>Our design goal for Flight is to create a new protocol for data services that uses the Arrow columnar format as both the over-the-wire data representation as well as the public API presented to developers. In doing so, we reduce or remove the serialization costs associated with data transport and increase the overall efficiency of distributed data systems. Additionally, two systems that are already using Apache Arrow for other purposes can communicate data to each other with extreme efficiency.</p>
</blockquote>
<p>To put this in context, it helps to have a little recap of how the project has grown: Arrow was originally introduced to provide an efficient and language-agnostic <a href="https://arrow.apache.org/docs/format/Columnar.html">standard for representing tabular data in-memory</a>, but as the project has grown it has necessarily expanded in scope. For example, storing data in-memory is not entirely useful if you can’t manipulate it, so Arrow now supplies a powerful <a href="https://arrow.apache.org/docs/cpp/compute.html">compute engine</a> that underpins both the <a href="https://arrow.apache.org/docs/r/index.html">arrow package in R</a> and the <a href="https://arrow.apache.org/docs/python/index.html">pyarrow library in Python</a>, and several others besides. In other words, the compute engine has been developed to solve a practical data science problem.</p>
<p>Arrow Flight evolved from a similar practical concern. It’s pretty trivial to point out that we live in a networked world now, and as consequence it is hard to avoid situations where the data to be analysed are stored on a different machine than the one that does the analysis. In my earlier posts on <a href="https://blog.djnavarro.net/posts/2022-09-09_reticulated-arrow/">reticulate</a> and <a href="https://blog.djnavarro.net/posts/2022-09-16_arrow-and-rpy2/">rpy2</a> I talked about how to efficiently share an Arrow data set between <em>languages</em>, but I implicitly assumed in those posts that the R process and the Python process were running on the same <em>machine</em>. The moment we have processes running on different machines, those tricks don’t work anymore!</p>
<p>Flight is designed to solve this problem. It’s not a fancypants protocol with lots of different parts. It exists for one purpose: it makes it super easy to transfer Arrow-formatted data. That’s it. It’s pretty flexible though, and you can build other stuff on top of flight (more on that later), but the design of flight is deliberately simple. It’s <em>meant</em> to be pretty minimal, so you can “just use it” without having to think too hard or do any of the obnoxious implementation work yourself.</p>
<p><br></p>
<div class="column-body-outset">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="img/biplane.jpg" class="img-fluid figure-img"></p>
<p></p><figcaption class="figure-caption"><a href="https://pixabay.com/photos/aircraft-flight-sunset-clouds-1756149/">Image by Gerhard from Pixabay</a></figcaption><p></p>
</figure>
</div>
</div>
<p><br></p>
<section id="prerequisites" class="level3">
<h3 class="anchored" data-anchor-id="prerequisites">Prerequisites</h3>
<p>There are a couple of prerequisites for this post. Specifically I’ll assume you have the <a href="https://arrow.apache.org/docs/r/">arrow</a> and <a href="https://rstudio.github.io/reticulate/">reticulate</a> packages installed in your R environment, and similarly that your Python environment has <a href="https://arrow.apache.org/docs/python/index.html">pyarrow</a> installed. If you’re only interested in the Python side, you probably don’t need either of the R packages, but R users will need to have the pyarrow installation because the R flight implementation builds on pyarrow.</p>
<p><br></p>
</section>
</section>
<section id="an-r-example" class="level2 page-columns page-full">
<h2 class="anchored" data-anchor-id="an-r-example">An R example</h2>
<p>The implementation of Arrow Flight varies a little across languages. In this post I’m going to focus on the two languages I use most – R and Python – but there’s nothing stopping you from using other languages. For example, the book <a href="https://www.packtpub.com/product/in-memory-analytics-with-apache-arrow/9781801071031">In-Memory Analytics with Apache Arrow</a> by <a href="https://twitter.com/zeroshade">Matt Topol</a> has worked examples using C++ and Go, in addition to Python.</p>
<p>For the purposes of this post I’m going to start with R because the arrow package in R exposes a “high-level” interface that will allow us to start using a flight server without having to dive deeply into how it all works. However, as we’ll see, there are some limitations to this approach – not least of which is the fact that the R implementation turns out to secretly be a Python implementation under the hood – and as the post progresses I’ll pivot to Python in order to unpack some of the lower-level functionality.</p>
<p>To do this I’ll need access to the arrow and reticulate packages, and I’ll need to make certain that the Python environment is one that has pyarrow installed. For my machine, the commands to do this look like this:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(arrow)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(reticulate)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">use_miniconda</span>(<span class="st">"base"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>It may be a little different for you depending on your configuration. For more information on this, take a look at the <a href="https://blog.djnavarro.net/posts/2022-09-09_reticulated-arrow/">reticulate post</a> I wrote recently.</p>
<p><br></p>
<section id="the-flight-server" class="level3 page-columns page-full">
<h3 class="anchored" data-anchor-id="the-flight-server">The flight server</h3>
<p>Okay, so let’s get started by thinking about the simplest possible scenario for using a flight server. In this set up all we want the server to do is to act as a “cache” for Arrow tables. Clients can upload tables to the server, download tables from the server, and so on. That’s all we’re really trying to accomplish, and happily for us this use case is supported out of the box in R.</p>
<p>Here’s how it works. As I mentioned earlier, R doesn’t actually implement the flight protocol itself: it’s just a wrapper around the Python tools. What that means is the underlying flight server is actually written in Python, and if we want to start that server running from R we have to call the <code>load_flight_server()</code> function that will allow us access to this server from R. Conveniently, the arrow R package comes bundled with a “demo” server that already provides the server side functionality that we want, and I can import it like this:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>server_class <span class="ot">&lt;-</span> <span class="fu">load_flight_server</span>(<span class="st">"demo_flight_server"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>When I do this, all I’ve done is obtain access to the relevant Python code. I haven’t created a server yet and I haven’t started it running either. Create an instance of the “demo server”, I call the <code>DemoFlightServer()</code> method attached to the <code>server_class()</code> object:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>server <span class="ot">&lt;-</span> server_class_object<span class="sc">$</span><span class="fu">DemoFlightServer</span>(<span class="at">port =</span> <span class="dv">8089</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We have now defined a server that, once started, will run on port 8089. The <code>server</code> object has a <code>serve()</code> method that I can call to start it running:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>server<span class="sc">$</span><span class="fu">serve</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>I’ve written a short script called <a href="./start_demo_server.R">start_demo_server.R</a> that bundles all these operations together, and the easiest way to start a server running in its very own R process (i.e., an R session that isn’t the one you’re currently working in) would be to type this at the terminal:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="ex">Rscript</span> start_demo_server.R <span class="kw">&amp;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>This will start an R process as a background job that will create a server and start it running. As an alternative, if you’re comfortable with using the <a href="https://callr.r-lib.org/">callr</a> package, you can use <code>callr::r_bg()</code> to create a child R process from your current one. The child process will run in the background, and we can start start the server within that R session without blocking the current one. Here’s some code that will do exactly that:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>r_process <span class="ot">&lt;-</span> callr<span class="sc">::</span><span class="fu">r_bg</span>(<span class="cf">function</span>() {</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>  reticulate<span class="sc">::</span><span class="fu">use_miniconda</span>(<span class="st">"base"</span>)  </span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>  demo <span class="ot">&lt;-</span> arrow<span class="sc">::</span><span class="fu">load_flight_server</span>(<span class="st">"demo_flight_server"</span>)</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>  server <span class="ot">&lt;-</span> demo<span class="sc">$</span><span class="fu">DemoFlightServer</span>(<span class="at">port =</span> <span class="dv">8089</span>)</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>  server<span class="sc">$</span><span class="fu">serve</span>()</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>})</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Regardless of what method you’ve chosen, I’ll now assume that the demo server is now running in the background on port 8089.</p>
<p><br></p>
<div class="column-body-outset">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="img/hummingbird.jpg" class="img-fluid figure-img"></p>
<p></p><figcaption class="figure-caption"><a href="https://pixabay.com/photos/hummingbird-bird-flight-avian-1854225/">Image by Pexels from Pixabay</a></figcaption><p></p>
</figure>
</div>
</div>
<p><br></p>
</section>
<section id="the-flight-client" class="level3 page-columns page-full">
<h3 class="anchored" data-anchor-id="the-flight-client">The flight client</h3>
<p>Now that I have this server running quietly in the background on port 8089, I can define a flight client in my current R session that can interact with it. To do that, I call <code>flight_connect()</code>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>client <span class="ot">&lt;-</span> <span class="fu">flight_connect</span>(<span class="at">port =</span> <span class="dv">8089</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Perhaps unsurprisingly, the R object <code>client</code> is a wrapper around a Python flight client. It comes with various methods that implement low-level flight operations, but I’m going to hold off talking about those for a moment because we won’t need to use the low-level interface in this initial example.</p>
<p>Let’s start by using the client to as ask a simple question: what is stored on the server? The way that data source are conceptualised in Arrow flight is as a set of “flights”. Each individual “flight” corresponds to a data stream from which the client can download data. The precise implementation of this idea (e.g., what data structures are stored in a single flight) varies from server to server, but in both examples in this post each flight stores a single Arrow table.</p>
<p>In any case, to find out what flights are currently available on our server, we can call the <code>list_flights()</code> function:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="fu">list_flights</span>(client)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>list()</code></pre>
</div>
</div>
<p>Hm, okay, there’s nothing there. That makes sense because I haven’t actually uploaded anything to the server yet! Okay, well, let’s suppose I want to store a copy of the <code>airquality</code> data as an Arrow table on my server. As R users are probably aware, this is a data set that comes bundled with R, but just so we’re all on the same page here’s the first few rows of the data set:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(airquality)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  Ozone Solar.R Wind Temp Month Day
1    41     190  7.4   67     5   1
2    36     118  8.0   72     5   2
3    12     149 12.6   74     5   3
4    18     313 11.5   62     5   4
5    NA      NA 14.3   56     5   5
6    28      NA 14.9   66     5   6</code></pre>
</div>
</div>
<p>This object is a regular data frame in R, not an Arrow table, and strictly speaking what we want our client to do is send an Arrow table version of this data set to the server. Happily for us, the <code>flight_put()</code> function supplied by the arrow package will take care of the conversion for us, and we can cache a copy of the data as an Arrow table on the server in one line of code:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="fu">flight_put</span>(client, <span class="at">data =</span> airquality, <span class="at">path =</span> <span class="st">"pollution_data"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>In this code, the <code>flight_put()</code> function uses the <code>client</code> object to communicate with the server, it uses the <code>data</code> argument to find the local copy of the data set, and the <code>path</code> argument is used to provide a name for the data set on the server (i.e., on the server this data set will be called <code>pollution_data</code>). Now that we’ve done the upload, if we try calling <code>list_flights()</code> again we get this as the result:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="fu">list_flights</span>(client)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "pollution_data"</code></pre>
</div>
</div>
<p>Yay!</p>
<p>Now, just to prove to you that I’m not cheating, let’s check to make sure that there is no object called <code>pollution_data</code> stored locally within my R session:<a href="#fn2" class="footnote-ref" id="fnref2" role="doc-noteref"><sup>2</sup></a></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>pollution_data</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-error">
<pre><code>Error in eval(expr, envir, enclos): object 'pollution_data' not found</code></pre>
</div>
</div>
<p>Clearly there is no object called <code>pollution_data</code> available in my current R session. That data set is stored only on the server. To get access to the data cached on the server, I use the <code>flight_get()</code> function:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="fu">flight_get</span>(client, <span class="st">"pollution_data"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Table
153 rows x 6 columns
$Ozone &lt;int32&gt;
$Solar.R &lt;int32&gt;
$Wind &lt;double&gt;
$Temp &lt;int32&gt;
$Month &lt;int32&gt;
$Day &lt;int32&gt;

See $metadata for additional Schema metadata</code></pre>
</div>
</div>
<p>What has just happened is our client contacted the server and downloaded a copy of the Arrow table stored remotely. It works!</p>
<p>At the very least we have proof-of-concept that we can start a flight server and use it to upload and download data. But there’s a lot that hasn’t really been explained properly here. The time has come to start digging a little deeper, so we can really get a sense of what’s going on under the hood and how this simple example can be extended.</p>
<p><br></p>
<div class="column-body-outset">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="img/staircase.jpg" class="img-fluid figure-img"></p>
<p></p><figcaption class="figure-caption"><a href="https://pixabay.com/photos/staircase-upwards-rails-railings-274614/">Image by Francis from Pixabay</a></figcaption><p></p>
</figure>
</div>
</div>
<p><br></p>
</section>
</section>
<section id="unpacking-the-data-exchange-process" class="level2 page-columns page-full">
<h2 class="anchored" data-anchor-id="unpacking-the-data-exchange-process">Unpacking the data exchange process</h2>
<p>One thing that I like about the flight functionality exposed through <code>flight_connect()</code>, <code>flight_put()</code>, <code>flight_get()</code>, etc is that it operates at a high level of abstraction. In my day-to-day data analysis work I really don’t want to spend my time thinking about low-level operations. When I tell R to “put” a data set onto the server I <em>want</em> it to happen with one line of code. This high level API is super useful to me on an everyday basis, but it also masks some of the details about how flight works. To give you a sense of what’s being hidden, we can take a closer look at the <code>client</code> object. Here’s a list of some of the methods that are available through the object itself:</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>client<span class="sc">$</span><span class="fu">do_put</span>()</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>client<span class="sc">$</span><span class="fu">do_get</span>()</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>client<span class="sc">$</span><span class="fu">do_action</span>()</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>client<span class="sc">$</span><span class="fu">list_action</span>()</span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>client<span class="sc">$</span><span class="fu">list_flights</span>()</span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>client<span class="sc">$</span><span class="fu">get_flight_info</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Each of these methods describes a low level operation available to the flight client, and because the R implementation is built on top of the Python version, these are all Python methods that are available in R thanks to the magic of <a href="https://rstudio.github.io/reticulate/">reticulate</a>. What we’re seeing exposed here are the actual Arrow flight methods, and it’s helpful to unpack things a little so we can see how these methods are related to the functions I’ve been calling in R.</p>
<p>As you might expect, the <code>do_put()</code> method for the client is very closely related to the <code>flight_put()</code> function that I called earlier! However, they aren’t the same. The <code>do_put()</code> method doesn’t actually upload any data, it merely opens a connection to the server, which we can then use to stream data from the client to the server. If you were calling the <code>do_put()</code> method directly, you would need to take care of that yourself. But it’s tiresome to write that code over and over, so the <code>flight_put()</code> function provides a convenient high-level wrapper that abstracts over all that.</p>
<p>If you’re the analyst working with the data, this is fabulous. But if you’re looking to implement your very own flight server, you probably need to understand what these low level operations are. So that’s where we’re headed next…</p>
<p><br></p>
<section id="unpacking-flight_put" class="level3">
<h3 class="anchored" data-anchor-id="unpacking-flight_put">Unpacking flight_put()</h3>
<p>Let’s start by taking a look at what happens when we call the R function <code>flight_put()</code>. Our goal is to transmit the data to the server, and there’s an Arrow Flight method called <code>do_put()</code> that can do this for us. However, the structure of the interaction is a little more complicated than simply calling <code>do_put()</code>. It’s a multi-step operation that unfolds as shown below:</p>
<p><img src="img/do_put.png" class="img-fluid"></p>
<p>The first step in the process occurs when the client calls <code>do_put()</code>, a flight method that takes two arguments: a <strong>flight descriptor</strong> object that is used to identify the specific data stream that the client wants to be sent – and later on I’ll talk what the descriptor actually looks like – and the <a href="https://arrow.apache.org/docs/r/reference/Schema.html">schema</a> for the flight data.<a href="#fn3" class="footnote-ref" id="fnref3" role="doc-noteref"><sup>3</sup></a> Setting aside the particulars of the syntax – which might be different in every language – here’s what the <code>do_put()</code> fuction call looks like on the client side:</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>do_put(descriptor, schema)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Passing the schema on the client side serves a particular purpose: it allows the client to create <strong>stream writer</strong> and <strong>stream reader</strong> objects that are returned to the client-side user, and are also passed along to the server. The writer object is the thing that will take care of streaming data to the server, and the reader object is responsible for reading any metadata response that the server happens to send.<a href="#fn4" class="footnote-ref" id="fnref4" role="doc-noteref"><sup>4</sup></a></p>
<p>Now let’s have a look at the server side, where the <code>do_put()</code> method expects three inputs: the flight descriptor, the writer, and the reader. So here’s the signature on the server side:</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>do_put(descriptor, reader, writer)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>As long as these methods are written appropriately for both the client and the server, we now have a situation where both machines agree on the description of the data and have objects that can take care of the streaming process.</p>
<p>We now move to step two in the communication, in which the client streams the data to the server. Once the data arrive on the server side, the <code>do_put()</code> method for the server stores the data along with an appropriate descriptor, so that it can be found later. Optionally, this is followed by a third stage in which the server sends a response containing metadata to the client. In the example server I’ll build in the next section, I won’t bother with that step!</p>
<p><br></p>
</section>
<section id="unpacking-flight_get" class="level3 page-columns page-full">
<h3 class="anchored" data-anchor-id="unpacking-flight_get">Unpacking flight_get()</h3>
<p>Next let’s look at <code>flight_get()</code>. When I called this function earlier, it triggered two separate interactions between the client and server. First, the client calls the <code>get_flight_info()</code> method, and the server responds with some information about the data source that includes – among other things – a <strong>ticket</strong>. Again, the ticket is a particular data structure that I’ll talk more about later, but for now it’s enough to note that it’s a token that uniquely specifies which flight is requested.</p>
<p>Once in possession of this ticket, the client can call <code>do_get()</code> to request that the server send the data that matches the ticket, which the server then streams. So the whole exchange looks like this:</p>
<p><img src="img/do_get.png" class="img-fluid"></p>
<p>So, in the previous example when I called <code>flight_get()</code>, the process looked like this. On the client side, we used the <code>"pollution_data"</code> path to construct a descriptor object and the client used <code>get_flight_info()</code> to request that information about this “flight” from the server:</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>get_flight_info(descriptor)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>On the server side, once the descriptor is received, a <strong>flight info</strong> object is constructed. The flight info object is comprised of five parts:</p>
<ul>
<li>The schema for the data stored by the flight,</li>
<li>The flight descriptor object</li>
<li>A list of one or more endpoints that specify where the data are available for streaming. Each end point includes a location from which to stream, and the associated ticket for that location</li>
<li>The total number of records (i.e.&nbsp;rows) stored</li>
<li>The total number of bytes to be streamed (i.e., the size of the data)</li>
</ul>
<p>This flight info is then returned to the client.</p>
<p>It may seem like this arrangement is overly elaborate: why does the client need this much information if only the ticket is needed to request the data? To be honest, for the simple server-client examples I’ve used in this post, this level of complexity is not really needed. However, it’s extremely useful that it’s structured like this when we want to start adopting a more sophisticated setup. One thing it allows, for example, is an arrangement where both the server and client can be distributed across multiple machines, with different endpoints streaming different subsets of the data. Matt Topol discusses some examples where this architecture is employed in <a href="https://www.packtpub.com/product/in-memory-analytics-with-apache-arrow/9781801071031">In-Memory Analytics with Apache Arrow</a>.</p>
<p>Once this flight information has been received by the client, we can extract the ticket from the relevant endpoint (there will be only one endpoint in the server I build in the next section). The client now calls:</p>
<div class="sourceCode" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="fu">do_get</span>(ticket)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The server then sends a <strong>stream reader</strong> object that the client can use to receive the stream of data from the server.</p>
<p><br></p>
<div class="column-body-outset">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="img/balloons.jpg" class="img-fluid figure-img"></p>
<p></p><figcaption class="figure-caption"><a href="https://pixabay.com/photos/hot-air-balloons-adventure-balloons-1867279/">Image by Pexels from Pixabay</a></figcaption><p></p>
</figure>
</div>
</div>
<p><br></p>
</section>
</section>
<section id="a-python-example" class="level2 page-columns page-full">
<h2 class="anchored" data-anchor-id="a-python-example">A Python example</h2>
<p>Now that we have a basic understanding of what is happening at a lower level, we can build a flight server of our very own. To do this I’ll switch over to Python. R doesn’t currently have a direct implementation of flight, and relies on Python. Given this, it’s easiest to switch completely to Python for the rest of this post.</p>
<p><br></p>
<section id="a-tiny-flight-server" class="level3">
<h3 class="anchored" data-anchor-id="a-tiny-flight-server">A tiny flight server</h3>
<p>Our goal in this section is to write our own flight server in Python that does the same job as the one we saw earlier in the R example: it’s a server that allows you to cache copies of Arrow tables. To do so, we’ll start our Python script the way one usually does, with some imports:</p>
<div class="cell">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>tiny_flight.py</strong></pre>
</div>
<div class="sourceCode cell-code" id="cb24" data-startfrom="3"><pre class="sourceCode numberSource python numberLines number-lines code-with-copy"><code class="sourceCode python" style="counter-reset: source-line 2;"><span id="cb24-3"><a href="#cb24-3"></a><span class="im">import</span> pyarrow <span class="im">as</span> pa</span>
<span id="cb24-4"><a href="#cb24-4"></a><span class="im">import</span> pyarrow.flight <span class="im">as</span> flight</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<p>What I’ll do now is define a Python class called <code>TinyServer</code>. The job of this class is to provide server side flight methods for <code>do_get()</code>, <code>do_put()</code>, and others. We’ll be able to use this class to create specific server instances and set them running, in more or less the exact same fashion that we did previously in the R example.</p>
<p>I’ll explain the code in more detail in a moment after I’ve shown you both the server and the client, but let’s start just by looking at the code. You can find all the code in the <a href="tiny_flight.py">tiny_flight.py</a> script that accompanies this post. Here’s the complete code used to define the <code>TinyServer</code> class:</p>
<div class="cell">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>tiny_flight.py [server]</strong></pre>
</div>
<div class="sourceCode cell-code" id="cb25" data-startfrom="7"><pre class="sourceCode numberSource python numberLines number-lines code-with-copy"><code class="sourceCode python" style="counter-reset: source-line 6;"><span id="cb25-7"><a href="#cb25-7"></a><span class="kw">class</span> TinyServer(flight.FlightServerBase):</span>
<span id="cb25-8"><a href="#cb25-8"></a>  </span>
<span id="cb25-9"><a href="#cb25-9"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, </span>
<span id="cb25-10"><a href="#cb25-10"></a>                 host <span class="op">=</span> <span class="st">'localhost'</span>, </span>
<span id="cb25-11"><a href="#cb25-11"></a>                 port <span class="op">=</span> <span class="dv">5678</span>):</span>
<span id="cb25-12"><a href="#cb25-12"></a>        <span class="va">self</span>.tables <span class="op">=</span> {}</span>
<span id="cb25-13"><a href="#cb25-13"></a>        <span class="va">self</span>.location <span class="op">=</span> flight                  <span class="op">\</span></span>
<span id="cb25-14"><a href="#cb25-14"></a>                        .Location               <span class="op">\</span></span>
<span id="cb25-15"><a href="#cb25-15"></a>                        .for_grpc_tcp(host, port)</span>
<span id="cb25-16"><a href="#cb25-16"></a>        <span class="bu">super</span>().<span class="fu">__init__</span>(<span class="va">self</span>.location)</span>
<span id="cb25-17"><a href="#cb25-17"></a>    </span>
<span id="cb25-18"><a href="#cb25-18"></a>    <span class="at">@staticmethod</span>    </span>
<span id="cb25-19"><a href="#cb25-19"></a>    <span class="kw">def</span> server_message(method, name):</span>
<span id="cb25-20"><a href="#cb25-20"></a>        msg <span class="op">=</span> <span class="st">'(server) '</span>                       \</span>
<span id="cb25-21"><a href="#cb25-21"></a>              <span class="op">+</span> method                          <span class="op">\</span></span>
<span id="cb25-22"><a href="#cb25-22"></a>              <span class="op">+</span> <span class="st">' '</span>                             \</span>
<span id="cb25-23"><a href="#cb25-23"></a>              <span class="op">+</span> name.decode(<span class="st">'utf-8'</span>)</span>
<span id="cb25-24"><a href="#cb25-24"></a>        <span class="bu">print</span>(msg)</span>
<span id="cb25-25"><a href="#cb25-25"></a>      </span>
<span id="cb25-26"><a href="#cb25-26"></a>    <span class="kw">def</span> do_put(<span class="va">self</span>, context, descriptor, reader, </span>
<span id="cb25-27"><a href="#cb25-27"></a>               writer):</span>
<span id="cb25-28"><a href="#cb25-28"></a>        table_name <span class="op">=</span> descriptor.command</span>
<span id="cb25-29"><a href="#cb25-29"></a>        <span class="va">self</span>.server_message(<span class="st">'do_put'</span>, table_name)</span>
<span id="cb25-30"><a href="#cb25-30"></a>        <span class="va">self</span>.tables[table_name] <span class="op">=</span> reader.read_all()</span>
<span id="cb25-31"><a href="#cb25-31"></a></span>
<span id="cb25-32"><a href="#cb25-32"></a>    <span class="kw">def</span> do_get(<span class="va">self</span>, context, ticket):</span>
<span id="cb25-33"><a href="#cb25-33"></a>        table_name <span class="op">=</span> ticket.ticket</span>
<span id="cb25-34"><a href="#cb25-34"></a>        <span class="va">self</span>.server_message(<span class="st">'do_get'</span>, table_name)</span>
<span id="cb25-35"><a href="#cb25-35"></a>        table <span class="op">=</span> <span class="va">self</span>.tables[table_name]</span>
<span id="cb25-36"><a href="#cb25-36"></a>        <span class="cf">return</span> flight.RecordBatchStream(table)</span>
<span id="cb25-37"><a href="#cb25-37"></a>  </span>
<span id="cb25-38"><a href="#cb25-38"></a>    <span class="kw">def</span> flight_info(<span class="va">self</span>, descriptor):</span>
<span id="cb25-39"><a href="#cb25-39"></a>        table_name <span class="op">=</span> descriptor.command</span>
<span id="cb25-40"><a href="#cb25-40"></a>        table <span class="op">=</span> <span class="va">self</span>.tables[table_name]</span>
<span id="cb25-41"><a href="#cb25-41"></a>        schema <span class="op">=</span> table.schema</span>
<span id="cb25-42"><a href="#cb25-42"></a>        ncases <span class="op">=</span> table.num_rows</span>
<span id="cb25-43"><a href="#cb25-43"></a>        </span>
<span id="cb25-44"><a href="#cb25-44"></a>        output <span class="op">=</span> pa.MockOutputStream()</span>
<span id="cb25-45"><a href="#cb25-45"></a>        writer <span class="op">=</span> pa.RecordBatchStreamWriter(output, </span>
<span id="cb25-46"><a href="#cb25-46"></a>                                            schema)</span>
<span id="cb25-47"><a href="#cb25-47"></a>        writer.write_table(table)</span>
<span id="cb25-48"><a href="#cb25-48"></a>        writer.close()</span>
<span id="cb25-49"><a href="#cb25-49"></a>        nbytes <span class="op">=</span> output.size()</span>
<span id="cb25-50"><a href="#cb25-50"></a>        </span>
<span id="cb25-51"><a href="#cb25-51"></a>        ticket <span class="op">=</span> flight.Ticket(table_name)</span>
<span id="cb25-52"><a href="#cb25-52"></a>        location <span class="op">=</span> <span class="va">self</span>.location.uri.decode(<span class="st">'utf-8'</span>)</span>
<span id="cb25-53"><a href="#cb25-53"></a>        endpoint <span class="op">=</span> flight.FlightEndpoint(ticket,</span>
<span id="cb25-54"><a href="#cb25-54"></a>                                         [location])</span>
<span id="cb25-55"><a href="#cb25-55"></a>        </span>
<span id="cb25-56"><a href="#cb25-56"></a>        <span class="cf">return</span> flight.FlightInfo(schema, </span>
<span id="cb25-57"><a href="#cb25-57"></a>                                 descriptor, </span>
<span id="cb25-58"><a href="#cb25-58"></a>                                 [endpoint], </span>
<span id="cb25-59"><a href="#cb25-59"></a>                                 ncases,</span>
<span id="cb25-60"><a href="#cb25-60"></a>                                 nbytes)</span>
<span id="cb25-61"><a href="#cb25-61"></a>    </span>
<span id="cb25-62"><a href="#cb25-62"></a>    <span class="kw">def</span> get_flight_info(<span class="va">self</span>, context, descriptor):</span>
<span id="cb25-63"><a href="#cb25-63"></a>        table_name <span class="op">=</span> descriptor.command</span>
<span id="cb25-64"><a href="#cb25-64"></a>        <span class="va">self</span>.server_message(<span class="st">'get_flight_info'</span>,</span>
<span id="cb25-65"><a href="#cb25-65"></a>                            table_name)</span>
<span id="cb25-66"><a href="#cb25-66"></a>        <span class="cf">return</span> <span class="va">self</span>.flight_info(descriptor)        </span>
<span id="cb25-67"><a href="#cb25-67"></a>        </span>
<span id="cb25-68"><a href="#cb25-68"></a>    <span class="kw">def</span> list_flights(<span class="va">self</span>, context, criteria):</span>
<span id="cb25-69"><a href="#cb25-69"></a>        <span class="va">self</span>.server_message(<span class="st">'list_flights'</span>, <span class="st">b' '</span>)</span>
<span id="cb25-70"><a href="#cb25-70"></a>        <span class="cf">for</span> table_name <span class="kw">in</span> <span class="va">self</span>.tables.keys():</span>
<span id="cb25-71"><a href="#cb25-71"></a>            descriptor <span class="op">=</span> flight                  <span class="op">\</span></span>
<span id="cb25-72"><a href="#cb25-72"></a>                         .FlightDescriptor       <span class="op">\</span></span>
<span id="cb25-73"><a href="#cb25-73"></a>                         .for_command(table_name)</span>
<span id="cb25-74"><a href="#cb25-74"></a>            <span class="cf">yield</span> <span class="va">self</span>.flight_info(descriptor)</span>
<span id="cb25-75"><a href="#cb25-75"></a></span>
<span id="cb25-76"><a href="#cb25-76"></a>    <span class="kw">def</span> do_action(<span class="va">self</span>, context, action):</span>
<span id="cb25-77"><a href="#cb25-77"></a>        <span class="cf">if</span> action.<span class="bu">type</span> <span class="op">==</span> <span class="st">'drop_table'</span>:</span>
<span id="cb25-78"><a href="#cb25-78"></a>            table_name <span class="op">=</span> action.body.to_pybytes()</span>
<span id="cb25-79"><a href="#cb25-79"></a>            <span class="kw">del</span> <span class="va">self</span>.tables[table_name]</span>
<span id="cb25-80"><a href="#cb25-80"></a>            <span class="va">self</span>.server_message(<span class="st">'drop_table'</span>,</span>
<span id="cb25-81"><a href="#cb25-81"></a>                                table_name)</span>
<span id="cb25-82"><a href="#cb25-82"></a></span>
<span id="cb25-83"><a href="#cb25-83"></a>        <span class="cf">elif</span> action.<span class="bu">type</span> <span class="op">==</span> <span class="st">'shutdown'</span>:</span>
<span id="cb25-84"><a href="#cb25-84"></a>            <span class="va">self</span>.server_message(<span class="st">'shutdown'</span>, <span class="st">b' '</span>)</span>
<span id="cb25-85"><a href="#cb25-85"></a>            <span class="va">self</span>.shutdown()</span>
<span id="cb25-86"><a href="#cb25-86"></a></span>
<span id="cb25-87"><a href="#cb25-87"></a>        <span class="cf">else</span>:</span>
<span id="cb25-88"><a href="#cb25-88"></a>            <span class="cf">raise</span> <span class="pp">KeyError</span>(<span class="st">'Unknown action </span><span class="sc">{!r}</span><span class="st">'</span>.</span>
<span id="cb25-89"><a href="#cb25-89"></a>                           <span class="bu">format</span>(action.<span class="bu">type</span>))</span>
<span id="cb25-90"><a href="#cb25-90"></a></span>
<span id="cb25-91"><a href="#cb25-91"></a>    <span class="kw">def</span> list_actions(<span class="va">self</span>, context):</span>
<span id="cb25-92"><a href="#cb25-92"></a>        <span class="cf">return</span> [(<span class="st">'drop_table'</span>, <span class="st">'Drop table'</span>),</span>
<span id="cb25-93"><a href="#cb25-93"></a>                (<span class="st">'shutdown'</span>, <span class="st">'Shut down server'</span>)]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<p>Now, if you’re at all like me this code won’t immediately make sense. Probably you’ll skim over it, read bits of it, and <em>some</em> of it will make sense… but not all of it. There’s a couple of reasons for that. The first and most obvious reason is that it’s a big chunk of code that I haven’t explained yet! The second reason is that (in my opinion) server-side code never makes sense on its own: it only really makes sense when you can place it next to the client-side code so that you can see how the two parts fit together. With that in mind, let’s take a quick peek at the client-side code…</p>
<p><br></p>
</section>
<section id="a-tiny-flight-client" class="level3 page-columns page-full">
<h3 class="anchored" data-anchor-id="a-tiny-flight-client">A tiny flight client</h3>
<p>To accompany a <code>TinyServer</code>, we’ll need a <code>TinyClient</code> that knows how to talk to it. Happily for us, it’s easier to define the client than to define the server, so the source code that defines the <code>TinyClient</code> class is considerably shorter:</p>
<div class="cell">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>tiny_flight.py [client]</strong></pre>
</div>
<div class="sourceCode cell-code" id="cb26" data-startfrom="96"><pre class="sourceCode numberSource python numberLines number-lines code-with-copy"><code class="sourceCode python" style="counter-reset: source-line 95;"><span id="cb26-96"><a href="#cb26-96"></a><span class="kw">class</span> TinyClient:</span>
<span id="cb26-97"><a href="#cb26-97"></a></span>
<span id="cb26-98"><a href="#cb26-98"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, host <span class="op">=</span> <span class="st">'localhost'</span>, port <span class="op">=</span> <span class="dv">5678</span>):</span>
<span id="cb26-99"><a href="#cb26-99"></a>        <span class="va">self</span>.location <span class="op">=</span> flight                      <span class="op">\</span></span>
<span id="cb26-100"><a href="#cb26-100"></a>                        .Location                   <span class="op">\</span></span>
<span id="cb26-101"><a href="#cb26-101"></a>                        .for_grpc_tcp(host, port)</span>
<span id="cb26-102"><a href="#cb26-102"></a>        <span class="va">self</span>.connection <span class="op">=</span> flight.<span class="ex">connect</span>(<span class="va">self</span>.location)</span>
<span id="cb26-103"><a href="#cb26-103"></a>        <span class="va">self</span>.connection.wait_for_available()</span>
<span id="cb26-104"><a href="#cb26-104"></a></span>
<span id="cb26-105"><a href="#cb26-105"></a>    <span class="kw">def</span> put_table(<span class="va">self</span>, name, table):</span>
<span id="cb26-106"><a href="#cb26-106"></a>        table_name <span class="op">=</span> name.encode(<span class="st">'utf8'</span>)</span>
<span id="cb26-107"><a href="#cb26-107"></a>        descriptor <span class="op">=</span> flight                         <span class="op">\</span></span>
<span id="cb26-108"><a href="#cb26-108"></a>                     .FlightDescriptor              <span class="op">\</span></span>
<span id="cb26-109"><a href="#cb26-109"></a>                     .for_command(table_name)</span>
<span id="cb26-110"><a href="#cb26-110"></a>        writer, reader <span class="op">=</span> <span class="va">self</span>                       <span class="op">\</span></span>
<span id="cb26-111"><a href="#cb26-111"></a>                         .connection                <span class="op">\</span></span>
<span id="cb26-112"><a href="#cb26-112"></a>                         .do_put(descriptor,</span>
<span id="cb26-113"><a href="#cb26-113"></a>                                 table.schema)</span>
<span id="cb26-114"><a href="#cb26-114"></a>        writer.write(table)</span>
<span id="cb26-115"><a href="#cb26-115"></a>        writer.close()</span>
<span id="cb26-116"><a href="#cb26-116"></a>      </span>
<span id="cb26-117"><a href="#cb26-117"></a>    <span class="kw">def</span> get_table(<span class="va">self</span>, name):</span>
<span id="cb26-118"><a href="#cb26-118"></a>        table_name <span class="op">=</span> name.encode(<span class="st">'utf8'</span>)</span>
<span id="cb26-119"><a href="#cb26-119"></a>        ticket <span class="op">=</span> flight.Ticket(table_name)</span>
<span id="cb26-120"><a href="#cb26-120"></a>        reader <span class="op">=</span> <span class="va">self</span>.connection.do_get(ticket)</span>
<span id="cb26-121"><a href="#cb26-121"></a>        <span class="cf">return</span> reader.read_all()</span>
<span id="cb26-122"><a href="#cb26-122"></a>    </span>
<span id="cb26-123"><a href="#cb26-123"></a>    <span class="kw">def</span> list_tables(<span class="va">self</span>):</span>
<span id="cb26-124"><a href="#cb26-124"></a>        names <span class="op">=</span> []</span>
<span id="cb26-125"><a href="#cb26-125"></a>        <span class="cf">for</span> flight <span class="kw">in</span> <span class="va">self</span>.connection.list_flights():</span>
<span id="cb26-126"><a href="#cb26-126"></a>            table_name <span class="op">=</span> flight.descriptor.command</span>
<span id="cb26-127"><a href="#cb26-127"></a>            names.append(table_name.decode(<span class="st">'utf-8'</span>))</span>
<span id="cb26-128"><a href="#cb26-128"></a>        <span class="cf">return</span> names</span>
<span id="cb26-129"><a href="#cb26-129"></a>    </span>
<span id="cb26-130"><a href="#cb26-130"></a>    <span class="kw">def</span> drop_table(<span class="va">self</span>, name):</span>
<span id="cb26-131"><a href="#cb26-131"></a>        table_name <span class="op">=</span> name.encode(<span class="st">'utf8'</span>)</span>
<span id="cb26-132"><a href="#cb26-132"></a>        drop <span class="op">=</span> flight.Action(<span class="st">'drop_table'</span>, table_name) </span>
<span id="cb26-133"><a href="#cb26-133"></a>        <span class="va">self</span>.connection.do_action(drop)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<p>These two classes are designed to work in concert: the <code>do_put()</code> method for <code>TinyServer</code> is aligned with the <code>do_put()</code> method for <code>TinyClient</code>, and the <code>put_table()</code> function I wrote on the client side is a convenient high-level wrapper that manages the whole “put a table on the server” interaction without requiring the user to do anything other than write a single line of code. That’s the reason I started by showing you all the source code for both parts before explaining any of the specific methods: in the next few sections I’ll walk you through the code, placing the relevant snippets from the server code and the client code next to each other so you can more clearly see how they relate to each other.</p>
<p><br></p>
<div class="column-body-outset">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="img/kite.jpg" class="img-fluid figure-img"></p>
<p></p><figcaption class="figure-caption"><a href="https://pixabay.com/photos/child-boy-dragon-dragon-flight-2887483/">Image by Anja from Pixabay</a></figcaption><p></p>
</figure>
</div>
</div>
<p><br></p>
</section>
<section id="initialisation" class="level3">
<h3 class="anchored" data-anchor-id="initialisation">Initialisation</h3>
<p>Let’s start by looking at what happens when the server and client are initialised. When a new <code>TinyServer</code> or <code>TinyClient</code> object is created, the <code>__init__</code> function is called:</p>
<div class="cell">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>tiny_flight.py [server]</strong></pre>
</div>
<div class="sourceCode cell-code" id="cb27" data-startfrom="7"><pre class="sourceCode numberSource python numberLines number-lines code-with-copy"><code class="sourceCode python" style="counter-reset: source-line 6;"><span id="cb27-7"><a href="#cb27-7"></a><span class="kw">class</span> TinyServer(flight.FlightServerBase):</span>
<span id="cb27-8"><a href="#cb27-8"></a>  </span>
<span id="cb27-9"><a href="#cb27-9"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, </span>
<span id="cb27-10"><a href="#cb27-10"></a>                 host <span class="op">=</span> <span class="st">'localhost'</span>, </span>
<span id="cb27-11"><a href="#cb27-11"></a>                 port <span class="op">=</span> <span class="dv">5678</span>):</span>
<span id="cb27-12"><a href="#cb27-12"></a>        <span class="va">self</span>.tables <span class="op">=</span> {}</span>
<span id="cb27-13"><a href="#cb27-13"></a>        <span class="va">self</span>.location <span class="op">=</span> flight                  <span class="op">\</span></span>
<span id="cb27-14"><a href="#cb27-14"></a>                        .Location               <span class="op">\</span></span>
<span id="cb27-15"><a href="#cb27-15"></a>                        .for_grpc_tcp(host, port)</span>
<span id="cb27-16"><a href="#cb27-16"></a>        <span class="bu">super</span>().<span class="fu">__init__</span>(<span class="va">self</span>.location)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<div class="cell">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>tiny_flight.py [client]</strong></pre>
</div>
<div class="sourceCode cell-code" id="cb28" data-startfrom="96"><pre class="sourceCode numberSource python numberLines number-lines code-with-copy"><code class="sourceCode python" style="counter-reset: source-line 95;"><span id="cb28-96"><a href="#cb28-96"></a><span class="kw">class</span> TinyClient:</span>
<span id="cb28-97"><a href="#cb28-97"></a></span>
<span id="cb28-98"><a href="#cb28-98"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, host <span class="op">=</span> <span class="st">'localhost'</span>, port <span class="op">=</span> <span class="dv">5678</span>):</span>
<span id="cb28-99"><a href="#cb28-99"></a>        <span class="va">self</span>.location <span class="op">=</span> flight                      <span class="op">\</span></span>
<span id="cb28-100"><a href="#cb28-100"></a>                        .Location                   <span class="op">\</span></span>
<span id="cb28-101"><a href="#cb28-101"></a>                        .for_grpc_tcp(host, port)</span>
<span id="cb28-102"><a href="#cb28-102"></a>        <span class="va">self</span>.connection <span class="op">=</span> flight.<span class="ex">connect</span>(<span class="va">self</span>.location)</span>
<span id="cb28-103"><a href="#cb28-103"></a>        <span class="va">self</span>.connection.wait_for_available()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<p>Some things to notice here. At start up, the server and client both call the <code>flight.Location.for_grpc_tcp()</code> function to generate a <a href="https://arrow.apache.org/docs/python/generated/pyarrow.flight.Location.html">Location</a> object used to specify the address of the server:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>loc <span class="op">=</span> flight.Location.for_grpc_tcp(<span class="st">'localhost'</span>, <span class="dv">5678</span>)</span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(loc)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;Location b'grpc+tcp://localhost:5678'&gt;</code></pre>
</div>
</div>
<p>The important thing in this output the server address. The <code>localhost:5678</code> part indicates that the server is running locally on port 5678, and the <code>grpc+tcp://</code> part tells us what communication protocols are being used. For this server, those protocols are <a href="https://grpc.io/">gRPC</a> and <a href="https://en.wikipedia.org/wiki/Transmission_Control_Protocol">TCP</a>. I’ll talk about this more later. For now, it’s sufficient to recognise that this location object does store the server address. If I’d really wanted to, I could have written code that constructs this string manually<a href="#fn5" class="footnote-ref" id="fnref5" role="doc-noteref"><sup>5</sup></a> but there’s no need to do that when the pyarrow flight module supplies built-in location classes to do this for us!</p>
<p>The rest of the code is used for initialisation. On the server side, we initialise the server object as an instance of the parent class (i.e., <code>FlightServerBase</code>). On the client side, the first action is to call <code>flight.connect()</code>: this is also an initialisation action that returns an instance of the <code>FlightClient</code> class. In other words there’s a symmetry here: the <code>TinyServer</code> is built on top of the <code>FlightServerBase</code> class, and the <code>TinyClient</code> is built on top of the <code>FlightClient</code> class.</p>
<p>The other thing to notice here is the data structures set up in these initialisations. On the server side we create an empty dictionary called <code>tables</code> (referred to as <code>self.tables</code> since it belongs to the instance not the class) that the server uses to store any data sets that it is sent. On the client side, the <code>self.con</code> object is used to represent our connection to the server: it is this object that is an intance of the <code>FlightClient</code> class, and it comes equipped with client side methods for <code>do_put()</code>, <code>do_get()</code> etc. Finally, notice that the last action that the client takes when it is initialised is to wait for the connection to the server to be established.</p>
<p><br></p>
</section>
<section id="putting-a-table" class="level3">
<h3 class="anchored" data-anchor-id="putting-a-table">Putting a table</h3>
<p>Next, let’s take a look at the code used to place data on the server. On the server side, we have to specify the <code>do_put()</code> method. In this case, all my code does is store a copy of the data in <code>self.tables</code> and prints a little message to the server console using the <code>server_message()</code> function:</p>
<div class="cell">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>tiny_flight.py [server]</strong></pre>
</div>
<div class="sourceCode cell-code" id="cb31" data-startfrom="18"><pre class="sourceCode numberSource python numberLines number-lines code-with-copy"><code class="sourceCode python" style="counter-reset: source-line 17;"><span id="cb31-18"><a href="#cb31-18"></a>    <span class="at">@staticmethod</span>    </span>
<span id="cb31-19"><a href="#cb31-19"></a>    <span class="kw">def</span> server_message(method, name):</span>
<span id="cb31-20"><a href="#cb31-20"></a>        msg <span class="op">=</span> <span class="st">'(server) '</span>                       \</span>
<span id="cb31-21"><a href="#cb31-21"></a>              <span class="op">+</span> method                          <span class="op">\</span></span>
<span id="cb31-22"><a href="#cb31-22"></a>              <span class="op">+</span> <span class="st">' '</span>                             \</span>
<span id="cb31-23"><a href="#cb31-23"></a>              <span class="op">+</span> name.decode(<span class="st">'utf-8'</span>)</span>
<span id="cb31-24"><a href="#cb31-24"></a>        <span class="bu">print</span>(msg)</span>
<span id="cb31-25"><a href="#cb31-25"></a>      </span>
<span id="cb31-26"><a href="#cb31-26"></a>    <span class="kw">def</span> do_put(<span class="va">self</span>, context, descriptor, reader, </span>
<span id="cb31-27"><a href="#cb31-27"></a>               writer):</span>
<span id="cb31-28"><a href="#cb31-28"></a>        table_name <span class="op">=</span> descriptor.command</span>
<span id="cb31-29"><a href="#cb31-29"></a>        <span class="va">self</span>.server_message(<span class="st">'do_put'</span>, table_name)</span>
<span id="cb31-30"><a href="#cb31-30"></a>        <span class="va">self</span>.tables[table_name] <span class="op">=</span> reader.read_all()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<p>There’s a few things to comment on here. First, let’s note that the <code>server_message()</code> function isn’t very interesting for our purposes. It exists solely to print out messages so that the server announces what it is doing.<a href="#fn6" class="footnote-ref" id="fnref6" role="doc-noteref"><sup>6</sup></a> So we can ignore it for now. The important part of this code is this line in the <code>do_put()</code> function that does all the server-side work:</p>
<div class="cell">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>tiny_flight.py [server]</strong></pre>
</div>
<div class="sourceCode cell-code" id="cb32" data-startfrom="30"><pre class="sourceCode numberSource python numberLines number-lines code-with-copy"><code class="sourceCode python" style="counter-reset: source-line 29;"><span id="cb32-30"><a href="#cb32-30"></a>        <span class="va">self</span>.tables[table_name] <span class="op">=</span> reader.read_all()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<p>Let’s unpack this line one step at a time. The <code>reader</code> object has been passed to the server as one of the arguments to <code>do_put()</code>, and it’s a <a href="https://arrow.apache.org/docs/python/generated/pyarrow.ipc.RecordBatchStreamReader.html">RecordBatchStreamReader</a>. That is, it’s an object capable of receiving a stream of Arrow data. When the <code>read_all()</code> method is called, it reads all record batches sent by the client and returns the final result as an Arrow table. This table is then stored in the <code>self.tables</code> dictionary.</p>
<p>Next, notice that the key against which the table is stored as the value is specified by <code>descriptor.command</code>. This part of the code also needs to be explained! What is a “descriptor” object? What is the “command” attribute of a descriptor? That’s not at all obvious from inspection. To resolve our confusion, it helps to realise that this <code>descriptor</code> object is one of the arguments to the the server-side <code>do_put()</code> function, and the code that creates this object is over on the the client side. So let’s look at the code I wrote for the client side:</p>
<div class="cell">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>tiny_flight.py [client]</strong></pre>
</div>
<div class="sourceCode cell-code" id="cb33" data-startfrom="105"><pre class="sourceCode numberSource python numberLines number-lines code-with-copy"><code class="sourceCode python" style="counter-reset: source-line 104;"><span id="cb33-105"><a href="#cb33-105"></a>    <span class="kw">def</span> put_table(<span class="va">self</span>, name, table):</span>
<span id="cb33-106"><a href="#cb33-106"></a>        table_name <span class="op">=</span> name.encode(<span class="st">'utf8'</span>)</span>
<span id="cb33-107"><a href="#cb33-107"></a>        descriptor <span class="op">=</span> flight                         <span class="op">\</span></span>
<span id="cb33-108"><a href="#cb33-108"></a>                     .FlightDescriptor              <span class="op">\</span></span>
<span id="cb33-109"><a href="#cb33-109"></a>                     .for_command(table_name)</span>
<span id="cb33-110"><a href="#cb33-110"></a>        writer, reader <span class="op">=</span> <span class="va">self</span>                       <span class="op">\</span></span>
<span id="cb33-111"><a href="#cb33-111"></a>                         .connection                <span class="op">\</span></span>
<span id="cb33-112"><a href="#cb33-112"></a>                         .do_put(descriptor,</span>
<span id="cb33-113"><a href="#cb33-113"></a>                                 table.schema)</span>
<span id="cb33-114"><a href="#cb33-114"></a>        writer.write(table)</span>
<span id="cb33-115"><a href="#cb33-115"></a>        writer.close()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<p>Here we have a <code>put_table()</code> Python function does the same job that the <code>flight_put()</code> function does in the R example I presented earlier. It is a high-level wrapper function that sends a <code>do_put()</code> call to the server, streams the data across, then stops. This line of code in this function is the one that makes the <code>do_put()</code> call:</p>
<div class="cell">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>tiny_flight.py [client]</strong></pre>
</div>
<div class="sourceCode cell-code" id="cb34" data-startfrom="110"><pre class="sourceCode numberSource python numberLines number-lines code-with-copy"><code class="sourceCode python" style="counter-reset: source-line 109;"><span id="cb34-110"><a href="#cb34-110"></a>        writer, reader <span class="op">=</span> <span class="va">self</span>                       <span class="op">\</span></span>
<span id="cb34-111"><a href="#cb34-111"></a>                         .connection                <span class="op">\</span></span>
<span id="cb34-112"><a href="#cb34-112"></a>                         .do_put(descriptor,</span>
<span id="cb34-113"><a href="#cb34-113"></a>                                 table.schema)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<p>Okay, so the <code>descriptor</code> on the client side is also the thing that later gets used on the server side to create the key against which the table is stored. If we look at the preceding line of code, we can see that the <code>descriptor</code> object is an instance of the <code>FlightDescriptor</code> class. So let’s actually step into the Python console and run the commands required to create a flight descriptor object:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a>table_name <span class="op">=</span> <span class="st">b'name-of-data'</span></span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>descriptor <span class="op">=</span> flight.FlightDescriptor.for_command(table_name)</span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(descriptor)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;FlightDescriptor command: b'name-of-data'&gt;</code></pre>
</div>
</div>
<p>Perhaps unsurprisingly, the <code>command</code> attribute is in fact the (byte encoded) string that we used to specify the <code>name</code>. In other words, once we strip back all the layers here it turns out that the server stores the data set using the name that the client gave it!</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a>descriptor.command</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>b'name-of-data'</code></pre>
</div>
</div>
<p><br></p>
</section>
<section id="getting-a-table" class="level3">
<h3 class="anchored" data-anchor-id="getting-a-table">Getting a table</h3>
<p>Next, let’s have a look at the code used to get data from the server. Just like last time, I’ll put the relevant sections from the server code and the client side code side by side:</p>
<div class="cell">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>tiny_flight.py [server]</strong></pre>
</div>
<div class="sourceCode cell-code" id="cb39" data-startfrom="32"><pre class="sourceCode numberSource python numberLines number-lines code-with-copy"><code class="sourceCode python" style="counter-reset: source-line 31;"><span id="cb39-32"><a href="#cb39-32"></a>    <span class="kw">def</span> do_get(<span class="va">self</span>, context, ticket):</span>
<span id="cb39-33"><a href="#cb39-33"></a>        table_name <span class="op">=</span> ticket.ticket</span>
<span id="cb39-34"><a href="#cb39-34"></a>        <span class="va">self</span>.server_message(<span class="st">'do_get'</span>, table_name)</span>
<span id="cb39-35"><a href="#cb39-35"></a>        table <span class="op">=</span> <span class="va">self</span>.tables[table_name]</span>
<span id="cb39-36"><a href="#cb39-36"></a>        <span class="cf">return</span> flight.RecordBatchStream(table)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<div class="cell">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>tiny_flight.py [client]</strong></pre>
</div>
<div class="sourceCode cell-code" id="cb40" data-startfrom="117"><pre class="sourceCode numberSource python numberLines number-lines code-with-copy"><code class="sourceCode python" style="counter-reset: source-line 116;"><span id="cb40-117"><a href="#cb40-117"></a>    <span class="kw">def</span> get_table(<span class="va">self</span>, name):</span>
<span id="cb40-118"><a href="#cb40-118"></a>        table_name <span class="op">=</span> name.encode(<span class="st">'utf8'</span>)</span>
<span id="cb40-119"><a href="#cb40-119"></a>        ticket <span class="op">=</span> flight.Ticket(table_name)</span>
<span id="cb40-120"><a href="#cb40-120"></a>        reader <span class="op">=</span> <span class="va">self</span>.connection.do_get(ticket)</span>
<span id="cb40-121"><a href="#cb40-121"></a>        <span class="cf">return</span> reader.read_all()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<p>On the client side, the <code>get_table()</code> helper function that I’ve written does two things. First it creates a <code>ticket</code> object from the <code>name</code> of the data table to be retrieved. It then calls the <code>do_get()</code> flight method to communicate with the server. Then, using the <code>reader</code> object returned by <code>do_get()</code>, it streams the data from the server. The server side code is the mirror image: when the ticket is received, it uses this ticket to retrieve the specific <code>table</code> from <code>self.tables</code>, and returns a stream.</p>
<p>Looking at these two code extracts side by side we can see that the ticket object created by the client when <code>flight.Ticket()</code> is called ends up being used by the server to retrieve the requested table. So we should take a look at what happens here. What we hope to see is that this ticket ends up producing the same key that would have been used to store the data originally: that is, when the server specifies the storage key with <code>table_name = ticket.ticket</code> in the <code>do_get()</code> method, it should be producing the same key that the <code>do_put()</code> method created when <code>table_name = descriptor.command</code> was executed. Let’s verify that this is actually true!</p>
<p>Since I already have a <code>table_name</code> object lying around from earlier, let’s run that line of code shall we?</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a>ticket <span class="op">=</span> flight.Ticket(table_name)</span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(ticket)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;Ticket b'name-of-data'&gt;</code></pre>
</div>
</div>
<p>That looks promising. If we take a peek at the <code>ticket.ticket</code> object that gets used on the server side, we see that – yet again – under the hood the ticket is really just an alias for the name of the data set:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a>ticket.ticket</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>b'name-of-data'</code></pre>
</div>
</div>
<p>Well that’s a relief. In the server-side code, the <code>descriptor.command</code> object and the <code>ticket.ticket</code> object both produce the correct key used to index a table.</p>
<p><br></p>
</section>
<section id="getting-information" class="level3">
<h3 class="anchored" data-anchor-id="getting-information">Getting information</h3>
<p>Our journey through the source code continues. On the client side I’ve written a function called <code>list_tables()</code> that returns the names of all tables stored on the server. Here’s what that looks like:</p>
<div class="cell">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>tiny_flight.py [client]</strong></pre>
</div>
<div class="sourceCode cell-code" id="cb45" data-startfrom="123"><pre class="sourceCode numberSource python numberLines number-lines code-with-copy"><code class="sourceCode python" style="counter-reset: source-line 122;"><span id="cb45-123"><a href="#cb45-123"></a>    <span class="kw">def</span> list_tables(<span class="va">self</span>):</span>
<span id="cb45-124"><a href="#cb45-124"></a>        names <span class="op">=</span> []</span>
<span id="cb45-125"><a href="#cb45-125"></a>        <span class="cf">for</span> flight <span class="kw">in</span> <span class="va">self</span>.connection.list_flights():</span>
<span id="cb45-126"><a href="#cb45-126"></a>            table_name <span class="op">=</span> flight.descriptor.command</span>
<span id="cb45-127"><a href="#cb45-127"></a>            names.append(table_name.decode(<span class="st">'utf-8'</span>))</span>
<span id="cb45-128"><a href="#cb45-128"></a>        <span class="cf">return</span> names</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<p>The key part of this function is the call to <code>self.connection.list_flights()</code>. That’s where the client contacts the server and requests information. Everthing else in the function is there to extract the one piece of information (the name of the table) that we’re interested in and return it to the user.</p>
<p>Pivoting over to the server code, there are two flight methods that are relevant here. The <code>get_flight_info()</code> function is a flight method that returns information about a single flight – where, in this case, there’s a one-to-one mapping between flights and tables – and the <code>list_flights()</code> method can be used to retrieve information about all flights stored on the server:</p>
<div class="cell">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>tiny_flight.py [server]</strong></pre>
</div>
<div class="sourceCode cell-code" id="cb46" data-startfrom="62"><pre class="sourceCode numberSource python numberLines number-lines code-with-copy"><code class="sourceCode python" style="counter-reset: source-line 61;"><span id="cb46-62"><a href="#cb46-62"></a>    <span class="kw">def</span> get_flight_info(<span class="va">self</span>, context, descriptor):</span>
<span id="cb46-63"><a href="#cb46-63"></a>        table_name <span class="op">=</span> descriptor.command</span>
<span id="cb46-64"><a href="#cb46-64"></a>        <span class="va">self</span>.server_message(<span class="st">'get_flight_info'</span>,</span>
<span id="cb46-65"><a href="#cb46-65"></a>                            table_name)</span>
<span id="cb46-66"><a href="#cb46-66"></a>        <span class="cf">return</span> <span class="va">self</span>.flight_info(descriptor)        </span>
<span id="cb46-67"><a href="#cb46-67"></a>        </span>
<span id="cb46-68"><a href="#cb46-68"></a>    <span class="kw">def</span> list_flights(<span class="va">self</span>, context, criteria):</span>
<span id="cb46-69"><a href="#cb46-69"></a>        <span class="va">self</span>.server_message(<span class="st">'list_flights'</span>, <span class="st">b' '</span>)</span>
<span id="cb46-70"><a href="#cb46-70"></a>        <span class="cf">for</span> table_name <span class="kw">in</span> <span class="va">self</span>.tables.keys():</span>
<span id="cb46-71"><a href="#cb46-71"></a>            descriptor <span class="op">=</span> flight                  <span class="op">\</span></span>
<span id="cb46-72"><a href="#cb46-72"></a>                         .FlightDescriptor       <span class="op">\</span></span>
<span id="cb46-73"><a href="#cb46-73"></a>                         .for_command(table_name)</span>
<span id="cb46-74"><a href="#cb46-74"></a>            <span class="cf">yield</span> <span class="va">self</span>.flight_info(descriptor)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<p>There’s two things to comment on here. First, note that the <code>list_flight()</code> method iterates<a href="#fn7" class="footnote-ref" id="fnref7" role="doc-noteref"><sup>7</sup></a> over all the stored keys in the <code>tables</code> dictionary, uses the key to construct a flight descriptor, and then calls the <code>flight_info()</code> helper function that I’ll explain in a moment. In contrast, the <code>get_flight_info()</code> function receives a flight descriptor directly from the client, so it’s much simpler: it just calls <code>flight_info()</code> directly.</p>
<p>Okay, so now let’s have a look at the <code>flight_info()</code> helper method. Here’s the code for that one:</p>
<div class="cell">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>tiny_flight.py [server]</strong></pre>
</div>
<div class="sourceCode cell-code" id="cb47" data-startfrom="38"><pre class="sourceCode numberSource python numberLines number-lines code-with-copy"><code class="sourceCode python" style="counter-reset: source-line 37;"><span id="cb47-38"><a href="#cb47-38"></a>    <span class="kw">def</span> flight_info(<span class="va">self</span>, descriptor):</span>
<span id="cb47-39"><a href="#cb47-39"></a>        table_name <span class="op">=</span> descriptor.command</span>
<span id="cb47-40"><a href="#cb47-40"></a>        table <span class="op">=</span> <span class="va">self</span>.tables[table_name]</span>
<span id="cb47-41"><a href="#cb47-41"></a>        schema <span class="op">=</span> table.schema</span>
<span id="cb47-42"><a href="#cb47-42"></a>        ncases <span class="op">=</span> table.num_rows</span>
<span id="cb47-43"><a href="#cb47-43"></a>        </span>
<span id="cb47-44"><a href="#cb47-44"></a>        output <span class="op">=</span> pa.MockOutputStream()</span>
<span id="cb47-45"><a href="#cb47-45"></a>        writer <span class="op">=</span> pa.RecordBatchStreamWriter(output, </span>
<span id="cb47-46"><a href="#cb47-46"></a>                                            schema)</span>
<span id="cb47-47"><a href="#cb47-47"></a>        writer.write_table(table)</span>
<span id="cb47-48"><a href="#cb47-48"></a>        writer.close()</span>
<span id="cb47-49"><a href="#cb47-49"></a>        nbytes <span class="op">=</span> output.size()</span>
<span id="cb47-50"><a href="#cb47-50"></a>        </span>
<span id="cb47-51"><a href="#cb47-51"></a>        ticket <span class="op">=</span> flight.Ticket(table_name)</span>
<span id="cb47-52"><a href="#cb47-52"></a>        location <span class="op">=</span> <span class="va">self</span>.location.uri.decode(<span class="st">'utf-8'</span>)</span>
<span id="cb47-53"><a href="#cb47-53"></a>        endpoint <span class="op">=</span> flight.FlightEndpoint(ticket,</span>
<span id="cb47-54"><a href="#cb47-54"></a>                                         [location])</span>
<span id="cb47-55"><a href="#cb47-55"></a>        </span>
<span id="cb47-56"><a href="#cb47-56"></a>        <span class="cf">return</span> flight.FlightInfo(schema, </span>
<span id="cb47-57"><a href="#cb47-57"></a>                                 descriptor, </span>
<span id="cb47-58"><a href="#cb47-58"></a>                                 [endpoint], </span>
<span id="cb47-59"><a href="#cb47-59"></a>                                 ncases,</span>
<span id="cb47-60"><a href="#cb47-60"></a>                                 nbytes)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<p>Let’s start by looking at the return value. It’s constructed by a call to <code>flight.FlightInfo()</code> and it takes five arguments. As I mentioned earlier in the post, these arguments encode the following:</p>
<ul>
<li>The <code>schema</code> for the data stored by the flight,</li>
<li>The flight <code>descriptor</code> object</li>
<li>A list of one or more endpoints – in this cases, <code>[endpoint]</code> is a list containing a single endpoint – that specifies where the data are available for streaming. Each endpoint includes a <code>location</code> from which to stream, and the associated <code>ticket</code> for that location</li>
<li>The total number of records stored is stored as <code>ncases</code></li>
<li>The total number of bytes to be streamed is stored as <code>nbytes</code></li>
</ul>
<p>Looking at the rest of the function, you can see that some these values are relatively easy to compute. The <code>schema</code> and number of records (<code>ncases</code>), for instance, are both stored as attributes of the <code>table</code>: those can be read directly from the stored table. The <code>descriptor</code> is even easier: it’s one of the inputs to the function. It’s a little more effort to construct the <code>endpoint</code>, because we need to call <code>flight.Ticket()</code> to construct a ticket object, we need to extract the server <code>location</code> that we stored when the server was initialised, and then we call <code>flight.Endpoint()</code> to put these things together. There’s a little more code involved, but there’s nothing conceptually difficult here.</p>
<p>The <code>nbytes</code> value is a different kettle of fish entirely! We need to calculate the total number of bytes required to stream the Arrow table. That’s not stored as an attribute of the table, so we have to compute it directly. Here’s the section of code that does this:</p>
<div class="cell">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>tiny_flight.py [server]</strong></pre>
</div>
<div class="sourceCode cell-code" id="cb48" data-startfrom="44"><pre class="sourceCode numberSource python numberLines number-lines code-with-copy"><code class="sourceCode python" style="counter-reset: source-line 43;"><span id="cb48-44"><a href="#cb48-44"></a>        output <span class="op">=</span> pa.MockOutputStream()</span>
<span id="cb48-45"><a href="#cb48-45"></a>        writer <span class="op">=</span> pa.RecordBatchStreamWriter(output, </span>
<span id="cb48-46"><a href="#cb48-46"></a>                                            schema)</span>
<span id="cb48-47"><a href="#cb48-47"></a>        writer.write_table(table)</span>
<span id="cb48-48"><a href="#cb48-48"></a>        writer.close()</span>
<span id="cb48-49"><a href="#cb48-49"></a>        nbytes <span class="op">=</span> output.size()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<p>Superficially, this code looks like it’s writing data to a stream: the <code>writer</code> object constructed in the second line is a stream writer object, and the next two lines proceed to write the table and close the connection. So, we’re streaming? Not precisely: the <code>output</code> is a <a href="https://arrow.apache.org/docs/cpp/api/io.html?highlight=mockoutputstream#_CPPv4N5arrow2io16MockOutputStreamE">MockOutputStream</a>. As the documentation notes, this is:</p>
<blockquote class="blockquote">
<p>A helper class to track the size of allocations. Writes to this stream do not copy or retain any data, they just bump a size counter that can be later used to know exactly which data size needs to be allocated for actual writing.</p>
</blockquote>
<p>In other words, the mock output stream is used only to record the size of the stream, and we can read off that result in the final line shown in the previous code extract.</p>
<p><br></p>
</section>
<section id="custom-actions" class="level3 page-columns page-full">
<h3 class="anchored" data-anchor-id="custom-actions">Custom actions</h3>
<div class="cell">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>tiny_flight.py [server]</strong></pre>
</div>
<div class="sourceCode cell-code" id="cb49" data-startfrom="76"><pre class="sourceCode numberSource python numberLines number-lines code-with-copy"><code class="sourceCode python" style="counter-reset: source-line 75;"><span id="cb49-76"><a href="#cb49-76"></a>    <span class="kw">def</span> do_action(<span class="va">self</span>, context, action):</span>
<span id="cb49-77"><a href="#cb49-77"></a>        <span class="cf">if</span> action.<span class="bu">type</span> <span class="op">==</span> <span class="st">'drop_table'</span>:</span>
<span id="cb49-78"><a href="#cb49-78"></a>            table_name <span class="op">=</span> action.body.to_pybytes()</span>
<span id="cb49-79"><a href="#cb49-79"></a>            <span class="kw">del</span> <span class="va">self</span>.tables[table_name]</span>
<span id="cb49-80"><a href="#cb49-80"></a>            <span class="va">self</span>.server_message(<span class="st">'drop_table'</span>,</span>
<span id="cb49-81"><a href="#cb49-81"></a>                                table_name)</span>
<span id="cb49-82"><a href="#cb49-82"></a></span>
<span id="cb49-83"><a href="#cb49-83"></a>        <span class="cf">elif</span> action.<span class="bu">type</span> <span class="op">==</span> <span class="st">'shutdown'</span>:</span>
<span id="cb49-84"><a href="#cb49-84"></a>            <span class="va">self</span>.server_message(<span class="st">'shutdown'</span>, <span class="st">b' '</span>)</span>
<span id="cb49-85"><a href="#cb49-85"></a>            <span class="va">self</span>.shutdown()</span>
<span id="cb49-86"><a href="#cb49-86"></a></span>
<span id="cb49-87"><a href="#cb49-87"></a>        <span class="cf">else</span>:</span>
<span id="cb49-88"><a href="#cb49-88"></a>            <span class="cf">raise</span> <span class="pp">KeyError</span>(<span class="st">'Unknown action </span><span class="sc">{!r}</span><span class="st">'</span>.</span>
<span id="cb49-89"><a href="#cb49-89"></a>                           <span class="bu">format</span>(action.<span class="bu">type</span>))</span>
<span id="cb49-90"><a href="#cb49-90"></a></span>
<span id="cb49-91"><a href="#cb49-91"></a>    <span class="kw">def</span> list_actions(<span class="va">self</span>, context):</span>
<span id="cb49-92"><a href="#cb49-92"></a>        <span class="cf">return</span> [(<span class="st">'drop_table'</span>, <span class="st">'Drop table'</span>),</span>
<span id="cb49-93"><a href="#cb49-93"></a>                (<span class="st">'shutdown'</span>, <span class="st">'Shut down server'</span>)]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<div class="cell">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>tiny_flight.py [client]</strong></pre>
</div>
<div class="sourceCode cell-code" id="cb50" data-startfrom="130"><pre class="sourceCode numberSource python numberLines number-lines code-with-copy"><code class="sourceCode python" style="counter-reset: source-line 129;"><span id="cb50-130"><a href="#cb50-130"></a>    <span class="kw">def</span> drop_table(<span class="va">self</span>, name):</span>
<span id="cb50-131"><a href="#cb50-131"></a>        table_name <span class="op">=</span> name.encode(<span class="st">'utf8'</span>)</span>
<span id="cb50-132"><a href="#cb50-132"></a>        drop <span class="op">=</span> flight.Action(<span class="st">'drop_table'</span>, table_name) </span>
<span id="cb50-133"><a href="#cb50-133"></a>        <span class="va">self</span>.connection.do_action(drop)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<p><br></p>
<div class="column-body-outset">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="img/bumblebee.jpg" class="img-fluid figure-img"></p>
<p></p><figcaption class="figure-caption"><a href="https://pixabay.com/photos/bumblebee-hovering-nectar-insect-6326653/">Image by Gary Stearman from Pixabay</a></figcaption><p></p>
</figure>
</div>
</div>
<p><br></p>
</section>
<section id="using-our-server" class="level3 page-columns page-full">
<h3 class="anchored" data-anchor-id="using-our-server">Using our server</h3>
<p>Conveniently, the <a href="tiny_flight.py">tiny_flight.py</a> script is bundled with this post, so I can import it as a module:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> threading</span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> tiny_flight <span class="im">as</span> tiny</span>
<span id="cb51-3"><a href="#cb51-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-4"><a href="#cb51-4" aria-hidden="true" tabindex="-1"></a>server <span class="op">=</span> tiny.TinyServer(port <span class="op">=</span> <span class="dv">9001</span>)</span>
<span id="cb51-5"><a href="#cb51-5" aria-hidden="true" tabindex="-1"></a>thread <span class="op">=</span> threading.Thread(target <span class="op">=</span> <span class="kw">lambda</span>: server.serve(), </span>
<span id="cb51-6"><a href="#cb51-6" aria-hidden="true" tabindex="-1"></a>                          daemon <span class="op">=</span> <span class="va">True</span>)</span>
<span id="cb51-7"><a href="#cb51-7" aria-hidden="true" tabindex="-1"></a>thread.start()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now let’s start our client…</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a>client <span class="op">=</span> tiny.TinyClient(port <span class="op">=</span> <span class="dv">9001</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>(server) list_flights  </code></pre>
</div>
</div>
<p>Let’s create some tables on the client side and cache them on the server:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pyarrow <span class="im">as</span> pa</span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a>mario <span class="op">=</span> pa.table([[<span class="st">"Mario"</span>, <span class="st">"Luigi"</span>, <span class="st">"Peach"</span>]], names<span class="op">=</span>[<span class="st">"Character"</span>])</span>
<span id="cb54-3"><a href="#cb54-3" aria-hidden="true" tabindex="-1"></a>riots <span class="op">=</span> pa.table([[<span class="st">"Stonewall"</span>, <span class="st">"Comptons"</span>, <span class="st">"Mardi Gras"</span>]], names<span class="op">=</span>[<span class="st">"Riot"</span>])</span>
<span id="cb54-4"><a href="#cb54-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-5"><a href="#cb54-5" aria-hidden="true" tabindex="-1"></a>client.put_table(<span class="st">"mario"</span>, mario)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>(server) do_put mario</code></pre>
</div>
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a>client.put_table(<span class="st">"riots"</span>, riots)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>(server) do_put riots</code></pre>
</div>
</div>
<p>Now let’s ask the server to tell us what it’s storing:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb58"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a>client.list_tables()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>(server) list_flights  
['mario', 'riots']</code></pre>
</div>
</div>
<p>Wait, we don’t want the mario table anymore:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb60"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a>client.drop_table(<span class="st">"mario"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>(server) drop_table mario</code></pre>
</div>
<div class="sourceCode cell-code" id="cb62"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a>client.list_tables()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>(server) list_flights  
['riots']</code></pre>
</div>
</div>
<p><br></p>
<div class="column-body-outset">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="img/boarding-pass.jpg" class="img-fluid figure-img"></p>
<p></p><figcaption class="figure-caption"><a href="https://pixabay.com/photos/travel-airport-boarding-pass-5219496/">Image by Joshua Woroniecki from Pixabay</a></figcaption><p></p>
</figure>
</div>
</div>
<p><br></p>
</section>
</section>
<section id="further-down-the-rabbit-hole" class="level2 page-columns page-full">
<h2 class="anchored" data-anchor-id="further-down-the-rabbit-hole">Further down the rabbit hole</h2>
<p>A little bit of detail about RPC vs REST, about gRPC and protobuf. Not a lot is needed here, just enough to understand what flight is built on top of…</p>
<p><br></p>
<div class="column-body-outset">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="img/birds.jpg" class="img-fluid figure-img"></p>
<p></p><figcaption class="figure-caption"><a href="https://pixabay.com/photos/nature-animals-bird-migratory-bird-2746726/">Image by Gerhard from Pixabay</a></figcaption><p></p>
</figure>
</div>
</div>
<p><br></p>
</section>
<section id="where-to-next" class="level2">
<h2 class="anchored" data-anchor-id="where-to-next">Where to next?</h2>
<p>Compared to the rest of the Apache Arrow project, it’s not so easy to find tutorials and documentation about flight. It’s still a little piecemeal. With that in mind, here’s an annotated reading list that will be helpful if you want to explore flight further:</p>
<ul>
<li><a href="https://arrow.apache.org/blog/2019/10/13/introducing-arrow-flight/">The original announcement of flight</a> by Wes McKinney on the Apache Arrow blog gives a very good overview of the motivation for why flight was introduced.</li>
<li><a href="https://voltrondata.com/news/data-transfer-at-the-speed-of-flight/">Data transfer at the speed of flight</a> by Tom Drabas, Fernanda Foertter, and David Li. This is a blog post on the Voltron Data blog that provides a concrete example of a working flight server written in Python. The Python code I’ve discussed in this post is an elaboration of the content in that post. It’s a good starting point</li>
<li><a href="https://voltrondata.com/news/apache-arrow-flight-primer/">Apache Arrow Flight: A Primer</a> by David Li and Tom Drabas. This is another blog post on the Voltron Data website. This one doesn’t have any working code for you to look at, but it provides a good summary of the technologies that Arrow Flight is built upon. It’s a little intense for novices but is pretty handy for intermediate level users who want to take a peek under the hood.</li>
<li><a href="https://arrow.apache.org/docs/python/flight.html">The Python documentation flight vignette</a> is pretty readable and goes into a moderate amount of detail, but be aware it implicitly assumes some familiarity with remote procedure calls.</li>
<li><a href="https://arrow.apache.org/cookbook/py/flight.html">The Python cookbook for Arrow</a> contains the most thorough worked example I’ve seen anywhere. It’s a little dense for novice users, but it’s still the one of the most comprehensive resources I’ve seen, and the only one that talks about issues like authentication (which I have not discussed at all here!)</li>
<li><a href="https://arrow.apache.org/docs/r/articles/flight.html">The R documentation flight vignette</a> has a succinct overview of how you can use the high-level interface provided by <code>flight_put()</code>, <code>flight_get()</code>, etc. What it doesn’t do (yet?) is discuss the low-level features. At the moment you won’t find a discussion of say <code>client$do_get()</code> and how it relates to <code>flight_get()</code>.</li>
<li>Along similar lines there are some examples in the <a href="https://arrow.apache.org/cookbook/r/flight.html">R cookbook</a>, but they are also quite minimal.</li>
<li>It’s not publicly accessible without purchase, but if you’re willing to spend some money I thoroughly recommend the chapter on Arrow flight in Matt Topol’s book <a href="https://www.packtpub.com/product/in-memory-analytics-with-apache-arrow/9781801071031">In-Memory Analytics with Apache Arrow</a>. I found it really helpful for cementing my own understanding. In addition to the worked examples in Python, C++, and Go, the chapter provides some historical context for understanding the difference between RPC frameworks and REST frameworks, and is also the only resource I’m aware of that goes into detail about how more sophisticated network architectures are supported by flight.</li>
</ul>
<p>Additionally, when digging around in source code, I found it handy to take a look at these parts of the code base:</p>
<ul>
<li><a href="https://github.com/apache/arrow/blob/master/r/inst/demo_flight_server.py">Source code for the R demo server</a></li>
<li><a href="https://github.com/apache/arrow/blob/master/python/examples/flight/server.py">A Python example server</a></li>
<li><a href="https://github.com/apache/arrow/blob/master/python/pyarrow/_flight.pyx">Source code for the pyarrow flight implementation</a></li>
</ul>
<p>Finally, while neither one is ideal as a place to start, once I started getting the hang of what I was doing, I have found it handy to browse through the <a href="https://arrow.apache.org/docs/python/api/flight.html">Python flight API reference pages</a>, and to occasionally dip into the official <a href="https://arrow.apache.org/docs/format/Flight.html">Arrow flight RPC specification</a>. Regarding the latter, my experience was that the images showing how each of the flight methods operates were handy, and the <a href="https://arrow.apache.org/docs/format/Flight.html#protocol-buffer-definitions">comments</a> shown in the in the “protocol buffer definitions” are nice because they’re maybe the clearest verbal description of what each of the flight methods expects as input and what objects they will return.</p>
<p>Happy hunting!</p>
<div class="cell">

</div>
<!--------------- appendices go here ----------------->


</section>


<div id="quarto-appendix" class="default"><section id="footnotes" class="footnotes footnotes-end-of-document" role="doc-endnotes"><h2 class="anchored quarto-appendix-heading">Footnotes</h2>

<ol>
<li id="fn1"><p>All the way back to October 2019, which is like ancient history by Arrow standards. Sigh. This project moves too damned fast to keep pace with it all.<a href="#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn2"><p>One of my favourite things about having a quarto blog is that every post is a notebook. It’s technically possible to “cheat” by including hidden code chunks that execute different code than that shown in the post, but it’s something I do very sparingly and only when there’s some weirdness involved. I’m not doing that here. When this post is rendered, it does start a new instance of the demo server in a different R session: every flight server demonstrated here is in fact running in the background so that the post renders, and server side data are all stored by those other processes. There really is no copy of the <code>pollution_data</code> object in the R session used to render this post. It’s somewhere else, as it bloody well should be.<a href="#fnref2" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn3"><p>Optionally, you can also pass a third “options” argument.<a href="#fnref3" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn4"><p>The examples in this post are simple ones where the server doesn’t actually send a response, so the reader object isn’t used for anything<a href="#fnref4" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn5"><p>People with more experience in Python than I would notice the importance of the <code>b''</code> notation. One thing I didn’t know about Python until recently is that it is quite explicit in specifying how strings are encoded. The <code>b''</code> notation is used to indicate that this is a “byte literal” string. To convert it to utf-8 text, it heeds to be explicitly decoded. I mention this here because later on in the post I’m going to call <code>.encode()</code> and <code>.decode()</code> string methods to switch back and forth between byte literals and utf-8 strings. I’m assuming this is common knowledge among Python users, but coming from R this was a little surprising!<a href="#fnref5" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn6"><p>As I mentioned in an earlier post, all the “strings” that the client and server are using to represent tickets, locations, etc are represented as byte literals. That means that the <code>content</code> argument that gets passed to <code>server_message()</code> will always be a byte literal, not utf-8 encoded. In order to print a message to the console, we need to decode the bytes into utf-8 format, which is why the code for <code>server_message()</code> uses <code>content.decode("utf-8")</code>.<a href="#fnref6" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn7"><p>For fellow Python newbies: if you’re unsure about why <code>list_flights()</code> generates return values with <code>yield</code> rather than <code>return</code>, it’s worth taking a little time to read up on Python iterables and generators. There’s an excellent explanation on <a href="https://stackoverflow.com/questions/231767/what-does-the-yield-keyword-do">this stackoverflow question</a><a href="#fnref7" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
</ol>
</section><section class="quarto-appendix-contents"><h2 class="anchored quarto-appendix-heading">Reuse</h2><div quarto-reuse="quarto-reuse" class="quarto-appendix-contents"><a rel="license" href="https://creativecommons.org/licenses/by/4.0/">https://creativecommons.org/licenses/by/4.0/</a></div></section><section class="quarto-appendix-contents"><h2 class="anchored quarto-appendix-heading">Citation</h2><div><div class="quarto-appendix-secondary-label">BibTeX citation:</div><pre class="sourceCode code-with-copy quarto-appendix-bibtex"><code class="sourceCode bibtex">@online{navarro2022,
  author = {Danielle Navarro},
  editor = {},
  title = {Building an {Arrow} {Flight} Server},
  date = {2022-09-23},
  url = {https://blog.djnavarro.net/posts/2022-09-23_flight},
  langid = {en}
}
</code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre><div class="quarto-appendix-secondary-label">For attribution, please cite this work as:</div><div id="ref-navarro2022" class="csl-entry quarto-appendix-citeas" role="doc-biblioentry">
Danielle Navarro. 2022. <span>“Building an Arrow Flight Server.”</span>
September 23, 2022. <a href="https://blog.djnavarro.net/posts/2022-09-23_flight">https://blog.djnavarro.net/posts/2022-09-23_flight</a>.
</div></div></section></div></main> <!-- /main -->
<!-- plausible -->
<script async="" defer="" data-domain="blog.djnavarro.net" src="https://plausible.io/js/plausible.js"></script>
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    setTimeout(function() {
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const cites = ref.parentNode.getAttribute('data-cites').split(' ');
    tippyHover(ref, function() {
      var popup = window.document.createElement('div');
      cites.forEach(function(cite) {
        var citeDiv = window.document.createElement('div');
        citeDiv.classList.add('hanging-indent');
        citeDiv.classList.add('csl-entry');
        var biblioDiv = window.document.getElementById('ref-' + cite);
        if (biblioDiv) {
          citeDiv.innerHTML = biblioDiv.innerHTML;
        }
        popup.appendChild(citeDiv);
      });
      return popup.innerHTML;
    });
  }
});
</script>
</div> <!-- /content -->



</body></html>