<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.433">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Danielle Navarro">
<meta name="dcterms.date" content="2023-07-15">
<meta name="description" content="Another small step along the path to Bayesian pharmacometrics">

<title>Notes from a data witch - Getting started with Torsten</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<style>

      .quarto-title-block .quarto-title-banner {
        background: #eeeeee;
      }
</style>

  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<link rel="stylesheet" href="../../styles.css">
<meta property="og:title" content="Notes from a data witch - Getting started with Torsten">
<meta property="og:description" content="Another small step along the path to Bayesian pharmacometrics">
<meta property="og:image" content="https://blog.djnavarro.net/posts/2023-07-15_torsten/torsten-crop.png">
<meta property="og:site-name" content="Notes from a data witch">
<meta property="og:image:height" content="500">
<meta property="og:image:width" content="500">
<meta property="og:image:alt" content="Hand-drawn scientific diagram from 1937 showing 'blood circulation', 'tissue boundaries', and adding pharamacometric notation">
<meta name="twitter:title" content="Notes from a data witch - Getting started with Torsten">
<meta name="twitter:description" content="Another small step along the path to Bayesian pharmacometrics">
<meta name="twitter:image" content="https://blog.djnavarro.net/posts/2023-07-15_torsten/torsten-crop.png">
<meta name="twitter:creator" content="@djnavarro">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image-height" content="500">
<meta name="twitter:image-width" content="500">
<meta name="twitter:image:alt" content="Hand-drawn scientific diagram from 1937 showing 'blood circulation', 'tissue boundaries', and adding pharamacometric notation">
</head>

<body class="floating nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../index.html" rel="" target="">
 <span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../index.xml" rel="" target="">
 <span class="menu-text">RSS</span></a>
  </li>  
</ul>
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-sites" role="button" data-bs-toggle="dropdown" aria-expanded="false" rel="" target="">
 <span class="menu-text">Sites</span>
    </a>
    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="nav-menu-sites">    
        <li>
    <a class="dropdown-item" href="https://djnavarro.net" rel="" target="">
 <span class="dropdown-text">Homepage</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="https://blog.djnavarro.net" rel="" target="">
 <span class="dropdown-text">Data science blog</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="https://art.djnavarro.net" rel="" target="">
 <span class="dropdown-text">Generative art</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="https://papers.djnavarro.net" rel="" target="">
 <span class="dropdown-text">Academic papers</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="https://djnavarro.net/sites" rel="" target="">
 <span class="dropdown-text">More…</span></a>
  </li>  
    </ul>
  </li>
</ul>
            <div class="quarto-navbar-tools">
</div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default toc-left page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <h1 class="title">Getting started with Torsten</h1>
                  <div>
        <div class="description">
          Another small step along the path to Bayesian pharmacometrics
        </div>
      </div>
                          <div class="quarto-categories">
                <div class="quarto-category">R</div>
                <div class="quarto-category">Stan</div>
                <div class="quarto-category">Torsten</div>
                <div class="quarto-category">Pharmacometrics</div>
              </div>
                  </div>
  </div>
    
  
  <div class="quarto-title-meta">

      <div>
      <div class="quarto-title-meta-heading">Author</div>
      <div class="quarto-title-meta-contents">
               <p><a href="https://djnavarro.net">Danielle Navarro</a> <a href="https://orcid.org/0000-0001-7648-6578" class="quarto-title-author-orcid"> <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAA2ZpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMC1jMDYwIDYxLjEzNDc3NywgMjAxMC8wMi8xMi0xNzozMjowMCAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wTU09Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9tbS8iIHhtbG5zOnN0UmVmPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvc1R5cGUvUmVzb3VyY2VSZWYjIiB4bWxuczp4bXA9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC8iIHhtcE1NOk9yaWdpbmFsRG9jdW1lbnRJRD0ieG1wLmRpZDo1N0NEMjA4MDI1MjA2ODExOTk0QzkzNTEzRjZEQTg1NyIgeG1wTU06RG9jdW1lbnRJRD0ieG1wLmRpZDozM0NDOEJGNEZGNTcxMUUxODdBOEVCODg2RjdCQ0QwOSIgeG1wTU06SW5zdGFuY2VJRD0ieG1wLmlpZDozM0NDOEJGM0ZGNTcxMUUxODdBOEVCODg2RjdCQ0QwOSIgeG1wOkNyZWF0b3JUb29sPSJBZG9iZSBQaG90b3Nob3AgQ1M1IE1hY2ludG9zaCI+IDx4bXBNTTpEZXJpdmVkRnJvbSBzdFJlZjppbnN0YW5jZUlEPSJ4bXAuaWlkOkZDN0YxMTc0MDcyMDY4MTE5NUZFRDc5MUM2MUUwNEREIiBzdFJlZjpkb2N1bWVudElEPSJ4bXAuZGlkOjU3Q0QyMDgwMjUyMDY4MTE5OTRDOTM1MTNGNkRBODU3Ii8+IDwvcmRmOkRlc2NyaXB0aW9uPiA8L3JkZjpSREY+IDwveDp4bXBtZXRhPiA8P3hwYWNrZXQgZW5kPSJyIj8+84NovQAAAR1JREFUeNpiZEADy85ZJgCpeCB2QJM6AMQLo4yOL0AWZETSqACk1gOxAQN+cAGIA4EGPQBxmJA0nwdpjjQ8xqArmczw5tMHXAaALDgP1QMxAGqzAAPxQACqh4ER6uf5MBlkm0X4EGayMfMw/Pr7Bd2gRBZogMFBrv01hisv5jLsv9nLAPIOMnjy8RDDyYctyAbFM2EJbRQw+aAWw/LzVgx7b+cwCHKqMhjJFCBLOzAR6+lXX84xnHjYyqAo5IUizkRCwIENQQckGSDGY4TVgAPEaraQr2a4/24bSuoExcJCfAEJihXkWDj3ZAKy9EJGaEo8T0QSxkjSwORsCAuDQCD+QILmD1A9kECEZgxDaEZhICIzGcIyEyOl2RkgwAAhkmC+eAm0TAAAAABJRU5ErkJggg=="></a></p>
            </div>
    </div>
      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">July 15, 2023</p>
      </div>
    </div>
    
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal sidebar-navigation floating overflow-auto">
    <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#installation" id="toc-installation" class="nav-link active" data-scroll-target="#installation">Installation</a></li>
  <li><a href="#the-data-file" id="toc-the-data-file" class="nav-link" data-scroll-target="#the-data-file">The data file</a></li>
  <li><a href="#the-model-file" id="toc-the-model-file" class="nav-link" data-scroll-target="#the-model-file">The model file</a></li>
  <li><a href="#where-can-i-find-the-analytical-solutions" id="toc-where-can-i-find-the-analytical-solutions" class="nav-link" data-scroll-target="#where-can-i-find-the-analytical-solutions">Where can I find the analytical solutions?</a></li>
  <li><a href="#useful-resources" id="toc-useful-resources" class="nav-link" data-scroll-target="#useful-resources">Useful resources</a></li>
  <li><a href="#done" id="toc-done" class="nav-link" data-scroll-target="#done">Done!</a></li>
  </ul>
</nav>
</nav>
<div id="quarto-sidebar-glass" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
    </div>
<!-- main -->
<main class="content quarto-banner-title-block page-columns page-full" id="quarto-document-content">




<!--------------- my typical setup ----------------->
<!--------------- post begins here ----------------->
<p>In recent months I’ve been gradually teaching myself pharmacometrics, and <a href="https://blog.djnavarro.net/category/pharmacometrics">writing blog posts as I go</a>. I started out writing about relatively simple methods for <a href="../../posts/2023-04-26_non-compartmental-analysis/">non-compartmental analysis</a>, moved on to talking about <a href="../../posts/2023-05-16_stan-ode/">compartmental analysis with Stan</a>, and then to <a href="../../posts/2023-06-10_pop-pk-models/">population pharmacokinetic models in Stan</a>. Now it feels like time for me to move on to looking at <a href="https://metrumresearchgroup.github.io/Torsten/">Torsten</a>.</p>
<p>What’s Torsten, you ask?</p>
<p>Torsten is essentially a forked copy of <a href="https://mc-stan.org/">Stan</a> that has a collection of functions added that can be useful in pharmacometric analyses. As described by <a href="https://doi.org/10.1002/psp4.12926">Elmokadem et al (2023)</a>:</p>
<blockquote class="blockquote">
<p>Torsten is a library of Stan functions built to facilitate analysis of pharmacometric data … [It] contains functions to build specific linear compartmental models as one and two-compartment models with first-order absorption into the central compartment, general linear models that can be expressed as a system of linear ordinary differential equations (ODEs), general compartmental models that can be expressed as a system of ODEs.</p>
</blockquote>
<p>The name “Torsten” refers to Torsten Teorell, described as the <a href="https://doi.org/10.3109/03009739509178895">father of pharmacokinetics</a>. The preview image of this post is taken from the figures in a 1937 paper by Teorell:</p>
<p><img src="torsten-figs.png" class="img-fluid"></p>
<p>I do like knowing where the names of things come from, and the history to different disciplines. But to be fair that’s not the purpose of this post, so let’s set the history to one side and take a look at the software. The website is quite clear that Torsten is currently (as of version 0.89rc) a prototype:</p>
<blockquote class="blockquote">
<p>WARNING: The current version of Torsten is a prototype. It is being released for review and comment, and to support limited research applications. It has not been rigorously tested and should not be used for critical applications without further testing or cross-checking by comparison with other methods. We encourage interested users to try Torsten out and are happy to assist. Please report issues, bugs, and feature requests on our GitHub page.</p>
</blockquote>
<p>My goals in this post are modest:</p>
<ul>
<li><a href="#installation">Install Torsten</a> and make sure it’s working</li>
<li>Understand the <a href="#the-data-file">data format</a> expected by the Torsten-specific solvers</li>
<li>Work my way through the <a href="#the-model-file">model file</a> for simple two-compartment analysis</li>
<li>Work out what’s going on regarding <a href="#where-can-i-find-the-analytical-solutions">analytic solutions in Torsten</a></li>
</ul>
<p>As usual, the notes are mostly intended for the benefit of future-me, who absolutely will have forgotten all this in a week from now. But it’s possible that other people may find them helpful too I suppose. Anyway, here goes…</p>
<section id="installation" class="level2">
<h2 class="anchored" data-anchor-id="installation">Installation</h2>
<p>Installing Torsten starts by cloning the <a href="https://github.com/metrumresearchgroup/Torsten">GitHub repository</a>. Just recently I’ve gotten into the habit of using the <a href="https://cli.github.com/">GitHub command line tool</a> for tasks like this, so the command I used was this:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span> ~/GitHub</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="ex">gh</span> repo clone metrumresearchgroup/Torsten</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>But really, anything that clones a repository will work.</p>
<p>Once you have a copy of the repo, you can build Torsten in any number of ways. Given that I’m usually working from R, the most convenient way for me to do this is with the cmdstanr package. If you don’t have the cmdstanr package, you need to install it first. It’s not on CRAN but you can install it by adding the Stan repository to the <code>repos</code> path when calling <code>remotes::install_cran()</code>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>remotes<span class="sc">::</span><span class="fu">install_cran</span>(</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>    <span class="at">pkgs =</span> <span class="st">"cmdstanr"</span>, </span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">repos =</span> <span class="fu">c</span>(</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>        <span class="st">"https://mc-stan.org/r-packages/"</span>, </span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>        <span class="fu">getOption</span>(<span class="st">"repos"</span>)</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Next, you need to make sure that cmdstanr uses the Torsten version of Stan, and not any other version of Stan that you might have installed on your system. This is important because Torsten supplies various functions that we’ll need, and especially important in my case because I also have a “vanilla” copy of Stan installed elsewhere on my laptop. Here’s how I do that:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>torsten_dir <span class="ot">&lt;-</span> <span class="st">"~/GitHub/Torsten"</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>cmdstanr<span class="sc">::</span><span class="fu">set_cmdstan_path</span>(fs<span class="sc">::</span><span class="fu">path</span>(torsten_dir, <span class="st">"cmdstan"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>CmdStan path set to: /home/danielle/GitHub/Torsten/cmdstan</code></pre>
</div>
</div>
<p>In a moment, I’m going to try to compile a Stan/Torsten model (and indeed compile Torsten itself), so it’s important to make sure the C++ toolchain is set up properly. If you already have C++ compilers set up on your machine (which I do) then you probably don’t need to do anything special to make sure that everything compiles properly, but just to be safe we’ll check:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>cmdstanr<span class="sc">::</span><span class="fu">check_cmdstan_toolchain</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>The C++ toolchain required for CmdStan is setup properly!</code></pre>
</div>
</div>
<p>Excellent. Now comes the acid test: let’s see if we can use Torsten to build and sample from a Stan model that specifically requires Torsten functions. I’m following the <a href="https://metrumresearchgroup.github.io/Torsten/installation/#testing">instructions on the installation page</a> here, more or less. But I’m going to walk through the process a little more slowly than those instructions do.</p>
<p>The first step here is to compile the Stan model. The very first time you do this, it can take a moderately long time because two things are happening:</p>
<ul>
<li>First, the compiler need to compile the modified copy of Stan that Torsten ships with. That takes a while, but fortunately it only has to be done once.</li>
<li>Second, the compiler needs to compile the “pk2cpt” model itself. This is fairly fast. This compilation step only happens when the model binary is out of date.</li>
</ul>
<p>Fortunately for me I’ve already done this step once before and I have both binaries compiled already so it all happens instantaneously. In any case, here’s the code:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>model_dir <span class="ot">&lt;-</span> fs<span class="sc">::</span><span class="fu">path</span>(torsten_dir, <span class="st">"example-models"</span>, <span class="st">"pk2cpt"</span>)</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>model_src <span class="ot">&lt;-</span> fs<span class="sc">::</span><span class="fu">path</span>(model_dir, <span class="st">"pk2cpt.stan"</span>)</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>model <span class="ot">&lt;-</span> cmdstanr<span class="sc">::</span><span class="fu">cmdstan_model</span>(model_src)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The key thing to note here is that the “pk2cpt.stan” source code relies on Torsten-specific functions that don’t exist in vanilla Stan. It won’t work if you’re not using the Torsten version of Stan. The mere fact that it compiles is itself telling us that it’s all configured correctly.</p>
<p>So now we fit the model:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>model_fit <span class="ot">&lt;-</span> model<span class="sc">$</span><span class="fu">sample</span>(</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> fs<span class="sc">::</span><span class="fu">path</span>(model_dir, <span class="st">"pk2cpt.data.R"</span>),</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">init =</span> fs<span class="sc">::</span><span class="fu">path</span>(model_dir, <span class="st">"pk2cpt.init.R"</span>),</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">seed =</span> <span class="dv">123</span>,</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">chains =</span> <span class="dv">4</span>,</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">parallel_chains =</span> <span class="dv">2</span>,</span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">refresh =</span> <span class="dv">500</span>,</span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">show_messages =</span> <span class="cn">FALSE</span></span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Running MCMC with 4 chains, at most 2 in parallel...

Chain 1 Iteration:    1 / 2000 [  0%]  (Warmup) 
Chain 2 Iteration:    1 / 2000 [  0%]  (Warmup) 
Chain 1 Iteration:  500 / 2000 [ 25%]  (Warmup) 
Chain 2 Iteration:  500 / 2000 [ 25%]  (Warmup) 
Chain 1 Iteration: 1000 / 2000 [ 50%]  (Warmup) 
Chain 1 Iteration: 1001 / 2000 [ 50%]  (Sampling) 
Chain 2 Iteration: 1000 / 2000 [ 50%]  (Warmup) 
Chain 2 Iteration: 1001 / 2000 [ 50%]  (Sampling) 
Chain 1 Iteration: 1500 / 2000 [ 75%]  (Sampling) 
Chain 2 Iteration: 1500 / 2000 [ 75%]  (Sampling) 
Chain 1 Iteration: 2000 / 2000 [100%]  (Sampling) 
Chain 1 finished in 7.7 seconds.
Chain 2 Iteration: 2000 / 2000 [100%]  (Sampling) 
Chain 3 Iteration:    1 / 2000 [  0%]  (Warmup) 
Chain 2 finished in 7.7 seconds.
Chain 4 Iteration:    1 / 2000 [  0%]  (Warmup) 
Chain 3 Iteration:  500 / 2000 [ 25%]  (Warmup) 
Chain 4 Iteration:  500 / 2000 [ 25%]  (Warmup) 
Chain 4 Iteration: 1000 / 2000 [ 50%]  (Warmup) 
Chain 4 Iteration: 1001 / 2000 [ 50%]  (Sampling) 
Chain 3 Iteration: 1000 / 2000 [ 50%]  (Warmup) 
Chain 3 Iteration: 1001 / 2000 [ 50%]  (Sampling) 
Chain 4 Iteration: 1500 / 2000 [ 75%]  (Sampling) 
Chain 3 Iteration: 1500 / 2000 [ 75%]  (Sampling) 
Chain 4 Iteration: 2000 / 2000 [100%]  (Sampling) 
Chain 4 finished in 7.5 seconds.
Chain 3 Iteration: 2000 / 2000 [100%]  (Sampling) 
Chain 3 finished in 8.0 seconds.

All 4 chains finished successfully.
Mean chain execution time: 7.7 seconds.
Total execution time: 15.7 seconds.</code></pre>
</div>
</div>
<p>When doing this interactively, you should set <code>show_messages = TRUE</code> so that you can see the “informational messages”. As I’m coming to learn, it’s grossly typical of ODE models that you get a few warning messages during the early stages of warmup. But Stan messages tend to be quite good, and in this case they’re quite helpful in reassuring us that there’s not a problem in this instance (they occur early while the MCMC sampler is in a very weird part of the space and then disappear). I’ve suppressed them here because they make the quarto blog output messier than it needs to be. All good.</p>
<p>To draw a pretty picture showing the posterior distribution of the clearance rate parameter for this model (CL), we can do this:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="co"># remotes::install_cran("bayesplot")</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>bayesplot<span class="sc">::</span><span class="fu">mcmc_dens_overlay</span>(model_fit<span class="sc">$</span><span class="fu">draws</span>(<span class="st">"CL"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/prettiness-pk2cpt-model-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>That looks right. Torsten is configured correctly, the model compiles, the sampler works, and the posterior distributions plotted here mirror the ones that are secretly tucked away in an output file here:</p>
<pre><code>[torsten-directory]/example-models/pk2cpt/deliv/figure/density.pdf</code></pre>
<p>My first goal is accomplished. We are good to go!</p>
</section>
<section id="the-data-file" class="level2">
<h2 class="anchored" data-anchor-id="the-data-file">The data file</h2>
<p>Okay, so now that I’ve succeeded in doing <em>something</em> with Torsten, it would be nice to have a better sense of what precisely I’ve done. Obviously<a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a> I’ve run a Stan model of some kind on some data set, but the Torsten documentation doesn’t really go into a lot of detail here.</p>
<p>I’ll start by taking a look at the data. I’ve cached a copy of the data file along with this post, located at <code>./example/pk2cpt_data.R</code> relative to this quarto document. The file defines the variables needed by Stan as R vectors, but to make my life a little easier I’ll organise them into a tibble that resembles a NONMEM-style <a href="https://metrumresearchgroup.github.io/Torsten/function/events/">event schedule</a>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>(<span class="st">"./example/pk2cpt_data.R"</span>)</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>pk2cpt_data <span class="ot">&lt;-</span> tibble<span class="sc">::</span><span class="fu">tibble</span>(</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">cmt =</span> cmt,</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">evid =</span> evid,</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">addl =</span> addl,</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">ss =</span> ss,</span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">amt =</span> amt, </span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">time =</span> time,</span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">rate =</span> rate,</span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">ii =</span> ii,</span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">dv =</span> <span class="cn">NA</span></span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a>pk2cpt_data<span class="sc">$</span>dv[iObs] <span class="ot">&lt;-</span> cObs</span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a>pk2cpt_data</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 54 × 9
     cmt  evid  addl    ss   amt  time  rate    ii    dv
   &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
 1     1     1    14     0 80000 0         0    12   NA 
 2     2     0     0     0     0 0.083     0     0  359.
 3     2     0     0     0     0 0.167     0     0  663.
 4     2     0     0     0     0 0.25      0     0 1106.
 5     2     0     0     0     0 0.5       0     0 1185.
 6     2     0     0     0     0 0.75      0     0 1802.
 7     2     0     0     0     0 1         0     0 2296.
 8     2     0     0     0     0 1.5       0     0 2008.
 9     2     0     0     0     0 2         0     0 2001.
10     2     0     0     0     0 3         0     0 1115.
# ℹ 44 more rows</code></pre>
</div>
</div>
<p>I am firmly of the opinion that these aren’t good variable names, but they are completely standard in the field so I’m just going to have to memorise them. To that end, and despite the fact that I have written a version of this about a dozen times already, here’s what each of those variables refers to:</p>
<ul>
<li><code>cmt</code>: compartment number to which the row refers</li>
<li><code>evid</code>: event id (0=observation, 1=dose, 2=other)</li>
<li><code>addl</code>: number of additional identical doses given</li>
<li><code>ss</code>: is it steady-state dosing? (0=false, 1=true)</li>
<li><code>amt</code>: dose amount administered at this time</li>
<li><code>time</code>: time of observation/administration</li>
<li><code>rate</code>: rate of drug infusion (=0 for bolus administration)</li>
<li><code>ii</code>: interdose interval: time between additional doses</li>
<li><code>dv</code>: the dependent variable (observed concentration)</li>
</ul>
<p>The key point here is that (unlike in my previous post where I used a slightly different data structure in my bespoke Stan model), Torsten functions expect input variables that look very similar to those used in NONMEM. Fair enough.</p>
<p>Now that I have a sense of the data structure, let’s plot it to see what the observed pharmacokinetic function looks like. In the plot below, the dotted vertical lines mark the moments at which additional doses were administered. The circular markers connected by solid lines represent the observed drug concentrations:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>pk2cpt_data <span class="sc">|&gt;</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">filter</span>(evid <span class="sc">==</span> <span class="dv">0</span>) <span class="sc">|&gt;</span></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">ggplot</span>(ggplot2<span class="sc">::</span><span class="fu">aes</span>(time, dv)) <span class="sc">+</span></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">geom_vline</span>(</span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>        <span class="at">xintercept =</span> (<span class="dv">0</span><span class="sc">:</span><span class="dv">14</span>) <span class="sc">*</span> <span class="dv">12</span>,</span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>        <span class="at">color =</span> <span class="st">"grey50"</span>,</span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>        <span class="at">linetype =</span> <span class="st">"dotted"</span></span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">geom_path</span>() <span class="sc">+</span> </span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">scale_y_continuous</span>(<span class="at">breaks =</span> (<span class="dv">0</span><span class="sc">:</span><span class="dv">3</span>) <span class="sc">*</span> <span class="dv">1000</span>) <span class="sc">+</span></span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Time"</span>, <span class="at">y =</span> <span class="st">"Concentration"</span>) <span class="sc">+</span></span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">theme</span>(<span class="at">panel.grid =</span> ggplot2<span class="sc">::</span><span class="fu">element_blank</span>())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/pk2cpt-plot-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>The solid lines connecting the dots are a bit misleading. For the first, second, and last doses, measurements are taken regularly enough that you can see the rise and fall of drug concentration associated with each dose. For all other doses, however, there’s only a single measurement taken immediately before the dose is administered, with the result that it looks like a fairly flat function through the middle of the data. This makes total sense from an experimental design point of view, of course, it’s just important to remember that there’s a good reason why the observed data has this slightly odd shape.</p>
<p>Objective #2 accomplished. Time to move to the next one.</p>
</section>
<section id="the-model-file" class="level2 page-columns page-full">
<h2 class="anchored" data-anchor-id="the-model-file">The model file</h2>
<p>Let’s take a look at the source code for the Torsten/Stan model that I fit in the last section. For the sake of my sanity I’m not going to use the actual .stan file that Torsten distributes. In the original version there’s no explanation of what the parameters mean or what the data variables are.</p>
<p>I’m about 99% certain that the reason for this is that among pharmacometricians it is “understood” that everyone already knows the notational specifications used in <a href="https://en.wikipedia.org/wiki/NONMEM">NONMEM</a>, and consequently nobody bothers to say what those terms mean. To be honest I find it a little frustrating. If you want new users to consider Torsten as a viable modelling tool for pharmacometrics, I think it’s a bad idea to make it a <em>prerequisite</em> that new users already know NONMEM. But as I am Queen only of this blog and not of statistics generally, and my guess is that the primary target audience for Torsten are pharmacometricians who have already used NONMEM for many years, I’ll restrict myself to mild grumbling and simply fix the comments so that the “hidden curriculum” aspect to all this is no longer quite so hidden. Nevertheless, given that the vast majority of my readership belong to the 99.99% of statisticians and data scientists who aren’t professional pharamacometricians,<a href="#fn2" class="footnote-ref" id="fnref2" role="doc-noteref"><sup>2</sup></a> I’ve added a lot more annotation to my version of the file:</p>
<div class="cell column-body-outset" data-file="example/pk2cpt.stan" data-output.var="pk2cpt">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>./example/pk2cpt.stan</strong></pre>
</div>
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode numberSource stan number-lines code-with-copy"><code class="sourceCode stan"><span id="cb15-1"><a href="#cb15-1"></a><span class="co">// Two compartment model using Torsten analytical solver </span></span>
<span id="cb15-2"><a href="#cb15-2"></a></span>
<span id="cb15-3"><a href="#cb15-3"></a><span class="kw">data</span>{</span>
<span id="cb15-4"><a href="#cb15-4"></a>  <span class="dt">int</span>&lt;<span class="kw">lower</span> = <span class="dv">1</span>&gt; nt;                <span class="co">// number of events</span></span>
<span id="cb15-5"><a href="#cb15-5"></a>  <span class="dt">int</span>&lt;<span class="kw">lower</span> = <span class="dv">1</span>&gt; nObs;              <span class="co">// number of observations</span></span>
<span id="cb15-6"><a href="#cb15-6"></a>  <span class="dt">array</span>[nObs] <span class="dt">int</span>&lt;<span class="kw">lower</span> = <span class="dv">1</span>&gt; iObs;  <span class="co">// indices of observation events</span></span>
<span id="cb15-7"><a href="#cb15-7"></a>  </span>
<span id="cb15-8"><a href="#cb15-8"></a>  <span class="co">// NONMEM data</span></span>
<span id="cb15-9"><a href="#cb15-9"></a>  <span class="dt">array</span>[nt] <span class="dt">int</span>&lt;<span class="kw">lower</span> = <span class="dv">1</span>&gt; cmt; <span class="co">// compartment number</span></span>
<span id="cb15-10"><a href="#cb15-10"></a>  <span class="dt">array</span>[nt] <span class="dt">int</span> evid;           <span class="co">// event id (0=observation, 1=dose, 2=other)</span></span>
<span id="cb15-11"><a href="#cb15-11"></a>  <span class="dt">array</span>[nt] <span class="dt">int</span> addl;           <span class="co">// number of additional identical doses given</span></span>
<span id="cb15-12"><a href="#cb15-12"></a>  <span class="dt">array</span>[nt] <span class="dt">int</span> ss;             <span class="co">// is it steady-state dosing? (0=false, 1=true)</span></span>
<span id="cb15-13"><a href="#cb15-13"></a>  <span class="dt">array</span>[nt] <span class="dt">real</span> amt;           <span class="co">// dose amount administered at this time</span></span>
<span id="cb15-14"><a href="#cb15-14"></a>  <span class="dt">array</span>[nt] <span class="dt">real</span> time;          <span class="co">// time of observation/administration </span></span>
<span id="cb15-15"><a href="#cb15-15"></a>  <span class="dt">array</span>[nt] <span class="dt">real</span> rate;          <span class="co">// rate of drug infusion (0 for bolus administration)</span></span>
<span id="cb15-16"><a href="#cb15-16"></a>  <span class="dt">array</span>[nt] <span class="dt">real</span> ii;            <span class="co">// interdose interval: time between additional doses </span></span>
<span id="cb15-17"><a href="#cb15-17"></a>  </span>
<span id="cb15-18"><a href="#cb15-18"></a>  <span class="dt">vector</span>&lt;<span class="kw">lower</span> = <span class="dv">0</span>&gt;[nObs] cObs;  <span class="co">// observed concentration (the dv)</span></span>
<span id="cb15-19"><a href="#cb15-19"></a>}</span>
<span id="cb15-20"><a href="#cb15-20"></a></span>
<span id="cb15-21"><a href="#cb15-21"></a><span class="kw">transformed data</span>{</span>
<span id="cb15-22"><a href="#cb15-22"></a>  <span class="dt">vector</span>[nObs] logCObs = log(cObs);</span>
<span id="cb15-23"><a href="#cb15-23"></a>  <span class="dt">int</span> nTheta = <span class="dv">5</span>;  <span class="co">// number of ODE parameters describing the pharmacokinetic function</span></span>
<span id="cb15-24"><a href="#cb15-24"></a>  <span class="dt">int</span> nCmt = <span class="dv">3</span>;    <span class="co">// number of compartments in model (1=gut, 2=central, 3=peripheral)</span></span>
<span id="cb15-25"><a href="#cb15-25"></a>}</span>
<span id="cb15-26"><a href="#cb15-26"></a></span>
<span id="cb15-27"><a href="#cb15-27"></a><span class="kw">parameters</span>{</span>
<span id="cb15-28"><a href="#cb15-28"></a>  <span class="dt">real</span>&lt;<span class="kw">lower</span> = <span class="dv">0</span>&gt; CL;    <span class="co">// clearance rate from central compartment</span></span>
<span id="cb15-29"><a href="#cb15-29"></a>  <span class="dt">real</span>&lt;<span class="kw">lower</span> = <span class="dv">0</span>&gt; Q;     <span class="co">// intercompartmental clearance rate</span></span>
<span id="cb15-30"><a href="#cb15-30"></a>  <span class="dt">real</span>&lt;<span class="kw">lower</span> = <span class="dv">0</span>&gt; V1;    <span class="co">// volume of distribution, central compartment</span></span>
<span id="cb15-31"><a href="#cb15-31"></a>  <span class="dt">real</span>&lt;<span class="kw">lower</span> = <span class="dv">0</span>&gt; V2;    <span class="co">// volume of distribution, peripheral compartment</span></span>
<span id="cb15-32"><a href="#cb15-32"></a>  <span class="dt">real</span>&lt;<span class="kw">lower</span> = <span class="dv">0</span>&gt; ka;    <span class="co">// absorption rate constant from gut to central </span></span>
<span id="cb15-33"><a href="#cb15-33"></a>  <span class="dt">real</span>&lt;<span class="kw">lower</span> = <span class="dv">0</span>&gt; sigma; <span class="co">// standard deviation of measurement error on log-scale</span></span>
<span id="cb15-34"><a href="#cb15-34"></a>}</span>
<span id="cb15-35"><a href="#cb15-35"></a></span>
<span id="cb15-36"><a href="#cb15-36"></a><span class="kw">transformed parameters</span>{</span>
<span id="cb15-37"><a href="#cb15-37"></a>  <span class="dt">array</span>[nTheta] <span class="dt">real</span> theta;        <span class="co">// parameters of the pharmacokinetic function</span></span>
<span id="cb15-38"><a href="#cb15-38"></a>  <span class="dt">matrix</span>&lt;<span class="kw">lower</span> = <span class="dv">0</span>&gt;[nCmt, nt] x;   <span class="co">// drug amounts in each compartment over time</span></span>
<span id="cb15-39"><a href="#cb15-39"></a></span>
<span id="cb15-40"><a href="#cb15-40"></a>  <span class="co">// predicted drug concentrations in the central compartment</span></span>
<span id="cb15-41"><a href="#cb15-41"></a>  <span class="dt">row_vector</span>&lt;<span class="kw">lower</span> = <span class="dv">0</span>&gt;[nt] cHat;  <span class="co">// row vector, one element per event</span></span>
<span id="cb15-42"><a href="#cb15-42"></a>  <span class="dt">vector</span>&lt;<span class="kw">lower</span> = <span class="dv">0</span>&gt;[nObs] cHatObs; <span class="co">// column vector, one element per *observation*</span></span>
<span id="cb15-43"><a href="#cb15-43"></a></span>
<span id="cb15-44"><a href="#cb15-44"></a>  <span class="co">// bundle pharmacokinetic parameters into a vector</span></span>
<span id="cb15-45"><a href="#cb15-45"></a>  theta[<span class="dv">1</span>] = CL;</span>
<span id="cb15-46"><a href="#cb15-46"></a>  theta[<span class="dv">2</span>] = Q;</span>
<span id="cb15-47"><a href="#cb15-47"></a>  theta[<span class="dv">3</span>] = V1;</span>
<span id="cb15-48"><a href="#cb15-48"></a>  theta[<span class="dv">4</span>] = V2;</span>
<span id="cb15-49"><a href="#cb15-49"></a>  theta[<span class="dv">5</span>] = ka;</span>
<span id="cb15-50"><a href="#cb15-50"></a></span>
<span id="cb15-51"><a href="#cb15-51"></a>  <span class="co">// compute the pharmacokinetic function (drug amounts in all compartments)</span></span>
<span id="cb15-52"><a href="#cb15-52"></a>  x = pmx_solve_twocpt(time, amt, rate, ii, evid, cmt, addl, ss, theta);</span>
<span id="cb15-53"><a href="#cb15-53"></a></span>
<span id="cb15-54"><a href="#cb15-54"></a>  cHat = x[<span class="dv">2</span>, :] ./ V1;  <span class="co">// compute drug concentrations in central compartment</span></span>
<span id="cb15-55"><a href="#cb15-55"></a>  cHatObs = cHat'[iObs]; <span class="co">// transform to column vector &amp; keep relevant cells only</span></span>
<span id="cb15-56"><a href="#cb15-56"></a>}</span>
<span id="cb15-57"><a href="#cb15-57"></a></span>
<span id="cb15-58"><a href="#cb15-58"></a><span class="kw">model</span>{</span>
<span id="cb15-59"><a href="#cb15-59"></a>  <span class="co">// informative prior</span></span>
<span id="cb15-60"><a href="#cb15-60"></a>  CL ~ lognormal(log(<span class="dv">10</span>), <span class="fl">0.25</span>);</span>
<span id="cb15-61"><a href="#cb15-61"></a>  Q ~ lognormal(log(<span class="dv">15</span>), <span class="fl">0.5</span>);</span>
<span id="cb15-62"><a href="#cb15-62"></a>  V1 ~ lognormal(log(<span class="dv">35</span>), <span class="fl">0.25</span>);</span>
<span id="cb15-63"><a href="#cb15-63"></a>  V2 ~ lognormal(log(<span class="dv">105</span>), <span class="fl">0.5</span>);</span>
<span id="cb15-64"><a href="#cb15-64"></a>  ka ~ lognormal(log(<span class="fl">2.5</span>), <span class="dv">1</span>);</span>
<span id="cb15-65"><a href="#cb15-65"></a>  sigma ~ cauchy(<span class="dv">0</span>, <span class="dv">1</span>);</span>
<span id="cb15-66"><a href="#cb15-66"></a></span>
<span id="cb15-67"><a href="#cb15-67"></a>  <span class="co">// measurement errors are log-normally distributed</span></span>
<span id="cb15-68"><a href="#cb15-68"></a>  logCObs ~ normal(log(cHatObs), sigma);</span>
<span id="cb15-69"><a href="#cb15-69"></a>}</span>
<span id="cb15-70"><a href="#cb15-70"></a></span>
<span id="cb15-71"><a href="#cb15-71"></a><span class="kw">generated quantities</span>{</span>
<span id="cb15-72"><a href="#cb15-72"></a>  <span class="dt">array</span>[nObs] <span class="dt">real</span> cObsPred; <span class="co">// simulated observations</span></span>
<span id="cb15-73"><a href="#cb15-73"></a>  <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span>:nObs) {</span>
<span id="cb15-74"><a href="#cb15-74"></a>    cObsPred[i] = exp(normal_rng(log(cHatObs[i]), sigma));</span>
<span id="cb15-75"><a href="#cb15-75"></a>  }</span>
<span id="cb15-76"><a href="#cb15-76"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<p>Even with the additional commenting, it’s still a little impenetrable unless you’re a pharmacometric insider, because the pharmacokinetic model is not represented anywhere in this Stan code. It’s simply understood that this is a two-compartment model by virtue of the fact that the <code>pmx_solve_twocpt()</code> function is called, and all the details of what that <em>means</em> have been rendered invisible in the process.</p>
<p>That’s not wrong from the Torsten perspective – and probably necessary – but at the same time it makes the code difficult to follow for anyone who isn’t a pharmacometrician. So let’s make it a bit more explicit, yes? What precisely is the ODE system solved by the <code>pmx_solve_twocpt()</code> function? Fortunately, the actual ODEs are described by <a href="https://doi.org/10.1002/psp4.12812">Margossian et al (2022)</a> and are in fact the same ones I used in a previous post.</p>
<p>I’ll reproduce the ODEs here in exactly the same form as they are presented by Margossian et al:<a href="#fn3" class="footnote-ref" id="fnref3" role="doc-noteref"><sup>3</sup></a></p>
<p><span class="math display">\[
\begin{array}{rcl}
\displaystyle\frac{du_{\mbox{gut}}}{dt} &amp; = &amp; -k_a u_{\mbox{gut}} \\ \\
\displaystyle\frac{du_{\mbox{cent}}}{dt} &amp; = &amp; k_a u_{\mbox{gut}} - \left( \displaystyle\frac{\mbox{CL}}{V_{\mbox{cent}}} + \displaystyle\frac{Q}{V_\mbox{cent}} \right) u_{\mbox{cent}} + \displaystyle\frac{Q}{V_{\mbox{peri}}} u_{\mbox{peri}} \\ \\
\displaystyle\frac{du_{\mbox{peri}}}{dt} &amp; = &amp; \displaystyle\frac{Q}{V_\mbox{cent}} u_{\mbox{cent}} - \displaystyle\frac{Q}{V_{\mbox{peri}}} u_{\mbox{peri}}
\end{array}
\]</span></p>
<p>There’s still a little friction here because mathematical notation is never precisely identical to variable naming in code (nor should it be). But it does help to have a little lookup table like this one:</p>
<table class="table">
<colgroup>
<col style="width: 18%">
<col style="width: 31%">
<col style="width: 49%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: center;">Stan variable</th>
<th style="text-align: center;">Mathematical notatation</th>
<th style="text-align: left;">Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;"><code>x[1, :]</code></td>
<td style="text-align: center;"><span class="math inline">\(u_{\mbox{gut}}\)</span></td>
<td style="text-align: left;">Drug amount in the gut</td>
</tr>
<tr class="even">
<td style="text-align: center;"><code>x[2, :]</code></td>
<td style="text-align: center;"><span class="math inline">\(u_{\mbox{cent}}\)</span></td>
<td style="text-align: left;">Drug amount in central compartment</td>
</tr>
<tr class="odd">
<td style="text-align: center;"><code>x[3, :]</code></td>
<td style="text-align: center;"><span class="math inline">\(u_{\mbox{peri}}\)</span></td>
<td style="text-align: left;">Drug amount in peripheral compartment</td>
</tr>
<tr class="even">
<td style="text-align: center;"><code>ka</code></td>
<td style="text-align: center;"><span class="math inline">\(k_a\)</span></td>
<td style="text-align: left;">Absorption rate constant from gut</td>
</tr>
<tr class="odd">
<td style="text-align: center;"><code>CL</code></td>
<td style="text-align: center;"><span class="math inline">\(\mbox{CL}\)</span></td>
<td style="text-align: left;">Elimination clearance from central</td>
</tr>
<tr class="even">
<td style="text-align: center;"><code>Q</code></td>
<td style="text-align: center;"><span class="math inline">\(Q\)</span></td>
<td style="text-align: left;">Intercompartmental clearance</td>
</tr>
<tr class="odd">
<td style="text-align: center;"><code>V1</code></td>
<td style="text-align: center;"><span class="math inline">\(V_\mbox{cent}\)</span></td>
<td style="text-align: left;">Volume of central compartment</td>
</tr>
<tr class="even">
<td style="text-align: center;"><code>V2</code></td>
<td style="text-align: center;"><span class="math inline">\(V_\mbox{peri}\)</span></td>
<td style="text-align: left;">Volume of peripheral compartment</td>
</tr>
</tbody>
</table>
<p>The differential equations are all expressed in terms of drug amounts rather than drug concentrations, and the <code>pmx_solve_twocpt()</code> function solves for drug amounts in each compartment at each point in time. However, pharmacometric functions specify how drug concentrations change over time, so the Stan code makes the appropriate transformation. With that in mind I find it helpful to extend the table slightly:</p>
<table class="table">
<colgroup>
<col style="width: 22%">
<col style="width: 29%">
<col style="width: 48%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: center;">Stan transformation</th>
<th style="text-align: center;">Mathematical notatation</th>
<th style="text-align: left;">Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;"><code>x[2, :] ./ V1</code></td>
<td style="text-align: center;"><span class="math inline">\(u_{\mbox{cent}} / V_\mbox{cent}\)</span></td>
<td style="text-align: left;">Drug concentration in central compartment</td>
</tr>
<tr class="even">
<td style="text-align: center;"><code>x[3, :] ./ V2</code></td>
<td style="text-align: center;"><span class="math inline">\(u_{\mbox{peri}} / V_\mbox{peri}\)</span></td>
<td style="text-align: left;">Drug concentration in peripheral compartment</td>
</tr>
</tbody>
</table>
<p>Having written that out, the Stan code seems pretty interpretable. There’s still something missing here insofar as it’s not entirely clear <em>how</em> the <code>pmx_solve_twocpt()</code> function computes the drug amounts in each compartment at all time points, but at least it’s now clear <em>what</em> it is computing.</p>
</section>
<section id="where-can-i-find-the-analytical-solutions" class="level2">
<h2 class="anchored" data-anchor-id="where-can-i-find-the-analytical-solutions">Where can I find the analytical solutions?</h2>
<p>In my <a href="../../posts/2023-06-10_pop-pk-models/">previous post on pop-PK modelling</a>, I managed to get far enough along that I could implement my own two-compartment models in Stan, without using Torsten. However, in order to do that I had to rely on numerical ODE solvers to compute solutions to the pharmacokinetic functions. It turns out that was unnecessary. On the <a href="https://metrumresearchgroup.github.io/Torsten/">Torsten home page</a>, it indicates that:</p>
<blockquote class="blockquote">
<p>One and two compartment models are based on analytical solutions of governing ODEs.</p>
</blockquote>
<p>So presumably there <em>are</em> some analytical solutions somewhere! A little awkwardly, the documentation doesn’t explicitly say what the analytical solutions for the two-compartment model are or where they are taken from, but a little bit of digging gives us some answers. First, looking through the Torsten source reveals the relevant parts of the code:</p>
<ul>
<li><a href="https://github.com/metrumresearchgroup/Torsten/blob/0168482d400e4b819acadbc28cc817dd1a037c1b/cmdstan/stan/lib/stan_math/stan/math/torsten/pmx_solve_twocpt.hpp">This file</a> appears to be where the <code>torsten::pmx_solve_twocpt()</code> function is defined.</li>
<li><a href="https://github.com/metrumresearchgroup/Torsten/blob/0168482d400e4b819acadbc28cc817dd1a037c1b/cmdstan/stan/lib/stan_math/stan/math/torsten/pmx_twocpt_model.hpp">This file</a> appears to be where the analytical solutions are specified.</li>
</ul>
<p>Second, a little hunting around on the internet unearths this handy little paper by <a href="https://doi.org/10.12793/tcp.2019.27.2.43">D’Argenio and Bae (2019)</a> that derives the analytical solutions of interest. Skimming the paper quickly suggests it’s not too complicated an exercise to implement analytical solutions (especially if you’re not trying to optimise for performance), and even the derivations don’t look too painful. I may return to that topic in a later post, but for now I feel reassured that I know where to look when I want to dive deeper.</p>
</section>
<section id="useful-resources" class="level2">
<h2 class="anchored" data-anchor-id="useful-resources">Useful resources</h2>
<p>I suspect that at a future date I’ll want to pick up from where this post leaves off. With that in mind, these are the resources I relied on when putting it together:</p>
<ul>
<li><p><a href="https://doi.org/10.1002/psp4.12926">Bayesian PBPK modeling using R/Stan/Torsten and Julia/SciML/Turing.Jl</a>. Journal article by Ahmed Elmokadem, Yi Zhang, Timothy Knab, Eric Jordie, and Bill Gillespie, January 2023.</p></li>
<li><p><a href="https://doi.org/10.1002/psp4.12812">Flexible and efficient Bayesian pharmacometrics modeling using Stan and Torsten, Part I</a>. Journal article by Charles Margossian, Yi Zhang, and Bill Gillespie, April 2022.</p></li>
<li><p><a href="https://www.metrumrg.com/wp-content/uploads/2023/06/bbr.bayes_StanCon2023.pdf">Bayesian modeling workflow for pharmacometric applications using bbr.bayes with Stan/Torsten</a>. Slides by Bill Gillespie, June 2023.<a href="#fn4" class="footnote-ref" id="fnref4" role="doc-noteref"><sup>4</sup></a></p></li>
<li><p><a href="https://metrumrg.com/wp-content/uploads/2018/05/BayesianPmetricsMBSW2018.pdf">Bayesian Data Analysis Using Stan/Torsten for Pharmacometric Applications</a>. Slides by Bill Gillespie, May 2018.</p></li>
<li><p><a href="https://doi.org/10.12793/tcp.2019.27.2.43">Analytical solution of linear multi-compartment models with non-zero initial condition and its implementation with R</a>. Journal article by David D’Argenio and Kyun-Seop Bae, June 2019.</p></li>
<li><p><em>Kinetics of distribution of substances administered to the body. I. The extravascular modes of administration.</em> Journal article by Torsten Teorell, 1937. Discussed in <a href="https://doi.org/10.3109/03009739509178895">Torsten Teorell, the Father of Pharmacokinetics</a> by Lennart Paalzow, 1995.</p></li>
<li><p><a href="stanpmx.github.io/">Stan and R for Pharmacometrics</a>. Book by Casey Davis, Yasong Lu, Arya Pourzanjani, and Pavan Vaddady.<a href="#fn5" class="footnote-ref" id="fnref5" role="doc-noteref"><sup>5</sup></a></p></li>
</ul>
</section>
<section id="done" class="level2">
<h2 class="anchored" data-anchor-id="done">Done!</h2>
<p>…and with that, I’ve accomplished my very limited goals for this post, and for once in my life I shall bloody well refrain from expanding on it further and turning a short blog post into a monograph.</p>


</section>


<div id="quarto-appendix" class="default"><section id="footnotes" class="footnotes footnotes-end-of-document" role="doc-endnotes"><h2 class="anchored quarto-appendix-heading">Footnotes</h2>

<ol>
<li id="fn1"><p>I mean… “obvious” in the sense that I’m a person who has used Stan before and the output from the previous section is very familiar to me <em>as</em> Stan output.<a href="#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn2"><p>Number obviously fictitious but probably in the right ballpark.<a href="#fnref2" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn3"><p>The same ODE system appears in the <a href="https://metrumresearchgroup.github.io/Torsten/function/two-cpt/">Torsten documentation for the two-compartment model</a>, using <span class="math inline">\(y\)</span> in place of <span class="math inline">\(u\)</span> and <span class="math inline">\(y^\prime\)</span> in place of <span class="math inline">\(du/dt\)</span>. I probably should have used that version in this post, but I found the Margossian et al version first and I’m too lazy to rewrite the LaTeX expressions.<a href="#fnref3" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn4"><p>Thank you to Mike Smith for pointing me to this resource.<a href="#fnref4" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn5"><p>Thank you to Tim Waterhouse for pointing me to this resource.<a href="#fnref5" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
</ol>
</section><section class="quarto-appendix-contents"><h2 class="anchored quarto-appendix-heading">Reuse</h2><div id="quarto-reuse" class="quarto-appendix-contents"><div><a rel="license" href="https://creativecommons.org/licenses/by/4.0/">https://creativecommons.org/licenses/by/4.0/</a></div></div></section><section class="quarto-appendix-contents"><h2 class="anchored quarto-appendix-heading">Citation</h2><div><div class="quarto-appendix-secondary-label">BibTeX citation:</div><pre class="sourceCode code-with-copy quarto-appendix-bibtex"><code class="sourceCode bibtex">@online{navarro2023,
  author = {Navarro, Danielle},
  title = {Getting Started with {Torsten}},
  date = {2023-07-15},
  url = {https://blog.djnavarro.net/posts/2023-07-15_torsten},
  langid = {en}
}
</code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre><div class="quarto-appendix-secondary-label">For attribution, please cite this work as:</div><div id="ref-navarro2023" class="csl-entry quarto-appendix-citeas" role="listitem">
Navarro, Danielle. 2023. <span>“Getting Started with Torsten.”</span>
July 15, 2023. <a href="https://blog.djnavarro.net/posts/2023-07-15_torsten">https://blog.djnavarro.net/posts/2023-07-15_torsten</a>.
</div></div></section></div></main> <!-- /main -->
<!-- plausible -->
<script async="" defer="" data-domain="blog.djnavarro.net" src="https://plausible.io/js/plausible.js"></script>
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
      &nbsp;
    </div>   
    <div class="nav-footer-center">
      <ul class="footer-items list-unstyled">
    <li class="nav-item">
    <a class="nav-link" href="https://blog.djnavarro.net">blog.djnavarro.net</a>
  </li>  
</ul>
    </div>
    <div class="nav-footer-right">
      &nbsp;
    </div>
  </div>
</footer>



</body></html>