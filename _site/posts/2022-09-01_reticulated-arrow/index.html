<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.1.149">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Danielle Navarro">
<meta name="dcterms.date" content="2022-09-01">
<meta name="description" content="A neat trick">

<title>Notes from a data witch - Passing Arrow Tables between R and Python with reticulate</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1.6em;
  vertical-align: middle;
}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>


<link rel="stylesheet" href="../../styles.css">
<meta property="og:title" content="Notes from a data witch - Passing Arrow Tables between R and Python with reticulate">
<meta property="og:description" content="A neat trick">
<meta property="og:image" content="https://blog.djnavarro.net/posts/2022-09-01_reticulated-arrow/img/cover.jpg">
<meta property="og:site-name" content="Notes from a data witch">
<meta name="twitter:title" content="Notes from a data witch - Passing Arrow Tables between R and Python with reticulate">
<meta name="twitter:description" content="A neat trick">
<meta name="twitter:image" content="https://blog.djnavarro.net/posts/2022-09-01_reticulated-arrow/img/cover.jpg">
<meta name="twitter:creator" content="@djnavarro">
<meta name="twitter:card" content="summary_large_image">
</head>

<body class="floating nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">Notes from a data witch</span>
    </a>
  </div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../about.html">Danielle Navarro</a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://twitter.com/djnavarro"><i class="bi bi-twitter" role="img" aria-label="twitter">
</i> 
 </a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/djnavarro"><i class="bi bi-github" role="img" aria-label="github">
</i> 
 </a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://djnavarro.net"><i class="bi bi-person-circle" role="img" aria-label="website">
</i> 
 </a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://art.djnavarro.net"><i class="bi bi-palette-fill" role="img" aria-label="art">
</i> 
 </a>
  </li>  
</ul>
              <div id="quarto-search" class="" title="Search"></div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default toc-left page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <h1 class="title">Passing Arrow Tables between R and Python with reticulate</h1>
                  <div>
        <div class="description">
          A neat trick
        </div>
      </div>
                          <div class="quarto-categories">
                <div class="quarto-category">Apache Arrow</div>
                <div class="quarto-category">R</div>
                <div class="quarto-category">Python</div>
              </div>
                  </div>
  </div>
    
  <div class="quarto-title-meta-author">
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-heading">Affiliation</div>
    
      <div class="quarto-title-meta-contents">
      <a href="https://djnavarro.net">Danielle Navarro</a> <a href="https://orcid.org/0000-0001-7648-6578" class="quarto-title-author-orcid"> <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAA2ZpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMC1jMDYwIDYxLjEzNDc3NywgMjAxMC8wMi8xMi0xNzozMjowMCAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wTU09Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9tbS8iIHhtbG5zOnN0UmVmPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvc1R5cGUvUmVzb3VyY2VSZWYjIiB4bWxuczp4bXA9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC8iIHhtcE1NOk9yaWdpbmFsRG9jdW1lbnRJRD0ieG1wLmRpZDo1N0NEMjA4MDI1MjA2ODExOTk0QzkzNTEzRjZEQTg1NyIgeG1wTU06RG9jdW1lbnRJRD0ieG1wLmRpZDozM0NDOEJGNEZGNTcxMUUxODdBOEVCODg2RjdCQ0QwOSIgeG1wTU06SW5zdGFuY2VJRD0ieG1wLmlpZDozM0NDOEJGM0ZGNTcxMUUxODdBOEVCODg2RjdCQ0QwOSIgeG1wOkNyZWF0b3JUb29sPSJBZG9iZSBQaG90b3Nob3AgQ1M1IE1hY2ludG9zaCI+IDx4bXBNTTpEZXJpdmVkRnJvbSBzdFJlZjppbnN0YW5jZUlEPSJ4bXAuaWlkOkZDN0YxMTc0MDcyMDY4MTE5NUZFRDc5MUM2MUUwNEREIiBzdFJlZjpkb2N1bWVudElEPSJ4bXAuZGlkOjU3Q0QyMDgwMjUyMDY4MTE5OTRDOTM1MTNGNkRBODU3Ii8+IDwvcmRmOkRlc2NyaXB0aW9uPiA8L3JkZjpSREY+IDwveDp4bXBtZXRhPiA8P3hwYWNrZXQgZW5kPSJyIj8+84NovQAAAR1JREFUeNpiZEADy85ZJgCpeCB2QJM6AMQLo4yOL0AWZETSqACk1gOxAQN+cAGIA4EGPQBxmJA0nwdpjjQ8xqArmczw5tMHXAaALDgP1QMxAGqzAAPxQACqh4ER6uf5MBlkm0X4EGayMfMw/Pr7Bd2gRBZogMFBrv01hisv5jLsv9nLAPIOMnjy8RDDyYctyAbFM2EJbRQw+aAWw/LzVgx7b+cwCHKqMhjJFCBLOzAR6+lXX84xnHjYyqAo5IUizkRCwIENQQckGSDGY4TVgAPEaraQr2a4/24bSuoExcJCfAEJihXkWDj3ZAKy9EJGaEo8T0QSxkjSwORsCAuDQCD+QILmD1A9kECEZgxDaEZhICIzGcIyEyOl2RkgwAAhkmC+eAm0TAAAAABJRU5ErkJggg=="></a>
    </div>
      <div class="quarto-title-meta-contents">
          <p class="affiliation">
              <a href="https://voltrondata.com">
              Voltron Data
              </a>
            </p>
        </div>
      </div>

  <div class="quarto-title-meta">

        
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">September 1, 2022</p>
      </div>
    </div>
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse sidebar-navigation floating overflow-auto">
    <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#data-interchange-in-a-polyglot-world" id="toc-data-interchange-in-a-polyglot-world" class="nav-link active" data-scroll-target="#data-interchange-in-a-polyglot-world">Data interchange in a polyglot world</a>
  <ul class="collapse">
  <li><a href="#the-trick" id="toc-the-trick" class="nav-link" data-scroll-target="#the-trick">The trick</a></li>
  <li><a href="#managing-the-python-environment-from-r" id="toc-managing-the-python-environment-from-r" class="nav-link" data-scroll-target="#managing-the-python-environment-from-r">Managing the Python environment from R</a></li>
  <li><a href="#using-reticulate-to-call-python-from-r" id="toc-using-reticulate-to-call-python-from-r" class="nav-link" data-scroll-target="#using-reticulate-to-call-python-from-r">Using reticulate to call Python from R</a></li>
  <li><a href="#interoperability-of-r-and-python-code" id="toc-interoperability-of-r-and-python-code" class="nav-link" data-scroll-target="#interoperability-of-r-and-python-code">Interoperability of R and Python code</a></li>
  <li><a href="#copying-data-frames-between-languages" id="toc-copying-data-frames-between-languages" class="nav-link" data-scroll-target="#copying-data-frames-between-languages">Copying data frames between languages</a></li>
  </ul></li>
  <li><a href="#data-interchange-with-arrow-in-the-polyglot-world" id="toc-data-interchange-with-arrow-in-the-polyglot-world" class="nav-link" data-scroll-target="#data-interchange-with-arrow-in-the-polyglot-world">Data interchange with Arrow in the polyglot world</a>
  <ul class="collapse">
  <li><a href="#setting-up-arrow" id="toc-setting-up-arrow" class="nav-link" data-scroll-target="#setting-up-arrow">Setting up arrow</a></li>
  <li><a href="#setting-up-pyarrow" id="toc-setting-up-pyarrow" class="nav-link" data-scroll-target="#setting-up-pyarrow">Setting up pyarrow</a></li>
  <li><a href="#handover-to-python" id="toc-handover-to-python" class="nav-link" data-scroll-target="#handover-to-python">Handover to Python</a></li>
  <li><a href="#handover-to-r" id="toc-handover-to-r" class="nav-link" data-scroll-target="#handover-to-r">Handover to R</a></li>
  </ul></li>
  <li><a href="#does-arrow-really-make-a-big-difference" id="toc-does-arrow-really-make-a-big-difference" class="nav-link" data-scroll-target="#does-arrow-really-make-a-big-difference">Does Arrow really make a big difference?</a></li>
  </ul>
</nav>
</nav>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
    </div>
<!-- main -->
<main class="content quarto-banner-title-block" id="quarto-document-content">




<!-- 
cover img: https://unsplash.com/photos/k39RGHmLoV8
artist: Claudio Schwarz
licence: unsplash free-to-use 
-->
<!--------------- my typical setup ----------------->
<!-- 
the default python environment is this one:
/home/danielle/.local/share/r-miniconda/envs/r-reticulate/bin/python
--->
<p>As the 21st century gears up for its quarter-life crisis, the trend in data science is toward multi-language tools. I use <a href="https://quarto.org/">quarto</a> to write this blog, a document preparation system that supports code evaluation in R, Python, Julia, and more. My work revolves around <a href="https://arrow.apache.org/">Apache Arrow</a>, a toolbox for data analysis and interchange with implementations in multiple languages. You get the idea. In one sense this new development is fantastic ‚Äì your language of choice is much more likely to be supported in the future than it ever was in the past. In another sense it is daunting ‚Äì it sometimes feels like we need to learn <em>all the things</em> in order to get by in this brave new world. Meanwhile we all have our actual jobs to do and we don‚Äôt have the time. In the <a href="https://www.youtube.com/watch?v=1i739SyCu9I">immortal words of Bob Katter</a>,</p>
<blockquote class="blockquote">
<p>I mean, you know, people are entitled to their sexual proclivities. Let there be a thousand blossoms bloom as far as I‚Äôm concerned, you know‚Ä¶</p>
<p>&nbsp; &nbsp; &nbsp; [<em>pauses, expression turns dark</em>]</p>
<p>‚Ä¶but I ain‚Äôt spending any time on it because, in the meantime, every three months a person is torn to pieces by a crocodile in North Queensland</p>
</blockquote>
<p>I mean, he makes a good point?<a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a> There‚Äôs a lot going on in the data science world, none of us can keep pace with all of it, and we‚Äôre all trying our best not to be eaten by crocodiles.</p>
<p><br><br></p>
<section id="data-interchange-in-a-polyglot-world" class="level2">
<h2 class="anchored" data-anchor-id="data-interchange-in-a-polyglot-world">Data interchange in a polyglot world</h2>
<p>In the spirit of saving you from at least one reptilian threat, this post is a quick primer on how to efficiently pass control of a large data set between R and Python <em>without</em> making any wasteful copies of the data.</p>
<p>The idea to write this post came from a recent discussion on twitter about passing control of a data set from R to Python within a Quarto document like this one. The part of the discussion that really caught my I was this part:<a href="#fn2" class="footnote-ref" id="fnref2" role="doc-noteref"><sup>2</sup></a></p>
<blockquote class="blockquote">
<p><a href="https://twitter.com/mxcatnap/status/1559991199494279169">Cass Wilkinson Salda√±a</a>: If you were working on a bilingual (Python + R) Quarto project, and you‚Äôd want to hand off your (brilliantly cleaned, happy, thriving) tibble to a modeling stack in Python, how would you conduct the handoff?</p>
<p><a href="https://twitter.com/chowthedog/status/1560012424589312001">Michael Chow</a>: For something quick I might try handing off with reticulate, but if there were any ounce of uncertainty or pain I‚Äôd bail out to saving with arrow (or to a CSV).</p>
<p><a href="https://twitter.com/jonkeane/status/1560016227824721920">Jon Keane</a>: And with an arrow table (or dataset) that handoff can be zero copy, zero serialization. We need to improve our docs around this but there‚Äôs an <a href="https://github.com/apache/arrow/blob/8474ee5a3ed725d4bb56c75fc1b13a53cba1fd1f/r/tests/testthat/test-python.R#L90">example in the tests</a> that shows it off, and <a href="https://arrow.apache.org/docs/r/article">some documentation</a></p>
</blockquote>
<p>Jon‚Äôs comment is the one that really caught my attention because they‚Äôre completely right: passing data back and forth between R and Python without making copies of the data<a href="#fn3" class="footnote-ref" id="fnref3" role="doc-noteref"><sup>3</sup></a> is something that‚Äôs <em>obnoxiously</em> easy to do using Apache Arrow‚Ä¶</p>
<p>‚Ä¶but only if you know the trick, and the trick isn‚Äôt well documented yet.</p>
<p><br><br></p>
<section id="the-trick" class="level3">
<h3 class="anchored" data-anchor-id="the-trick">The trick</h3>
<p>The ‚Äútrick‚Äù is simple: if your data are stored as an Arrow Table, and you use the <a href="https://rstudio.github.io/reticulate/">reticulate</a> package to pass it from R to Python (or vice versa), only the metadata changes hands. Because an Arrow Table has the <em>same</em> structure in-memory when accessed from Python as it does in R, the data set itself does not need to be touched at all. The only thing that needs to happen is the language on the receiving end needs to be told <em>where</em> the data are stored. Or, to put it another way, we just pass a pointer across. This all happens invisibly, so if you know how to use reticulate,<a href="#fn4" class="footnote-ref" id="fnref4" role="doc-noteref"><sup>4</sup></a> you already know how to do this!</p>
<p>Yes yes Danielle, that‚Äôs all well and good, but what if I don‚Äôt know how to use reticulate? What if I‚Äôm one of those people who are vaguely aware that reticulate exists as an R package that provides an interface to Python, but haven‚Äôt actually used it and am not sure how to get started? What am I supposed to do then?</p>
<p>As it happens, you‚Äôre in luck. Until quite recently I was one of those people, and I‚Äôm deeply sympathetic. I‚Äôd somehow convinced myself that using reticulate would be super hard and require magic powers that I don‚Äôt have. Thankfully, it turned out to be much less painful than I feared, and I‚Äôll walk you through the process (or at least the process I followed!) now. <br><br></p>
</section>
<section id="managing-the-python-environment-from-r" class="level3">
<h3 class="anchored" data-anchor-id="managing-the-python-environment-from-r">Managing the Python environment from R</h3>
<p>If reticulate is not already on your system, you can install it from CRAN with <code>install.packages("reticulate")</code>. Once installed, you can load it in the usual fashion:</p>
<div class="cell">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>[R code]</strong></pre>
</div>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(reticulate)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<p>Next, we check that reticulate can find your Python environment if you have more than one make sure it‚Äôs finding the one you want to use! If you‚Äôre at all like me you‚Äôll find you‚Äôve managed to accumulate several different Python environments, often by accident. Currently I have four Python environments managed by <a href="https://docs.conda.io/en/latest/miniconda.html">miniconda</a>:</p>
<div class="cell">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>[at the terminal]</strong></pre>
</div>
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="ex">conda</span> env list</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code># conda environments:
#
                         /home/danielle/.local/share/r-miniconda
                         /home/danielle/.local/share/r-miniconda/envs/arrow_env
                         /home/danielle/.local/share/r-miniconda/envs/r-reticulate
base                     /home/danielle/miniconda3</code></pre>
</div>
</div>
<p>The three environments in the ‚Äúr-miniconda‚Äù folder exist because when I first started using reticulate I let it manage its own Python and miniconda installation. The commands I used at the time were these:</p>
<div class="cell">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>[R code]</strong></pre>
</div>
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="fu">install_python</span>()</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="fu">install_miniconda</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<p>When I did this, reticulate set me up with a default Python build, managed by the copy of miniconda that it installed. This isn‚Äôt a bad thing,<a href="#fn5" class="footnote-ref" id="fnref5" role="doc-noteref"><sup>5</sup></a> but also it isn‚Äôt the primary version of Python that I use when writing ‚Äúeveryday‚Äù Python code:<a href="#fn6" class="footnote-ref" id="fnref6" role="doc-noteref"><sup>6</sup></a> my usual Python environment is the fourth one on the list above, and for the purposes of this post that‚Äôs the one I want reticulate to use. I can do this with <code>use_miniconda()</code>, explicitly specifying the <code>condaenv</code> to be used:</p>
<div class="cell">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>[R code]</strong></pre>
</div>
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="fu">use_miniconda</span>(</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">condaenv =</span> <span class="st">"/home/danielle/miniconda3/bin/python"</span>, </span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">required =</span> <span class="cn">TRUE</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<p><br><br></p>
</section>
<section id="using-reticulate-to-call-python-from-r" class="level3">
<h3 class="anchored" data-anchor-id="using-reticulate-to-call-python-from-r">Using reticulate to call Python from R</h3>
<p>Now that my environment is set up I‚Äôm ready to use Python. When calling Python code from within R, some code translation is necessary due to the differences in syntax across languages. As a simple example, let‚Äôs say I have my regular Python session open and I want to check my Python version and executable. To do this I‚Äôd import the sys library:</p>
<div class="cell">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>[python code]</strong></pre>
</div>
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> sys</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(sys.version)</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(sys.executable)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>3.9.12 (main, Apr  5 2022, 07:05:27) 
[GCC 7.5.0]
/home/danielle/miniconda3/bin/python</code></pre>
</div>
</div>
<p>To execute these commands from R, the code needs some minor changes. The <code>import()</code> function replaces the <code>import</code> keyword, and <code>$</code> replaces <code>.</code> as the accessor:</p>
<div class="cell">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>[R code]</strong></pre>
</div>
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>sys <span class="ot">&lt;-</span> <span class="fu">import</span>(<span class="st">"sys"</span>)</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>sys<span class="sc">$</span>version</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>sys<span class="sc">$</span>executable</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "3.9.12 (main, Apr  5 2022, 07:05:27) \n[GCC 7.5.0]"
[1] "/home/danielle/miniconda3/bin/python"</code></pre>
</div>
</div>
<p>The code looks more R-like, but Python is doing the work.<a href="#fn7" class="footnote-ref" id="fnref7" role="doc-noteref"><sup>7</sup></a></p>
<p><br><br></p>
</section>
<section id="interoperability-of-r-and-python-code" class="level3">
<h3 class="anchored" data-anchor-id="interoperability-of-r-and-python-code">Interoperability of R and Python code</h3>
<p>One of the nice things about reticulate is that the Python functions it exposes are easy to use intermix with regular R code. I‚Äôll give an illustration using the unbearably cute <a href="https://pypi.org/project/art/">‚Äúart‚Äù library in Python</a>. There‚Äôs a lot you can do with it, but for this post I‚Äôll just use the <code>decor()</code> function that generates cute text decorations. This is what happens when I call it natively from Python:</p>
<div class="cell">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>[Python code]</strong></pre>
</div>
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> art</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>art.decor(<span class="st">"heart9"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>'¬¥*‚Ä¢.¬∏(*‚Ä¢.¬∏‚ô•¬∏.‚Ä¢*¬¥)¬∏.‚Ä¢*¬¥'</code></pre>
</div>
</div>
<p>When called from R with reticulate, the code looks like this:</p>
<div class="cell">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>[R code]</strong></pre>
</div>
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>art <span class="ot">&lt;-</span> <span class="fu">import</span>(<span class="st">"art"</span>)</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>art<span class="sc">$</span><span class="fu">decor</span>(<span class="st">"heart9"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "¬¥*‚Ä¢.¬∏(*‚Ä¢.¬∏‚ô•¬∏.‚Ä¢*¬¥)¬∏.‚Ä¢*¬¥"</code></pre>
</div>
</div>
<p>So cute! üíï</p>
<p>Now let‚Äôs suppose I want to create a modified version of <code>decor()</code>. In the original <code>decor()</code> function, the first argument must be a single string that specifies the name of a decoration. Examples include <code>"heart9"</code>, <code>"wave3"</code>, or anything other pattern known to the <code>decor()</code> function. You can only pass one string: it does not accept vectors. What I‚Äôd like to do in my modified version is pass a numeric vector as input, and receive a vector of heart decorations as output.</p>
<p>Although the original <code>decor()</code> function is written in Python, I can write the code for my modified function entirely in R. I don‚Äôt have to write any Python code unless I desperately want to. Here‚Äôs one way of implementing the modified function using the <a href="https://purrr.tidyverse.org/">purrr</a> functional programming toolkit:</p>
<div class="cell">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>[R code]</strong></pre>
</div>
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>decor_heart <span class="ot">&lt;-</span> <span class="cf">function</span>(x) {</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>  purrr<span class="sc">::</span><span class="fu">map_chr</span>(x, <span class="sc">~</span> art<span class="sc">$</span><span class="fu">decor</span>(<span class="fu">paste0</span>(<span class="st">"heart"</span>, .x)))</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a><span class="fu">decor_heart</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">9</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "~~&lt;üíö&gt;~~"               "~~&gt;&lt;~~&gt;üíñ"              "‚îÄ‚ïê⁄ø⁄ø€£⁄ø‚ïê‚îÄüíñ‚îÄ‚ïê⁄ø⁄ø€£⁄ø‚ïê‚îÄ"      
[4] "‡º∫‚ô•‡ºª‚ùÄ‡º∫‚ô•‡ºªüíïÔªø"              "üíóüíú.¬∏¬∏.‚Ä¢¬¥¬Ø`‚òÜ¬∫‡Æá‚Ä¢¬¥‚ô•"     "-‚ô•-‚ô°--^["              
[7] "*‚Ä¢.¬∏‚ô°"                  "‚ïö¬ª‚ô°¬´‚ïù"                  "¬¥*‚Ä¢.¬∏(*‚Ä¢.¬∏‚ô•¬∏.‚Ä¢*¬¥)¬∏.‚Ä¢*¬¥"</code></pre>
</div>
</div>
<p>Yay! Vectorised prettiness! üòç</p>
<p><br><br></p>
</section>
<section id="copying-data-frames-between-languages" class="level3">
<h3 class="anchored" data-anchor-id="copying-data-frames-between-languages">Copying data frames between languages</h3>
<p>Okay, now that we understand the basics of reticulate, it‚Äôs time to tackle the problem of transferring data sets between R and Python. For now, let‚Äôs leave Arrow out of this. All we‚Äôre going to do is take an ordinary R data frame and transfer it to Python.</p>
<p>First, let‚Äôs load some data into R. Sticking to the reptilian theme we‚Äôve got going here, the data are taken from <a href="http://www.reptile-database.org/">The Reptile Database</a> (accessed August 31 2022), an open and freely available catalog of reptile species and their scientific classifications.<a href="#fn8" class="footnote-ref" id="fnref8" role="doc-noteref"><sup>8</sup></a></p>
<div class="cell">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>[R code]</strong></pre>
</div>
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>taxa <span class="ot">&lt;-</span> readr<span class="sc">::</span><span class="fu">read_csv2</span>(<span class="st">"taxa.csv"</span>)</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>taxa</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 14,930 √ó 10
   taxon_id family subfa‚Ä¶¬π genus subge‚Ä¶¬≤ speci‚Ä¶¬≥ autho‚Ä¶‚Å¥ infra‚Ä¶‚Åµ infra‚Ä¶‚Å∂ infra‚Ä¶‚Å∑
   &lt;chr&gt;    &lt;chr&gt;  &lt;chr&gt;   &lt;chr&gt; &lt;lgl&gt;   &lt;chr&gt;   &lt;chr&gt;   &lt;chr&gt;   &lt;chr&gt;   &lt;chr&gt;  
 1 Ablepha‚Ä¶ Scinc‚Ä¶ Eugong‚Ä¶ Able‚Ä¶ NA      alaicus ELPATJ‚Ä¶ &lt;NA&gt;    &lt;NA&gt;    &lt;NA&gt;   
 2 Ablepha‚Ä¶ Scinc‚Ä¶ Eugong‚Ä¶ Able‚Ä¶ NA      alaicus ELPATJ‚Ä¶ subsp.  alaicus ELPATJ‚Ä¶
 3 Ablepha‚Ä¶ Scinc‚Ä¶ Eugong‚Ä¶ Able‚Ä¶ NA      alaicus ELPATJ‚Ä¶ subsp.  kucenk‚Ä¶ NIKOLS‚Ä¶
 4 Ablepha‚Ä¶ Scinc‚Ä¶ Eugong‚Ä¶ Able‚Ä¶ NA      alaicus ELPATJ‚Ä¶ subsp.  yakovl‚Ä¶ (EREMC‚Ä¶
 5 Ablepha‚Ä¶ Scinc‚Ä¶ Eugong‚Ä¶ Able‚Ä¶ NA      anatol‚Ä¶ SCHMID‚Ä¶ &lt;NA&gt;    &lt;NA&gt;    &lt;NA&gt;   
 6 Ablepha‚Ä¶ Scinc‚Ä¶ Eugong‚Ä¶ Able‚Ä¶ NA      bivitt‚Ä¶ (MENET‚Ä¶ &lt;NA&gt;    &lt;NA&gt;    &lt;NA&gt;   
 7 Ablepha‚Ä¶ Scinc‚Ä¶ Eugong‚Ä¶ Able‚Ä¶ NA      budaki  G√ñCMEN‚Ä¶ &lt;NA&gt;    &lt;NA&gt;    &lt;NA&gt;   
 8 Ablepha‚Ä¶ Scinc‚Ä¶ Eugong‚Ä¶ Able‚Ä¶ NA      cherno‚Ä¶ DAREVS‚Ä¶ &lt;NA&gt;    &lt;NA&gt;    &lt;NA&gt;   
 9 Ablepha‚Ä¶ Scinc‚Ä¶ Eugong‚Ä¶ Able‚Ä¶ NA      cherno‚Ä¶ DAREVS‚Ä¶ subsp.  cherno‚Ä¶ DAREVS‚Ä¶
10 Ablepha‚Ä¶ Scinc‚Ä¶ Eugong‚Ä¶ Able‚Ä¶ NA      cherno‚Ä¶ DAREVS‚Ä¶ subsp.  eiselti SCHMID‚Ä¶
# ‚Ä¶ with 14,920 more rows, and abbreviated variable names ¬π‚Äãsubfamily,
#   ¬≤‚Äãsubgenus, ¬≥‚Äãspecific_epithet, ‚Å¥‚Äãauthority, ‚Åµ‚Äãinfraspecific_marker,
#   ‚Å∂‚Äãinfraspecific_epithet, ‚Å∑‚Äãinfraspecific_authority</code></pre>
</div>
</div>
<p>Currently this object is stored in-memory as an R data frame and we want to move it to Python. However, because Python data structures are different from R data structures, what this actually requires us to do is make a copy of the whole data set inside Python, using a Python-native data structure (in this case a Pandas DataFrame). Thankfully, reticulate does this seamlessly with the <code>r_to_py()</code> function:</p>
<div class="cell">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>[R code]</strong></pre>
</div>
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>py_taxa <span class="ot">&lt;-</span> <span class="fu">r_to_py</span>(taxa)</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>py_taxa</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>                            taxon_id  ...    infraspecific_authority
0                 Ablepharus_alaicus  ...                         NA
1         Ablepharus_alaicus_alaicus  ...          ELPATJEVSKY, 1901
2        Ablepharus_alaicus_kucenkoi  ...             NIKOLSKY, 1902
3      Ablepharus_alaicus_yakovlevae  ...         (EREMCHENKO, 1983)
4              Ablepharus_anatolicus  ...                         NA
...                              ...  ...                        ...
14925           Zygaspis_quadrifrons  ...                         NA
14926               Zygaspis_vandami  ...                         NA
14927     Zygaspis_vandami_arenicola  ...  BROADLEY &amp; BROADLEY, 1997
14928       Zygaspis_vandami_vandami  ...         (FITZSIMONS, 1930)
14929              Zygaspis_violacea  ...                         NA

[14930 rows x 10 columns]</code></pre>
</div>
</div>
<p>Within the Python session, an object called <code>r</code> has been created: the Pandas DataFrame object is stored as <code>r.py_taxa</code>, and we can manipulate it using Python code in whatever fashion we normally might. To keep things simple, all I‚Äôll do here is count the number of entries in the data set for each reptilian family:</p>
<div class="cell">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>[python code]</strong></pre>
</div>
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>counts <span class="op">=</span> r. <span class="op">\</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>  py_taxa[[<span class="st">"family"</span>, <span class="st">"taxon_id"</span>]]. <span class="op">\</span></span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>  groupby(<span class="st">"family"</span>). <span class="op">\</span></span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>  agg(<span class="bu">len</span>)</span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>counts</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>                 taxon_id
family                   
Acrochordidae           3
Agamidae              677
Alligatoridae          16
Alopoglossidae         32
Amphisbaenidae        206
...                   ...
Xenodermidae           30
Xenopeltidae            2
Xenophidiidae           2
Xenosauridae           15
Xenotyphlopidae         1

[93 rows x 1 columns]</code></pre>
</div>
</div>
<p>Of course, I could have done this in R using dplyr functions but that‚Äôs not the point of the post. What matters for our purposes is that <code>counts</code> is a Pandas DataFrame that we‚Äôd like to pull back from the Python session into our R session.</p>
<p>Again, this turns out to be easier than I was expecting. The reticulate package exposes an object named <code>py</code> to the user, and any objects I created in my Python session can be accessed that way:</p>
<div class="cell" data-out.lines="10">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>[R code]</strong></pre>
</div>
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>py<span class="sc">$</span>counts</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>                   taxon_id
Acrochordidae             3
Agamidae                677
Alligatoridae            16
Alopoglossidae           32
Amphisbaenidae          206
Anguidae                113
Aniliidae                 3
Anomalepididae           23
Anomochilidae             3
...</code></pre>
</div>
</div>
<p>What‚Äôs especially neat is that the data structure has been automatically translated for us: the <code>counts</code> object in Python is a Pandas DataFrame, but when accessed from R it is automatically translated into a native R data structure: <code>py$counts</code> is a regular data frame:</p>
<div class="cell">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>[R code]</strong></pre>
</div>
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="fu">class</span>(py<span class="sc">$</span>counts)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "data.frame"</code></pre>
</div>
</div>
<p><br><br></p>
</section>
</section>
<section id="data-interchange-with-arrow-in-the-polyglot-world" class="level2">
<h2 class="anchored" data-anchor-id="data-interchange-with-arrow-in-the-polyglot-world">Data interchange with Arrow in the polyglot world</h2>
<p>The example in the previous section looks smooth and seamless because the data set is small. However, it is fundamentally inefficient for the simple reason that a Pandas DataFrame looks different in memory to an R data frame. It‚Äôs not possible for the two languages to share a single copy of the data because they don‚Äôt agree on what ‚Äúthe data‚Äù are. To handover data from R to Python (or vice versa) it is necessary to copy the data set and convert it to a more appropriate format.</p>
<p>When the data set is small, this is not a problem. But as your data set grows, it becomes ever more burdensome. These copy-and-convert operations are not cheap.</p>
<p>Wouldn‚Äôt it be nice if R and Python could both agree to represent the data as, oh let‚Äôs say‚Ä¶. an Arrow Table? On the R side we could interact with it using the arrow R package, and on the Python side we could interact with it using the pyarrow module. But regardless of which language we‚Äôre using, the thing in memory would be <em>exactly</em> the same‚Ä¶ handing over the data set from one language to the other would no longer require any copying. A little metadata would change hands, and that‚Äôs all.</p>
<p>That sounds much nicer.</p>
<p><br><br></p>
<section id="setting-up-arrow" class="level3">
<h3 class="anchored" data-anchor-id="setting-up-arrow">Setting up arrow</h3>
<p>I‚Äôm not going to talk much about setting up arrow for R in this post, because I‚Äôve written about it before! In addition to the <a href="https://arrow.apache.org/docs/r/">installation instructions on the arrow documentation</a> there‚Äôs a <a href="https://blog.djnavarro.net/posts/2021-11-19_starting-apache-arrow-in-r/">getting started with arrow</a> post on this blog. But in any case, it‚Äôs usually pretty straightfoward: you can install the arrow R package from CRAN in the usual way using <code>install.packages("arrow")</code> and then load it in the usual fashion:</p>
<div class="cell">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>[R code]</strong></pre>
</div>
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(arrow)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<p>From there we‚Äôre good to go. Let‚Äôs start by reading the reptiles data directly from file into an Arrow Table:</p>
<div class="cell">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>[R code]</strong></pre>
</div>
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>taxa_arrow <span class="ot">&lt;-</span> <span class="fu">read_delim_arrow</span>(</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">file =</span> <span class="st">"taxa.csv"</span>, </span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">delim =</span> <span class="st">";"</span>, </span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">as_data_frame =</span> <span class="cn">FALSE</span></span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a>taxa_arrow</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Table
14930 rows x 10 columns
$taxon_id &lt;string&gt;
$family &lt;string&gt;
$subfamily &lt;string&gt;
$genus &lt;string&gt;
$subgenus &lt;null&gt;
$specific_epithet &lt;string&gt;
$authority &lt;string&gt;
$infraspecific_marker &lt;string&gt;
$infraspecific_epithet &lt;string&gt;
$infraspecific_authority &lt;string&gt;</code></pre>
</div>
</div>
<p><br><br></p>
</section>
<section id="setting-up-pyarrow" class="level3">
<h3 class="anchored" data-anchor-id="setting-up-pyarrow">Setting up pyarrow</h3>
<p>Okay, what‚Äôs our next step? Well, in the previous example, the R data frame was handled on the Python side by the Pandas module. And as a consequence, you‚Äôd imagine that it was pretty important that my Python environment has Pandas installed right? The same is true when passing an Arrow Table: you need to have pyarrow installed on the Python side as well as arrow installed on the R side. So let‚Äôs do that.</p>
<p>As a convenience, the arrow package supplies a helper function called <code>install_pyarrow()</code> that calls the relevant reticulate functions for you, but for the purposes of this post I‚Äôll show you the reticulate functions. The python environment I‚Äôm using in this post is managed by miniconda, so I‚Äôll use <code>conda_install()</code> to do the work:</p>
<div class="cell">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>[R code]</strong></pre>
</div>
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="fu">conda_install</span>(</span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">packages =</span> <span class="st">"pyarrow"</span>, </span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">envname =</span> <span class="st">"/home/danielle/miniconda3"</span>, </span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">conda =</span> <span class="st">"/home/danielle/miniconda3/bin/conda"</span></span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<p>In this code, <code>packages</code> is the name of the to-be-installed python module, <code>envname</code> is the path to the conda environment, and <code>conda</code> is the path to the conda executable. As a general rule you don‚Äôt need to be this explicit: reticulate will find the environment and conda executable for you.</p>
<p>Next let‚Äôs import pyarrow on the Python side and check the version:</p>
<div class="cell">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>[python code]</strong></pre>
</div>
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pyarrow</span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>pyarrow.__version__</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>'8.0.0'</code></pre>
</div>
</div>
<p>As an aside ‚Äì because I‚Äôm on on linux and life on linux is dark and full of terrors ‚Äì this didn‚Äôt actually work for me the first time I tried it, and naturally I was filled with despair. Instead of the nice output above, I got an error saying:</p>
<pre><code>libstdc++.so.6: version `GLIBCXX_3.4.22' not found</code></pre>
<p>As usual, googling the error message led me to discover I needed to update the relevant library. It turned out to be an easy fix with this command:</p>
<div class="cell">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>[at the terminal]</strong></pre>
</div>
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> apt-get update</span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> apt-get install libstdc++6</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<p>Yet another catastrophe averted by copy/pasting into a search engine üôÉ</p>
<p><br><br></p>
</section>
<section id="handover-to-python" class="level3">
<h3 class="anchored" data-anchor-id="handover-to-python">Handover to Python</h3>
<p>After all that set up, it‚Äôs almost comically easy to do the transfer itself. It‚Äôs literally the same as last time: we call <code>r_to_py()</code>. The <code>taxa_arrow</code> variable refers to an Arrow Table on the R side, so now all I have to do is use <code>r_to_py()</code> to create <code>py_taxa_arrow</code>, a variable that refers to the same Arrow Table from the Python side:</p>
<div class="cell">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>[R code]</strong></pre>
</div>
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a>py_taxa_arrow <span class="ot">&lt;-</span> <span class="fu">r_to_py</span>(taxa_arrow)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<p>Since we‚Äôre in Python now, let‚Äôs just switch languages and take a peek, shall we? Just like last time, objects created by reticulate are accessible on the Python side via the <code>r</code> object, so we access this object in Python with <code>r.py_taxa_arrow</code>:</p>
<div class="cell">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>[python code]</strong></pre>
</div>
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a>r.py_taxa_arrow</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>pyarrow.Table
taxon_id: string
family: string
subfamily: string
genus: string
subgenus: null
specific_epithet: string
authority: string
infraspecific_marker: string
infraspecific_epithet: string
infraspecific_authority: string
----
taxon_id: [["Ablepharus_alaicus","Ablepharus_alaicus_alaicus","Ablepharus_alaicus_kucenkoi","Ablepharus_alaicus_yakovlevae","Ablepharus_anatolicus",...,"Plestiodon_egregius_onocrepis","Plestiodon_egregius_similis","Plestiodon_elegans","Plestiodon_fasciatus","Plestiodon_finitimus"],["Plestiodon_gilberti","Plestiodon_gilberti_cancellosus","Plestiodon_gilberti_gilberti","Plestiodon_gilberti_placerensis","Plestiodon_gilberti_rubricaudatus",...,"Zygaspis_quadrifrons","Zygaspis_vandami","Zygaspis_vandami_arenicola","Zygaspis_vandami_vandami","Zygaspis_violacea"]]
family: [["Scincidae","Scincidae","Scincidae","Scincidae","Scincidae",...,"Scincidae","Scincidae","Scincidae","Scincidae","Scincidae"],["Scincidae","Scincidae","Scincidae","Scincidae","Scincidae",...,"Amphisbaenidae","Amphisbaenidae","Amphisbaenidae","Amphisbaenidae","Amphisbaenidae"]]
subfamily: [["Eugongylinae","Eugongylinae","Eugongylinae","Eugongylinae","Eugongylinae",...,"Scincinae","Scincinae","Scincinae","Scincinae","Scincinae"],["Scincinae","Scincinae","Scincinae","Scincinae","Scincinae",...,null,null,null,null,null]]
genus: [["Ablepharus","Ablepharus","Ablepharus","Ablepharus","Ablepharus",...,"Plestiodon","Plestiodon","Plestiodon","Plestiodon","Plestiodon"],["Plestiodon","Plestiodon","Plestiodon","Plestiodon","Plestiodon",...,"Zygaspis","Zygaspis","Zygaspis","Zygaspis","Zygaspis"]]
subgenus: [11142 nulls,3788 nulls]
specific_epithet: [["alaicus","alaicus","alaicus","alaicus","anatolicus",...,"egregius","egregius","elegans","fasciatus","finitimus"],["gilberti","gilberti","gilberti","gilberti","gilberti",...,"quadrifrons","vandami","vandami","vandami","violacea"]]
authority: [["ELPATJEVSKY, 1901","ELPATJEVSKY, 1901","ELPATJEVSKY, 1901","ELPATJEVSKY, 1901","SCHMIDTLER, 1997",...,"BAIRD, 1858","BAIRD, 1858","(BOULENGER, 1887)","(LINNAEUS, 1758)","OKAMOTO &amp; HIKIDA, 2012"],["(VAN DENBURGH, 1896)","(VAN DENBURGH, 1896)","(VAN DENBURGH, 1896)","(VAN DENBURGH, 1896)","(VAN DENBURGH, 1896)",...,"(PETERS, 1862)","(FITZSIMONS, 1930)","(FITZSIMONS, 1930)","(FITZSIMONS, 1930)","(PETERS, 1854)"]]
infraspecific_marker: [[null,"subsp.","subsp.","subsp.",null,...,"subsp.","subsp.",null,null,null],[null,"subsp.","subsp.","subsp.","subsp.",...,null,null,"subsp.","subsp.",null]]
infraspecific_epithet: [[null,"alaicus","kucenkoi","yakovlevae",null,...,"onocrepis","similis",null,null,null],[null,"cancellosus","gilberti","placerensis","rubricaudatus",...,null,null,"arenicola","vandami",null]]
infraspecific_authority: [[null,"ELPATJEVSKY, 1901","NIKOLSKY, 1902","(EREMCHENKO, 1983)",null,...,"(COPE, 1871)","(MCCONKEY, 1957)",null,null,null],[null,"(RODGERS &amp; FITCH, 1947)","(VAN DENBURGH, 1896)","(RODGERS, 1944)","(TAYLOR, 1936)",...,null,null,"BROADLEY &amp; BROADLEY, 1997","(FITZSIMONS, 1930)",null]]</code></pre>
</div>
</div>
<p>The output is formatted slightly differently because the Python pyarrow library is now doing the work. You can see from the first line that this is a <em>pyarrow</em> Table, but nevertheless when you look at the rest of the output it‚Äôs pretty clear that this is the same table.</p>
<p>Easy!</p>
<p><br><br></p>
</section>
<section id="handover-to-r" class="level3">
<h3 class="anchored" data-anchor-id="handover-to-r">Handover to R</h3>
<p>Right then, what‚Äôs next? Just like last time, let‚Äôs do a little bit of data wrangling on the Python side. In the code below I‚Äôm using pyarrow to do the same thing I did with Pandas earlier: counting the number of entries for each reptile family.</p>
<div class="cell">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>[python code]</strong></pre>
</div>
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a>counts_arrow <span class="op">=</span> r.py_taxa_arrow. <span class="op">\</span></span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>  group_by(<span class="st">"family"</span>). <span class="op">\</span></span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a>  aggregate([(<span class="st">"taxon_id"</span>, <span class="st">"count"</span>)]). <span class="op">\</span></span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a>  sort_by([(<span class="st">"family"</span>, <span class="st">"ascending"</span>)])</span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a>counts_arrow</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>pyarrow.Table
taxon_id_count: int64
family: string
----
taxon_id_count: [[3,677,16,32,206,...,2,2,15,1,5]]
family: [["Acrochordidae","Agamidae","Alligatoridae","Alopoglossidae","Amphisbaenidae",...,"Xenopeltidae","Xenophidiidae","Xenosauridae","Xenotyphlopidae",null]]</code></pre>
</div>
</div>
<p>Flipping back to R, the <code>counts_arrow</code> object is accessible via the <code>py</code> object. Let‚Äôs take a look:</p>
<div class="cell">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>[R code]</strong></pre>
</div>
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a>py<span class="sc">$</span>counts_arrow</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Table
93 rows x 2 columns
$taxon_id_count &lt;int64&gt;
$family &lt;string&gt;</code></pre>
</div>
</div>
<p>The output is formatted a little differently because on this side it is the R arrow package printing the output, but it‚Äôs the same Table.</p>
<p>Mission accomplished!</p>
<p><br><br></p>
</section>
</section>
<section id="does-arrow-really-make-a-big-difference" class="level2">
<h2 class="anchored" data-anchor-id="does-arrow-really-make-a-big-difference">Does Arrow really make a big difference?</h2>
<p>Okay‚Ä¶ one more thing. But it‚Äôs an important one!</p>
<p>At the end of all this, you might want to know if using Arrow makes much of a difference. As much as I love learning new things for the sheer joy of learning new things, I prefer to learn useful things when I can! So let‚Äôs do a little comparison. First, I‚Äôll load a few more packages‚Ä¶</p>
<div class="cell">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>[R code]</strong></pre>
</div>
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tictoc)</span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tibble)</span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(purrr)</span>
<span id="cb41-5"><a href="#cb41-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyr)</span>
<span id="cb41-6"><a href="#cb41-6" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<p>Next, I‚Äôll define a <code>handover_time()</code> function that takes two arguments. The first argument <code>n</code> specifies the number of rows in the to-be-transferred data set. The second argument <code>arrow</code> is a logical value: setting <code>arrow = FALSE</code> means that an R data frame will be passed to Python as a Panda DataFrame, wheras <code>arrow = TRUE</code> means that an Arrow Table in R will be passed to Python and remain an Arrow Table. The actual data set is constructed by randomly sampling <code>n</code> rows from the <code>taxa</code> data set (with replacement):</p>
<div class="cell">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>[R code]</strong></pre>
</div>
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a>handover_time <span class="ot">&lt;-</span> <span class="cf">function</span>(n, <span class="at">arrow =</span> <span class="cn">FALSE</span>) {</span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a>  data_in_r <span class="ot">&lt;-</span> <span class="fu">slice_sample</span>(taxa, <span class="at">n =</span> n, <span class="at">replace =</span> <span class="cn">TRUE</span>)</span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(arrow) {</span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a>    data_in_r <span class="ot">&lt;-</span> <span class="fu">arrow_table</span>(data_in_r)</span>
<span id="cb42-5"><a href="#cb42-5" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb42-6"><a href="#cb42-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tic</span>()</span>
<span id="cb42-7"><a href="#cb42-7" aria-hidden="true" tabindex="-1"></a>  data_in_python <span class="ot">&lt;-</span> <span class="fu">r_to_py</span>(data_in_r)</span>
<span id="cb42-8"><a href="#cb42-8" aria-hidden="true" tabindex="-1"></a>  t <span class="ot">&lt;-</span> <span class="fu">toc</span>(<span class="at">quiet =</span> <span class="cn">TRUE</span>)</span>
<span id="cb42-9"><a href="#cb42-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(t<span class="sc">$</span>toc <span class="sc">-</span> t<span class="sc">$</span>tic)</span>
<span id="cb42-10"><a href="#cb42-10" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<p>Now that I‚Äôve defined the test function, let‚Äôs see what happens. I‚Äôll vary the number of rows from 10000 to 1000000 for both the native data frame version and the Arrow Table version, and store the result as <code>times</code>:</p>
<div class="cell" data-hash="index_cache/html/speed-test-2_5b7dfe08b589ec827e86b19cd57ec596">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>[R code]</strong></pre>
</div>
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a>times <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">n =</span> <span class="fu">seq</span>(<span class="dv">10000</span>, <span class="dv">1000000</span>, <span class="at">length.out =</span> <span class="dv">100</span>),</span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">data_frame =</span> <span class="fu">map_dbl</span>(n, handover_time),</span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">arrow_table =</span> <span class="fu">map_dbl</span>(n, handover_time, <span class="at">arrow =</span> <span class="cn">TRUE</span>),</span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<p>Now let‚Äôs plot the data:</p>
<div class="cell">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>[R code]</strong></pre>
</div>
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a>times <span class="sc">|&gt;</span> </span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(</span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">cols =</span> <span class="fu">c</span>(<span class="st">"data_frame"</span>, <span class="st">"arrow_table"</span>), </span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">names_to =</span> <span class="st">"type"</span>, </span>
<span id="cb44-5"><a href="#cb44-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">values_to =</span> <span class="st">"time"</span></span>
<span id="cb44-6"><a href="#cb44-6" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span> </span>
<span id="cb44-7"><a href="#cb44-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb44-8"><a href="#cb44-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">type =</span> type <span class="sc">|&gt;</span> </span>
<span id="cb44-9"><a href="#cb44-9" aria-hidden="true" tabindex="-1"></a>      <span class="fu">factor</span>(</span>
<span id="cb44-10"><a href="#cb44-10" aria-hidden="true" tabindex="-1"></a>        <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"data_frame"</span>, <span class="st">"arrow_table"</span>),</span>
<span id="cb44-11"><a href="#cb44-11" aria-hidden="true" tabindex="-1"></a>        <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"Data Frames"</span>, <span class="st">"Arrow Tables"</span>)</span>
<span id="cb44-12"><a href="#cb44-12" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb44-13"><a href="#cb44-13" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb44-14"><a href="#cb44-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(n, time)) <span class="sc">+</span> </span>
<span id="cb44-15"><a href="#cb44-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>() <span class="sc">+</span> </span>
<span id="cb44-16"><a href="#cb44-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span>type) <span class="sc">+</span> </span>
<span id="cb44-17"><a href="#cb44-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>() <span class="sc">+</span> </span>
<span id="cb44-18"><a href="#cb44-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb44-19"><a href="#cb44-19" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Number of Rows"</span>,</span>
<span id="cb44-20"><a href="#cb44-20" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Handover Time (Seconds)"</span>, </span>
<span id="cb44-21"><a href="#cb44-21" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"How long does it take to pass data from R to Python?"</span></span>
<span id="cb44-22"><a href="#cb44-22" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/plot-speed-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Okay yeah. I‚Äôll be the first to admit that this isn‚Äôt a very sophisticated way to do benchmarking, but when the difference is this stark you really don‚Äôt have to be sophisticated. Without Arrow, the only way to hand data from R to Python is to copy and convert the data, and that‚Äôs time consuming. The time cost gets worse the larger your data set becomes. With Arrow, the problem goes away because you‚Äôre not copying the data at all. The time cost is tiny and it stays tiny even as the data set gets bigger.</p>
<p>Seems handy to me?</p>
<p><br><br></p>
<!--------------- appendices go here ----------------->
<div class="cell">

</div>


</section>


<div id="quarto-appendix" class="default"><section id="footnotes" class="footnotes footnotes-end-of-document" role="doc-endnotes"><h2 class="anchored quarto-appendix-heading">Footnotes</h2>

<ol>
<li id="fn1"><p>A good point about data science, that is. I‚Äôm not convinced it was a stellar contribution to the discussion of LGBT rights in the antipodes. Although frankly it wasn‚Äôt the worst comment on same sex marriage I saw an Australian politician make at the time, not by a loooooong margin.<a href="#fnref1" class="footnote-back" role="doc-backlink">‚Ü©Ô∏é</a></p></li>
<li id="fn2"><p>I‚Äôve edited the exchange ever so slightly to improve clarity and to insert readable link text to assist screenreaders.<a href="#fnref2" class="footnote-back" role="doc-backlink">‚Ü©Ô∏é</a></p></li>
<li id="fn3"><p>I‚Äôll talk more about this later, but for now it‚Äôs enough to note that when you have really big data sets the absolute last thing you want to do is make unnecessary copies ‚Äì it eats up a looooot of your compute time!<a href="#fnref3" class="footnote-back" role="doc-backlink">‚Ü©Ô∏é</a></p></li>
<li id="fn4"><p>Something to note here is that the reticulate solution implicitly assumes R is your ‚Äúprimary‚Äù language and Python is the ‚Äúsecondary‚Äù language. That is, reticulate is an R package that calls Python, not a Python module that calls R. Simularly, this quarto document uses the <a href="https://quarto.org/docs/computations/r.html">knitr engine</a> (also an R package) to integrate code from the two languages. Yes the tools are multi-language, but the setup is pretty R-centric. Arguably this is typical for how an R user would set up a multi-language project, and since R is my primary language it‚Äôs my preferred solution. However, it‚Äôs not a particularly Pythonic way of approaching the problem. But fear not, Python fans. In the next post I‚Äôm going to describe an approach that solves the same problem in a Python-centric way.<a href="#fnref4" class="footnote-back" role="doc-backlink">‚Ü©Ô∏é</a></p></li>
<li id="fn5"><p>In fact, it‚Äôs often a good idea to let reticulate do its own thing!<a href="#fnref5" class="footnote-back" role="doc-backlink">‚Ü©Ô∏é</a></p></li>
<li id="fn6"><p>Okay fine I don‚Äôt write Python code every day but you know what I mean‚Ä¶<a href="#fnref6" class="footnote-back" role="doc-backlink">‚Ü©Ô∏é</a></p></li>
<li id="fn7"><p>As an aside it‚Äôs worth noting that reticulate exports an object called <code>py</code>, from which Python objects can be accessed: the <code>sys</code> object can also be referred to as <code>py$sys</code>.<a href="#fnref7" class="footnote-back" role="doc-backlink">‚Ü©Ô∏é</a></p></li>
<li id="fn8"><p>Note that the website does not explicitly specify a particular licence, but <a href="https://www.researchgate.net/publication/352462027_A_Quarter_Century_of_Reptile_and_Amphibian_Databases">journal articles documenting the database</a> written by the maintainers do refer to it as ‚Äúopen and freely available‚Äù. With that in mind I take it that the use of the data in this post is permitted. Naturally, should I discover that it is not I‚Äôll immediately remove it!<a href="#fnref8" class="footnote-back" role="doc-backlink">‚Ü©Ô∏é</a></p></li>
</ol>
</section><section class="quarto-appendix-contents"><h2 class="anchored quarto-appendix-heading">Reuse</h2><div quarto-reuse="quarto-reuse" class="quarto-appendix-contents"><a rel="license" href="https://creativecommons.org/licenses/by/4.0/">https://creativecommons.org/licenses/by/4.0/</a></div></section><section class="quarto-appendix-contents"><h2 class="anchored quarto-appendix-heading">Citation</h2><div><div class="quarto-appendix-secondary-label">BibTeX citation:</div><pre class="sourceCode code-with-copy quarto-appendix-bibtex"><code class="sourceCode bibtex">@online{navarro2022,
  author = {Danielle Navarro},
  editor = {},
  title = {Passing {Arrow} {Tables} Between {R} and {Python} with
    Reticulate},
  date = {2022-09-01},
  url = {https://blog.djnavarro.net/posts/2022-09-01_reticulated-arrow},
  langid = {en}
}
</code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre><div class="quarto-appendix-secondary-label">For attribution, please cite this work as:</div><div id="ref-navarro2022" class="csl-entry quarto-appendix-citeas" role="doc-biblioentry">
Danielle Navarro. 2022. <span>‚ÄúPassing Arrow Tables Between R and Python
with Reticulate.‚Äù</span> September 1, 2022. <a href="https://blog.djnavarro.net/posts/2022-09-01_reticulated-arrow">https://blog.djnavarro.net/posts/2022-09-01_reticulated-arrow</a>.
</div></div></section></div></main> <!-- /main -->
<!-- plausible -->
<script async="" defer="" data-domain="blog.djnavarro.net" src="https://plausible.io/js/plausible.js"></script>
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "Óßã";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    setTimeout(function() {
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const cites = ref.parentNode.getAttribute('data-cites').split(' ');
    tippyHover(ref, function() {
      var popup = window.document.createElement('div');
      cites.forEach(function(cite) {
        var citeDiv = window.document.createElement('div');
        citeDiv.classList.add('hanging-indent');
        citeDiv.classList.add('csl-entry');
        var biblioDiv = window.document.getElementById('ref-' + cite);
        if (biblioDiv) {
          citeDiv.innerHTML = biblioDiv.innerHTML;
        }
        popup.appendChild(citeDiv);
      });
      return popup.innerHTML;
    });
  }
});
</script>
</div> <!-- /content -->



</body></html>