<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.433">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Danielle Navarro">
<meta name="dcterms.date" content="2023-12-19">
<meta name="description" content="There are times when you simply have to derive a thing yourself in order to understand it, even if no-one else cares">

<title>Notes from a data witch - Closed form solutions for a two-compartment pharmacokinetic model</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<style>

      .quarto-title-block .quarto-title-banner {
        background: #eeeeee;
      }
</style>

  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<link rel="stylesheet" href="../../styles.css">
<meta property="og:title" content="Notes from a data witch - Closed form solutions for a two-compartment pharmacokinetic model">
<meta property="og:description" content="There are times when you simply have to derive a thing yourself in order to understand it, even if no-one else cares">
<meta property="og:image" content="https://blog.djnavarro.net/posts/2023-12-19_solving-two-compartment-pk-models/gayatri-malhotra-4wF66_KWJxA-unsplash.jpg">
<meta property="og:site-name" content="Notes from a data witch">
<meta property="og:image:alt" content="Grey and yellow photo of stairs with multiplication formulas depicted on the steps">
<meta name="twitter:title" content="Notes from a data witch - Closed form solutions for a two-compartment pharmacokinetic model">
<meta name="twitter:description" content="There are times when you simply have to derive a thing yourself in order to understand it, even if no-one else cares">
<meta name="twitter:image" content="https://blog.djnavarro.net/posts/2023-12-19_solving-two-compartment-pk-models/gayatri-malhotra-4wF66_KWJxA-unsplash.jpg">
<meta name="twitter:creator" content="@djnavarro">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image:alt" content="Grey and yellow photo of stairs with multiplication formulas depicted on the steps">
</head>

<body class="floating nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../index.html" rel="" target="">
 <span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../index.xml" rel="" target="">
 <span class="menu-text">RSS</span></a>
  </li>  
</ul>
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-sites" role="button" data-bs-toggle="dropdown" aria-expanded="false" rel="" target="">
 <span class="menu-text">Sites</span>
    </a>
    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="nav-menu-sites">    
        <li>
    <a class="dropdown-item" href="https://djnavarro.net" rel="" target="">
 <span class="dropdown-text">Homepage</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="https://blog.djnavarro.net" rel="" target="">
 <span class="dropdown-text">Data science blog</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="https://art.djnavarro.net" rel="" target="">
 <span class="dropdown-text">Generative art</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="https://papers.djnavarro.net" rel="" target="">
 <span class="dropdown-text">Academic papers</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="https://djnavarro.net/sites" rel="" target="">
 <span class="dropdown-text">More…</span></a>
  </li>  
    </ul>
  </li>
</ul>
            <div class="quarto-navbar-tools">
</div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default toc-left page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <h1 class="title">Closed form solutions for a two-compartment pharmacokinetic model</h1>
                  <div>
        <div class="description">
          There are times when you simply have to derive a thing yourself in order to understand it, even if no-one else cares
        </div>
      </div>
                          <div class="quarto-categories">
                <div class="quarto-category">Pharmacometrics</div>
              </div>
                  </div>
  </div>
    
  
  <div class="quarto-title-meta">

      <div>
      <div class="quarto-title-meta-heading">Author</div>
      <div class="quarto-title-meta-contents">
               <p><a href="https://djnavarro.net">Danielle Navarro</a> <a href="https://orcid.org/0000-0001-7648-6578" class="quarto-title-author-orcid"> <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAA2ZpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMC1jMDYwIDYxLjEzNDc3NywgMjAxMC8wMi8xMi0xNzozMjowMCAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wTU09Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9tbS8iIHhtbG5zOnN0UmVmPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvc1R5cGUvUmVzb3VyY2VSZWYjIiB4bWxuczp4bXA9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC8iIHhtcE1NOk9yaWdpbmFsRG9jdW1lbnRJRD0ieG1wLmRpZDo1N0NEMjA4MDI1MjA2ODExOTk0QzkzNTEzRjZEQTg1NyIgeG1wTU06RG9jdW1lbnRJRD0ieG1wLmRpZDozM0NDOEJGNEZGNTcxMUUxODdBOEVCODg2RjdCQ0QwOSIgeG1wTU06SW5zdGFuY2VJRD0ieG1wLmlpZDozM0NDOEJGM0ZGNTcxMUUxODdBOEVCODg2RjdCQ0QwOSIgeG1wOkNyZWF0b3JUb29sPSJBZG9iZSBQaG90b3Nob3AgQ1M1IE1hY2ludG9zaCI+IDx4bXBNTTpEZXJpdmVkRnJvbSBzdFJlZjppbnN0YW5jZUlEPSJ4bXAuaWlkOkZDN0YxMTc0MDcyMDY4MTE5NUZFRDc5MUM2MUUwNEREIiBzdFJlZjpkb2N1bWVudElEPSJ4bXAuZGlkOjU3Q0QyMDgwMjUyMDY4MTE5OTRDOTM1MTNGNkRBODU3Ii8+IDwvcmRmOkRlc2NyaXB0aW9uPiA8L3JkZjpSREY+IDwveDp4bXBtZXRhPiA8P3hwYWNrZXQgZW5kPSJyIj8+84NovQAAAR1JREFUeNpiZEADy85ZJgCpeCB2QJM6AMQLo4yOL0AWZETSqACk1gOxAQN+cAGIA4EGPQBxmJA0nwdpjjQ8xqArmczw5tMHXAaALDgP1QMxAGqzAAPxQACqh4ER6uf5MBlkm0X4EGayMfMw/Pr7Bd2gRBZogMFBrv01hisv5jLsv9nLAPIOMnjy8RDDyYctyAbFM2EJbRQw+aAWw/LzVgx7b+cwCHKqMhjJFCBLOzAR6+lXX84xnHjYyqAo5IUizkRCwIENQQckGSDGY4TVgAPEaraQr2a4/24bSuoExcJCfAEJihXkWDj3ZAKy9EJGaEo8T0QSxkjSwORsCAuDQCD+QILmD1A9kECEZgxDaEZhICIzGcIyEyOl2RkgwAAhkmC+eAm0TAAAAABJRU5ErkJggg=="></a></p>
            </div>
    </div>
      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">December 19, 2023</p>
      </div>
    </div>
    
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal sidebar-navigation floating overflow-auto">
    <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#the-matter-at-hand" id="toc-the-matter-at-hand" class="nav-link active" data-scroll-target="#the-matter-at-hand">The matter at hand</a></li>
  <li><a href="#a-two-compartment-pharmacokinetic-model" id="toc-a-two-compartment-pharmacokinetic-model" class="nav-link" data-scroll-target="#a-two-compartment-pharmacokinetic-model">A two compartment pharmacokinetic model</a></li>
  <li><a href="#solving-linear-time-homogeneous-ode-systems" id="toc-solving-linear-time-homogeneous-ode-systems" class="nav-link" data-scroll-target="#solving-linear-time-homogeneous-ode-systems">Solving linear time-homogeneous ODE systems</a></li>
  <li><a href="#solve-a-simpler-problem" id="toc-solve-a-simpler-problem" class="nav-link" data-scroll-target="#solve-a-simpler-problem">Solve a simpler problem</a></li>
  <li><a href="#returning-to-the-original-problem" id="toc-returning-to-the-original-problem" class="nav-link" data-scroll-target="#returning-to-the-original-problem">Returning to the original problem</a></li>
  <li><a href="#does-it-work" id="toc-does-it-work" class="nav-link" data-scroll-target="#does-it-work">Does it work?</a></li>
  <li><a href="#was-it-worth-it" id="toc-was-it-worth-it" class="nav-link" data-scroll-target="#was-it-worth-it">Was it worth it?</a></li>
  <li><a href="#resources" id="toc-resources" class="nav-link" data-scroll-target="#resources">Resources</a></li>
  </ul>
</nav>
</nav>
<div id="quarto-sidebar-glass" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
    </div>
<!-- main -->
<main class="content quarto-banner-title-block page-columns page-full" id="quarto-document-content">




<!--------------- my typical setup ----------------->
<!--------------- post begins here ----------------->
<p>It is late December, the office is quiet on the eve of the annual ritual of everyone vanishing into their own personal end of year vacations, and I have time to breathe and – heaven forfend – to think. As such, and in the spirit of trying to do something professionally useful during this strangely empty moment of the year, it is time for another post in my irregular and unsystematic <a href="http://blog.djnavarro.net/category/pharmacometrics">series on pharmacometrics</a>. Does anyone except Danielle care? Unlikely. Will it make the world a better place? Absolutely not. But neither of these has ever been a governing consideration on this blog.<a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a></p>
<section id="the-matter-at-hand" class="level2">
<h2 class="anchored" data-anchor-id="the-matter-at-hand">The matter at hand</h2>
<p>The topic for today’s installment in Danielle’s ongoing public display of blog-based narcissism is deriving closed-form solutions for two-compartment pharmacokinetic (PK) models. There is absolutely nothing in the post that is not already extremely well known by pharmacometricians, and the scope of the post is somewhat narrower than the full range of two-compartment PK models. I’m mostly going to consider this model:</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="./2-cpt-phys.png" class="img-fluid figure-img" style="width:60.0%"></p>
</figure>
</div>
<p>Here we have the garden-variety two-compartment model with first-order absorption and first-order elimination. In the usual application of this model we have a drug that is administered orally. The drug is absorbed gradually from the gut into systemic circulation (central compartment), and is gradually eliminated from the body, again from the central compartment. During the time that the drug is within the body, it does not stay solely within the blood: it is distributed through various other tissues, and so the volume over which it is distributed changes over time. In a two-compartment model the complexity of this is simplified: the drug concentration in a typical study is measured only in the central compartment (e.g., by measuring plasma concentration), and so the model does not concern itself with the fine grained details of what is happening elsewhere in the body. It is often (not always) sufficient to assume that the “other” tissues in which the drug distributes comprise a single “peripheral compartment”.</p>
<p>In order to attach physiologically meaningful interpretation to this model, it’s typically parameterised in terms of the following five quantities:</p>
<ul>
<li>Volume of distribution for the central compartment <span class="math inline">\(V_c\)</span> refers to the volume over which the drug amount in the central compartment is assumed to be evenly distributed. It’s a fictional quantity – and can take on values that are much larger than the actual volume of blood or plasma for a variety of reasons – but it’s a convenient one.</li>
<li>Volume of distribution for the peripheral compartment <span class="math inline">\(V_p\)</span>: as above but for the peripheral compartment</li>
<li>Clearance <span class="math inline">\(Cl\)</span> is the volume within the central compartment that can be completely cleared of drug per unit time, and governs the elimination of drug from the body</li>
<li>Intercompartmental clearance <span class="math inline">\(Q\)</span> governs the exchange of drug between the central and peripheral compartments</li>
<li>The absorption rate constant <span class="math inline">\(k_a\)</span> is a scaling factor used to describe the proportion of the drug amount currently in the gut that is transferred into systemic circulation at any moment in time<a href="#fn2" class="footnote-ref" id="fnref2" role="doc-noteref"><sup>2</sup></a></li>
</ul>
<p>This model is probably the one I come across most in my everyday work, and these are the parameters used to interpret model behaviour. However, it’s not the most convenient form to use when working with the model mathematically, so let’s rewrite it in terms that are more convenient.</p>
</section>
<section id="a-two-compartment-pharmacokinetic-model" class="level2">
<h2 class="anchored" data-anchor-id="a-two-compartment-pharmacokinetic-model">A two compartment pharmacokinetic model</h2>
<p>As in every mathematical fairy tale and religious text, we begin with some notation. The state of our system will at time <span class="math inline">\(t\)</span> be described in terms of three quantities: <span class="math inline">\(x_{0t}\)</span> is the drug amount in the depot compartment (generally the gut) at time <span class="math inline">\(t\)</span> units post-dose, <span class="math inline">\(x_{1t}\)</span> is the amount in the central compartment, and <span class="math inline">\(x_{2t}\)</span> is the amount in the peripheral compartment. Our state vector <span class="math inline">\(\mathbf{x}_t \in \mathbb{R}^3_{\geq 0}\)</span> is the collection of these three things, and if you care deeply about such matters you might wish to assert that the drug amounts are described by a function <span class="math inline">\(\mathbf{x}(t)\)</span> that takes on such values:</p>
<p><span class="math display">\[
\mathbf{x}(t) = \mathbf{x}_t = (x_{0t}, x_{1t}, x_{2t})
\]</span> In an act of perversity, however, I’m not going to use the functional notation <span class="math inline">\(\mathbf{x}(t)\)</span> here. I’m simply going to talk about the state vector <span class="math inline">\(\mathbf{x}_t\)</span> because honestly no-one wants to see what this post would look like if I added all those extra parentheses.</p>
<p>Having established this notation and – in a Barbie-like state of best-day-ever excitement – we can now describe how the state vector changes over time using a system of ordinary differential equations (ODEs):</p>
<p><span class="math display">\[
\begin{array}{rcl}
\frac{d}{dt} x_{0t} &amp; = &amp; -k_{01} x_{0t} \\
\frac{d}{dt} x_{1t} &amp; = &amp; k_{01} x_{0t} - (k_{12} + k_{10}) x_{1t} + k_{21} x_{2t} \\
\frac{d}{dt} x_{2t} &amp; = &amp; k_{12} x_{1t} - k_{21} x_{2t}
\end{array}
\]</span></p>
<p>Here we have four rate constant parameters (<span class="math inline">\(k_{01}\)</span>, <span class="math inline">\(k_{10}\)</span>, <span class="math inline">\(k_{12}\)</span>, and <span class="math inline">\(k_{21}\)</span>), each of which describes the instantaneous transfer of drug quantity from one compartment to another: the notational convention is to refer to the source compartment as the first subscript and the destination compartment as the second, so for instance <span class="math inline">\(k_{12}\)</span> is the rate constant associated with the movement of drug from the central compartment (compartment 1) to the peripheral compartment (compartment 2). In this notation the “zero-th” compartment is an abstraction: <span class="math inline">\(k_{01}\)</span> describes absorption (generally from the gut) and <span class="math inline">\(k_{10}\)</span> describes elimination (generally to urine).<a href="#fn3" class="footnote-ref" id="fnref3" role="doc-noteref"><sup>3</sup></a></p>
<p>Schematically, the exchange of drug amounts between the compartments in this formalism can be visualised in the following way:</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="./2-cpt-micro.png" class="img-fluid figure-img" style="width:60.0%"></p>
</figure>
</div>
<p>Structurally you can see it’s the same as the model described at the start, and it’s not at all difficult to convert between the physiologically-interpretable parameterisation and the mathematically-convenient parameterisation using these rate constants.<a href="#fn4" class="footnote-ref" id="fnref4" role="doc-noteref"><sup>4</sup></a> between the ODE-friendly parameterisation that uses the rate constants <span class="math inline">\(k_{01}\)</span>, <span class="math inline">\(k_{10}\)</span>, <span class="math inline">\(k_{21}\)</span> and <span class="math inline">\(k_{12}\)</span> and the physiologically-interpretable parameterisation.<a href="#fn5" class="footnote-ref" id="fnref5" role="doc-noteref"><sup>5</sup></a></p>
<p>In matrix form we can express the ODE system as:</p>
<p><span class="math display">\[
\frac{d}{dt} \mathbf{x}_t = \mathbf{K} \mathbf{x}_t
\]</span></p>
<p>where</p>
<p><span class="math display">\[
\mathbf{K} = \left[
\begin{array}{ccc}
-k_{01} &amp;                0  &amp;       0 \\
k_{01} &amp; -k_{12} - k_{10}  &amp;  k_{21} \\
      0 &amp;           k_{12}  &amp; -k_{21} \\
\end{array}
\right]
\]</span></p>
<p>and our initial conditions for a dose administered orally at time <span class="math inline">\(t=0\)</span> are:</p>
<p><span class="math display">\[
\mathbf{x}_{0} = (\mbox{dose}, 0, 0)
\]</span></p>
<p>This particular parameterisation is most helpful when we want to think about the underlying ODE system, and it’s the one I’ll use for deriving solutions in this post, but when we want to interpret the models we usually rewrite it in terms of the parameters I described at the start of the post.<a href="#fn6" class="footnote-ref" id="fnref6" role="doc-noteref"><sup>6</sup></a></p>
</section>
<section id="solving-linear-time-homogeneous-ode-systems" class="level2">
<h2 class="anchored" data-anchor-id="solving-linear-time-homogeneous-ode-systems">Solving linear time-homogeneous ODE systems</h2>
<p>So now we get to the part of the post where the mathematics begins to intrude. Per our model, we have a linear time-homogeneous ODE system that we want to solve, in the sense that we would like a nice algebraic expression that describes the state <span class="math inline">\(\mathbf{x}_t\)</span> at time <span class="math inline">\(t\)</span>. Of course, I want all sorts of things in life that I can’t obtain without suffering, and this is no exception. If you want to solve a linear homogeneous ODE, you’re going to have to work with matrix exponentials, and with matrix exponentials comes pain. Especially if, like me, you vaguely remember matrix exponentials from an undergrad maths class you took 30 years ago and you actually haven’t needed to use them for anything much in the decades that followed.</p>
<p>Perhaps a small “refresher” will help us all then. The <a href="https://en.wikipedia.org/wiki/Matrix_exponential">matrix exponential</a> <span class="math inline">\(e^{\mathbf{K}}\)</span> of a matrix <span class="math inline">\(\mathbf{K}\)</span> is a quantity that is broadly analogous to its scalar equivalent <span class="math inline">\(e^k\)</span> for scalar value <span class="math inline">\(k\)</span>, and has similar (but not identical) properties. In the same way that we can define a scalar exponential <span class="math inline">\(e^k\)</span> via a <a href="https://en.wikipedia.org/wiki/Taylor_series#List_of_Maclaurin_series_of_some_common_functions">series expansion</a>, the matrix exponential <span class="math inline">\(e^{\mathbf{K}}\)</span> is defined as:</p>
<p><span class="math display">\[
\begin{array}{rcl}
e^{\mathbf{K}} &amp;=&amp; \mathbf{I} + \mathbf{K} + \frac{1}{2} \mathbf{K}^2 + \frac{1}{6} \mathbf{K}^3 + \ldots + \frac{1}{j!} \mathbf{K}^j + \ldots \\
&amp;=&amp; \sum_{j = 0}^\infty \frac{1}{j!} \mathbf{K}^j
\end{array}
\]</span></p>
<p>Some handy properties for matrix exponentials, most of which we’ll need:</p>
<ul>
<li>If <span class="math inline">\(\mathbf{K}\)</span> is a matrix of zeros, <span class="math inline">\(e^{\mathbf{K}} = 1\)</span></li>
<li>If <span class="math inline">\(\mathbf{K}\)</span> is the identity <span class="math inline">\(\mathbf{I}\)</span>, <span class="math inline">\(e^{\mathbf{K}} = e^{\mathbf{I}} = \mathbf{I}\)</span></li>
<li>If <span class="math inline">\(t\)</span> is a scalar, <span class="math inline">\(e^{t\mathbf{K}} = e^t e^\mathbf{K}\)</span></li>
<li>If <span class="math inline">\(m\)</span> and <span class="math inline">\(n\)</span> are scalars, <span class="math inline">\(e^{m\mathbf{K}} e^{n \mathbf{K}} = e^{(m + n)\mathbf{K}}\)</span></li>
<li>If <span class="math inline">\(\mathbf{D} = \mbox{diag}(d_1, d_2, \ldots)\)</span> is a diagonal matrix, <span class="math inline">\(e^\mathbf{D}\)</span> is the diagonal matrix <span class="math inline">\(e^\mathbf{D} = \mbox{diag}(e^{d_1}, e^{d_2}, \ldots)\)</span></li>
<li>The derivative is analogous to the scalar case, <span class="math inline">\(\frac{d}{dt} e^{t \mathbf{K}} = \mathbf{K} e^{t \mathbf{K}}\)</span></li>
<li>For an invertible matrix <span class="math inline">\(\mathbf{H}\)</span> such that <span class="math inline">\(\mathbf{K} = \mathbf{HMH^{-1}}\)</span>, <span class="math inline">\(e^{t\mathbf{K}} = \mathbf{H} e^{t \mathbf{M}} \mathbf{H^{-1}}\)</span></li>
</ul>
<p>On the basis of the derivative property above, it’s immediately clear that the solution to our ODE system is going to take the following form:<a href="#fn7" class="footnote-ref" id="fnref7" role="doc-noteref"><sup>7</sup></a></p>
<p><span class="math display">\[
\mathbf{x}_t = e^{t \mathbf{K}} \mathbf{x}_0
\]</span></p>
<p>Seeing that this is the form of the solution is the easy part. The hard part, of course, is finding the expression that describes the matrix exponential <span class="math inline">\(e^{t\mathbf{K}}\)</span>. Fortunately, this is something that cleverer people than I have already thought about, and in any case the properties of matrix exponentials suggest a general strategy for such problems:</p>
<ol type="1">
<li>Find the eigenvalues <span class="math inline">\(\lambda_1, \lambda_2, \ldots\)</span>, for the matrix <span class="math inline">\(\mathbf{K}\)</span></li>
<li>Find the corresponding eigenvectors <span class="math inline">\(\mathbf{u}_1, \mathbf{u}_2, \ldots\)</span></li>
<li>Construct the matrix <span class="math inline">\(\mathbf{U} = [\mathbf{u}_1, \mathbf{u}_2, \ldots]\)</span> with the eigenvectors as columns, and diagonal matrix <span class="math inline">\(\mathbf{\Lambda}\)</span> whose diagonals correspond to eigenvalues, and invert it to obtain <span class="math inline">\(\mathbf{U}^{-1}\)</span></li>
<li>Noting that we have the eigendecomposition <span class="math inline">\(K = \mathbf{U \Lambda U^{-1}}\)</span>, rewrite <span class="math inline">\(e^{t\mathbf{K}} = \mathbf{U} e^{t\mathbf{\Lambda}} \mathbf{U^{-1}}\)</span></li>
<li>Since <span class="math inline">\(\mathbf{\Lambda}\)</span> is diagonal, <span class="math inline">\(e^{t\mathbf{\Lambda}}\)</span> is straightforward, and we can calculate <span class="math inline">\(e^{t\mathbf{K}}\)</span> by matrix multiplication</li>
</ol>
<p>Okay then. Much like the Cylons, we have a Plan.<a href="#fn8" class="footnote-ref" id="fnref8" role="doc-noteref"><sup>8</sup></a></p>
</section>
<section id="solve-a-simpler-problem" class="level2">
<h2 class="anchored" data-anchor-id="solve-a-simpler-problem">Solve a simpler problem</h2>
<p>As Jane Austen famously said, “it is a truth universally acknowledged, that a woman in possession of a three-state ODE system must be in want of a two-state ODE that is easier to solve”. And so it is here. Rather than try to work with the model as described, I’ll start with a simpler model (one that is itself quite useful) that will be easier to solve, and whose solution will make it massively easier to solve the full system. And so it is that our first step will be to retreat from a two-compartment model with oral dosing to a two-compartment model with bolus IV dosing.</p>
<p>In most cases I’ve come across in my pharmacometric work so far, the drug we’re modelling is orally administered, and the model with first-order absorption into the central compartment described above (or some variation thereof) is the one we want to use. However, it’s convenient to start with a simpler case where the drug is administered by a bolus IV dose, and of course this scenario does arise in real life. In this scenario there is no depot compartment, and entire dose appears in the central compartment at <span class="math inline">\(t = 0\)</span>. Or, to frame it in technical terms, we have zero-order absorption into the central compartment rather than first-order absorption. Again assuming first-order elimination, <span class="math inline">\(\mathbf{K}\)</span> is now a simpler 2x2 matrix.<a href="#fn9" class="footnote-ref" id="fnref9" role="doc-noteref"><sup>9</sup></a> In this situation our state vector consists only of the central and peripheral compartments:</p>
<p><span class="math display">\[
\mathbf{x}(t) = \mathbf{x}_t = (x_{1t}, x_{2t})
\]</span></p>
<p>Our state transition matrix is now this:</p>
<p><span class="math display">\[
\mathbf{K} = \left[
\begin{array}{cc}
-k_{12} - k_{10}  &amp;  k_{21} \\
          k_{12}  &amp; -k_{21} \\
\end{array}
\right]
\]</span></p>
<p>and our initial state at time <span class="math inline">\(t=0\)</span> is:</p>
<p><span class="math display">\[
\mathbf{x}_{0} = (\mbox{dose}, 0)
\]</span></p>
<p>As before, our solution will be of the form</p>
<p><span class="math display">\[
\mathbf{x}_t = e^{t \mathbf{K}} \mathbf{x}_0
\]</span></p>
<p>and we can find this solution by following the general strategy outlined earlier. To that end, I’ll begin by finding the <a href="https://en.wikipedia.org/wiki/Eigenvalues_and_eigenvectors">eigenvalues</a> <span class="math inline">\(\lambda\)</span> that satisfy <span class="math inline">\(\det(\mathbf{K} - \lambda \mathbf{I}) = 0\)</span>. Well, technically speaking, I’ll begin by taking a little trip down memory lane to 1994 and my first-year undergraduate maths classes, but I’ll spare you that traumatic recollection and jump straight to the derivation:</p>
<p><span class="math display">\[
\begin{array}{rcl}
\det(\mathbf{K} - \lambda \mathbf{I})
&amp;=&amp; \det \left[
\begin{array}{cc}
-k_{12} - k_{10} - \lambda  &amp;  k_{21} \\
          k_{12}  &amp; -k_{21} - \lambda \\
\end{array}
\right] \\
&amp;=&amp; (-k_{12} - k_{10} - \lambda)(-k_{21} - \lambda) - k_{12} k_{21} \\
&amp;=&amp; \lambda^2 + (k_{10} + k_{12} + k_{21}) \lambda + k_{10} k_{21}
\end{array}
\]</span> The final expression doesn’t factorise into anything very pretty, so it’s conventional to simply define new variables <span class="math inline">\(\alpha\)</span> and <span class="math inline">\(\beta\)</span> such that:</p>
<p><span class="math display">\[
\begin{array}{rcl}
\alpha \beta &amp; = &amp; k_{10} k_{21} \\
\alpha + \beta &amp; = &amp; k_{10} + k_{12} + k_{21}
\end{array}
\]</span></p>
<p>when written in these new variables, which were constructed <em>specifically</em> to make an expression that factorises easily, the left hand side of our characteristic equation turns out to be shockingly simple to factorise:</p>
<p><span class="math display">\[
\det(\mathbf{K} - \lambda \mathbf{I}) = \lambda^2 + (\alpha + \beta) \lambda + \alpha \beta = (\lambda + \alpha)(\lambda + \beta)
\]</span></p>
<p>Wonders will never cease. In any case, when written in these terms, our two eigenvalues are <span class="math inline">\(\lambda = -\alpha\)</span> and <span class="math inline">\(\lambda = -\beta\)</span>. This is – of course – a pure notational convenience since <span class="math inline">\(-\alpha\)</span> and <span class="math inline">\(-\beta\)</span> were defined such that they would end up begin the eigenvalues, but it’s worth mentioning this because these are the exact variables that show up in various software systems (e.g., <a href="https://www.iconplc.com/solutions/technologies/nonmem">NONMEM</a>) and textbooks. Nevertheless, it’s still no good to us if we don’t go through tedious business of applying the quadratic formula to express <span class="math inline">\(\alpha\)</span> and <span class="math inline">\(\beta\)</span> in terms of <span class="math inline">\(k_{01}\)</span>, <span class="math inline">\(k_{10}\)</span>, <span class="math inline">\(k_{12}\)</span>, and <span class="math inline">\(k_{21}\)</span>. So here it is:</p>
<p><span class="math display">\[
\begin{array}{rcl}
\alpha, \beta
&amp;=&amp; \displaystyle\frac{(\alpha + \beta) \pm \sqrt{(\alpha + \beta)^2 - 4\alpha \beta}}{2} \\
&amp;=&amp; \displaystyle\frac{(k_{10} + k_{12} + k_{21}) \pm \sqrt{(k_{10} + k_{12} + k_{21})^2 - 4k_{10} k_{21}}}{2}
\end{array}
\]</span></p>
<p>Now that we have the eigenvalues, we proceed to the eigenvectors. For each eigenvalue <span class="math inline">\(\lambda\)</span> there is a corresponding eigenvector <span class="math inline">\(\mathbf{u}\)</span> such that <span class="math inline">\((\mathbf{K} - \lambda \mathbf{I}) \mathbf{u} = \mathbf{0}\)</span>. In our case:</p>
<p><span class="math display">\[
\left[
\begin{array}{cc}
-k_{12} - k_{10} - \lambda  &amp;  k_{21} \\
          k_{12}  &amp; -k_{21} - \lambda \\
\end{array}
\right]
\left[
\begin{array}{c}
u_1 \\
u_2
\end{array}
\right]
=
\left[
\begin{array}{c}
0 \\
0
\end{array}
\right]
\]</span></p>
<p>If this were a bigger matrix we’d probably use <a href="https://en.wikipedia.org/wiki/Gaussian_elimination">Gauss-Jordan elimination</a> to construct the row-reduced echelon form (RREF) and then read off the solutions using the RREF. That’s kind of overkill in this case because – let’s be brutally honest here – you can <em>look</em> at the bottom row and guess that the solution is going to have the form <span class="math inline">\(u_1 = k_{21} + \lambda\)</span>, <span class="math inline">\(u_2 = k_{12}\)</span>.</p>
<p>To convince ourselves that this is the correct solution, we’ll substitute it into both rows and see that, shockingly, we end up with zero. We’ll start with the bottom row because that was the one we used to guess the solution:</p>
<p><span class="math display">\[
\begin{array}{rcl}
k_{12} u_1 + (-k_{21} - \lambda) u_2
&amp;=&amp; k_{12} (k_{21} + \lambda) + (-k_{21} - \lambda) k_{12} \\
&amp;=&amp; 0
\end{array}
\]</span></p>
<p>I mean. Of course that was going to work. We literally chose expressions for <span class="math inline">\(u_1\)</span> and <span class="math inline">\(u_2\)</span> that would cause the two terms to cancel out. The actual test of our guess arrives when we try the same thing with the top row. This time it’s takes a little more effort:</p>
<p><span class="math display">\[
\begin{array}{rcl}
(-k_{12} - k_{10} - \lambda) u_1 + k_{21} u_2
&amp;=&amp; (-k_{12} - k_{10} - \lambda) (k_{21} + \lambda) + k_{21} k_{12} \\
&amp;=&amp; -k_{12} k_{21} - k_{10} k_{21} - \lambda k_{21} - k_{12} \lambda - k_{10} \lambda - \lambda^2 + k_{21} k_{12} \\
&amp;=&amp; - k_{10} k_{21} - \lambda k_{21} - k_{12} \lambda - k_{10} \lambda - \lambda^2 \\
&amp;=&amp; - k_{10} k_{21} - (k_{21} + k_{12} + k_{10}) \lambda - \lambda^2 \\
&amp;=&amp; - \alpha \beta - (\alpha + \beta) \lambda - \lambda^2 \\
&amp;=&amp; - (\lambda + \alpha) (\lambda + \beta) \\
\end{array}
\]</span></p>
<p>Once we have arrived at this expression, it’s clear that our guess is correct. The only two values that <span class="math inline">\(\lambda\)</span> can take are the eigenvalues <span class="math inline">\(\lambda = -\alpha\)</span> and <span class="math inline">\(\lambda = -\beta\)</span>, and both of those yield a value of zero. So our guess was indeed correct and we have our eigenvectors. Awesome.<a href="#fn10" class="footnote-ref" id="fnref10" role="doc-noteref"><sup>10</sup></a></p>
<p>Now that we are in possession of eigenvalues and eigenvectors we can construct the matrices <span class="math inline">\(\mathbf{U}\)</span> and <span class="math inline">\(\mathbf{\Lambda}\)</span> that will give us the <a href="https://en.wikipedia.org/wiki/Eigendecomposition_of_a_matrix">eigendecomposition</a> <span class="math inline">\(\mathbf{K} = \mathbf{U \Lambda U}^{-1}\)</span>. Here they are:</p>
<p><span class="math display">\[
\begin{array}{rcl}
\mathbf{\Lambda} &amp;=&amp;
\left[
\begin{array}{cc}
-\alpha &amp; 0 \\
0 &amp; -\beta
\end{array}
\right]
\\
\mathbf{U} &amp;=&amp;
\left[
\begin{array}{cc}
k_{21} -\alpha &amp; k_{21} - \beta \\
k_{12} &amp; k_{12}
\end{array}
\right]
\end{array}
\]</span></p>
<p>The last thing we need is the inverse <span class="math inline">\(\mathbf{U}^{-1}\)</span>, which is also fairly easy to derive. It’s a 2x2 matrix, after all, and inverting a 2x2 matrix isn’t even undergrad level maths: they taught us that one in high school. Noting first that determinant <span class="math inline">\(\det \mathbf{U}\)</span> is as follows,</p>
<p><span class="math display">\[
\det \mathbf{U} = (k_{21} - \alpha) k_{12} - k_{12} (k_{21} - \beta) = k_{12} (\beta - \alpha)
\]</span></p>
<p>we then write down the inverse as follows:</p>
<p><span class="math display">\[
\mathbf{U}^{-1} =
\frac{1}{k_{12}(\beta - \alpha)}
\left[
\begin{array}{cc}
k_{12} &amp; \beta - k_{21} \\
-k_{12} &amp; k_{21} -\alpha
\end{array}
\right]
\]</span></p>
<p>So now we have <span class="math inline">\(\mathbf{U}\)</span>, <span class="math inline">\(\mathbf{U}^{-1}\)</span>, and <span class="math inline">\(\mathbf{\Lambda}\)</span>, and we could proceed straight to doing the matrix multiplication but for the sake of what is left of my sanity I’m going to simplify my notation a bit and define two new constants <span class="math inline">\(a\)</span> and <span class="math inline">\(b\)</span>:</p>
<p><span class="math display">\[
\begin{array}{rcl}
a &amp; = &amp; (k_{21} - \alpha) / k_{12} \\
b &amp; = &amp; (k_{21} - \beta) / k_{12}
\end{array}
\]</span></p>
<p>With the help of these two constant, the expressions for <span class="math inline">\(\mathbf{U}\)</span> and <span class="math inline">\(\mathbf{U}^{-1}\)</span> are now considerably less unpleasant on the eye:</p>
<p><span class="math display">\[
\begin{array}{rcl}
\mathbf{U} &amp;=&amp;
k_{12} \left[
\begin{array}{cc}
a &amp; b \\
1 &amp; 1
\end{array}
\right]
\\
\mathbf{U}^{-1} &amp;=&amp;
\displaystyle\frac{1}{\beta - \alpha} \left[
\begin{array}{cc}
1 &amp; -b \\
-1 &amp; a
\end{array}
\right]
\end{array}
\]</span></p>
<p>Now that we have the eigendecomposition <span class="math inline">\(\mathbf{K} = \mathbf{U \Lambda U}^{-1}\)</span>, we can solve our matrix exponential. Using the last of the matrix exponential properties in the potted list I provided earlier in the pose, we can express the matrix exponential <span class="math inline">\(e^{t \mathbf{K}}\)</span> as the matrix product <span class="math inline">\(\mathbf{U} e^{t \mathbf{\Lambda}} \mathbf{U}^{-1}\)</span>. Conveniently, <span class="math inline">\(\Lambda\)</span> is a diagonal matrix which makes <span class="math inline">\(e^{t \mathbf{\Lambda}}\)</span> trivially easy, and so we obtain this:<a href="#fn11" class="footnote-ref" id="fnref11" role="doc-noteref"><sup>11</sup></a></p>
<p><span class="math display">\[
\begin{array}{rcl}
e^{t \mathbf{K}} &amp; = &amp;
\mathbf{U} e^{t \mathbf{\Lambda}} \mathbf{U}^{-1} \\
&amp; = &amp;
\displaystyle\frac{k_{12}}{\beta - \alpha}
\left[
\begin{array}{cc}
a &amp; b \\
1 &amp; 1
\end{array}
\right]
\left[
\begin{array}{cc}
e^{-\alpha t} &amp; 0 \\
0 &amp; e^{-\beta t}
\end{array}
\right]
\left[
\begin{array}{cc}
1 &amp; -b \\
-1 &amp; a
\end{array}
\right]
\\
&amp; = &amp;
\displaystyle\frac{k_{12}}{\beta - \alpha}
\left[
\begin{array}{cc}
a e^{-\alpha t} &amp; b e^{-\beta t} \\
e^{-\alpha t} &amp; e^{-\beta t}
\end{array}
\right]
\left[
\begin{array}{cc}
1 &amp; -b \\
-1 &amp; a
\end{array}
\right] \\
&amp;=&amp;
\displaystyle\frac{k_{12}}{\beta - \alpha}
\left[
\begin{array}{cc}
(a e^{-\alpha t} - b e^{-\beta t}) &amp; -ab (e^{-\alpha t} - e^{-\beta t}) \\
-(e^{-\alpha t} - e^{-\beta t}) &amp; (-b e^{-\alpha t} + a e^{-\beta t})
\end{array}
\right]
\end{array}
\]</span></p>
<p>So now we can turn to our solution:</p>
<p><span class="math display">\[
\begin{array}{rcl}
\mathbf{x}_t &amp; = &amp; e^{t \mathbf{K}} \ \mathbf{x}_0 \\
&amp; = &amp;
\displaystyle\frac{k_{12}}{\beta - \alpha}
\left[
\begin{array}{cc}
(a e^{-\alpha t} - b e^{-\beta t}) &amp; -ab (e^{-\alpha t} - e^{-\beta t}) \\
-(e^{-\alpha t} - e^{-\beta t}) &amp; (-b e^{-\alpha t} + a e^{-\beta t})
\end{array}
\right]
\left[
\begin{array}{cc}
\mbox{dose} \\
0
\end{array}
\right] \\
&amp; = &amp;
\mbox{dose} \times \displaystyle\frac{k_{12}}{\beta - \alpha} \left[
\begin{array}{cc}
a e^{-\alpha t} - b e^{-\beta t} \\
e^{-\alpha t} - e^{-\beta t}
\end{array}
\right]
\end{array}
\]</span> Recalling that the central compartment corresponds to the first element of the state vector (top row), we can focus on this and compute the drug amount (not concentration) in the central compartment at time <span class="math inline">\(t\)</span>:</p>
<p><span class="math display">\[
\begin{array}{rcl}
x_{1t}
&amp;=&amp;
\mbox{dose} \times \displaystyle\frac{k_{12}}{\beta - \alpha} \times \left(  a e^{-\alpha t} - b e^{-\beta t} \right) \\
&amp;=&amp;
\mbox{dose} \times \displaystyle\frac{k_{12}}{\beta - \alpha} \times \left( \left(\frac{k_{21} - \alpha}{k_{12}} \right)  e^{-\alpha t} - \left(\frac{k_{21} - \beta}{k_{12}} \right) e^{-\beta t} \right) \\
&amp;=&amp;
\mbox{dose} \times \left( \left(\displaystyle\frac{\alpha - k_{21}}{\alpha - \beta} \right) e^{-\alpha t} - \left(\displaystyle\frac{\beta - k_{21}}{\alpha - \beta} \right) e^{-\beta t} \right) \\
&amp;=&amp;
\mbox{dose} \times \left(A e^{-\alpha t} +  B e^{-\beta t} \right)
\end{array}
\]</span></p>
<p>and thus we have a model that can be expressed as a sum of two exponentials where:</p>
<p><span class="math display">\[
\begin{array}{rcl}
A &amp; = &amp; \displaystyle\frac{\alpha - k_{21}}{\alpha - \beta} \\ \\
B &amp; = &amp; \displaystyle\frac{\beta - k_{21}}{\alpha - \beta}
\end{array}
\]</span></p>
<p>If I’m being completely honest, it’s precisely this biexponential<a href="#fn12" class="footnote-ref" id="fnref12" role="doc-noteref"><sup>12</sup></a> form that motivated me to suck it up and derive the solution myself. One of the textbooks I was reading at work – in order to familiarise myself with some of the pharmacokinetic background that I need – introduced the two-compartment model by defining it formally in terms of this biexponential expression,<a href="#fn13" class="footnote-ref" id="fnref13" role="doc-noteref"><sup>13</sup></a> but then drew this model schematically using a state-transition diagram similar to the ones I used at the start of this post. I was <em>baffled</em>, because it was not at all obvious to me from inspection how the diagram and the equation were linked, and the book did not present a derivation.</p>
<p>So yes, as with most things I do on this blog, my true motivation was in fact pig-headed stubbornness. I’m terribly bad at taking certain things on faith, and felt a deep – and let’s be honest, pathological – need to derive the solution myself. It is the very essence of spite-driven mathematics.</p>
</section>
<section id="returning-to-the-original-problem" class="level2">
<h2 class="anchored" data-anchor-id="returning-to-the-original-problem">Returning to the original problem</h2>
<p>Now that we have a closed form solution for a two-compartment model with zero-order absorption into the central compartment (i.e., bolus IV dosing), we can return to the oral dosing model (assuming first-order absorption) that we started with. It’s a relatively straightforward solution at this point since we have a continuous influx from the gut, so we can convolve this time-dependent influx with the zero-order solution. Since I’m assuming bioavailability <span class="math inline">\(F = 1\)</span> for this post<a href="#fn14" class="footnote-ref" id="fnref14" role="doc-noteref"><sup>14</sup></a> I’ll happily act as if the drug amount arriving in the central compartment from the gut at time <span class="math inline">\(t\)</span> is the same as the amount that left the gut at time <span class="math inline">\(t\)</span>:</p>
<p><span class="math display">\[
-\frac{d}{dt} x_{0t} = \mbox{dose} \times k_{01} \times e^{-k_{01} t}
\]</span></p>
<p>Thus the drug amount in the central compartment at time <span class="math inline">\(t\)</span> is given:</p>
<p><span class="math display">\[
\begin{array}{rcl}
x_{1t}
&amp;=&amp; \mbox{dose} \times k_{01} \times \displaystyle\int_0^t e^{-k_{01} u} \left( A e^{-\alpha (t-u)} + B e^{-\beta (t-u)} \right) \ du \\
&amp;=&amp; \mbox{dose} \times k_{01} \times \displaystyle\int_0^t A e^{-\alpha (t-u) -k_{01} u} + B e^{-\beta (t-u) -k_{01} u}  \ du \\
&amp;=&amp; \mbox{dose} \times k_{01} \times \left( Ae^{-\alpha t} \left[ \frac{1}{\alpha - k_{01}} e^{(\alpha - k_{01})u} \right]_0^t + Be^{-\beta t} \left[ \frac{1}{\beta - k_{01}} e^{(\beta - k_{01})u} \right]_0^t   \right) \\
&amp;=&amp; \mbox{dose} \times k_{01} \times \left( \displaystyle\frac{Ae^{-\alpha t} (e^{(\alpha - k_{01})t} - 1)}{\alpha - k_{01}} + \displaystyle\frac{Be^{-\beta t} (e^{(\beta - k_{01})t} - 1)}{\beta - k_{01}}   \right) \\
\end{array}
\]</span></p>
<p>And just like that we have a solution.</p>
</section>
<section id="does-it-work" class="level2">
<h2 class="anchored" data-anchor-id="does-it-work">Does it work?</h2>
<p>I’m not so arrogant as to simply assume I got it right. It’s reassuring that all the expressions that came out along the way bear a striking resemblance to those I’ve seen in the textbooks, but I still want to compare to a numerical method that I trust. In an earlier post I talked about <a href="../../posts/2023-08-28_rxode2/">using the rxode2 package to simulate from pharmacokinetic models</a>, and while I could certainly use some other tool for this purpose (e.g., the deSolve package would be totally fine here) I might as well use rxode2 here as well. Here’s an R function that solves the problem numerically:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>numeric_solution <span class="ot">&lt;-</span> <span class="cf">function</span>(k01, k12, k21, k10, time) {</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>  mod <span class="ot">&lt;-</span> rxode2<span class="sc">::</span><span class="fu">rxode</span>({</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>    d<span class="sc">/</span><span class="fu">dt</span>(A0) <span class="ot">=</span> <span class="sc">-</span>k01 <span class="sc">*</span> A0;</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>    d<span class="sc">/</span><span class="fu">dt</span>(A1) <span class="ot">=</span> k01 <span class="sc">*</span> A0 <span class="sc">-</span> (k12 <span class="sc">+</span> k10) <span class="sc">*</span> A1 <span class="sc">+</span> k21 <span class="sc">*</span> A2;</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>    d<span class="sc">/</span><span class="fu">dt</span>(A2) <span class="ot">=</span> k12 <span class="sc">*</span> A1 <span class="sc">-</span> k21 <span class="sc">*</span> A2;</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>  inits <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="at">A0 =</span> <span class="dv">1</span>, <span class="at">A1 =</span> <span class="dv">0</span>, <span class="at">A2 =</span> <span class="dv">0</span>)</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>  ev <span class="ot">&lt;-</span> rxode2<span class="sc">::</span><span class="fu">eventTable</span>()</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>  ev<span class="sc">$</span><span class="fu">add.sampling</span>(<span class="at">time =</span> time)</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>  pars <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">k01 =</span> k01, <span class="at">k12 =</span> k12, <span class="at">k21 =</span> k21, <span class="at">k10 =</span> k10)</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>  dat <span class="ot">&lt;-</span> mod<span class="sc">$</span><span class="fu">solve</span>(pars, ev, inits)</span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>  dat <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(dat)</span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a>  out <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">time =</span> dat<span class="sc">$</span>time, </span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">amount =</span> dat<span class="sc">$</span>A1, </span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a>    <span class="at">solution =</span> <span class="st">"numeric"</span></span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(out)</span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Here’s the corresponding function implementing the analytic solution:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>analytic_solution <span class="ot">&lt;-</span> <span class="cf">function</span>(k01, k12, k21, k10, time) {</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>  ks <span class="ot">&lt;-</span> k10 <span class="sc">+</span> k12 <span class="sc">+</span> k21</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>  alpha <span class="ot">&lt;-</span> (ks <span class="sc">+</span> <span class="fu">sqrt</span>(ks<span class="sc">^</span><span class="dv">2</span> <span class="sc">-</span> (<span class="dv">4</span> <span class="sc">*</span> k10 <span class="sc">*</span> k21))) <span class="sc">/</span> <span class="dv">2</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>  beta  <span class="ot">&lt;-</span> (ks <span class="sc">-</span> <span class="fu">sqrt</span>(ks<span class="sc">^</span><span class="dv">2</span> <span class="sc">-</span> (<span class="dv">4</span> <span class="sc">*</span> k10 <span class="sc">*</span> k21))) <span class="sc">/</span> <span class="dv">2</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>  A <span class="ot">&lt;-</span> (alpha <span class="sc">-</span> k21) <span class="sc">/</span> (alpha <span class="sc">-</span> beta)</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>  B <span class="ot">&lt;-</span> <span class="sc">-</span>(beta <span class="sc">-</span> k21) <span class="sc">/</span> (alpha <span class="sc">-</span> beta) </span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>  A_term <span class="ot">&lt;-</span> A <span class="sc">*</span> <span class="fu">exp</span>(<span class="sc">-</span>alpha <span class="sc">*</span> time) <span class="sc">*</span> (<span class="fu">exp</span>(time <span class="sc">*</span> (alpha <span class="sc">-</span> k01)) <span class="sc">-</span> <span class="dv">1</span>) </span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>  B_term <span class="ot">&lt;-</span> B <span class="sc">*</span> <span class="fu">exp</span>(<span class="sc">-</span>beta  <span class="sc">*</span> time) <span class="sc">*</span> (<span class="fu">exp</span>(time <span class="sc">*</span> (beta  <span class="sc">-</span> k01)) <span class="sc">-</span> <span class="dv">1</span>) </span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>  A_term <span class="ot">&lt;-</span> A_term <span class="sc">*</span> k01 <span class="sc">/</span> (alpha <span class="sc">-</span> k01)  </span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>  B_term <span class="ot">&lt;-</span> B_term <span class="sc">*</span> k01 <span class="sc">/</span> (beta  <span class="sc">-</span> k01)</span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a>  out <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">time =</span> time, </span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">amount =</span> A_term <span class="sc">+</span> B_term, </span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a>    <span class="at">solution =</span> <span class="st">"analytic"</span></span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(out)</span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now let’s compare the two:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>k01 <span class="ot">&lt;-</span> .<span class="dv">3</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>k12 <span class="ot">&lt;-</span> .<span class="dv">2</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>k21 <span class="ot">&lt;-</span> .<span class="dv">1</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>k10 <span class="ot">&lt;-</span> .<span class="dv">3</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>time <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">24</span>, .<span class="dv">1</span>)</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>dat_numb <span class="ot">&lt;-</span> <span class="fu">numeric_solution</span>(k01, k12, k21, k10, time)</span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>dat_anal <span class="ot">&lt;-</span> <span class="fu">analytic_solution</span>(k01, k12, k21, k10, time)</span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>dat <span class="ot">&lt;-</span> <span class="fu">rbind</span>(dat_numb, dat_anal)</span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(dat, <span class="fu">aes</span>(time, amount, <span class="at">colour =</span> solution)) <span class="sc">+</span></span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">show.legend =</span> <span class="cn">FALSE</span>) <span class="sc">+</span></span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span>solution) <span class="sc">+</span></span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/unnamed-chunk-4-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Looks good to me? The differences between the two are small enough that we can attribute them to simulation precision etc…</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="fu">max</span>(<span class="fu">abs</span>(dat_numb<span class="sc">$</span>amount <span class="sc">-</span> dat_anal<span class="sc">$</span>amount))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 1.920889e-08</code></pre>
</div>
</div>
<p>…and yes, you get similar agreement between the two versions<a href="#fn15" class="footnote-ref" id="fnref15" role="doc-noteref"><sup>15</sup></a> if you feed in other parameter values. That’s good enough for me.</p>
</section>
<section id="was-it-worth-it" class="level2 page-columns page-full">
<h2 class="anchored" data-anchor-id="was-it-worth-it">Was it worth it?</h2>
<p>And so we come to the end. The problem is solved, Danielle has convinced herself that she understands the formalism properly, and a great many pieces of scrap paper were sacrificed to the dark gods of mathematics in the process. Was it all worthwhile? I mean… in one sense, probably not. The analytic solutions I’ve derived here are <em>highly</em> unoriginal, and of course they have already been implemented and incorporated into standard modelling tools used in pharmacometric modelling. Nothing new has been added to the world by me doing this. But also, it’s worth highlighting that it was a <em>very</em> good thing that these solutions exist thanks to the hard work of those that have come before us,<a href="#fn16" class="footnote-ref" id="fnref16" role="doc-noteref"><sup>16</sup></a> because they do make a massive difference in terms of computational performance:</p>
<div class="cell column-page-right">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>microbenchmark<span class="sc">::</span><span class="fu">microbenchmark</span>(</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">numeric_solution</span>(k01, k12, k21, k10, time),</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">analytic_solution</span>(k01, k12, k21, k10, time)</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Unit: microseconds
                                        expr       min         lq       mean    median         uq       max neval
  numeric_solution(k01, k12, k21, k10, time) 36942.567 39292.0655 43605.2781 41941.764 45527.6240 68079.242   100
 analytic_solution(k01, k12, k21, k10, time)   141.298   166.7515   248.3604   177.763   230.7435  5089.839   100</code></pre>
</div>
</div>
<p>The units here are microseconds, so yeah okay they’re both fast. They’re both fast enough that I have no reason at all to care when running a small simulation: <a href="https://en.wikipedia.org/wiki/Runge%E2%80%93Kutta%E2%80%93Fehlberg_method">RK45</a> and <a href="https://en.wikipedia.org/wiki/Backward_differentiation_formula">BDF</a> exist for a <em>reason</em>, and as Dan Simpson reminded me the other day, generations of numerical analysts have suffered so that I don’t have to.</p>
<p>However, a speedup of a this magnitude makes a very big difference in the context of model fitting. Even my lazy R implementation of the analytic solution is hundreds of times faster than the very efficient numerical solution implemented by rxode2, and of course the speed up would be even more extreme if I could be bothered writing it in a compiled language like C++ or Rust or whatever. But of course I have no need to do that because that’s already been done in software. All I really care about for this post is deriving the solution and verifying that it works.</p>
<p>I’ve suffered enough.</p>
</section>
<section id="resources" class="level2">
<h2 class="anchored" data-anchor-id="resources">Resources</h2>
<p>Open access resources:</p>
<ul>
<li>Alex Best has an open textbook <em>Introducing Mathematical Biology</em>, and chapter 20 derives the <a href="https://sheffield.pressbooks.pub/introducingmathematicalbiology/chapter/a-two-compartment-bolus-model/">solution for the two-compartment bolus IV model</a>. It doesn’t go into quite as much detail as I do in this post (it spares the reader from the pain of matrix exponentials, for example) but I found it very helpful.</li>
<li>Jiří Lebl and Trefor Bazett have an open resouce <em>Introduction to Differential Equations</em> whose section on <a href="https://web.uvic.ca/~tbazett/diffyqs/sec_matexp.html">matrix exponentials</a> I found useful when trying to “refresh my memory” (i.e., learn something that I kind of ignored 30 years ago when it came up in my undergrad maths classes). Relatedly, the list of properties for matrix exponentials is mostly sourced from the wikipedia page on <a href="https://en.wikipedia.org/wiki/Matrix_exponential">matrix exponentials</a>.</li>
</ul>
<p>Other resources:</p>
<ul>
<li>It’s not open access, and it doesn’t dive into the derivations, but one of the books I’ve been reading at work is <a href="https://www.routledge.com/Pharmacokinetic-and-Pharmacodynamic-Data-Analysis-Concepts-and-Applications/Gabrielsson-Weiner/p/book/9789198299106">Pharmacokinetic and Pharmacodynamic Data Analysis (2nd ed)</a> by Johan Gabrielsson and Daniel Weiner: chapter 2 presents the bi-exponential model using the “macro” parameters (<span class="math inline">\(A\)</span>, <span class="math inline">\(B\)</span>, <span class="math inline">\(\alpha\)</span>, <span class="math inline">\(\beta\)</span>) and the formulas for converting to the “micro” parameters (the fractional rate constants <span class="math inline">\(k_{01}\)</span>, <span class="math inline">\(k_{10}\)</span>, <span class="math inline">\(k_{21}\)</span>, <span class="math inline">\(k_{12}\)</span>), along with the more general scientific considerations around the model.</li>
<li>The other book I’m reading at work is <a href="https://onlinelibrary.wiley.com/doi/book/10.1002/9781118784860">Introduction to Population Pharmacokinetic / Pharmacodynamic Analysis with Nonlinear Mixed Effects Models</a> by Joel S. Owen and Jill Fiedler-Kelly. It provides a good coverage of compartmental models in the context of the NONMEM software package, and is somewhat relevant insofar as the different parameterisations (i.e., TRANS subroutines<a href="#fn17" class="footnote-ref" id="fnref17" role="doc-noteref"><sup>17</sup></a>) for the ADVAN3 and ADVAN4 subroutines appear in this post (and make more sense to me now that I’ve derived the solutions).</li>
</ul>


</section>


<div id="quarto-appendix" class="default"><section id="footnotes" class="footnotes footnotes-end-of-document" role="doc-endnotes"><h2 class="anchored quarto-appendix-heading">Footnotes</h2>

<ol>
<li id="fn1"><p>If she were to only write posts when she thought someone cared or when it would somehow improve the state of world affairs, she’d never write anything at all. No, she writes blog posts for the same reason twinks make sex tapes in senate hearing rooms: for the pure and unsullied chaos of the thing itself.<a href="#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn2"><p>This is of course not quite true: for simplicity I’m not considering <a href="https://en.wikipedia.org/wiki/Bioavailability">bioavailability</a> in this post, nor am I considering lag time. I’m certainly not considering transit compartments and the like. The focus of the post is about the ODE system used to model what happens to the drug once it arrives in systemic circulation.<a href="#fnref2" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn3"><p>By convention we also don’t count the “depot” compartment (usually the gut) as one of the compartments: although the state <span class="math inline">\(\mathbf{x}_t\)</span> is a vector of length 3, only two of the compartments (central and peripheral) are used to model the disposition (a term of art referring to both “distribution” and “elimination”) of the drug, so this is a two-compartment model.<a href="#fnref3" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn4"><p>Yes, I do realise that there are 4 rate constants and 5 physiological parameters. In the rate-constants version there would also be a fifth parameter: when fitting models we need a volumetric scaling parameter to convert between drug amount and drug concentration in the central compartment (where the concentration is typically measured), and as such we would include <span class="math inline">\(V_c\)</span> as a parameter in the rate-constant version too. I’ve omitted that in this post for the same reason I have ignored the bioavailability <span class="math inline">\(F\)</span> and the lag time to absorption: none of these parameters are super-relevant to solving the ODE. <span class="math inline">\(V_c\)</span> and <span class="math inline">\(F\)</span> are both scaling factors that multiply various terms by a constant factor, the lag-time is a shift parameter applied to <span class="math inline">\(t\)</span>. None of them affect the general form of the solution, which is the thing I care about for the purposes of the post.<a href="#fnref4" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn5"><p>For example, to obtain the rate constants from the physiological parameters, we use <span class="math inline">\(k_{10} = Cl / V_c\)</span>, <span class="math inline">\(k_{01} = k_a\)</span>, <span class="math inline">\(k_{12} = Q/V_c\)</span>, and <span class="math inline">\(k_{21} = Q/V_p\)</span>. It’s pretty similar going the other way.<a href="#fnref5" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn6"><p>In the Gabrielsson and Weiner textbook I’m reading at work, the parameterisation in terms of the fractional rate constants <span class="math inline">\(k_{01}\)</span>, <span class="math inline">\(k_{10}\)</span>, <span class="math inline">\(k_{21}\)</span> and <span class="math inline">\(k_{12}\)</span> is referred to as the “micro-” parameterisation, taking its name from the fact that the parameters describe the low-level operation of the ODE. This is in contrast to the “physiological” parameterisation in terms of <span class="math inline">\(Cl\)</span>, <span class="math inline">\(Q\)</span>, <span class="math inline">\(V_c\)</span>, <span class="math inline">\(V_p\)</span> and <span class="math inline">\(k_a\)</span> that attempts to ascribe biological interpretation to the quantities. There is also a third “macro-” parameterisation in terms of <span class="math inline">\(\alpha\)</span>, <span class="math inline">\(\beta\)</span>, <span class="math inline">\(A\)</span>, and <span class="math inline">\(B\)</span> in which the parameters correspond to the coefficients of the concentration-time curve. As we’ll see later in the post, something like the “macro-” parameterisation you see in the textbooks emerges more or less naturally from the solution to the ODE system. The version that shows up in this post isn’t 100% identical to the version in the textbook (it’s off by a scaling factor because I don’t bother to account for <span class="math inline">\(V_c\)</span> or to fold the dose into the coefficients <span class="math inline">\(A\)</span> and <span class="math inline">\(B\)</span>) but honestly nobody should care about this because the macro-scale parameterisation doesn’t have any scientific meaning. It’s just a convenient description of a biexponential curve that makes you sound fancy at very boring parties when you tell people that the exponents are eigenvalues of the ODE.<a href="#fnref6" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn7"><p>Yes, I know. If I were being rigorous here I’d be precise about how I ended up with this as the exact expression, but I am tired and this is neither a journal article nor a textbook.<a href="#fnref7" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn8"><p>As has been so often noted in the BSG fandom, the Cylons quite clearly did not have a Plan. The writers did not ever think of a coherent Plan, and badly tried to retcon a Plan onto the plot in the TV movie by the same name. As <a href="https://www.latimes.com/entertainment/tv/la-et-hc-battlestar-galactica-reunion-atx-fest-20170611-story.html">Mike Moore</a> later explained, it was just something that looked cool in the opening credits. Much the same could be said for me pretending I ever have a plan when trying to derive something: the Plan is the thing you make up after the fact after you accidentally end up with the answer.<a href="#fnref8" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn9"><p>Formally speaking, I suppose I ought to be using subscripts to distinguish the 3x3 oral-dosing matrix <span class="math inline">\(\mathbf{K}_{o}\)</span> from the 2x2 bolus IV dosing matrix <span class="math inline">\(\mathbf{K}_{iv}\)</span>, but I’ll refrain from doing so in this post because it’s always clear from context which one I’m referring to.<a href="#fnref9" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn10"><p>For extremely specific values of “awesome”.<a href="#fnref10" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn11"><p>No I do not know why those stray <code>$$</code> fences are showing up in the rendered document. The equations are as-intended, but those should not be included in the output. I kinda think I might have broken the parser with my extremely ugly latex, which is normally a thing I only expect to get told at kink parties<a href="#fnref11" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn12"><p>Where of course a biexponential is a model that is sexually attracted to two exponents.<a href="#fnref12" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn13"><p>Technically – <em>per</em>. <em>my</em>. <em>earlier</em>. <em>footnote</em> – the one in the book differed from this one by a multiplicative scale factor since it was expressed in terms of concentrations, but whatever. That’s not germane to the post.<a href="#fnref13" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn14"><p>I mean, multiplying everything by <span class="math inline">\(F\)</span> is not exactly difficult right? If you can follow the rest of this solution you absolutely know how to generalise it to other values of <span class="math inline">\(F\)</span>. But okay, if you care deeply about the niceties I will be like Bart and <a href="https://knowyourmeme.com/memes/say-the-line-bart">say the line</a>: without loss of generality, I set <span class="math inline">\(F=1\)</span> in this post. I’m sure that makes everyone happier.<a href="#fnref14" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn15"><p>Yes those variable names were deliberate. Of <em>course</em> those variable names were deliberate, whose blog do you think you are reading girl? Now, let’s review our safety tips for numbing lubric…<a href="#fnref15" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn16"><p>She pauses, wondering if this is the right moment to link to her favourite Lily Allen song? <a href="https://www.youtube.com/watch?v=fUYaosyR4bE">Yes, it is</a>.<a href="#fnref16" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn17"><p>Technically speaking they only count as trans subroutines in the UK legal system if they have a fortran recognition certificate and a permission slip from a doctor that despises them.<a href="#fnref17" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
</ol>
</section><section class="quarto-appendix-contents"><h2 class="anchored quarto-appendix-heading">Reuse</h2><div id="quarto-reuse" class="quarto-appendix-contents"><div><a rel="license" href="https://creativecommons.org/licenses/by/4.0/">https://creativecommons.org/licenses/by/4.0/</a></div></div></section><section class="quarto-appendix-contents"><h2 class="anchored quarto-appendix-heading">Citation</h2><div><div class="quarto-appendix-secondary-label">BibTeX citation:</div><pre class="sourceCode code-with-copy quarto-appendix-bibtex"><code class="sourceCode bibtex">@online{navarro2023,
  author = {Navarro, Danielle},
  title = {Closed Form Solutions for a Two-Compartment Pharmacokinetic
    Model},
  date = {2023-12-19},
  url = {https://blog.djnavarro.net/posts/2023-12-19_solving-two-compartment-pk-models},
  langid = {en}
}
</code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre><div class="quarto-appendix-secondary-label">For attribution, please cite this work as:</div><div id="ref-navarro2023" class="csl-entry quarto-appendix-citeas" role="listitem">
Navarro, Danielle. 2023. <span>“Closed Form Solutions for a
Two-Compartment Pharmacokinetic Model.”</span> December 19, 2023. <a href="https://blog.djnavarro.net/posts/2023-12-19_solving-two-compartment-pk-models">https://blog.djnavarro.net/posts/2023-12-19_solving-two-compartment-pk-models</a>.
</div></div></section></div></main> <!-- /main -->
<!-- plausible -->
<script async="" defer="" data-domain="blog.djnavarro.net" src="https://plausible.io/js/plausible.js"></script>
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
      &nbsp;
    </div>   
    <div class="nav-footer-center">
      <ul class="footer-items list-unstyled">
    <li class="nav-item">
    <a class="nav-link" href="https://blog.djnavarro.net">blog.djnavarro.net</a>
  </li>  
</ul>
    </div>
    <div class="nav-footer-right">
      &nbsp;
    </div>
  </div>
</footer>



</body></html>