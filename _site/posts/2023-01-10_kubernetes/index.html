<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.353">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Danielle Navarro">
<meta name="dcterms.date" content="2023-01-10">
<meta name="description" content="In which it is painfully clear that the author is trying to figure it all out as she goes">

<title>Notes from a data witch - Deploying R with kubernetes</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>
<style>

      .quarto-title-block .quarto-title-banner {
        background: #eeeeee;
      }
</style>


<link rel="stylesheet" href="../../styles.css">
<meta property="og:title" content="Notes from a data witch - Deploying R with kubernetes">
<meta property="og:description" content="In which it is painfully clear that the author is trying to figure it all out as she goes">
<meta property="og:image" content="https://blog.djnavarro.net/posts/2023-01-10_kubernetes/donut.png">
<meta property="og:site-name" content="Notes from a data witch">
<meta property="og:image:height" content="800">
<meta property="og:image:width" content="800">
<meta property="og:image:alt" content="Many tan and white squares arranged in concentric circles against an orange background">
<meta name="twitter:title" content="Notes from a data witch - Deploying R with kubernetes">
<meta name="twitter:description" content="In which it is painfully clear that the author is trying to figure it all out as she goes">
<meta name="twitter:image" content="https://blog.djnavarro.net/posts/2023-01-10_kubernetes/donut.png">
<meta name="twitter:creator" content="@djnavarro">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image-height" content="800">
<meta name="twitter:image-width" content="800">
<meta name="twitter:image:alt" content="Many tan and white squares arranged in concentric circles against an orange background">
</head>

<body class="floating nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../index.html" rel="" target="">
 <span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../index.xml" rel="" target="">
 <span class="menu-text">RSS</span></a>
  </li>  
</ul>
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-sites" role="button" data-bs-toggle="dropdown" aria-expanded="false" rel="" target="">
 <span class="menu-text">Sites</span>
    </a>
    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="nav-menu-sites">    
        <li>
    <a class="dropdown-item" href="https://djnavarro.net" rel="" target="">
 <span class="dropdown-text">Homepage</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="https://blog.djnavarro.net" rel="" target="">
 <span class="dropdown-text">Data science blog</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="https://art.djnavarro.net" rel="" target="">
 <span class="dropdown-text">Generative art</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="https://papers.djnavarro.net" rel="" target="">
 <span class="dropdown-text">Academic papers</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="https://djnavarro.net/sites" rel="" target="">
 <span class="dropdown-text">More…</span></a>
  </li>  
    </ul>
  </li>
</ul>
            <div class="quarto-navbar-tools">
</div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default toc-left page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <h1 class="title">Deploying R with kubernetes</h1>
                  <div>
        <div class="description">
          In which it is painfully clear that the author is trying to figure it all out as she goes
        </div>
      </div>
                          <div class="quarto-categories">
                <div class="quarto-category">R</div>
                <div class="quarto-category">Docker</div>
                <div class="quarto-category">Kubernetes</div>
                <div class="quarto-category">Plumber</div>
              </div>
                  </div>
  </div>
    
  
  <div class="quarto-title-meta">

      <div>
      <div class="quarto-title-meta-heading">Author</div>
      <div class="quarto-title-meta-contents">
               <p><a href="https://djnavarro.net">Danielle Navarro</a> <a href="https://orcid.org/0000-0001-7648-6578" class="quarto-title-author-orcid"> <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAA2ZpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMC1jMDYwIDYxLjEzNDc3NywgMjAxMC8wMi8xMi0xNzozMjowMCAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wTU09Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9tbS8iIHhtbG5zOnN0UmVmPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvc1R5cGUvUmVzb3VyY2VSZWYjIiB4bWxuczp4bXA9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC8iIHhtcE1NOk9yaWdpbmFsRG9jdW1lbnRJRD0ieG1wLmRpZDo1N0NEMjA4MDI1MjA2ODExOTk0QzkzNTEzRjZEQTg1NyIgeG1wTU06RG9jdW1lbnRJRD0ieG1wLmRpZDozM0NDOEJGNEZGNTcxMUUxODdBOEVCODg2RjdCQ0QwOSIgeG1wTU06SW5zdGFuY2VJRD0ieG1wLmlpZDozM0NDOEJGM0ZGNTcxMUUxODdBOEVCODg2RjdCQ0QwOSIgeG1wOkNyZWF0b3JUb29sPSJBZG9iZSBQaG90b3Nob3AgQ1M1IE1hY2ludG9zaCI+IDx4bXBNTTpEZXJpdmVkRnJvbSBzdFJlZjppbnN0YW5jZUlEPSJ4bXAuaWlkOkZDN0YxMTc0MDcyMDY4MTE5NUZFRDc5MUM2MUUwNEREIiBzdFJlZjpkb2N1bWVudElEPSJ4bXAuZGlkOjU3Q0QyMDgwMjUyMDY4MTE5OTRDOTM1MTNGNkRBODU3Ii8+IDwvcmRmOkRlc2NyaXB0aW9uPiA8L3JkZjpSREY+IDwveDp4bXBtZXRhPiA8P3hwYWNrZXQgZW5kPSJyIj8+84NovQAAAR1JREFUeNpiZEADy85ZJgCpeCB2QJM6AMQLo4yOL0AWZETSqACk1gOxAQN+cAGIA4EGPQBxmJA0nwdpjjQ8xqArmczw5tMHXAaALDgP1QMxAGqzAAPxQACqh4ER6uf5MBlkm0X4EGayMfMw/Pr7Bd2gRBZogMFBrv01hisv5jLsv9nLAPIOMnjy8RDDyYctyAbFM2EJbRQw+aAWw/LzVgx7b+cwCHKqMhjJFCBLOzAR6+lXX84xnHjYyqAo5IUizkRCwIENQQckGSDGY4TVgAPEaraQr2a4/24bSuoExcJCfAEJihXkWDj3ZAKy9EJGaEo8T0QSxkjSwORsCAuDQCD+QILmD1A9kECEZgxDaEZhICIzGcIyEyOl2RkgwAAhkmC+eAm0TAAAAABJRU5ErkJggg=="></a></p>
            </div>
    </div>
      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">January 10, 2023</p>
      </div>
    </div>
    
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal sidebar-navigation floating overflow-auto">
    <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#ggplot2-on-kubernetes" id="toc-ggplot2-on-kubernetes" class="nav-link active" data-scroll-target="#ggplot2-on-kubernetes">ggplot2 on kubernetes</a></li>
  <li><a href="#um.-what-is-kubernetes-do-i-care" id="toc-um.-what-is-kubernetes-do-i-care" class="nav-link" data-scroll-target="#um.-what-is-kubernetes-do-i-care">Um. What is kubernetes? Do I care?</a></li>
  <li><a href="#write-the-r-code" id="toc-write-the-r-code" class="nav-link" data-scroll-target="#write-the-r-code">Write the R code</a></li>
  <li><a href="#expose-an-api" id="toc-expose-an-api" class="nav-link" data-scroll-target="#expose-an-api">Expose an API</a></li>
  <li><a href="#containerise-it" id="toc-containerise-it" class="nav-link" data-scroll-target="#containerise-it">Containerise it</a></li>
  <li><a href="#push-it-to-the-registry" id="toc-push-it-to-the-registry" class="nav-link" data-scroll-target="#push-it-to-the-registry">Push it to the registry</a></li>
  <li><a href="#create-a-kubernetes-cluster" id="toc-create-a-kubernetes-cluster" class="nav-link" data-scroll-target="#create-a-kubernetes-cluster">Create a kubernetes cluster</a></li>
  <li><a href="#command-line-tools" id="toc-command-line-tools" class="nav-link" data-scroll-target="#command-line-tools">Command line tools</a>
  <ul class="collapse">
  <li><a href="#installing-gcloud" id="toc-installing-gcloud" class="nav-link" data-scroll-target="#installing-gcloud">Installing gcloud</a></li>
  <li><a href="#installing-kubectl" id="toc-installing-kubectl" class="nav-link" data-scroll-target="#installing-kubectl">Installing kubectl</a></li>
  <li><a href="#connect-to-the-cluster" id="toc-connect-to-the-cluster" class="nav-link" data-scroll-target="#connect-to-the-cluster">Connect to the cluster</a></li>
  </ul></li>
  <li><a href="#kubernetes-terminology" id="toc-kubernetes-terminology" class="nav-link" data-scroll-target="#kubernetes-terminology">Kubernetes terminology</a></li>
  <li><a href="#create-a-deployment" id="toc-create-a-deployment" class="nav-link" data-scroll-target="#create-a-deployment">Create a deployment</a></li>
  <li><a href="#expose-the-deployment-no-https" id="toc-expose-the-deployment-no-https" class="nav-link" data-scroll-target="#expose-the-deployment-no-https">Expose the deployment (no https)</a></li>
  <li><a href="#expose-the-deployment-with-https" id="toc-expose-the-deployment-with-https" class="nav-link" data-scroll-target="#expose-the-deployment-with-https">Expose the deployment (with https)</a>
  <ul class="collapse">
  <li><a href="#get-a-static-ip" id="toc-get-a-static-ip" class="nav-link" data-scroll-target="#get-a-static-ip">Get a static IP</a></li>
  <li><a href="#get-a-certificate" id="toc-get-a-certificate" class="nav-link" data-scroll-target="#get-a-certificate">Get a certificate</a></li>
  <li><a href="#create-a-service" id="toc-create-a-service" class="nav-link" data-scroll-target="#create-a-service">Create a service</a></li>
  <li><a href="#create-the-dns-record" id="toc-create-the-dns-record" class="nav-link" data-scroll-target="#create-the-dns-record">Create the DNS record</a></li>
  <li><a href="#create-an-ingress" id="toc-create-an-ingress" class="nav-link" data-scroll-target="#create-an-ingress">Create an ingress</a></li>
  </ul></li>
  <li><a href="#epilogue" id="toc-epilogue" class="nav-link" data-scroll-target="#epilogue">Epilogue</a></li>
  </ul>
</nav>
</nav>
<div id="quarto-sidebar-glass" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
    </div>
<!-- main -->
<main class="content quarto-banner-title-block page-columns page-full" id="quarto-document-content">




<!--------------- my typical setup ----------------->
<!--------------- post begins here ----------------->
<p><strong>NOTE:</strong> The donuts app is no longer live. It was starting to cost me money! :-)</p>
<blockquote class="blockquote">
<p>Me: ooh I made a kubernetes app <br> 10yo: I made a paper dragon <br> Me: yeah… yours is cooler <br> &nbsp; – My daughter, reminding me that perspective is a thing</p>
</blockquote>
<p>Story time. There was a very weird moment in machine learning history, about 20 years ago, when the probabilistic AI folks were completely obsessed with Bayesian nonparametrics, and a disproportionate number of papers at NeurIPS had titles like “[Cutesy prefix]: An infinite dimensional model of [something really boring]”. In most cases, you’d dig into the paper and discover that they hadn’t done anything very special. All they’d done is implement a Bayesian model of [boring thing] that was ambiguous about the number of [components], and instead of thinking about what prior constraints make sense for the problem they were trying to solve, the authors used a <a href="https://en.wikipedia.org/wiki/Chinese_restaurant_process">Chinese restaurant process</a> (CRP) to specify the conditional prior distribution over allocations of observations to components. The CRP has the mildly-interesting property that for any finite sample size there is a non-negligible conditional probability that the next observation belongs to a hitherto unobserved component, and asymptotically the partitions over observations it generates have a countably infinite number of components. Alas, exactly zero of these papers happened to have an infinitely large data set to train the model on, and without fail the results in the papers didn’t appear to have anything “infinite dimensional” about them whatsoever.</p>
<p>I say this with love and gentleness, dear reader, because I wrote quite a few of those papers myself.</p>
<p>Why do I tell this story in a blog post that has absolutely nothing to do with machine learning, statistics, or Bayesian inference? Because in a fit of pique, somewhere around 2006, I decided to do the damned reading myself and learned quite a lot of Bayesian nonparametrics. Not because I thought it would be useful, but because I was curious and I was getting extremely irritated at overconfident machine learning boys telling me that as a mere psychologist I couldn’t possibly understand the depth of their thinking.</p>
<p>Which brings me, naturally enough, to <a href="https://kubernetes.io/">kubernetes</a>.</p>
<p><br></p>
<section id="ggplot2-on-kubernetes" class="level2">
<h2 class="anchored" data-anchor-id="ggplot2-on-kubernetes">ggplot2 on kubernetes</h2>
<p>Let’s start at the ending, shall we? The art shown below is generated at <a href="https://donut.djnavarro.net">donut.djnavarro.net</a>, and it is more-or-less unique. The site is designed to serve a different image every time it is accessed, using the timestamp as the seed to a generative art system written in R with ggplot2. If you refresh this page, the artwork will change:</p>
<a href="https://donut.djnavarro.net"><img width="100%" src="https://donut.djnavarro.net" title="donut.djnavarro.net"></a>
<p><br></p>
<p>Under the hood, the site is a kubernetes app running containerised R code with google kubernetes engine. Sounds fancy, right?</p>
<p>Well, maybe. Shall we take a look at how it works? Perhaps, like so many other things in this world, it will turn out not to be anywhere near as complicated as it is made out to be.</p>
<p><br></p>
</section>
<section id="um.-what-is-kubernetes-do-i-care" class="level2">
<h2 class="anchored" data-anchor-id="um.-what-is-kubernetes-do-i-care">Um. What is kubernetes? Do I care?</h2>
<p>There’s nothing I love more than looking at the website for a software tool and trying to work out what it does by reading how the developers have chosen to describe it. On the <a href="https://kubernetes.io/">kubernetes</a> website they’ve gone with the headline <em>“Production-Grade Container Orchestration”</em>, and started with this:</p>
<blockquote class="blockquote">
<p>Kubernetes, also known as K8s, is an open-source system for automating deployment, scaling, and management of containerized applications.</p>
</blockquote>
<p>As opening lines go it wouldn’t get you a lot of attention on grindr<a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a> but context makes a difference and it’s not so terrible as a description of what kubernetes does. It’s a useful tool if you need to deploy an application on a cluster<a href="#fn2" class="footnote-ref" id="fnref2" role="doc-noteref"><sup>2</sup></a> and have that application run smoothly as you “scale” your cluster by adding more “nodes”<a href="#fn3" class="footnote-ref" id="fnref3" role="doc-noteref"><sup>3</sup></a> to the cluster. For the application I’m about to write, kubernetes is overkill. I don’t actually need kubernetes to run something this simple, but this is a learning exercise. I’m doing it so that I can familiarise myself with core concepts. When I get to the part of the post that actually <em>does</em> something with kubernetes I’ll start introducing terminology, but for now that’s enough for us.</p>
<p>Should you care as an R user? I mean, probably not. If you want a proper answer, Roel Hogervorst has an excellent blog post called <a href="https://www.r-bloggers.com/2022/04/wtf-is-kubernetes-and-should-i-care-as-r-user/"><em>“WTF is Kubernetes and Should I Care as R User?”</em></a> I won’t duplicate content here: you should read the original post. But the short answer is that you probably won’t need to run your own application using kubernetes, but you might need to contribute code to a larger application that uses it. If so, you may want to play around with kubernetes to make sure you understand what it does.</p>
<p><br></p>
</section>
<section id="write-the-r-code" class="level2 page-columns page-full">
<h2 class="anchored" data-anchor-id="write-the-r-code">Write the R code</h2>
<blockquote class="blockquote">
<p>Likes to watch me in the glass room, bathroom <br> Chateau Marmont, slippin’ on my red dress, puttin’ on my makeup <br> Glass room, perfume, cognac, lilac fumes <br> Says it feels like heaven to him <br> &nbsp; – Lana Del Rey<a href="#fn4" class="footnote-ref" id="fnref4" role="doc-noteref"><sup>4</sup></a></p>
</blockquote>
<p>Let’s begin at the beginning. Anytime you want to write something, it helps to have something to say. There is nothing more tiresome than an op-ed writer trying to fill out 1000 words to make the Saturday paper deadline, but tech writing that tries to demonstrate a tool<a href="#fn5" class="footnote-ref" id="fnref5" role="doc-noteref"><sup>5</sup></a> without anything even remotely resembling an application runs a very close second. So let’s at least <em>pretend</em> we have a use case for this yeah?</p>
<p>In real life I am an unemployed 40-something woman who smokes and drinks too much and makes very poor choices around men, but in my spare moments I make <a href="https://art.djnavarro.net/">generative art</a> using R. It’s an extremely unprofitable hobby<a href="#fn6" class="footnote-ref" id="fnref6" role="doc-noteref"><sup>6</sup></a> but it’s not completely without market value. Among other things the lovely folks at Posit were kind enough to pay me to put together an <a href="https://art-from-code.netlify.app">“art from code”</a> workshop last year, and thanks to their kindness and my weird priorities there is now a nice little online tutorial that you can use to learn how to make generative art in R. What I’m going to do in this post is build a little kubernetes app that creates generative in R. It won’t be very fancy, but hopefully you can see how an app like this could be expanded<a href="#fn7" class="footnote-ref" id="fnref7" role="doc-noteref"><sup>7</sup></a> to create a platform for “long form generative art” with R, not dissimilar to what <a href="https://www.artblocks.io/">artblocks</a> or <a href="https://www.fxhash.xyz/">fxhash</a> allow generative artists to do with javascript. The artist supplies code (in this case using R) that generates artwork, and the server uses that code to generate an arbitrary number of pieces that… idk, I guess you could sell them? Whatever. Do I look like a capitalist to you?</p>
<p>To build something like this we’ll need some R code that creates generative art. I won’t try to make anything too fancy here. In fact, I’ll reuse code for the “donuts” system I used in my <a href="https://blog.djnavarro.net/queue/">multi-threaded task queues post</a>. It’s a good choice for this application because the donuts system is something that is extremely easy to implement in R because the ggplot2 package provides tooling for creating data visualisations that use polar geometry<a href="#fn8" class="footnote-ref" id="fnref8" role="doc-noteref"><sup>8</sup></a></p>
<p>Here’s how you build the system. I won’t go into detail because this system is a very minor variation on <a href="https://art-from-code.netlify.app/day-1/session-1/#composition">this one in my art-from-code tutorial</a>, but here’s the gist. First, the plot is going to need a colour scheme, so we’ll define a function that samples a palette randomly with the assistance of the ggthemes package:</p>
<div class="cell">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>server.R</strong></pre>
</div>
<div class="sourceCode cell-code" id="cb1" data-startfrom="4"><pre class="sourceCode numberSource r numberLines number-lines code-with-copy"><code class="sourceCode r" style="counter-reset: source-line 3;"><span id="cb1-4"><a href="#cb1-4"></a>sample_canva <span class="ot">&lt;-</span> <span class="cf">function</span>(<span class="at">seed =</span> <span class="cn">NULL</span>) {</span>
<span id="cb1-5"><a href="#cb1-5"></a>  <span class="cf">if</span>(<span class="sc">!</span><span class="fu">is.null</span>(seed)) <span class="fu">set.seed</span>(seed)</span>
<span id="cb1-6"><a href="#cb1-6"></a>  <span class="fu">sample</span>(ggthemes<span class="sc">::</span>canva_palettes, <span class="dv">1</span>)[[<span class="dv">1</span>]]</span>
<span id="cb1-7"><a href="#cb1-7"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<p>Next, we’ll have a function that generates a table full of random numbers that we will later on map onto various plot aesthetics to make a pretty picture:</p>
<div class="cell">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>server.R</strong></pre>
</div>
<div class="sourceCode cell-code" id="cb2" data-startfrom="10"><pre class="sourceCode numberSource r numberLines number-lines code-with-copy"><code class="sourceCode r" style="counter-reset: source-line 9;"><span id="cb2-10"><a href="#cb2-10"></a>sample_data <span class="ot">&lt;-</span> <span class="cf">function</span>(<span class="at">seed =</span> <span class="cn">NULL</span>, <span class="at">n =</span> <span class="dv">100</span>){</span>
<span id="cb2-11"><a href="#cb2-11"></a>  <span class="cf">if</span>(<span class="sc">!</span><span class="fu">is.null</span>(seed)) <span class="fu">set.seed</span>(seed)</span>
<span id="cb2-12"><a href="#cb2-12"></a>  dat <span class="ot">&lt;-</span> tibble<span class="sc">::</span><span class="fu">tibble</span>(</span>
<span id="cb2-13"><a href="#cb2-13"></a>    <span class="at">x0 =</span> stats<span class="sc">::</span><span class="fu">runif</span>(n),</span>
<span id="cb2-14"><a href="#cb2-14"></a>    <span class="at">y0 =</span> stats<span class="sc">::</span><span class="fu">runif</span>(n),</span>
<span id="cb2-15"><a href="#cb2-15"></a>    <span class="at">x1 =</span> x0 <span class="sc">+</span> stats<span class="sc">::</span><span class="fu">runif</span>(n, <span class="at">min =</span> <span class="sc">-</span>.<span class="dv">2</span>, <span class="at">max =</span> .<span class="dv">2</span>),</span>
<span id="cb2-16"><a href="#cb2-16"></a>    <span class="at">y1 =</span> y0 <span class="sc">+</span> stats<span class="sc">::</span><span class="fu">runif</span>(n, <span class="at">min =</span> <span class="sc">-</span>.<span class="dv">2</span>, <span class="at">max =</span> .<span class="dv">2</span>),</span>
<span id="cb2-17"><a href="#cb2-17"></a>    <span class="at">shade =</span> stats<span class="sc">::</span><span class="fu">runif</span>(n),</span>
<span id="cb2-18"><a href="#cb2-18"></a>    <span class="at">size =</span> stats<span class="sc">::</span><span class="fu">runif</span>(n),</span>
<span id="cb2-19"><a href="#cb2-19"></a>    <span class="at">shape =</span> <span class="fu">factor</span>(<span class="fu">sample</span>(<span class="dv">0</span><span class="sc">:</span><span class="dv">22</span>, <span class="at">size =</span> n, <span class="at">replace =</span> <span class="cn">TRUE</span>))</span>
<span id="cb2-20"><a href="#cb2-20"></a>  )</span>
<span id="cb2-21"><a href="#cb2-21"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<p>Now comes the part of the system that does most of the artistic work, by defining a visual layout for any plots that are created using the system:</p>
<div class="cell">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>server.R</strong></pre>
</div>
<div class="sourceCode cell-code" id="cb3" data-startfrom="24"><pre class="sourceCode numberSource r numberLines number-lines code-with-copy"><code class="sourceCode r" style="counter-reset: source-line 23;"><span id="cb3-24"><a href="#cb3-24"></a>donut_style <span class="ot">&lt;-</span> <span class="cf">function</span>(<span class="at">data =</span> <span class="cn">NULL</span>, palette) {</span>
<span id="cb3-25"><a href="#cb3-25"></a>  ggplot2<span class="sc">::</span><span class="fu">ggplot</span>(</span>
<span id="cb3-26"><a href="#cb3-26"></a>    <span class="at">data =</span> data,</span>
<span id="cb3-27"><a href="#cb3-27"></a>    <span class="at">mapping =</span> ggplot2<span class="sc">::</span><span class="fu">aes</span>(</span>
<span id="cb3-28"><a href="#cb3-28"></a>      <span class="at">x =</span> x0,</span>
<span id="cb3-29"><a href="#cb3-29"></a>      <span class="at">y =</span> y0,</span>
<span id="cb3-30"><a href="#cb3-30"></a>      <span class="at">xend =</span> x1,</span>
<span id="cb3-31"><a href="#cb3-31"></a>      <span class="at">yend =</span> y1,</span>
<span id="cb3-32"><a href="#cb3-32"></a>      <span class="at">colour =</span> shade,</span>
<span id="cb3-33"><a href="#cb3-33"></a>      <span class="at">linewidth =</span> size</span>
<span id="cb3-34"><a href="#cb3-34"></a>    )) <span class="sc">+</span></span>
<span id="cb3-35"><a href="#cb3-35"></a>    ggplot2<span class="sc">::</span><span class="fu">coord_polar</span>(<span class="at">clip =</span> <span class="st">"off"</span>) <span class="sc">+</span></span>
<span id="cb3-36"><a href="#cb3-36"></a>    ggplot2<span class="sc">::</span><span class="fu">scale_y_continuous</span>(</span>
<span id="cb3-37"><a href="#cb3-37"></a>      <span class="at">expand =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">0</span>),</span>
<span id="cb3-38"><a href="#cb3-38"></a>      <span class="at">limits =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">1</span>, <span class="dv">1</span>),</span>
<span id="cb3-39"><a href="#cb3-39"></a>      <span class="at">oob =</span> scales<span class="sc">::</span>oob_keep</span>
<span id="cb3-40"><a href="#cb3-40"></a>    ) <span class="sc">+</span></span>
<span id="cb3-41"><a href="#cb3-41"></a>    ggplot2<span class="sc">::</span><span class="fu">scale_x_continuous</span>(</span>
<span id="cb3-42"><a href="#cb3-42"></a>      <span class="at">expand =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">0</span>),</span>
<span id="cb3-43"><a href="#cb3-43"></a>      <span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>),</span>
<span id="cb3-44"><a href="#cb3-44"></a>      <span class="at">oob =</span> scales<span class="sc">::</span>oob_keep</span>
<span id="cb3-45"><a href="#cb3-45"></a>    ) <span class="sc">+</span></span>
<span id="cb3-46"><a href="#cb3-46"></a>    ggplot2<span class="sc">::</span><span class="fu">scale_colour_gradientn</span>(<span class="at">colours =</span> palette) <span class="sc">+</span></span>
<span id="cb3-47"><a href="#cb3-47"></a>    ggplot2<span class="sc">::</span><span class="fu">scale_linewidth</span>(<span class="at">range =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">6</span>)) <span class="sc">+</span></span>
<span id="cb3-48"><a href="#cb3-48"></a>    ggplot2<span class="sc">::</span><span class="fu">theme_void</span>() <span class="sc">+</span></span>
<span id="cb3-49"><a href="#cb3-49"></a>    ggplot2<span class="sc">::</span><span class="fu">theme</span>(</span>
<span id="cb3-50"><a href="#cb3-50"></a>      <span class="at">panel.background =</span> ggplot2<span class="sc">::</span><span class="fu">element_rect</span>(</span>
<span id="cb3-51"><a href="#cb3-51"></a>        <span class="at">fill =</span> palette[<span class="dv">1</span>], <span class="at">colour =</span> palette[<span class="dv">1</span>]</span>
<span id="cb3-52"><a href="#cb3-52"></a>      )</span>
<span id="cb3-53"><a href="#cb3-53"></a>    ) <span class="sc">+</span></span>
<span id="cb3-54"><a href="#cb3-54"></a>    ggplot2<span class="sc">::</span><span class="fu">guides</span>(</span>
<span id="cb3-55"><a href="#cb3-55"></a>      <span class="at">colour =</span> ggplot2<span class="sc">::</span><span class="fu">guide_none</span>(),</span>
<span id="cb3-56"><a href="#cb3-56"></a>      <span class="at">linewidth =</span> ggplot2<span class="sc">::</span><span class="fu">guide_none</span>(),</span>
<span id="cb3-57"><a href="#cb3-57"></a>      <span class="at">fill =</span> ggplot2<span class="sc">::</span><span class="fu">guide_none</span>(),</span>
<span id="cb3-58"><a href="#cb3-58"></a>      <span class="at">shape =</span> ggplot2<span class="sc">::</span><span class="fu">guide_none</span>()</span>
<span id="cb3-59"><a href="#cb3-59"></a>    )</span>
<span id="cb3-60"><a href="#cb3-60"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<p>The last step is a function that puts it all together. The <code>donut()</code> function takes a single integer-valued input and returns a plot object that happens to look slightly pretty:</p>
<div class="cell">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>server.R</strong></pre>
</div>
<div class="sourceCode cell-code" id="cb4" data-startfrom="63"><pre class="sourceCode numberSource r numberLines number-lines code-with-copy"><code class="sourceCode r" style="counter-reset: source-line 62;"><span id="cb4-63"><a href="#cb4-63"></a>donut <span class="ot">&lt;-</span> <span class="cf">function</span>(seed) {</span>
<span id="cb4-64"><a href="#cb4-64"></a></span>
<span id="cb4-65"><a href="#cb4-65"></a>  dat <span class="ot">&lt;-</span> <span class="fu">sample_data</span>(<span class="at">n =</span> <span class="dv">200</span>, <span class="at">seed =</span> seed) <span class="sc">|&gt;</span></span>
<span id="cb4-66"><a href="#cb4-66"></a>    dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">y1 =</span> y0, <span class="at">size =</span> size <span class="sc">/</span> <span class="dv">3</span>)</span>
<span id="cb4-67"><a href="#cb4-67"></a></span>
<span id="cb4-68"><a href="#cb4-68"></a>  line_spec <span class="ot">&lt;-</span> <span class="fu">sample</span>(<span class="fu">c</span>(<span class="st">"331311"</span>, <span class="st">"11"</span>, <span class="st">"111115"</span>), <span class="dv">1</span>)</span>
<span id="cb4-69"><a href="#cb4-69"></a></span>
<span id="cb4-70"><a href="#cb4-70"></a>  pic <span class="ot">&lt;-</span> <span class="fu">donut_style</span>(<span class="at">palette =</span> <span class="fu">sample_canva</span>(<span class="at">seed =</span> seed)) <span class="sc">+</span></span>
<span id="cb4-71"><a href="#cb4-71"></a>    ggplot2<span class="sc">::</span><span class="fu">geom_segment</span>(<span class="at">data =</span> dat, <span class="at">linetype =</span> line_spec)</span>
<span id="cb4-72"><a href="#cb4-72"></a></span>
<span id="cb4-73"><a href="#cb4-73"></a>  <span class="cf">if</span>(stats<span class="sc">::</span><span class="fu">runif</span>(<span class="dv">1</span>) <span class="sc">&lt;</span> .<span class="dv">5</span>) {</span>
<span id="cb4-74"><a href="#cb4-74"></a>    pic <span class="ot">&lt;-</span> pic <span class="sc">+</span></span>
<span id="cb4-75"><a href="#cb4-75"></a>      ggplot2<span class="sc">::</span><span class="fu">geom_segment</span>(</span>
<span id="cb4-76"><a href="#cb4-76"></a>        <span class="at">data =</span> dat <span class="sc">|&gt;</span> dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">y1 =</span> y1 <span class="sc">-</span> .<span class="dv">2</span>, <span class="at">y0 =</span> y0 <span class="sc">-</span> .<span class="dv">2</span>),</span>
<span id="cb4-77"><a href="#cb4-77"></a>        <span class="at">linetype =</span> line_spec</span>
<span id="cb4-78"><a href="#cb4-78"></a>      )</span>
<span id="cb4-79"><a href="#cb4-79"></a>  }</span>
<span id="cb4-80"><a href="#cb4-80"></a>  <span class="cf">if</span>(stats<span class="sc">::</span><span class="fu">runif</span>(<span class="dv">1</span>) <span class="sc">&lt;</span> .<span class="dv">5</span>) {</span>
<span id="cb4-81"><a href="#cb4-81"></a>    pic <span class="ot">&lt;-</span> pic <span class="sc">+</span></span>
<span id="cb4-82"><a href="#cb4-82"></a>      ggplot2<span class="sc">::</span><span class="fu">geom_segment</span>(</span>
<span id="cb4-83"><a href="#cb4-83"></a>        <span class="at">data =</span> dat <span class="sc">|&gt;</span> dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">y1 =</span> y1 <span class="sc">-</span> .<span class="dv">4</span>, <span class="at">y0 =</span> y0 <span class="sc">-</span> .<span class="dv">4</span>),</span>
<span id="cb4-84"><a href="#cb4-84"></a>        <span class="at">linetype =</span> line_spec</span>
<span id="cb4-85"><a href="#cb4-85"></a>      )</span>
<span id="cb4-86"><a href="#cb4-86"></a>  }</span>
<span id="cb4-87"><a href="#cb4-87"></a></span>
<span id="cb4-88"><a href="#cb4-88"></a>  pic</span>
<span id="cb4-89"><a href="#cb4-89"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<p>Here it is in action:</p>
<div class="page-columns page-full">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(seed <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">6</span>) <span class="fu">plot</span>(<span class="fu">donut</span>(seed))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell column-page quarto-layout-panel">
<div class="quarto-layout-row quarto-layout-valign-top">
<div class="cell-output-display quarto-layout-cell" style="flex-basis: 33.3%;justify-content: center;">
<p><img src="index_files/figure-html/donut-examples-1.png" class="img-fluid" width="576"></p>
</div>
<div class="cell-output-display quarto-layout-cell" style="flex-basis: 33.3%;justify-content: center;">
<p><img src="index_files/figure-html/donut-examples-2.png" class="img-fluid" width="576"></p>
</div>
<div class="cell-output-display quarto-layout-cell" style="flex-basis: 33.3%;justify-content: center;">
<p><img src="index_files/figure-html/donut-examples-3.png" class="img-fluid" width="576"></p>
</div>
</div>
<div class="quarto-layout-row quarto-layout-valign-top">
<div class="cell-output-display quarto-layout-cell" style="flex-basis: 33.3%;justify-content: center;">
<p><img src="index_files/figure-html/donut-examples-4.png" class="img-fluid" width="576"></p>
</div>
<div class="cell-output-display quarto-layout-cell" style="flex-basis: 33.3%;justify-content: center;">
<p><img src="index_files/figure-html/donut-examples-5.png" class="img-fluid" width="576"></p>
</div>
<div class="cell-output-display quarto-layout-cell" style="flex-basis: 33.3%;justify-content: center;">
<p><img src="index_files/figure-html/donut-examples-6.png" class="img-fluid" width="576"></p>
</div>
</div>
</div>
</div>
<p>Not my finest work, but still pretty enough to be fun.</p>
<p><br></p>
</section>
<section id="expose-an-api" class="level2">
<h2 class="anchored" data-anchor-id="expose-an-api">Expose an API</h2>
<blockquote class="blockquote">
<p>Are you posting hole on main again? <br> &nbsp; – Everyone who knows me, eventually</p>
</blockquote>
<p>The next step in the process is to define a public API that specifies how visitors to the website can interact with the underlying R code. That’s not something we typically do with R code because we aren’t usually in the business of writing web applications in R, but thanks to endless joy that is the <a href="https://www.rplumber.io/">plumber</a> this task can be accomplished with a few lines of code decoration:</p>
<div class="cell">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>server.R</strong></pre>
</div>
<div class="sourceCode cell-code" id="cb6" data-startfrom="91"><pre class="sourceCode numberSource r numberLines number-lines code-with-copy"><code class="sourceCode r" style="counter-reset: source-line 90;"><span id="cb6-91"><a href="#cb6-91"></a><span class="co">#* draws a donut plot</span></span>
<span id="cb6-92"><a href="#cb6-92"></a><span class="co">#* @serializer svg list(width = 10, height = 10)</span></span>
<span id="cb6-93"><a href="#cb6-93"></a><span class="co">#* @get /</span></span>
<span id="cb6-94"><a href="#cb6-94"></a><span class="cf">function</span>(<span class="at">seed =</span> <span class="cn">NA</span>) {</span>
<span id="cb6-95"><a href="#cb6-95"></a>  <span class="cf">if</span>(<span class="fu">is.na</span>(seed)) {</span>
<span id="cb6-96"><a href="#cb6-96"></a>    seed <span class="ot">&lt;-</span> <span class="fu">as.integer</span>(<span class="fu">Sys.time</span>())</span>
<span id="cb6-97"><a href="#cb6-97"></a>  }</span>
<span id="cb6-98"><a href="#cb6-98"></a>  <span class="fu">print</span>(<span class="fu">donut</span>(seed))</span>
<span id="cb6-99"><a href="#cb6-99"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<p>There are a few things to note here:</p>
<ul>
<li><p>The code decoration on line 93 specifies that the function defined in lines 94-99 will be called whenever an HTML <code>GET</code> request is sent to the <code>/</code> endpoint. Or, in simpler language, whenever someone visits the main page for the website that eventually ended up being hosted at <a href="https://donut.djnavarro.net">donut.djnavarro.net</a>.</p></li>
<li><p>The code decoration on line 92 how the output from the R function (an in-memory data structure) will be serialised (to a binary stream) and transmitted to the user.<a href="#fn9" class="footnote-ref" id="fnref9" role="doc-noteref"><sup>9</sup></a> In this case, the output is a plot object that would normally be handled by the R graphics device. What I’ve used plumber to do here, is have this output converted to an svg file. It’s that svg file that the website will serve to the user.</p></li>
<li><p>Finally, notice that the function does take a <code>seed</code> argument.<a href="#fn10" class="footnote-ref" id="fnref10" role="doc-noteref"><sup>10</sup></a> I’ve set <code>NA</code> as the default value rather than the more conventional <code>NULL</code> because plumber won’t accept a <code>NULL</code> default in this context.</p></li>
</ul>
<p>Noting that all the code I’ve presented so far belongs to a file called <a href="https://github.com/djnavarro/donut/blob/main/server.R"><code>server.R</code></a> (the link goes to the github repo for this “donut” side-project), I can start the web server running locally on port 3456 like this:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>plumber<span class="sc">::</span><span class="fu">plumb</span>(<span class="at">file=</span><span class="st">"server.R"</span>)<span class="sc">$</span><span class="fu">run</span>(<span class="at">port =</span> <span class="dv">3456</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><br></p>
</section>
<section id="containerise-it" class="level2 page-columns page-full">
<h2 class="anchored" data-anchor-id="containerise-it">Containerise it</h2>
<p>At this point in the process I have a perfectly functional webserver… that only runs on my machine which just happens to have the dependencies installed, and is only accessible locally from that machine. We’ll need to fix both of those problems.</p>
<p>Let’s start by fixing the first one by running the website from within a docker container. Under normal circumstances I’d walk you through that process, but since I wrote a <a href="https://blog.djnavarro.net/playing-with-docker/">long blog post about docker</a> just the other day, I’ll jump straight to showing you the <a href="https://github.com/djnavarro/donut/blob/main/Dockerfile"><code>Dockerfile</code></a>:</p>
<div class="column-page-right">
<div class="cell">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>Dockerfile</strong></pre>
</div>
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode numberSource dockerfile number-lines code-with-copy"><code class="sourceCode dockerfile"><span id="cb8-1"><a href="#cb8-1"></a><span class="kw">FROM</span> rocker/r-ver:4.2.2</span>
<span id="cb8-2"><a href="#cb8-2"></a></span>
<span id="cb8-3"><a href="#cb8-3"></a><span class="kw">LABEL</span> org.opencontainers.image.source <span class="st">"https://github.com/djnavarro/donut"</span></span>
<span id="cb8-4"><a href="#cb8-4"></a><span class="kw">LABEL</span> org.opencontainers.image.authors <span class="st">"Danielle Navarro &lt;djnavarro@protonmail.com&gt;"</span></span>
<span id="cb8-5"><a href="#cb8-5"></a><span class="kw">LABEL</span> org.opencontainers.image.description DESCRIPTION</span>
<span id="cb8-6"><a href="#cb8-6"></a><span class="kw">LABEL</span> org.opencontainers.image.licenses <span class="st">"MIT"</span></span>
<span id="cb8-7"><a href="#cb8-7"></a></span>
<span id="cb8-8"><a href="#cb8-8"></a><span class="kw">RUN</span> <span class="ex">Rscript</span> <span class="at">-e</span> <span class="st">'install.packages(c("ggplot2", "scales", "tibble", "dplyr", "plumber", "ggthemes"))'</span></span>
<span id="cb8-9"><a href="#cb8-9"></a><span class="kw">COPY</span> server.R /home/server.R</span>
<span id="cb8-10"><a href="#cb8-10"></a><span class="kw">EXPOSE</span> 80</span>
<span id="cb8-11"><a href="#cb8-11"></a><span class="kw">CMD</span> <span class="ex">Rscript</span> <span class="at">-e</span> <span class="st">'plumber::plumb(file="/home/server.R")$run(host="0.0.0.0", port = 80)'</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</div>
<p>Every instruction in this dockerfile is something I covered in the last post, except for the <a href="https://docs.docker.com/engine/reference/builder/#expose"><code>EXPOSE</code></a> instruction on line 10. That one tells the container to listen on port 80. It doesn’t necessarily publish the output anywhere accessible from outside the container<a href="#fn11" class="footnote-ref" id="fnref11" role="doc-noteref"><sup>11</sup></a> but it does mean that the plumber web server running inside the container is listening on port 80 and can create a response when it receives a request. I’ll deal with the publishing issue later.</p>
<p><br></p>
</section>
<section id="push-it-to-the-registry" class="level2 page-columns page-full">
<h2 class="anchored" data-anchor-id="push-it-to-the-registry">Push it to the registry</h2>
<p>The next step in the process is to host the image created from this dockerfile on a public registry.<a href="#fn12" class="footnote-ref" id="fnref12" role="doc-noteref"><sup>12</sup></a> I talked about that process in the last post too, so again I’ll keep things simple. The process I followed for the donut project is essentially identical to the one I used in this <a href="https://blog.djnavarro.net/posts/2023-01-01_playing-with-docker/#hosting-images">section of the docker post</a>. I’ve created a github actions workflow that automatically builds the image on github and hosts it with the github container registry. The resulting image name is <code>ghcr.io/djnavarro/donut:main</code> and here’s the <a href="https://github.com/djnavarro/donut/blob/main/.github/workflows/build-image.yaml"><code>build-image.yaml</code></a> workflow I’m using:</p>
<div class="column-page-right">
<div class="cell">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>.github/workflows/build-image.yaml</strong></pre>
</div>
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode numberSource yaml number-lines code-with-copy"><code class="sourceCode yaml"><span id="cb9-1"><a href="#cb9-1"></a><span class="fu">name</span><span class="kw">:</span><span class="at"> publish donut image</span></span>
<span id="cb9-2"><a href="#cb9-2"></a></span>
<span id="cb9-3"><a href="#cb9-3"></a><span class="fu">on</span><span class="kw">:</span></span>
<span id="cb9-4"><a href="#cb9-4"></a><span class="at">  </span><span class="fu">push</span><span class="kw">:</span></span>
<span id="cb9-5"><a href="#cb9-5"></a><span class="at">    </span><span class="fu">branches</span><span class="kw">:</span><span class="at"> </span><span class="kw">[</span><span class="st">'main'</span><span class="kw">]</span></span>
<span id="cb9-6"><a href="#cb9-6"></a></span>
<span id="cb9-7"><a href="#cb9-7"></a><span class="fu">env</span><span class="kw">:</span></span>
<span id="cb9-8"><a href="#cb9-8"></a><span class="at">  </span><span class="fu">REGISTRY</span><span class="kw">:</span><span class="at"> ghcr.io</span></span>
<span id="cb9-9"><a href="#cb9-9"></a><span class="at">  </span><span class="fu">IMAGE_NAME</span><span class="kw">:</span><span class="at"> ${{ github.repository }}</span></span>
<span id="cb9-10"><a href="#cb9-10"></a></span>
<span id="cb9-11"><a href="#cb9-11"></a><span class="fu">jobs</span><span class="kw">:</span></span>
<span id="cb9-12"><a href="#cb9-12"></a><span class="at">  </span><span class="fu">build-and-push-image</span><span class="kw">:</span></span>
<span id="cb9-13"><a href="#cb9-13"></a><span class="at">    </span><span class="fu">runs-on</span><span class="kw">:</span><span class="at"> ubuntu-latest</span></span>
<span id="cb9-14"><a href="#cb9-14"></a><span class="at">    </span><span class="fu">strategy</span><span class="kw">:</span></span>
<span id="cb9-15"><a href="#cb9-15"></a><span class="at">      </span><span class="fu">fail-fast</span><span class="kw">:</span><span class="at"> </span><span class="ch">false</span></span>
<span id="cb9-16"><a href="#cb9-16"></a><span class="at">      </span><span class="fu">matrix</span><span class="kw">:</span></span>
<span id="cb9-17"><a href="#cb9-17"></a><span class="at">        </span><span class="fu">include</span><span class="kw">:</span></span>
<span id="cb9-18"><a href="#cb9-18"></a><span class="at">          </span><span class="kw">-</span><span class="at"> </span><span class="fu">dockerfile</span><span class="kw">:</span><span class="at"> ./Dockerfile</span></span>
<span id="cb9-19"><a href="#cb9-19"></a><span class="at">            </span><span class="fu">image</span><span class="kw">:</span><span class="at"> ghcr.io/djnavarro/donut</span></span>
<span id="cb9-20"><a href="#cb9-20"></a></span>
<span id="cb9-21"><a href="#cb9-21"></a><span class="at">    </span><span class="fu">permissions</span><span class="kw">:</span></span>
<span id="cb9-22"><a href="#cb9-22"></a><span class="at">      </span><span class="fu">contents</span><span class="kw">:</span><span class="at"> read</span></span>
<span id="cb9-23"><a href="#cb9-23"></a><span class="at">      </span><span class="fu">packages</span><span class="kw">:</span><span class="at"> write</span></span>
<span id="cb9-24"><a href="#cb9-24"></a></span>
<span id="cb9-25"><a href="#cb9-25"></a><span class="at">    </span><span class="fu">steps</span><span class="kw">:</span></span>
<span id="cb9-26"><a href="#cb9-26"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> checkout repository</span></span>
<span id="cb9-27"><a href="#cb9-27"></a><span class="at">        </span><span class="fu">uses</span><span class="kw">:</span><span class="at"> actions/checkout@v2</span></span>
<span id="cb9-28"><a href="#cb9-28"></a></span>
<span id="cb9-29"><a href="#cb9-29"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> login to the container registry</span></span>
<span id="cb9-30"><a href="#cb9-30"></a><span class="at">        </span><span class="fu">uses</span><span class="kw">:</span><span class="at"> docker/login-action@f054a8b539a109f9f41c372932f1ae047eff08c9</span></span>
<span id="cb9-31"><a href="#cb9-31"></a><span class="at">        </span><span class="fu">with</span><span class="kw">:</span></span>
<span id="cb9-32"><a href="#cb9-32"></a><span class="at">          </span><span class="fu">registry</span><span class="kw">:</span><span class="at"> ${{ env.REGISTRY }}</span></span>
<span id="cb9-33"><a href="#cb9-33"></a><span class="at">          </span><span class="fu">username</span><span class="kw">:</span><span class="at"> ${{ github.actor }}</span></span>
<span id="cb9-34"><a href="#cb9-34"></a><span class="at">          </span><span class="fu">password</span><span class="kw">:</span><span class="at"> ${{ secrets.GITHUB_TOKEN }}</span></span>
<span id="cb9-35"><a href="#cb9-35"></a></span>
<span id="cb9-36"><a href="#cb9-36"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> extract metadata (tags, labels) for docker</span></span>
<span id="cb9-37"><a href="#cb9-37"></a><span class="at">        </span><span class="fu">id</span><span class="kw">:</span><span class="at"> meta</span></span>
<span id="cb9-38"><a href="#cb9-38"></a><span class="at">        </span><span class="fu">uses</span><span class="kw">:</span><span class="at"> docker/metadata-action@98669ae865ea3cffbcbaa878cf57c20bbf1c6c38</span></span>
<span id="cb9-39"><a href="#cb9-39"></a><span class="at">        </span><span class="fu">with</span><span class="kw">:</span></span>
<span id="cb9-40"><a href="#cb9-40"></a><span class="at">          </span><span class="fu">images</span><span class="kw">:</span><span class="at"> ${{ matrix.image }}</span></span>
<span id="cb9-41"><a href="#cb9-41"></a></span>
<span id="cb9-42"><a href="#cb9-42"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> build and push docker image</span></span>
<span id="cb9-43"><a href="#cb9-43"></a><span class="at">        </span><span class="fu">uses</span><span class="kw">:</span><span class="at"> docker/build-push-action@ad44023a93711e3deb337508980b4b5e9bcdc5dc</span></span>
<span id="cb9-44"><a href="#cb9-44"></a><span class="at">        </span><span class="fu">with</span><span class="kw">:</span></span>
<span id="cb9-45"><a href="#cb9-45"></a><span class="at">          </span><span class="fu">context</span><span class="kw">:</span><span class="at"> .</span></span>
<span id="cb9-46"><a href="#cb9-46"></a><span class="at">          </span><span class="fu">file</span><span class="kw">:</span><span class="at"> ${{ matrix.dockerfile }}</span></span>
<span id="cb9-47"><a href="#cb9-47"></a><span class="at">          </span><span class="fu">push</span><span class="kw">:</span><span class="at"> </span><span class="ch">true</span></span>
<span id="cb9-48"><a href="#cb9-48"></a><span class="at">          </span><span class="fu">tags</span><span class="kw">:</span><span class="at"> ${{ steps.meta.outputs.tags }}</span></span>
<span id="cb9-49"><a href="#cb9-49"></a><span class="at">          </span><span class="fu">labels</span><span class="kw">:</span><span class="at"> ${{ steps.meta.outputs.labels }}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</div>
<p>At long, long last we have all the precursors in place. We have a little web application that runs inside a docker container, and the image describing that container is hosted on a registry.<a href="#fn13" class="footnote-ref" id="fnref13" role="doc-noteref"><sup>13</sup></a> We can get started on the kubernetes side of things…</p>
<p><br></p>
</section>
<section id="create-a-kubernetes-cluster" class="level2">
<h2 class="anchored" data-anchor-id="create-a-kubernetes-cluster">Create a kubernetes cluster</h2>
<p>At the risk of stating the bloody obvious, if you want to use kubernetes to deploy an application on a cluster… you’re probably going to need a cluster running kubernetes. You can get yourself one of these in lots of different ways but the way I’m going to do it is with GKE, the <a href="https://cloud.google.com/kubernetes-engine">google kubernetes engine</a>. You’ll need a google account to do this, and yes this is something that they charge actual money for, but the good news is that when you sign up for google cloud services you get a few hundred dollars of credit to start with. That’s pretty useful for novices: it’s nice to be able to play around and learn the basics before you have to start worrying about what it’s going to cost.</p>
<p>If you go down that path you can access your projects from the cloud console, located at <a href="https://console.cloud.google.com/">console.cloud.google.com</a>. Once there you can navigate to the various pages you’ll need by clicking on links and menu items, but google offers a lot of different cloud services and it does take a little while for the interface to start feeling familiar, so I’ll link to the pages you need directly as well.</p>
<p>Before you can create a cluster of your very own, you need to create a project. Pretty much everything you do with google cloud services is organised into projects so that’s where we’ll start. To create a project, go to <a href="https://console.cloud.google.com/projectcreate">console.cloud.google.com/projectcreate</a> and follow the prompts. Give your project a fancy name that makes you sound cool: I called mine <code>donut-art</code>.</p>
<p>Now that you have a project, you’ll need to enable the specific google cloud services that your project will need access to. In this example the only thing I’ll need is GKE itself, but in other situations you might need access to google cloud storage or something like that. To enable GKE on your current project go to <a href="https://console.cloud.google.com/kubernetes/">console.cloud.google.com/kubernetes/</a>. If it hasn’t already been enabled for the project the page will ask if you want to. Even more conveniently, if you don’t have a cluster running it will ask if you want to create one.<a href="#fn14" class="footnote-ref" id="fnref14" role="doc-noteref"><sup>14</sup></a> It will give you two options: an “autopilot” cluster is one where google will automatically manage the configuration for you, whereas for a “standard” cluster you’ll have to be more explicit about how many nodes you want and how they are organised. There are situations where you need to use the standard cluster,<a href="#fn15" class="footnote-ref" id="fnref15" role="doc-noteref"><sup>15</sup></a> but this is not one of those so I went with the autopilot approach because it’s simpler. I didn’t need to change any of the defaults: I called my cluster <code>donut-cluster</code>, and created it in the region <code>australia-southeast1</code>.<a href="#fn16" class="footnote-ref" id="fnref16" role="doc-noteref"><sup>16</sup></a></p>
<p>Here’s a screenshot showing you what the relevant bit of the google kubernetes engine console looks like for me now that I have a cluster up and running:</p>
<p><img src="donut-cluster.png" class="img-fluid"></p>
<p>If I click on the “donut-cluster” link it takes me to a page with a lot more detail, but you can see that some of the information is the same:</p>
<p><br></p>
<p><img src="donut-cluster-detail.png" class="img-fluid"></p>
<p><br></p>
</section>
<section id="command-line-tools" class="level2">
<h2 class="anchored" data-anchor-id="command-line-tools">Command line tools</h2>
<p>Time for a little digression.</p>
<p>Take a look at the menu shown in the last screenshot. If I click on the “connect” button and it will reveal a command I can use to connect to the cluster from the terminal on my laptop… but it requires me to have the gcloud command line tools installed. Now, if you don’t want to install the tools locally you can avoid this by selecting the “run in cloud shell” option that also appears on the dialog box. However, I dislike the cloud shell and prefer to work from my own terminal. So, the next step is to install the command line tools. For this project, the two things I need are gcloud (to interact with google cloud services) and kubectl (to interact with kubernetes).</p>
<section id="installing-gcloud" class="level3">
<h3 class="anchored" data-anchor-id="installing-gcloud">Installing gcloud</h3>
<p>It turns out that installing the command line tools is relatively straightforward, and is made a lot easier thanks to the <a href="https://cloud.google.com/sdk/docs/install">gcloud installation instructions</a> which are detailed and not too hard to follow. In addition to the basic tools, I installed the “gke-gcloud-auth-plugin” which are needed for authentication. Once the command line tools are installed, authentication from your terminal is a one-line command:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="ex">gcloud</span> auth login</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>I can now interact with my google cloud projects from my command line.</p>
</section>
<section id="installing-kubectl" class="level3">
<h3 class="anchored" data-anchor-id="installing-kubectl">Installing kubectl</h3>
<p>The second tool I need for this project is <a href="https://kubernetes.io/docs/reference/kubectl/">kubectl</a>, a command line tool used to control a kubernetes cluster. You can find installation instructions for different operating systems by visiting the kubernetes <a href="https://kubernetes.io/docs/tasks/tools/">install tools</a> page. I’m doing this from a linux machine, so I also found it useful to enable autocompletion of kubectl commands within the bash shell. The instructions for this are included in the kubectl install page for linux.</p>
</section>
<section id="connect-to-the-cluster" class="level3">
<h3 class="anchored" data-anchor-id="connect-to-the-cluster">Connect to the cluster</h3>
<p>Now that I have gcloud and kubectl running, I can connect to my cluster. The first thing to do is use gcloud to get the credentials needed to connect to my cluster:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>  <span class="bu">export</span> <span class="va">USE_GKE_GCLOUD_AUTH_PLUGIN</span><span class="op">=</span>True</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>  <span class="ex">gcloud</span> container clusters get-credentials donut-cluster <span class="dt">\</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">--zone</span> australia-southeast1 <span class="dt">\</span></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">--project</span> donut-art</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<pre><code>Fetching cluster endpoint and auth data.
kubeconfig entry generated for donut-cluster.</code></pre>
<p>Then I can use kubectl to verify that it can connect to my cluster:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="ex">kubectl</span> cluster-info</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<pre><code>Kubernetes control plane is running at blah blah blah
GLBCDefaultBackend is running at blah blah blah
KubeDNS is running at blah blah blah
KubeDNSUpstream is running at blah blah blah
Metrics-server is running at blah blah blah</code></pre>
<p>Okay, I may have edited the output slightly. The missing bits are the various URLs. They aren’t very interesting… the main thing to notice is that yes, kubectl can connect to my cluster and the cluster is up and running.</p>
<p><br></p>
</section>
</section>
<section id="kubernetes-terminology" class="level2">
<h2 class="anchored" data-anchor-id="kubernetes-terminology">Kubernetes terminology</h2>
<p>Not surprisingly, kubernetes has a lot of terminology. That’s quite daunting when you’re getting started and I’m not going to attempt a complete glossary here. Instead, let’s start with these four terms, since we’ll use them a lot:</p>
<ul>
<li><strong>Container</strong>. This has the same meaning it has in other contexts: a container is a self-contained executable that bundles up dependencies and runs isolated from other processes on the machine. Kubernetes supports other types of containers besides docker containers, but let’s pretend we’re only talking about docker here.</li>
<li><strong>Pod</strong>. A pod is the smallest deployable unit you can create: it is an abstraction that refers to one or more containers working together. An application can have many pods running on many machines (nodes) but each pod runs on one machine. Pods are considered ephemeral. Kubernetes will have no qualms about shutting down a pod if it doesn’t seem to be doing its job, or creating new pods to replace it if it needs to,<br>
</li>
<li><strong>Deployment</strong>. A deployment is an abstraction that specifies a collection of pods that your application runs. Essentially it describes your “desired state” for the application. When you “apply” a deployment kubernetes will start the application running (more or less), and try to make the thing that’s actually running look like your stated deployment configuration.</li>
<li><strong>Service</strong>. A service is an abstraction that specifies how the pods running on your kubernetes cluster communicate with the outside world. They’re awfully handy things to have if you want your application to be accessible on the web.</li>
</ul>
<p>Conceptually, it’s also helpful to know these terms at the very beginning, even though frankly I’m not going to do anything with them here:</p>
<ul>
<li><strong>Node</strong>. A node refers one of the machines running in your cluster.</li>
<li><strong>Control Plane</strong>. The control plane refers to a collection of processes that run together on a single node and are in charge of actually running the whole thing. We won’t need to do anything to the control plane in this post other than leave it alone and let it do its job, but it does help to know the term because it shows up everywhere.</li>
</ul>
<p>More terms will appears as we go along – and I’ll try to explain all those when they pop up – but these are the ones that I wish I’d understood properly before I started trying to play with kubernetes clusters.</p>
<p><br></p>
</section>
<section id="create-a-deployment" class="level2">
<h2 class="anchored" data-anchor-id="create-a-deployment">Create a deployment</h2>
<p>The way to configure your kubernetes cluster is with manifest files that are written in <a href="https://en.wikipedia.org/wiki/YAML">yaml</a> format and use the <code>kubectl apply</code> command to update your cluster using the instructions laid out in the manifest file. You can use a manifest to modify any aspect to your cluster configuration, and later in this post I’ll show a few more manifests, but for now here’s the <a href="https://github.com/djnavarro/donut/blob/main/deployment.yaml"><code>deployment.yaml</code></a> file I’m using to specify a deployment for the donuts application:</p>
<div class="cell">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>deployment.yaml</strong></pre>
</div>
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode numberSource yaml number-lines code-with-copy"><code class="sourceCode yaml"><span id="cb15-1"><a href="#cb15-1"></a><span class="fu">apiVersion</span><span class="kw">:</span><span class="at"> apps/v1</span></span>
<span id="cb15-2"><a href="#cb15-2"></a><span class="fu">kind</span><span class="kw">:</span><span class="at"> Deployment</span></span>
<span id="cb15-3"><a href="#cb15-3"></a><span class="fu">metadata</span><span class="kw">:</span></span>
<span id="cb15-4"><a href="#cb15-4"></a><span class="at">  </span><span class="fu">labels</span><span class="kw">:</span></span>
<span id="cb15-5"><a href="#cb15-5"></a><span class="at">    </span><span class="fu">app.kubernetes.io/name</span><span class="kw">:</span><span class="at"> donut-example</span></span>
<span id="cb15-6"><a href="#cb15-6"></a><span class="at">  </span><span class="fu">name</span><span class="kw">:</span><span class="at"> donut</span></span>
<span id="cb15-7"><a href="#cb15-7"></a><span class="fu">spec</span><span class="kw">:</span></span>
<span id="cb15-8"><a href="#cb15-8"></a><span class="at">  </span><span class="fu">replicas</span><span class="kw">:</span><span class="at"> </span><span class="dv">2</span></span>
<span id="cb15-9"><a href="#cb15-9"></a><span class="at">  </span><span class="fu">selector</span><span class="kw">:</span></span>
<span id="cb15-10"><a href="#cb15-10"></a><span class="at">    </span><span class="fu">matchLabels</span><span class="kw">:</span></span>
<span id="cb15-11"><a href="#cb15-11"></a><span class="at">      </span><span class="fu">app.kubernetes.io/name</span><span class="kw">:</span><span class="at"> donut-example</span></span>
<span id="cb15-12"><a href="#cb15-12"></a><span class="at">  </span><span class="fu">template</span><span class="kw">:</span></span>
<span id="cb15-13"><a href="#cb15-13"></a><span class="at">    </span><span class="fu">metadata</span><span class="kw">:</span></span>
<span id="cb15-14"><a href="#cb15-14"></a><span class="at">      </span><span class="fu">labels</span><span class="kw">:</span></span>
<span id="cb15-15"><a href="#cb15-15"></a><span class="at">        </span><span class="fu">app.kubernetes.io/name</span><span class="kw">:</span><span class="at"> donut-example</span></span>
<span id="cb15-16"><a href="#cb15-16"></a><span class="at">    </span><span class="fu">spec</span><span class="kw">:</span></span>
<span id="cb15-17"><a href="#cb15-17"></a><span class="at">      </span><span class="fu">containers</span><span class="kw">:</span></span>
<span id="cb15-18"><a href="#cb15-18"></a><span class="at">        </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> donut</span></span>
<span id="cb15-19"><a href="#cb15-19"></a><span class="at">          </span><span class="fu">image</span><span class="kw">:</span><span class="at"> ghcr.io/djnavarro/donut:main</span></span>
<span id="cb15-20"><a href="#cb15-20"></a><span class="at">          </span><span class="fu">imagePullPolicy</span><span class="kw">:</span><span class="at"> Always</span></span>
<span id="cb15-21"><a href="#cb15-21"></a><span class="at">          </span><span class="fu">resources</span><span class="kw">:</span></span>
<span id="cb15-22"><a href="#cb15-22"></a><span class="at">            </span><span class="fu">requests</span><span class="kw">:</span></span>
<span id="cb15-23"><a href="#cb15-23"></a><span class="at">              </span><span class="fu">memory</span><span class="kw">:</span><span class="at"> </span><span class="st">"64Mi"</span></span>
<span id="cb15-24"><a href="#cb15-24"></a><span class="at">              </span><span class="fu">cpu</span><span class="kw">:</span><span class="at"> </span><span class="st">"250m"</span></span>
<span id="cb15-25"><a href="#cb15-25"></a><span class="at">            </span><span class="fu">limits</span><span class="kw">:</span></span>
<span id="cb15-26"><a href="#cb15-26"></a><span class="at">              </span><span class="fu">memory</span><span class="kw">:</span><span class="at"> </span><span class="st">"128Mi"</span></span>
<span id="cb15-27"><a href="#cb15-27"></a><span class="at">              </span><span class="fu">cpu</span><span class="kw">:</span><span class="at"> </span><span class="st">"500m"</span></span>
<span id="cb15-28"><a href="#cb15-28"></a><span class="at">          </span><span class="fu">ports</span><span class="kw">:</span></span>
<span id="cb15-29"><a href="#cb15-29"></a><span class="at">            </span><span class="kw">-</span><span class="at"> </span><span class="fu">containerPort</span><span class="kw">:</span><span class="at"> </span><span class="dv">80</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<p>For the moment, let’s censor the metadata and everything that uses the metadata so that we can focus on what the rest of the manifest is doing:</p>
<div class="cell">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>deployment.yaml</strong></pre>
</div>
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode numberSource yaml number-lines code-with-copy"><code class="sourceCode yaml"><span id="cb16-1"><a href="#cb16-1"></a><span class="fu">apiVersion</span><span class="kw">:</span><span class="at"> apps/v1</span></span>
<span id="cb16-2"><a href="#cb16-2"></a><span class="fu">kind</span><span class="kw">:</span><span class="at"> Deployment</span></span>
<span id="cb16-3"><a href="#cb16-3"></a><span class="fu">metadata</span><span class="kw">:</span><span class="at"> </span></span>
<span id="cb16-4"><a href="#cb16-4"></a><span class="at">  </span><span class="kw">[</span><span class="at">some metadata</span><span class="kw">]</span></span>
<span id="cb16-5"><a href="#cb16-5"></a><span class="fu">spec</span><span class="kw">:</span></span>
<span id="cb16-6"><a href="#cb16-6"></a><span class="at">  </span><span class="fu">replicas</span><span class="kw">:</span><span class="at"> </span><span class="dv">2</span></span>
<span id="cb16-7"><a href="#cb16-7"></a><span class="at">  </span><span class="fu">selector</span><span class="kw">:</span></span>
<span id="cb16-8"><a href="#cb16-8"></a><span class="at">    </span><span class="kw">[</span><span class="at">use some metadata</span><span class="kw">]</span></span>
<span id="cb16-9"><a href="#cb16-9"></a><span class="at">  </span><span class="fu">template</span><span class="kw">:</span></span>
<span id="cb16-10"><a href="#cb16-10"></a><span class="at">    </span><span class="fu">metadata</span><span class="kw">:</span></span>
<span id="cb16-11"><a href="#cb16-11"></a><span class="at">      </span><span class="kw">[</span><span class="at">some metadata</span><span class="kw">]</span></span>
<span id="cb16-12"><a href="#cb16-12"></a><span class="at">    </span><span class="fu">spec</span><span class="kw">:</span></span>
<span id="cb16-13"><a href="#cb16-13"></a><span class="at">      </span><span class="fu">containers</span><span class="kw">:</span></span>
<span id="cb16-14"><a href="#cb16-14"></a><span class="at">        </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> </span><span class="kw">[</span><span class="at">names are metadata</span><span class="kw">]</span></span>
<span id="cb16-15"><a href="#cb16-15"></a><span class="at">          </span><span class="fu">image</span><span class="kw">:</span><span class="at"> ghcr.io/djnavarro/donut:main</span></span>
<span id="cb16-16"><a href="#cb16-16"></a><span class="at">          </span><span class="fu">imagePullPolicy</span><span class="kw">:</span><span class="at"> Always</span></span>
<span id="cb16-17"><a href="#cb16-17"></a><span class="at">          </span><span class="fu">resources</span><span class="kw">:</span></span>
<span id="cb16-18"><a href="#cb16-18"></a><span class="at">            </span><span class="fu">requests</span><span class="kw">:</span></span>
<span id="cb16-19"><a href="#cb16-19"></a><span class="at">              </span><span class="fu">memory</span><span class="kw">:</span><span class="at"> </span><span class="st">"64Mi"</span></span>
<span id="cb16-20"><a href="#cb16-20"></a><span class="at">              </span><span class="fu">cpu</span><span class="kw">:</span><span class="at"> </span><span class="st">"250m"</span></span>
<span id="cb16-21"><a href="#cb16-21"></a><span class="at">            </span><span class="fu">limits</span><span class="kw">:</span></span>
<span id="cb16-22"><a href="#cb16-22"></a><span class="at">              </span><span class="fu">memory</span><span class="kw">:</span><span class="at"> </span><span class="st">"128Mi"</span></span>
<span id="cb16-23"><a href="#cb16-23"></a><span class="at">              </span><span class="fu">cpu</span><span class="kw">:</span><span class="at"> </span><span class="st">"500m"</span></span>
<span id="cb16-24"><a href="#cb16-24"></a><span class="at">          </span><span class="fu">ports</span><span class="kw">:</span></span>
<span id="cb16-25"><a href="#cb16-25"></a><span class="at">            </span><span class="kw">-</span><span class="at"> </span><span class="fu">containerPort</span><span class="kw">:</span><span class="at"> </span><span class="dv">80</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<p>There’s a lot going on here, so for the moment let’s focus on the bottom.<a href="#fn17" class="footnote-ref" id="fnref17" role="doc-noteref"><sup>17</sup></a> The section of the code from lines 13-25 is used to specify the docker containers<a href="#fn18" class="footnote-ref" id="fnref18" role="doc-noteref"><sup>18</sup></a> that my cluster is going to deploy. There’s only one container listed in this section, and the line that reads <code>image: ghcr.io/djnavarro/donut:main</code> is the way that I’ve specified the docker image to use when creating the container. There are other settings I’ve used to set up this container: I’ve asked kubernetes to allocate memory and cpu resources to the container, and I’ve exposed container port 80 (which, if you can remember back that far, is where the plumber web API is running inside the container). I’ve also set <code>imagePullPolicy: Always</code> to ensure that every time I update this deployment kubernetes will pull the image from the registry afresh. I did that because more often than not while I was writing code for the kubernetes deployment I was tweaking the image too, and I wanted to make sure that I was always trying to deploy the most recent version of the image.</p>
<p>Okay, now that we know what’s going on in that section of the code, let’s collapse that part and think about the manifest file like this:</p>
<div class="cell">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>deployment.yaml</strong></pre>
</div>
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode numberSource yaml number-lines code-with-copy"><code class="sourceCode yaml"><span id="cb17-1"><a href="#cb17-1"></a><span class="fu">apiVersion</span><span class="kw">:</span><span class="at"> apps/v1</span></span>
<span id="cb17-2"><a href="#cb17-2"></a><span class="fu">kind</span><span class="kw">:</span><span class="at"> Deployment</span></span>
<span id="cb17-3"><a href="#cb17-3"></a><span class="fu">metadata</span><span class="kw">:</span><span class="at"> </span></span>
<span id="cb17-4"><a href="#cb17-4"></a><span class="at">  </span><span class="kw">[</span><span class="at">some metadata</span><span class="kw">]</span></span>
<span id="cb17-5"><a href="#cb17-5"></a><span class="fu">spec</span><span class="kw">:</span></span>
<span id="cb17-6"><a href="#cb17-6"></a><span class="at">  </span><span class="fu">replicas</span><span class="kw">:</span><span class="at"> </span><span class="dv">2</span></span>
<span id="cb17-7"><a href="#cb17-7"></a><span class="at">  </span><span class="fu">selector</span><span class="kw">:</span></span>
<span id="cb17-8"><a href="#cb17-8"></a><span class="at">    </span><span class="kw">[</span><span class="at">use some metadata</span><span class="kw">]</span></span>
<span id="cb17-9"><a href="#cb17-9"></a><span class="at">  </span><span class="fu">template</span><span class="kw">:</span></span>
<span id="cb17-10"><a href="#cb17-10"></a><span class="at">    </span><span class="fu">metadata</span><span class="kw">:</span></span>
<span id="cb17-11"><a href="#cb17-11"></a><span class="at">      </span><span class="kw">[</span><span class="at">some metadata</span><span class="kw">]</span></span>
<span id="cb17-12"><a href="#cb17-12"></a><span class="at">    </span><span class="fu">spec</span><span class="kw">:</span></span>
<span id="cb17-13"><a href="#cb17-13"></a><span class="at">      </span><span class="kw">[</span><span class="at">details of one or more containers</span><span class="kw">]</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<p>Okay, so now let’s think about the bottom part of this code too. Lines 9-13 of this condensed pseudo-manifest describe some kind of template. But a template for what? Well, as clearly stated on line 13 in human(ish) language, it’s a template for “one or more containers”. In kubernetes terminology, a deployable thing that holds one or more containers is a pod… so this section of the code is describing a <a href="https://kubernetes.io/docs/concepts/workloads/pods/#pod-templates">pod template</a>. It’s an instruction to kubernetes that says… “hey, when you create a pod as part of this deployment, here’s the template you should use”. So we can simplify again:</p>
<div class="cell">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>deployment.yaml</strong></pre>
</div>
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode numberSource yaml number-lines code-with-copy"><code class="sourceCode yaml"><span id="cb18-1"><a href="#cb18-1"></a><span class="fu">apiVersion</span><span class="kw">:</span><span class="at"> apps/v1</span></span>
<span id="cb18-2"><a href="#cb18-2"></a><span class="fu">kind</span><span class="kw">:</span><span class="at"> Deployment</span></span>
<span id="cb18-3"><a href="#cb18-3"></a><span class="fu">metadata</span><span class="kw">:</span><span class="at"> </span></span>
<span id="cb18-4"><a href="#cb18-4"></a><span class="at">  </span><span class="kw">[</span><span class="at">some metadata</span><span class="kw">]</span></span>
<span id="cb18-5"><a href="#cb18-5"></a><span class="fu">spec</span><span class="kw">:</span></span>
<span id="cb18-6"><a href="#cb18-6"></a><span class="at">  </span><span class="fu">replicas</span><span class="kw">:</span><span class="at"> </span><span class="dv">2</span></span>
<span id="cb18-7"><a href="#cb18-7"></a><span class="at">  </span><span class="fu">selector</span><span class="kw">:</span></span>
<span id="cb18-8"><a href="#cb18-8"></a><span class="at">    </span><span class="kw">[</span><span class="at">use some metadata</span><span class="kw">]</span></span>
<span id="cb18-9"><a href="#cb18-9"></a><span class="at">  </span><span class="fu">template</span><span class="kw">:</span></span>
<span id="cb18-10"><a href="#cb18-10"></a><span class="at">    </span><span class="kw">[</span><span class="at">details of the pod template</span><span class="kw">]</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<p>In this condensed form we can see that lines 5-10 provide a specification of the deployment itself. I’ve given it a pod template that tells kubernetes what the pods should look like, and I’ve specified the number of “replicas”. How many copies of this pod do I want it to run in this deployment: for no good reason at all I decided to run two (i.e., two replicas).</p>
<p>If we simplify the manifest yet again, we can see the top-level description:</p>
<div class="cell">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>deployment.yaml</strong></pre>
</div>
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode numberSource yaml number-lines code-with-copy"><code class="sourceCode yaml"><span id="cb19-1"><a href="#cb19-1"></a><span class="fu">apiVersion</span><span class="kw">:</span><span class="at"> apps/v1</span></span>
<span id="cb19-2"><a href="#cb19-2"></a><span class="fu">kind</span><span class="kw">:</span><span class="at"> Deployment</span></span>
<span id="cb19-3"><a href="#cb19-3"></a><span class="fu">metadata</span><span class="kw">:</span><span class="at"> </span></span>
<span id="cb19-4"><a href="#cb19-4"></a><span class="at">  </span><span class="kw">[</span><span class="at">some metadata</span><span class="kw">]</span></span>
<span id="cb19-5"><a href="#cb19-5"></a><span class="fu">spec</span><span class="kw">:</span></span>
<span id="cb19-6"><a href="#cb19-6"></a><span class="at">  </span><span class="kw">[</span><span class="at">details of the deployment</span><span class="kw">]</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<p>The only other things to point out right now is that the “kind” field is used to tell kubernetes what type of object to create (a Deployment), and the “apiVersion” field is used to specify which version of the kubernetes API to use when interpreting the manifest. That’s handy to note because later on I’ll be using APIs that are a bit more specific to the google kubernetes engine.</p>
<p>Okay, so now that we have some sense of what’s going on in the <code>deployment.yaml</code> file (ignoring the fact that I’ve glossed over the metadata bits), let’s actually apply it to our cluster:<a href="#fn19" class="footnote-ref" id="fnref19" role="doc-noteref"><sup>19</sup></a></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="ex">kubectl</span> apply <span class="at">-f</span> deployment.yaml</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>To see if it’s working we can use <code>kubectl get deployments</code>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="ex">kubectl</span> get deployments</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<pre><code>NAME    READY   UP-TO-DATE   AVAILABLE   AGE
donut   2/2     2            2           19h</code></pre>
<p>It is alive.</p>
<p>For more details on this part of the process, check out the kubernetes documentation on <a href="https://kubernetes.io/docs/tasks/run-application/run-stateless-application-deployment/">deploying a stateless application</a>. You may also want to look at the page on <a href="https://kubernetes.io/docs/concepts/configuration/manage-resources-containers/">managing container resources</a> at this point.</p>
<p><br></p>
</section>
<section id="expose-the-deployment-no-https" class="level2">
<h2 class="anchored" data-anchor-id="expose-the-deployment-no-https">Expose the deployment (no https)</h2>
<p>At this point my little donut application is running happily on the cluster, but it doesn’t have a public IP address. No-one can visit it. To expose the deployment to the world you’ll need to start a service running that takes care of this for you. Exactly how you go about doing this depends on whether you want to enable https on the website. If you’re not too fussed about https the process is fairly simple and you can find details on how to do it by reading the <a href="https://kubernetes.io/docs/tutorials/stateless-application/expose-external-ip-address/">tutorial on exposing an external IP address</a>, and you may find the kubernetes <a href="https://kubernetes.io/docs/concepts/services-networking/service/">documentation on services</a> helpful too. The TL;DR is that it’s simple enough that you don’t even need to bother with a manifest file:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="ex">kubectl</span> expose deployment donut <span class="at">--type</span><span class="op">=</span>LoadBalancer <span class="at">--name</span><span class="op">=</span>donut-service</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The application is now online. It has a public IP address that you can find, and if you own a domain that you want to map to that IP address all you have to do is create a DNS record that points the URL at the appropriate IP. With any luck your domain provider will have some decent documentation for this. For instance, I use google domains for <code>djnavarro.net</code> domain, and they have some pretty decent <a href="https://support.google.com/a/answer/2579934?hl=en">instructions on configuring DNS records</a> that I could use to point <code>donut.djnavarro.net</code> at the IP address for my kubernetes application.</p>
<p>Unfortunately for me, I am a masochist, and as such I chose the option that delivers pain.</p>
<p><br></p>
</section>
<section id="expose-the-deployment-with-https" class="level2">
<h2 class="anchored" data-anchor-id="expose-the-deployment-with-https">Expose the deployment (with https)</h2>
<blockquote class="blockquote">
<p>I like the kick in the face <br> And the things you do to me <br> I love the way that it hurts <br> I don’t miss you, I miss the misery <br> &nbsp; – Halestorm</p>
</blockquote>
<p>Configuring the kubernetes application to use https is a bit of a pain in the ass.<a href="#fn20" class="footnote-ref" id="fnref20" role="doc-noteref"><sup>20</sup></a> I’m deploying all this through google kubernetes engine, so the approach I took was to follow the guide for using <a href="https://cloud.google.com/kubernetes-engine/docs/how-to/managed-certs">google-managed ssl certificates</a>. The guide is excellent… apart from a couple of minor… issues… that really fucked me<a href="#fn21" class="footnote-ref" id="fnref21" role="doc-noteref"><sup>21</sup></a> when I tried to follow it. I’ll mention those as I go.</p>
<section id="get-a-static-ip" class="level3">
<h3 class="anchored" data-anchor-id="get-a-static-ip">Get a static IP</h3>
<p>The first thing you have to do is create a static IP address that you’ll later use for your cluster. The <code>gcloud compute addresses create</code> command does that for you. Here’s how I did that for my cluster:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="ex">gcloud</span> compute addresses create donut-ip-address <span class="dt">\</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">--global</span> <span class="dt">\</span></span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">--project</span> donut-art</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<!-- :::{.column-page-right} -->
<!-- ``` -->
<!-- Created [https://www.googleapis.com/compute/v1/projects/donut-art/global/addresses/donut-ip-address] -->
<!-- ``` -->
<!-- ::: -->
<p>This prints out a very boring message that informs you that the ID address has been created. More helpfully, now that the IP address exists you can ask google to tell you what it is:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="ex">gcloud</span> compute addresses describe donut-ip-address <span class="dt">\</span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">--global</span> <span class="dt">\</span></span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">--project</span> donut-art</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>When you do this, the output prints out the IP address and some other details. Later on, this is the address you’ll create a DNS record for so that – in my case – the <a href="https://donut.djnavarro.net/">https://donut.djnavarro.net/</a> address points to the correct location.</p>
</section>
<section id="get-a-certificate" class="level3">
<h3 class="anchored" data-anchor-id="get-a-certificate">Get a certificate</h3>
<p>The next step in the process is to create a managed certificate. Somebody needs to certify that my website is what it says it is.<a href="#fn22" class="footnote-ref" id="fnref22" role="doc-noteref"><sup>22</sup></a> I’m going to need a manifest file for this, which I’ve saved as <a href="https://github.com/djnavarro/donut/blob/main/managed-cert.yaml"><code>managed-cert.yaml</code></a>:</p>
<div class="cell">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>managed-cert.yaml</strong></pre>
</div>
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode numberSource yaml number-lines code-with-copy"><code class="sourceCode yaml"><span id="cb26-1"><a href="#cb26-1"></a><span class="fu">apiVersion</span><span class="kw">:</span><span class="at"> networking.gke.io/v1</span></span>
<span id="cb26-2"><a href="#cb26-2"></a><span class="fu">kind</span><span class="kw">:</span><span class="at"> ManagedCertificate</span></span>
<span id="cb26-3"><a href="#cb26-3"></a><span class="fu">metadata</span><span class="kw">:</span></span>
<span id="cb26-4"><a href="#cb26-4"></a><span class="at">  </span><span class="fu">name</span><span class="kw">:</span><span class="at"> managed-cert</span></span>
<span id="cb26-5"><a href="#cb26-5"></a><span class="fu">spec</span><span class="kw">:</span></span>
<span id="cb26-6"><a href="#cb26-6"></a><span class="at">  </span><span class="fu">domains</span><span class="kw">:</span></span>
<span id="cb26-7"><a href="#cb26-7"></a><span class="at">    </span><span class="kw">-</span><span class="at"> donut.djnavarro.net</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<p>Notice that the <code>apiVersion</code> field here is using something specific to GKE: I’m using google infrastructure here and they’ve kindly<a href="#fn23" class="footnote-ref" id="fnref23" role="doc-noteref"><sup>23</sup></a> provided an API that makes it easy to use their managed certificates. The yaml here is pretty simple: I’m asking google to supply me with a certificate for my kubernetes application, which will be valid for the domain <code>donut.djnavarro.net</code> (you can list more than one here but I didn’t).</p>
<p>Now that I have a manifest, I apply it to my cluster in the usual way:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="ex">kubectl</span> apply <span class="at">-f</span> managed-cert.yaml</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Okay, at this point in the guide it warns you that it might take an hour or so for the certificate to be provisioned. I manage so many websites now that I’d stopped paying attention to this warning because like, 90% of the time, the thing actually happens in 20 seconds. Yeah nah, not this time babe. This one actually took an hour. We’ll come back to it. I mean, if you want to check you can try this command:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="ex">kubectl</span> describe managedcertificate managed-cert</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>It will print out a bunch of stuff, but when you scroll through the output you’ll very likely come across something that says that the certificate is “Provisioning”. It did work for me but it took a while so let’s move on while that is happening.</p>
</section>
<section id="create-a-service" class="level3">
<h3 class="anchored" data-anchor-id="create-a-service">Create a service</h3>
<p>Next up is the step that fucked me in the worst possible way. It failed, because I did a copy-paste on a bit of code that I needed to edit. I did that because the guide on the google website doesn’t flag this as something you need to edit. Worse yet, it failed silently because kubernetes had no bloody way to know my manifest was fucked up. Worst of all, for at least three hours I was convinced that my error was in the <em>later</em> step because this step failed silently.</p>
<p>Siiiiiiiiiiiiiigh. Computers were a mistake.</p>
<p>Anyway, let’s start by looking at the manifest file, which I’ve called <a href="https://github.com/djnavarro/donut/blob/main/mc-service.yaml"><code>mc-service.yaml</code></a>:</p>
<div class="cell">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>mc-service.yaml</strong></pre>
</div>
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode numberSource yaml number-lines code-with-copy"><code class="sourceCode yaml"><span id="cb29-1"><a href="#cb29-1"></a><span class="fu">apiVersion</span><span class="kw">:</span><span class="at"> v1</span></span>
<span id="cb29-2"><a href="#cb29-2"></a><span class="fu">kind</span><span class="kw">:</span><span class="at"> Service</span></span>
<span id="cb29-3"><a href="#cb29-3"></a><span class="fu">metadata</span><span class="kw">:</span></span>
<span id="cb29-4"><a href="#cb29-4"></a><span class="at">  </span><span class="fu">name</span><span class="kw">:</span><span class="at"> mc-service</span></span>
<span id="cb29-5"><a href="#cb29-5"></a><span class="fu">spec</span><span class="kw">:</span></span>
<span id="cb29-6"><a href="#cb29-6"></a><span class="at">  </span><span class="fu">selector</span><span class="kw">:</span></span>
<span id="cb29-7"><a href="#cb29-7"></a><span class="at">    </span><span class="fu">app.kubernetes.io/name</span><span class="kw">:</span><span class="at"> donut-example</span></span>
<span id="cb29-8"><a href="#cb29-8"></a><span class="at">  </span><span class="fu">type</span><span class="kw">:</span><span class="at"> NodePort</span></span>
<span id="cb29-9"><a href="#cb29-9"></a><span class="at">  </span><span class="fu">ports</span><span class="kw">:</span></span>
<span id="cb29-10"><a href="#cb29-10"></a><span class="at">    </span><span class="kw">-</span><span class="at"> </span><span class="fu">protocol</span><span class="kw">:</span><span class="at"> TCP</span></span>
<span id="cb29-11"><a href="#cb29-11"></a><span class="at">      </span><span class="fu">port</span><span class="kw">:</span><span class="at"> </span><span class="dv">80</span></span>
<span id="cb29-12"><a href="#cb29-12"></a><span class="at">      </span><span class="fu">targetPort</span><span class="kw">:</span><span class="at"> </span><span class="dv">80</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<p>At this point in the process I freely admit I’m at the edge of my own knowledge, and I don’t want to say too much about something I only barely understand myself, but there are two things I will point out about this:</p>
<ul>
<li><p>Notice that under <code>spec.selector</code> (lines 5-7) I’m referring to the name of my deployment (<code>donut-example</code>). That’s what the kubernetes docs tell you to do when setting up a NodePort service (see <a href="https://kubernetes.io/docs/concepts/services-networking/service/">here</a>), but the guide on the the corresponding google page that I linked to earlier (i.e., <a href="https://cloud.google.com/kubernetes-engine/docs/how-to/managed-certs">this one</a>) misled me. It made me think I was supposed to use the name of the service (<code>mc-service</code>). You want this service to point at your deployment!</p></li>
<li><p>Notice I’m doing everything on port 80? You probably don’t need to do this, but I found some discussion online about an old issue with kubernetes where they were hardcoding port 80 somewhere. I’m pretty certain that’s been properly resolved now and I don’t need to use port 80 for everything, but it was one of the tweaks I made on the way to figuring out the problem with <code>spec.selector</code> and… well… fuck it. The current version works and I’m new to kubernetes so I’m not changing it today.</p></li>
</ul>
<p>In any case, now that I have a manifest file I can apply it to the cluster:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="ex">kubectl</span> apply <span class="at">-f</span> mc-service.yaml</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="create-the-dns-record" class="level3">
<h3 class="anchored" data-anchor-id="create-the-dns-record">Create the DNS record</h3>
<p>The next step in the process was to create a DNS record (with google domains in my case) for <code>donut.djnavarro.net</code> that points this subdomain to the appropriate IP address. I talked about this earlier in the post, so let’s move on…</p>
</section>
<section id="create-an-ingress" class="level3">
<h3 class="anchored" data-anchor-id="create-an-ingress">Create an ingress</h3>
<p>If the gods were kind we would be done, but of course we are not. I have a managed certificate and I have a service that exposes my deployment. That <em>doesn’t</em> mean that my application is configured to serve pages over https. To do this I need to create an <a href="https://kubernetes.io/docs/concepts/services-networking/ingress/">ingress</a> that manages external access to the service I created earlier and handles the SSL bit. Which is the thing I really need in order to make https work. Again…</p>
<p>Siiiiiiiiiiiigh.</p>
<p>Okay, here’s my <a href="https://github.com/djnavarro/donut/blob/main/mc-ingress.yaml"><code>mc-ingress.yaml</code></a> manifest file for that:</p>
<div class="cell">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>mc-ingress.yaml</strong></pre>
</div>
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode numberSource yaml number-lines code-with-copy"><code class="sourceCode yaml"><span id="cb31-1"><a href="#cb31-1"></a><span class="fu">apiVersion</span><span class="kw">:</span><span class="at"> networking.k8s.io/v1</span></span>
<span id="cb31-2"><a href="#cb31-2"></a><span class="fu">kind</span><span class="kw">:</span><span class="at"> Ingress</span></span>
<span id="cb31-3"><a href="#cb31-3"></a><span class="fu">metadata</span><span class="kw">:</span></span>
<span id="cb31-4"><a href="#cb31-4"></a><span class="at">  </span><span class="fu">name</span><span class="kw">:</span><span class="at"> mc-ingress</span></span>
<span id="cb31-5"><a href="#cb31-5"></a><span class="at">  </span><span class="fu">annotations</span><span class="kw">:</span></span>
<span id="cb31-6"><a href="#cb31-6"></a><span class="at">    </span><span class="fu">kubernetes.io/ingress.global-static-ip-name</span><span class="kw">:</span><span class="at"> donut-ip-address</span></span>
<span id="cb31-7"><a href="#cb31-7"></a><span class="at">    </span><span class="fu">networking.gke.io/managed-certificates</span><span class="kw">:</span><span class="at"> managed-cert</span></span>
<span id="cb31-8"><a href="#cb31-8"></a><span class="at">    </span><span class="fu">kubernetes.io/ingress.class</span><span class="kw">:</span><span class="at"> </span><span class="st">"gce"</span></span>
<span id="cb31-9"><a href="#cb31-9"></a><span class="fu">spec</span><span class="kw">:</span></span>
<span id="cb31-10"><a href="#cb31-10"></a><span class="at">  </span><span class="fu">defaultBackend</span><span class="kw">:</span></span>
<span id="cb31-11"><a href="#cb31-11"></a><span class="at">    </span><span class="fu">service</span><span class="kw">:</span></span>
<span id="cb31-12"><a href="#cb31-12"></a><span class="at">      </span><span class="fu">name</span><span class="kw">:</span><span class="at"> mc-service</span></span>
<span id="cb31-13"><a href="#cb31-13"></a><span class="at">      </span><span class="fu">port</span><span class="kw">:</span></span>
<span id="cb31-14"><a href="#cb31-14"></a><span class="at">        </span><span class="fu">number</span><span class="kw">:</span><span class="at"> </span><span class="dv">80</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<p>This manifest uses the static IP address I created (<code>donut-ip-address</code>), as well as the TLS certificate that I’ve asked google to provide me (<code>managed-cert</code>), and it specifies the <code>mc-service</code> I created as the backend. These things together give me https… apparently.</p>
<p>As usual, I apply the manifest to my cluster:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="ex">kubectl</span> apply <span class="at">-f</span> mc-ingress.yaml </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>I can inspect the results with <code>kubectl get ingress</code>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="ex">kubectl</span> get ingress</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<pre><code>NAME         CLASS    HOSTS   ADDRESS         PORTS   AGE
mc-ingress   &lt;none&gt;   *       34.149.195.33   80      98s</code></pre>
<p>I might still have to wait for the certificate provisioning to finish, so I’d better check again:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="ex">kubectl</span> describe managedcertificate managed-cert</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Here’s the relevant bit of the output showing what it looks like once it’s all working:</p>
<pre><code>Spec:
  Domains:
    donut.djnavarro.net
Status:
  Certificate Name:    mcrt-b2204ff4-ad92-4811-a56d-f007190bb659
  Certificate Status:  Active
  Domain Status:
    Domain:     donut.djnavarro.net
    Status:     Active</code></pre>
<p>At last. I have https. It works, which I can verify simply by visiting <a href="https://donut.djnavarro.net">https://donut.djnavarro.net</a> and seeing if my app is working. Obviously I know that it is, because the embedded image at the start of the post is doing what it’s supposed to, but just for fun I’ll do it again:</p>
<a href="https://donut.djnavarro.net"><img width="100%" src="https://donut.djnavarro.net" title="donut.djnavarro.net"></a>
<p><br></p>
<p>Excellent. It works.</p>
<p><br></p>
</section>
</section>
<section id="epilogue" class="level2">
<h2 class="anchored" data-anchor-id="epilogue">Epilogue</h2>
<p>The application I built is very limited, and I think it’s important to point to the things that I know it does poorly. I am sure there are others, but the big one is storage. As currently designed, the app generates a new image every time the site is visited. That’s wasteful, especially if you’re going to reuse images. You can do better than this by enabling google cloud storage, connecting to it as a volume, and writing generated images to storage when they are create. The plumber app would then check for the relevant files before trying to generate a new one. There’s a useful <a href="https://cloud.google.com/kubernetes-engine/docs/how-to/volumes">tutorial on volumes</a> if you want to explore this with the google kubernetes engine.</p>
<p>It’s also worth pointing out that I have completely ignored <a href="https://helm.sh/">helm</a>, the package manager for kubernetes. Helm is excellent, and when the time comes that you want to deploy an application that someone else has designed properly, the thing you actually do is use a helm “chart”. For example, the one time I actually got <a href="https://spark.apache.org/">spark</a> running properly on a kubernetes cluster, the way I did it was using a terribly-useful helm chart provided by Bitnami: <a href="https://bitnami.com/stack/spark/helm">bitnami.com/stack/spark/helm</a>. There’s a lot of useful tooling built up around kubernetes, and you might as well take advantage of that!</p>
<p>That being said… yes there’s a lot more to talk about, but I’m done with this post. I’m tired and unemployed, and since nobody is paying me for any of this I’m going to call it quits for today.</p>
<!--------------- appendices go here ----------------->


</section>


<div id="quarto-appendix" class="default"><section id="footnotes" class="footnotes footnotes-end-of-document" role="doc-endnotes"><h2 class="anchored quarto-appendix-heading">Footnotes</h2>

<ol>
<li id="fn1"><p>Though who knows: there’s a lot of strange on grindr.<a href="#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn2"><p>Lots of computers working as a single unit.<a href="#fnref2" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn3"><p>Also known colloquially as “computers”. A node in a cluster is one of the machines that makes up the cluster. I’m endlessly entertained by the human ability to make concepts impenetrable to outsiders by writing in jargon that is never explained to novices.<a href="#fnref3" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn4"><p>Oh look it’s a trans who likes Lana, how original.<a href="#fnref4" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn5"><p>The author does not count.<a href="#fnref5" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn6"><p>Unless you are Thomas Lin Pedersen, but I think it is very clear that he is much taller than me.<a href="#fnref6" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn7"><p>After a <em>staggering</em> amount of work, mind you…<a href="#fnref7" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn8"><p>To be honest I am still not convinced <code>coord_polar()</code> is particularly useful for visualisation because I very rarely have anything to say that is naturally expressed as a pie chart, but it’s brilliant for generative art.<a href="#fnref8" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn9"><p>This isn’t the right place for a deep dive on <a href="https://blog.djnavarro.net/serialisation-with-rds/">serialising R objects</a>, but I’ve written about it before.<a href="#fnref9" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn10"><p>Arguments can be passed to a plumber endpoint through the query string. For instance, the URL <a href="http://donut.djnavarro.net/?seed=6">http://donut.djnavarro.net/?seed=6</a> fixes the <code>seed</code> to 6, so the output will always be the same as the red and black donut shown in the bottom right of the output above.<a href="#fnref10" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn11"><p>Here’s a blog post on the difference between <a href="https://nickjanetakis.com/blog/docker-tip-59-difference-between-exposing-and-publishing-ports">exposing and publishing ports</a> in docker if you need it!<a href="#fnref11" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn12"><p>It doesn’t have to be public: kubernetes can pull images from private registries too, but I’m not going to bother with that sort of thing here<a href="#fnref12" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn13"><p>If this were something fancier you’d probably have more than one container, but I’m keeping this as simple as possible for the sake of what’s left of my sanity.<a href="#fnref13" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn14"><p>I should mention that yes you can do all this with the <code>gcloud</code> command line tool, but I haven’t reached the point in the post where I talk about that yet, and in any case the point-and-click process is actually pretty easy.<a href="#fnref14" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn15"><p>An example would be if you plan to deploy <a href="https://spark.apache.org/">spark</a> on kubernetes. I’ve been playing around with that a little and for that you really need to have google back off and not delete nodes whenever the autopilot thinks you don’t need them. But that’s not the case for the donut app so I’m keeping it simple.<a href="#fnref15" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn16"><p>Also known as “Sydney” to those of us who live here<a href="#fnref16" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn17"><p>Too obvious.<a href="#fnref17" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn18"><p>Kubernetes supports other types of containers besides docker, but let’s not complicate matters.<a href="#fnref18" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn19"><p>The <code>-f</code> argument in <code>kubectl apply</code> here tells it to use the manifest <strong>f</strong>ile.<a href="#fnref19" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn20"><p>Which may be your thing in an appropriate mutually consensual context, but it’s not everyone’s cup of tea.<a href="#fnref20" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn21"><p>Not in the fun way.<a href="#fnref21" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn22"><p>I could go on a long ramble about all my issues with authority figures at this point, but frankly I don’t think that certification authorities are a bad thing so perhaps just this once I’ll be a good girl and use the damn service. It’s convenient and it’s useful.<a href="#fnref22" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn23"><p>lol no. This is a figure of speech. Nothing that google or any large tech company does is a kindness. It is self interest on their part, of course, but it’s convenient for my purposes here.<a href="#fnref23" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
</ol>
</section><section class="quarto-appendix-contents"><h2 class="anchored quarto-appendix-heading">Reuse</h2><div id="quarto-reuse" class="quarto-appendix-contents"><div><a rel="license" href="https://creativecommons.org/licenses/by/4.0/">https://creativecommons.org/licenses/by/4.0/</a></div></div></section><section class="quarto-appendix-contents"><h2 class="anchored quarto-appendix-heading">Citation</h2><div><div class="quarto-appendix-secondary-label">BibTeX citation:</div><pre class="sourceCode code-with-copy quarto-appendix-bibtex"><code class="sourceCode bibtex">@online{navarro2023,
  author = {Navarro, Danielle},
  title = {Deploying {R} with Kubernetes},
  date = {2023-01-10},
  url = {https://blog.djnavarro.net/posts/2023-01-10_kubernetes},
  langid = {en}
}
</code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre><div class="quarto-appendix-secondary-label">For attribution, please cite this work as:</div><div id="ref-navarro2023" class="csl-entry quarto-appendix-citeas" role="listitem">
Navarro, Danielle. 2023. <span>“Deploying R with Kubernetes.”</span>
January 10, 2023. <a href="https://blog.djnavarro.net/posts/2023-01-10_kubernetes">https://blog.djnavarro.net/posts/2023-01-10_kubernetes</a>.
</div></div></section></div></main> <!-- /main -->
<!-- plausible -->
<script async="" defer="" data-domain="blog.djnavarro.net" src="https://plausible.io/js/plausible.js"></script>
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
      &nbsp;
    </div>   
    <div class="nav-footer-center">
      <ul class="footer-items list-unstyled">
    <li class="nav-item">
    <a class="nav-link" href="https://blog.djnavarro.net">blog.djnavarro.net</a>
  </li>  
</ul>
    </div>
    <div class="nav-footer-right">
      &nbsp;
    </div>
  </div>
</footer>



</body></html>