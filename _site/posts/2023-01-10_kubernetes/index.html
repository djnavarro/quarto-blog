<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.2.280">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Danielle Navarro">
<meta name="dcterms.date" content="2023-01-10">
<meta name="description" content="In which it is painfully clear that the author is trying to figure it all out as she goes">

<title>Notes from a data witch - Deploying R with kubernetes</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1.6em;
  vertical-align: middle;
}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>
<style>
    .quarto-title-block .quarto-title-banner {
      background: #eeeeee;
    }
    </style>


<link rel="stylesheet" href="../../styles.css">
<meta property="og:title" content="Notes from a data witch - Deploying R with kubernetes">
<meta property="og:description" content="In which it is painfully clear that the author is trying to figure it all out as she goes">
<meta property="og:image" content="https://blog.djnavarro.net/posts/2023-01-10_kubernetes/donut.png">
<meta property="og:site-name" content="Notes from a data witch">
<meta property="og:image:height" content="800">
<meta property="og:image:width" content="800">
<meta name="twitter:title" content="Notes from a data witch - Deploying R with kubernetes">
<meta name="twitter:description" content="In which it is painfully clear that the author is trying to figure it all out as she goes">
<meta name="twitter:image" content="https://blog.djnavarro.net/posts/2023-01-10_kubernetes/donut.png">
<meta name="twitter:creator" content="@djnavarro">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image-height" content="800">
<meta name="twitter:image-width" content="800">
</head>

<body class="floating nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">Notes from a data witch</span>
    </a>
  </div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item compact">
    <a class="nav-link" href="https://fosstodon.org/@djnavarro"><i class="bi bi-mastodon" role="img" aria-label="mastodon">
</i> 
 <span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/djnavarro"><i class="bi bi-github" role="img" aria-label="github">
</i> 
 <span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://djnavarro.net"><i class="bi bi-person-circle" role="img" aria-label="website">
</i> 
 <span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://art.djnavarro.net"><i class="bi bi-palette-fill" role="img" aria-label="art">
</i> 
 <span class="menu-text"></span></a>
  </li>  
</ul>
              <div id="quarto-search" class="" title="Search"></div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default toc-left page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <h1 class="title">Deploying R with kubernetes</h1>
                  <div>
        <div class="description">
          In which it is painfully clear that the author is trying to figure it all out as she goes
        </div>
      </div>
                          <div class="quarto-categories">
                <div class="quarto-category">R</div>
                <div class="quarto-category">Docker</div>
                <div class="quarto-category">Kubernetes</div>
                <div class="quarto-category">plumber</div>
              </div>
                  </div>
  </div>
    
  <div class="quarto-title-meta-author">
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-heading">Affiliation</div>
    
      <div class="quarto-title-meta-contents">
      <a href="https://djnavarro.net">Danielle Navarro</a> <a href="https://orcid.org/0000-0001-7648-6578" class="quarto-title-author-orcid"> <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAA2ZpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMC1jMDYwIDYxLjEzNDc3NywgMjAxMC8wMi8xMi0xNzozMjowMCAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wTU09Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9tbS8iIHhtbG5zOnN0UmVmPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvc1R5cGUvUmVzb3VyY2VSZWYjIiB4bWxuczp4bXA9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC8iIHhtcE1NOk9yaWdpbmFsRG9jdW1lbnRJRD0ieG1wLmRpZDo1N0NEMjA4MDI1MjA2ODExOTk0QzkzNTEzRjZEQTg1NyIgeG1wTU06RG9jdW1lbnRJRD0ieG1wLmRpZDozM0NDOEJGNEZGNTcxMUUxODdBOEVCODg2RjdCQ0QwOSIgeG1wTU06SW5zdGFuY2VJRD0ieG1wLmlpZDozM0NDOEJGM0ZGNTcxMUUxODdBOEVCODg2RjdCQ0QwOSIgeG1wOkNyZWF0b3JUb29sPSJBZG9iZSBQaG90b3Nob3AgQ1M1IE1hY2ludG9zaCI+IDx4bXBNTTpEZXJpdmVkRnJvbSBzdFJlZjppbnN0YW5jZUlEPSJ4bXAuaWlkOkZDN0YxMTc0MDcyMDY4MTE5NUZFRDc5MUM2MUUwNEREIiBzdFJlZjpkb2N1bWVudElEPSJ4bXAuZGlkOjU3Q0QyMDgwMjUyMDY4MTE5OTRDOTM1MTNGNkRBODU3Ii8+IDwvcmRmOkRlc2NyaXB0aW9uPiA8L3JkZjpSREY+IDwveDp4bXBtZXRhPiA8P3hwYWNrZXQgZW5kPSJyIj8+84NovQAAAR1JREFUeNpiZEADy85ZJgCpeCB2QJM6AMQLo4yOL0AWZETSqACk1gOxAQN+cAGIA4EGPQBxmJA0nwdpjjQ8xqArmczw5tMHXAaALDgP1QMxAGqzAAPxQACqh4ER6uf5MBlkm0X4EGayMfMw/Pr7Bd2gRBZogMFBrv01hisv5jLsv9nLAPIOMnjy8RDDyYctyAbFM2EJbRQw+aAWw/LzVgx7b+cwCHKqMhjJFCBLOzAR6+lXX84xnHjYyqAo5IUizkRCwIENQQckGSDGY4TVgAPEaraQr2a4/24bSuoExcJCfAEJihXkWDj3ZAKy9EJGaEo8T0QSxkjSwORsCAuDQCD+QILmD1A9kECEZgxDaEZhICIzGcIyEyOl2RkgwAAhkmC+eAm0TAAAAABJRU5ErkJggg=="></a>
    </div>
      <div class="quarto-title-meta-contents">
          <p class="affiliation">
              <a href="https://www.youtube.com/watch?v=j58V2vC9EPc">
              I’m on smoko
              </a>
            </p>
        </div>
      </div>

  <div class="quarto-title-meta">

        
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">January 10, 2023</p>
      </div>
    </div>
    
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse sidebar-navigation floating overflow-auto">
    <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#write-the-r-code" id="toc-write-the-r-code" class="nav-link active" data-scroll-target="#write-the-r-code">Write the R code</a></li>
  <li><a href="#expose-an-api" id="toc-expose-an-api" class="nav-link" data-scroll-target="#expose-an-api">Expose an API</a></li>
  <li><a href="#containerise-it" id="toc-containerise-it" class="nav-link" data-scroll-target="#containerise-it">Containerise it</a></li>
  <li><a href="#push-it-to-the-registry" id="toc-push-it-to-the-registry" class="nav-link" data-scroll-target="#push-it-to-the-registry">Push it to the registry</a></li>
  <li><a href="#create-a-project" id="toc-create-a-project" class="nav-link" data-scroll-target="#create-a-project">Create a project</a></li>
  <li><a href="#set-up-the-tools" id="toc-set-up-the-tools" class="nav-link" data-scroll-target="#set-up-the-tools">Set up the tools!</a></li>
  <li><a href="#create-your-cluster" id="toc-create-your-cluster" class="nav-link" data-scroll-target="#create-your-cluster">Create your cluster</a></li>
  <li><a href="#create-a-deployment" id="toc-create-a-deployment" class="nav-link" data-scroll-target="#create-a-deployment">Create a deployment</a></li>
  <li><a href="#expose-the-deployment-no-https" id="toc-expose-the-deployment-no-https" class="nav-link" data-scroll-target="#expose-the-deployment-no-https">Expose the deployment (no https)</a></li>
  <li><a href="#expose-the-deployment-with-https" id="toc-expose-the-deployment-with-https" class="nav-link" data-scroll-target="#expose-the-deployment-with-https">Expose the deployment (with https)</a></li>
  <li><a href="#where-next" id="toc-where-next" class="nav-link" data-scroll-target="#where-next">Where next?</a></li>
  </ul>
</nav>
</nav>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
    </div>
<!-- main -->
<main class="content quarto-banner-title-block page-columns page-full" id="quarto-document-content">




<!--------------- my typical setup ----------------->
<!--------------- post begins here ----------------->
<blockquote class="blockquote">
<p>Me: ooh I made a Kubernetes app <br> 10yo: I made a paper dragon <br> Me: yeah… yours is cooler</p>
</blockquote>
<img width="100%" src="https://donut.djnavarro.net" title="donut.djnavarro.net">
<p><br><br></p>
<section id="write-the-r-code" class="level2">
<h2 class="anchored" data-anchor-id="write-the-r-code">Write the R code</h2>
<p>Define a function that samples a palette randomly:</p>
<div class="cell">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>server.R</strong></pre>
</div>
<div class="sourceCode cell-code" id="cb1" data-startfrom="4"><pre class="sourceCode numberSource r numberLines number-lines code-with-copy"><code class="sourceCode r" style="counter-reset: source-line 3;"><span id="cb1-4"><a href="#cb1-4"></a>sample_canva <span class="ot">&lt;-</span> <span class="cf">function</span>(<span class="at">seed =</span> <span class="cn">NULL</span>) {</span>
<span id="cb1-5"><a href="#cb1-5"></a>  <span class="cf">if</span>(<span class="sc">!</span><span class="fu">is.null</span>(seed)) <span class="fu">set.seed</span>(seed)</span>
<span id="cb1-6"><a href="#cb1-6"></a>  <span class="fu">sample</span>(ggthemes<span class="sc">::</span>canva_palettes, <span class="dv">1</span>)[[<span class="dv">1</span>]]</span>
<span id="cb1-7"><a href="#cb1-7"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<div class="cell">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>server.R</strong></pre>
</div>
<div class="sourceCode cell-code" id="cb2" data-startfrom="10"><pre class="sourceCode numberSource r numberLines number-lines code-with-copy"><code class="sourceCode r" style="counter-reset: source-line 9;"><span id="cb2-10"><a href="#cb2-10"></a>sample_data <span class="ot">&lt;-</span> <span class="cf">function</span>(<span class="at">seed =</span> <span class="cn">NULL</span>, <span class="at">n =</span> <span class="dv">100</span>){</span>
<span id="cb2-11"><a href="#cb2-11"></a>  <span class="cf">if</span>(<span class="sc">!</span><span class="fu">is.null</span>(seed)) <span class="fu">set.seed</span>(seed)</span>
<span id="cb2-12"><a href="#cb2-12"></a>  dat <span class="ot">&lt;-</span> tibble<span class="sc">::</span><span class="fu">tibble</span>(</span>
<span id="cb2-13"><a href="#cb2-13"></a>    <span class="at">x0 =</span> stats<span class="sc">::</span><span class="fu">runif</span>(n),</span>
<span id="cb2-14"><a href="#cb2-14"></a>    <span class="at">y0 =</span> stats<span class="sc">::</span><span class="fu">runif</span>(n),</span>
<span id="cb2-15"><a href="#cb2-15"></a>    <span class="at">x1 =</span> x0 <span class="sc">+</span> stats<span class="sc">::</span><span class="fu">runif</span>(n, <span class="at">min =</span> <span class="sc">-</span>.<span class="dv">2</span>, <span class="at">max =</span> .<span class="dv">2</span>),</span>
<span id="cb2-16"><a href="#cb2-16"></a>    <span class="at">y1 =</span> y0 <span class="sc">+</span> stats<span class="sc">::</span><span class="fu">runif</span>(n, <span class="at">min =</span> <span class="sc">-</span>.<span class="dv">2</span>, <span class="at">max =</span> .<span class="dv">2</span>),</span>
<span id="cb2-17"><a href="#cb2-17"></a>    <span class="at">shade =</span> stats<span class="sc">::</span><span class="fu">runif</span>(n),</span>
<span id="cb2-18"><a href="#cb2-18"></a>    <span class="at">size =</span> stats<span class="sc">::</span><span class="fu">runif</span>(n),</span>
<span id="cb2-19"><a href="#cb2-19"></a>    <span class="at">shape =</span> <span class="fu">factor</span>(<span class="fu">sample</span>(<span class="dv">0</span><span class="sc">:</span><span class="dv">22</span>, <span class="at">size =</span> n, <span class="at">replace =</span> <span class="cn">TRUE</span>))</span>
<span id="cb2-20"><a href="#cb2-20"></a>  )</span>
<span id="cb2-21"><a href="#cb2-21"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<div class="cell">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>server.R</strong></pre>
</div>
<div class="sourceCode cell-code" id="cb3" data-startfrom="24"><pre class="sourceCode numberSource r numberLines number-lines code-with-copy"><code class="sourceCode r" style="counter-reset: source-line 23;"><span id="cb3-24"><a href="#cb3-24"></a>donut_style <span class="ot">&lt;-</span> <span class="cf">function</span>(<span class="at">data =</span> <span class="cn">NULL</span>, palette) {</span>
<span id="cb3-25"><a href="#cb3-25"></a>  ggplot2<span class="sc">::</span><span class="fu">ggplot</span>(</span>
<span id="cb3-26"><a href="#cb3-26"></a>    <span class="at">data =</span> data,</span>
<span id="cb3-27"><a href="#cb3-27"></a>    <span class="at">mapping =</span> ggplot2<span class="sc">::</span><span class="fu">aes</span>(</span>
<span id="cb3-28"><a href="#cb3-28"></a>      <span class="at">x =</span> x0,</span>
<span id="cb3-29"><a href="#cb3-29"></a>      <span class="at">y =</span> y0,</span>
<span id="cb3-30"><a href="#cb3-30"></a>      <span class="at">xend =</span> x1,</span>
<span id="cb3-31"><a href="#cb3-31"></a>      <span class="at">yend =</span> y1,</span>
<span id="cb3-32"><a href="#cb3-32"></a>      <span class="at">colour =</span> shade,</span>
<span id="cb3-33"><a href="#cb3-33"></a>      <span class="at">linewidth =</span> size</span>
<span id="cb3-34"><a href="#cb3-34"></a>    )) <span class="sc">+</span></span>
<span id="cb3-35"><a href="#cb3-35"></a>    ggplot2<span class="sc">::</span><span class="fu">coord_polar</span>(<span class="at">clip =</span> <span class="st">"off"</span>) <span class="sc">+</span></span>
<span id="cb3-36"><a href="#cb3-36"></a>    ggplot2<span class="sc">::</span><span class="fu">scale_y_continuous</span>(</span>
<span id="cb3-37"><a href="#cb3-37"></a>      <span class="at">expand =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">0</span>),</span>
<span id="cb3-38"><a href="#cb3-38"></a>      <span class="at">limits =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">1</span>, <span class="dv">1</span>),</span>
<span id="cb3-39"><a href="#cb3-39"></a>      <span class="at">oob =</span> scales<span class="sc">::</span>oob_keep</span>
<span id="cb3-40"><a href="#cb3-40"></a>    ) <span class="sc">+</span></span>
<span id="cb3-41"><a href="#cb3-41"></a>    ggplot2<span class="sc">::</span><span class="fu">scale_x_continuous</span>(</span>
<span id="cb3-42"><a href="#cb3-42"></a>      <span class="at">expand =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">0</span>),</span>
<span id="cb3-43"><a href="#cb3-43"></a>      <span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>),</span>
<span id="cb3-44"><a href="#cb3-44"></a>      <span class="at">oob =</span> scales<span class="sc">::</span>oob_keep</span>
<span id="cb3-45"><a href="#cb3-45"></a>    ) <span class="sc">+</span></span>
<span id="cb3-46"><a href="#cb3-46"></a>    ggplot2<span class="sc">::</span><span class="fu">scale_colour_gradientn</span>(<span class="at">colours =</span> palette) <span class="sc">+</span></span>
<span id="cb3-47"><a href="#cb3-47"></a>    ggplot2<span class="sc">::</span><span class="fu">scale_linewidth</span>(<span class="at">range =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">6</span>)) <span class="sc">+</span></span>
<span id="cb3-48"><a href="#cb3-48"></a>    ggplot2<span class="sc">::</span><span class="fu">theme_void</span>() <span class="sc">+</span></span>
<span id="cb3-49"><a href="#cb3-49"></a>    ggplot2<span class="sc">::</span><span class="fu">theme</span>(</span>
<span id="cb3-50"><a href="#cb3-50"></a>      <span class="at">panel.background =</span> ggplot2<span class="sc">::</span><span class="fu">element_rect</span>(</span>
<span id="cb3-51"><a href="#cb3-51"></a>        <span class="at">fill =</span> palette[<span class="dv">1</span>], <span class="at">colour =</span> palette[<span class="dv">1</span>]</span>
<span id="cb3-52"><a href="#cb3-52"></a>      )</span>
<span id="cb3-53"><a href="#cb3-53"></a>    ) <span class="sc">+</span></span>
<span id="cb3-54"><a href="#cb3-54"></a>    ggplot2<span class="sc">::</span><span class="fu">guides</span>(</span>
<span id="cb3-55"><a href="#cb3-55"></a>      <span class="at">colour =</span> ggplot2<span class="sc">::</span><span class="fu">guide_none</span>(),</span>
<span id="cb3-56"><a href="#cb3-56"></a>      <span class="at">linewidth =</span> ggplot2<span class="sc">::</span><span class="fu">guide_none</span>(),</span>
<span id="cb3-57"><a href="#cb3-57"></a>      <span class="at">fill =</span> ggplot2<span class="sc">::</span><span class="fu">guide_none</span>(),</span>
<span id="cb3-58"><a href="#cb3-58"></a>      <span class="at">shape =</span> ggplot2<span class="sc">::</span><span class="fu">guide_none</span>()</span>
<span id="cb3-59"><a href="#cb3-59"></a>    )</span>
<span id="cb3-60"><a href="#cb3-60"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<div class="cell">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>server.R</strong></pre>
</div>
<div class="sourceCode cell-code" id="cb4" data-startfrom="63"><pre class="sourceCode numberSource r numberLines number-lines code-with-copy"><code class="sourceCode r" style="counter-reset: source-line 62;"><span id="cb4-63"><a href="#cb4-63"></a>donut <span class="ot">&lt;-</span> <span class="cf">function</span>(seed) {</span>
<span id="cb4-64"><a href="#cb4-64"></a></span>
<span id="cb4-65"><a href="#cb4-65"></a>  dat <span class="ot">&lt;-</span> <span class="fu">sample_data</span>(<span class="at">n =</span> <span class="dv">200</span>, <span class="at">seed =</span> seed) <span class="sc">|&gt;</span></span>
<span id="cb4-66"><a href="#cb4-66"></a>    dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">y1 =</span> y0, <span class="at">size =</span> size <span class="sc">/</span> <span class="dv">3</span>)</span>
<span id="cb4-67"><a href="#cb4-67"></a></span>
<span id="cb4-68"><a href="#cb4-68"></a>  line_spec <span class="ot">&lt;-</span> <span class="fu">sample</span>(<span class="fu">c</span>(<span class="st">"331311"</span>, <span class="st">"11"</span>, <span class="st">"111115"</span>), <span class="dv">1</span>)</span>
<span id="cb4-69"><a href="#cb4-69"></a></span>
<span id="cb4-70"><a href="#cb4-70"></a>  pic <span class="ot">&lt;-</span> <span class="fu">donut_style</span>(<span class="at">palette =</span> <span class="fu">sample_canva</span>(<span class="at">seed =</span> seed)) <span class="sc">+</span></span>
<span id="cb4-71"><a href="#cb4-71"></a>    ggplot2<span class="sc">::</span><span class="fu">geom_segment</span>(<span class="at">data =</span> dat, <span class="at">linetype =</span> line_spec)</span>
<span id="cb4-72"><a href="#cb4-72"></a></span>
<span id="cb4-73"><a href="#cb4-73"></a>  <span class="cf">if</span>(stats<span class="sc">::</span><span class="fu">runif</span>(<span class="dv">1</span>) <span class="sc">&lt;</span> .<span class="dv">5</span>) {</span>
<span id="cb4-74"><a href="#cb4-74"></a>    pic <span class="ot">&lt;-</span> pic <span class="sc">+</span></span>
<span id="cb4-75"><a href="#cb4-75"></a>      ggplot2<span class="sc">::</span><span class="fu">geom_segment</span>(</span>
<span id="cb4-76"><a href="#cb4-76"></a>        <span class="at">data =</span> dat <span class="sc">|&gt;</span> dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">y1 =</span> y1 <span class="sc">-</span> .<span class="dv">2</span>, <span class="at">y0 =</span> y0 <span class="sc">-</span> .<span class="dv">2</span>),</span>
<span id="cb4-77"><a href="#cb4-77"></a>        <span class="at">linetype =</span> line_spec</span>
<span id="cb4-78"><a href="#cb4-78"></a>      )</span>
<span id="cb4-79"><a href="#cb4-79"></a>  }</span>
<span id="cb4-80"><a href="#cb4-80"></a>  <span class="cf">if</span>(stats<span class="sc">::</span><span class="fu">runif</span>(<span class="dv">1</span>) <span class="sc">&lt;</span> .<span class="dv">5</span>) {</span>
<span id="cb4-81"><a href="#cb4-81"></a>    pic <span class="ot">&lt;-</span> pic <span class="sc">+</span></span>
<span id="cb4-82"><a href="#cb4-82"></a>      ggplot2<span class="sc">::</span><span class="fu">geom_segment</span>(</span>
<span id="cb4-83"><a href="#cb4-83"></a>        <span class="at">data =</span> dat <span class="sc">|&gt;</span> dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">y1 =</span> y1 <span class="sc">-</span> .<span class="dv">4</span>, <span class="at">y0 =</span> y0 <span class="sc">-</span> .<span class="dv">4</span>),</span>
<span id="cb4-84"><a href="#cb4-84"></a>        <span class="at">linetype =</span> line_spec</span>
<span id="cb4-85"><a href="#cb4-85"></a>      )</span>
<span id="cb4-86"><a href="#cb4-86"></a>  }</span>
<span id="cb4-87"><a href="#cb4-87"></a></span>
<span id="cb4-88"><a href="#cb4-88"></a>  pic</span>
<span id="cb4-89"><a href="#cb4-89"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</section>
<section id="expose-an-api" class="level2">
<h2 class="anchored" data-anchor-id="expose-an-api">Expose an API</h2>
<p>with plumber</p>
<div class="cell">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>server.R</strong></pre>
</div>
<div class="sourceCode cell-code" id="cb5" data-startfrom="91"><pre class="sourceCode numberSource r numberLines number-lines code-with-copy"><code class="sourceCode r" style="counter-reset: source-line 90;"><span id="cb5-91"><a href="#cb5-91"></a><span class="co">#* draws a donut plot</span></span>
<span id="cb5-92"><a href="#cb5-92"></a><span class="co">#* @serializer svg list(width = 10, height = 10)</span></span>
<span id="cb5-93"><a href="#cb5-93"></a><span class="co">#* @get /</span></span>
<span id="cb5-94"><a href="#cb5-94"></a><span class="cf">function</span>(<span class="at">seed =</span> <span class="cn">NA</span>) {</span>
<span id="cb5-95"><a href="#cb5-95"></a>  <span class="cf">if</span>(<span class="fu">is.na</span>(seed)) {</span>
<span id="cb5-96"><a href="#cb5-96"></a>    seed <span class="ot">&lt;-</span> <span class="fu">as.integer</span>(<span class="fu">Sys.time</span>())</span>
<span id="cb5-97"><a href="#cb5-97"></a>  }</span>
<span id="cb5-98"><a href="#cb5-98"></a>  <span class="fu">print</span>(<span class="fu">donut</span>(seed))</span>
<span id="cb5-99"><a href="#cb5-99"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</section>
<section id="containerise-it" class="level2 page-columns page-full">
<h2 class="anchored" data-anchor-id="containerise-it">Containerise it</h2>
<div class="column-page-right">
<div class="cell">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>Dockerfile</strong></pre>
</div>
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode numberSource dockerfile number-lines code-with-copy"><code class="sourceCode dockerfile"><span id="cb6-1"><a href="#cb6-1"></a><span class="kw">FROM</span> rocker/r-ver:4.2.2</span>
<span id="cb6-2"><a href="#cb6-2"></a></span>
<span id="cb6-3"><a href="#cb6-3"></a><span class="kw">LABEL</span> org.opencontainers.image.source <span class="st">"https://github.com/djnavarro/donut"</span></span>
<span id="cb6-4"><a href="#cb6-4"></a><span class="kw">LABEL</span> org.opencontainers.image.authors <span class="st">"Danielle Navarro &lt;djnavarro@protonmail.com&gt;"</span></span>
<span id="cb6-5"><a href="#cb6-5"></a><span class="kw">LABEL</span> org.opencontainers.image.description DESCRIPTION</span>
<span id="cb6-6"><a href="#cb6-6"></a><span class="kw">LABEL</span> org.opencontainers.image.licenses <span class="st">"MIT"</span></span>
<span id="cb6-7"><a href="#cb6-7"></a></span>
<span id="cb6-8"><a href="#cb6-8"></a><span class="kw">RUN</span> <span class="ex">Rscript</span> <span class="at">-e</span> <span class="st">'install.packages(c("ggplot2", "scales", "tibble", "dplyr", "plumber", "ggthemes"))'</span></span>
<span id="cb6-9"><a href="#cb6-9"></a><span class="kw">COPY</span> server.R /home/server.R</span>
<span id="cb6-10"><a href="#cb6-10"></a><span class="kw">EXPOSE</span> 80</span>
<span id="cb6-11"><a href="#cb6-11"></a><span class="kw">CMD</span> <span class="ex">Rscript</span> <span class="at">-e</span> <span class="st">'plumber::plumb(file="/home/server.R")$run(host="0.0.0.0", port = 80)'</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</div>
<p>https://docs.docker.com/engine/reference/builder/#expose</p>
<p>https://nickjanetakis.com/blog/docker-tip-59-difference-between-exposing-and-publishing-ports</p>
</section>
<section id="push-it-to-the-registry" class="level2 page-columns page-full">
<h2 class="anchored" data-anchor-id="push-it-to-the-registry">Push it to the registry</h2>
<p>https://github.com/djnavarro/donut/pkgs/container/donut</p>
<div class="column-page-right">
<div class="cell">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>.github/workflows/build-image.yaml</strong></pre>
</div>
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode numberSource yaml number-lines code-with-copy"><code class="sourceCode yaml"><span id="cb7-1"><a href="#cb7-1"></a><span class="fu">name</span><span class="kw">:</span><span class="at"> publish donut image</span></span>
<span id="cb7-2"><a href="#cb7-2"></a></span>
<span id="cb7-3"><a href="#cb7-3"></a><span class="fu">on</span><span class="kw">:</span></span>
<span id="cb7-4"><a href="#cb7-4"></a><span class="at">  </span><span class="fu">push</span><span class="kw">:</span></span>
<span id="cb7-5"><a href="#cb7-5"></a><span class="at">    </span><span class="fu">branches</span><span class="kw">:</span><span class="at"> </span><span class="kw">[</span><span class="st">'main'</span><span class="kw">]</span></span>
<span id="cb7-6"><a href="#cb7-6"></a></span>
<span id="cb7-7"><a href="#cb7-7"></a><span class="fu">env</span><span class="kw">:</span></span>
<span id="cb7-8"><a href="#cb7-8"></a><span class="at">  </span><span class="fu">REGISTRY</span><span class="kw">:</span><span class="at"> ghcr.io</span></span>
<span id="cb7-9"><a href="#cb7-9"></a><span class="at">  </span><span class="fu">IMAGE_NAME</span><span class="kw">:</span><span class="at"> ${{ github.repository }}</span></span>
<span id="cb7-10"><a href="#cb7-10"></a></span>
<span id="cb7-11"><a href="#cb7-11"></a><span class="fu">jobs</span><span class="kw">:</span></span>
<span id="cb7-12"><a href="#cb7-12"></a><span class="at">  </span><span class="fu">build-and-push-image</span><span class="kw">:</span></span>
<span id="cb7-13"><a href="#cb7-13"></a><span class="at">    </span><span class="fu">runs-on</span><span class="kw">:</span><span class="at"> ubuntu-latest</span></span>
<span id="cb7-14"><a href="#cb7-14"></a><span class="at">    </span><span class="fu">strategy</span><span class="kw">:</span></span>
<span id="cb7-15"><a href="#cb7-15"></a><span class="at">      </span><span class="fu">fail-fast</span><span class="kw">:</span><span class="at"> </span><span class="ch">false</span></span>
<span id="cb7-16"><a href="#cb7-16"></a><span class="at">      </span><span class="fu">matrix</span><span class="kw">:</span></span>
<span id="cb7-17"><a href="#cb7-17"></a><span class="at">        </span><span class="fu">include</span><span class="kw">:</span></span>
<span id="cb7-18"><a href="#cb7-18"></a><span class="at">          </span><span class="kw">-</span><span class="at"> </span><span class="fu">dockerfile</span><span class="kw">:</span><span class="at"> ./Dockerfile</span></span>
<span id="cb7-19"><a href="#cb7-19"></a><span class="at">            </span><span class="fu">image</span><span class="kw">:</span><span class="at"> ghcr.io/djnavarro/donut</span></span>
<span id="cb7-20"><a href="#cb7-20"></a></span>
<span id="cb7-21"><a href="#cb7-21"></a><span class="at">    </span><span class="fu">permissions</span><span class="kw">:</span></span>
<span id="cb7-22"><a href="#cb7-22"></a><span class="at">      </span><span class="fu">contents</span><span class="kw">:</span><span class="at"> read</span></span>
<span id="cb7-23"><a href="#cb7-23"></a><span class="at">      </span><span class="fu">packages</span><span class="kw">:</span><span class="at"> write</span></span>
<span id="cb7-24"><a href="#cb7-24"></a></span>
<span id="cb7-25"><a href="#cb7-25"></a><span class="at">    </span><span class="fu">steps</span><span class="kw">:</span></span>
<span id="cb7-26"><a href="#cb7-26"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> checkout repository</span></span>
<span id="cb7-27"><a href="#cb7-27"></a><span class="at">        </span><span class="fu">uses</span><span class="kw">:</span><span class="at"> actions/checkout@v2</span></span>
<span id="cb7-28"><a href="#cb7-28"></a></span>
<span id="cb7-29"><a href="#cb7-29"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> login to the container registry</span></span>
<span id="cb7-30"><a href="#cb7-30"></a><span class="at">        </span><span class="fu">uses</span><span class="kw">:</span><span class="at"> docker/login-action@f054a8b539a109f9f41c372932f1ae047eff08c9</span></span>
<span id="cb7-31"><a href="#cb7-31"></a><span class="at">        </span><span class="fu">with</span><span class="kw">:</span></span>
<span id="cb7-32"><a href="#cb7-32"></a><span class="at">          </span><span class="fu">registry</span><span class="kw">:</span><span class="at"> ${{ env.REGISTRY }}</span></span>
<span id="cb7-33"><a href="#cb7-33"></a><span class="at">          </span><span class="fu">username</span><span class="kw">:</span><span class="at"> ${{ github.actor }}</span></span>
<span id="cb7-34"><a href="#cb7-34"></a><span class="at">          </span><span class="fu">password</span><span class="kw">:</span><span class="at"> ${{ secrets.GITHUB_TOKEN }}</span></span>
<span id="cb7-35"><a href="#cb7-35"></a></span>
<span id="cb7-36"><a href="#cb7-36"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> extract metadata (tags, labels) for docker</span></span>
<span id="cb7-37"><a href="#cb7-37"></a><span class="at">        </span><span class="fu">id</span><span class="kw">:</span><span class="at"> meta</span></span>
<span id="cb7-38"><a href="#cb7-38"></a><span class="at">        </span><span class="fu">uses</span><span class="kw">:</span><span class="at"> docker/metadata-action@98669ae865ea3cffbcbaa878cf57c20bbf1c6c38</span></span>
<span id="cb7-39"><a href="#cb7-39"></a><span class="at">        </span><span class="fu">with</span><span class="kw">:</span></span>
<span id="cb7-40"><a href="#cb7-40"></a><span class="at">          </span><span class="fu">images</span><span class="kw">:</span><span class="at"> ${{ matrix.image }}</span></span>
<span id="cb7-41"><a href="#cb7-41"></a></span>
<span id="cb7-42"><a href="#cb7-42"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> build and push docker image</span></span>
<span id="cb7-43"><a href="#cb7-43"></a><span class="at">        </span><span class="fu">uses</span><span class="kw">:</span><span class="at"> docker/build-push-action@ad44023a93711e3deb337508980b4b5e9bcdc5dc</span></span>
<span id="cb7-44"><a href="#cb7-44"></a><span class="at">        </span><span class="fu">with</span><span class="kw">:</span></span>
<span id="cb7-45"><a href="#cb7-45"></a><span class="at">          </span><span class="fu">context</span><span class="kw">:</span><span class="at"> .</span></span>
<span id="cb7-46"><a href="#cb7-46"></a><span class="at">          </span><span class="fu">file</span><span class="kw">:</span><span class="at"> ${{ matrix.dockerfile }}</span></span>
<span id="cb7-47"><a href="#cb7-47"></a><span class="at">          </span><span class="fu">push</span><span class="kw">:</span><span class="at"> </span><span class="ch">true</span></span>
<span id="cb7-48"><a href="#cb7-48"></a><span class="at">          </span><span class="fu">tags</span><span class="kw">:</span><span class="at"> ${{ steps.meta.outputs.tags }}</span></span>
<span id="cb7-49"><a href="#cb7-49"></a><span class="at">          </span><span class="fu">labels</span><span class="kw">:</span><span class="at"> ${{ steps.meta.outputs.labels }}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</div>
</section>
<section id="create-a-project" class="level2">
<h2 class="anchored" data-anchor-id="create-a-project">Create a project</h2>
<p>First create a project from the console https://console.cloud.google.com/</p>
<p>Give it a fancy name like <code>donut-art</code></p>
<p>Your project will need to enable google kubernetes engine</p>
</section>
<section id="set-up-the-tools" class="level2">
<h2 class="anchored" data-anchor-id="set-up-the-tools">Set up the tools!</h2>
<p>This is a bit of a digression but I promise it’s a useful one. click on the “connect” button and it will reveal a command you can use to connect to your cluster from the command line. you can do it right away by selecting the “run in cloud shell” option: that will execute the fancy little command in a terminal that google has already configured to have the tools you need to directly interact with your kubernetes cluster. however, there’s nothing stopping you from doing it yourself from the pretty little bash terminal on your machine.</p>
<p>The tools you need to install first are gcloud (the google cloud software development kit) and kubectl (tools for interacting with kubernetes). you’ll also need the “google kubernetes engine gcloud auth plugin”:</p>
<ul>
<li>install gcloud sdk (on ubuntu: https://cloud.google.com/sdk/docs/install#deb)</li>
<li>install gke-gcloud-auth-plugin (<code>sudo apt-get install google-cloud-sdk-gke-gcloud-auth-plugin</code>)</li>
<li>install kubectl (you can install with snap or apt-get); https://kubernetes.io/docs/reference/kubectl/</li>
</ul>
<p>https://kubernetes.io/docs/reference/kubectl/</p>
<p>https://kubernetes.io/docs/tasks/tools/install-kubectl-linux/</p>
<p>Footnote: Autocompletion for kubectl https://kubernetes.io/docs/reference/kubectl/cheatsheet/ (thank you to <span class="citation" data-cites="jan">@jan</span><span class="citation" data-cites="toot.io">@toot.io</span> for the hint)</p>
<p>don’t forget:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="ex">gcloud</span> auth login</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>to authenticate</p>
</section>
<section id="create-your-cluster" class="level2">
<h2 class="anchored" data-anchor-id="create-your-cluster">Create your cluster</h2>
<p>using autopilot</p>
<p>I called mine <code>donut-cluster</code>, region <code>australia-southeast1</code></p>
<p>now connect:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="bu">export</span> <span class="va">USE_GKE_GCLOUD_AUTH_PLUGIN</span><span class="op">=</span>True</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="ex">gcloud</span> container clusters get-credentials donut-cluster <span class="dt">\</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">--zone</span> australia-southeast1 <span class="dt">\</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">--project</span> donut-art</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>check that we can connect:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="ex">kubectl</span> cluster-info</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="create-a-deployment" class="level2">
<h2 class="anchored" data-anchor-id="create-a-deployment">Create a deployment</h2>
<div class="cell">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>deployment.yaml</strong></pre>
</div>
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode numberSource yaml number-lines code-with-copy"><code class="sourceCode yaml"><span id="cb11-1"><a href="#cb11-1"></a><span class="fu">apiVersion</span><span class="kw">:</span><span class="at"> apps/v1</span></span>
<span id="cb11-2"><a href="#cb11-2"></a><span class="fu">kind</span><span class="kw">:</span><span class="at"> Deployment</span></span>
<span id="cb11-3"><a href="#cb11-3"></a><span class="fu">metadata</span><span class="kw">:</span></span>
<span id="cb11-4"><a href="#cb11-4"></a><span class="at">  </span><span class="fu">labels</span><span class="kw">:</span></span>
<span id="cb11-5"><a href="#cb11-5"></a><span class="at">    </span><span class="fu">app.kubernetes.io/name</span><span class="kw">:</span><span class="at"> donut-example</span></span>
<span id="cb11-6"><a href="#cb11-6"></a><span class="at">  </span><span class="fu">name</span><span class="kw">:</span><span class="at"> donut</span></span>
<span id="cb11-7"><a href="#cb11-7"></a><span class="fu">spec</span><span class="kw">:</span></span>
<span id="cb11-8"><a href="#cb11-8"></a><span class="at">  </span><span class="fu">replicas</span><span class="kw">:</span><span class="at"> </span><span class="dv">2</span></span>
<span id="cb11-9"><a href="#cb11-9"></a><span class="at">  </span><span class="fu">selector</span><span class="kw">:</span></span>
<span id="cb11-10"><a href="#cb11-10"></a><span class="at">    </span><span class="fu">matchLabels</span><span class="kw">:</span></span>
<span id="cb11-11"><a href="#cb11-11"></a><span class="at">      </span><span class="fu">app.kubernetes.io/name</span><span class="kw">:</span><span class="at"> donut-example</span></span>
<span id="cb11-12"><a href="#cb11-12"></a><span class="at">  </span><span class="fu">template</span><span class="kw">:</span></span>
<span id="cb11-13"><a href="#cb11-13"></a><span class="at">    </span><span class="fu">metadata</span><span class="kw">:</span></span>
<span id="cb11-14"><a href="#cb11-14"></a><span class="at">      </span><span class="fu">labels</span><span class="kw">:</span></span>
<span id="cb11-15"><a href="#cb11-15"></a><span class="at">        </span><span class="fu">app.kubernetes.io/name</span><span class="kw">:</span><span class="at"> donut-example</span></span>
<span id="cb11-16"><a href="#cb11-16"></a><span class="at">    </span><span class="fu">spec</span><span class="kw">:</span></span>
<span id="cb11-17"><a href="#cb11-17"></a><span class="at">      </span><span class="fu">containers</span><span class="kw">:</span></span>
<span id="cb11-18"><a href="#cb11-18"></a><span class="at">        </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> donut</span></span>
<span id="cb11-19"><a href="#cb11-19"></a><span class="at">          </span><span class="fu">image</span><span class="kw">:</span><span class="at"> ghcr.io/djnavarro/donut:main</span></span>
<span id="cb11-20"><a href="#cb11-20"></a><span class="at">          </span><span class="fu">imagePullPolicy</span><span class="kw">:</span><span class="at"> Always</span></span>
<span id="cb11-21"><a href="#cb11-21"></a><span class="at">          </span><span class="fu">resources</span><span class="kw">:</span></span>
<span id="cb11-22"><a href="#cb11-22"></a><span class="at">            </span><span class="fu">requests</span><span class="kw">:</span></span>
<span id="cb11-23"><a href="#cb11-23"></a><span class="at">              </span><span class="fu">memory</span><span class="kw">:</span><span class="at"> </span><span class="st">"64Mi"</span></span>
<span id="cb11-24"><a href="#cb11-24"></a><span class="at">              </span><span class="fu">cpu</span><span class="kw">:</span><span class="at"> </span><span class="st">"250m"</span></span>
<span id="cb11-25"><a href="#cb11-25"></a><span class="at">            </span><span class="fu">limits</span><span class="kw">:</span></span>
<span id="cb11-26"><a href="#cb11-26"></a><span class="at">              </span><span class="fu">memory</span><span class="kw">:</span><span class="at"> </span><span class="st">"128Mi"</span></span>
<span id="cb11-27"><a href="#cb11-27"></a><span class="at">              </span><span class="fu">cpu</span><span class="kw">:</span><span class="at"> </span><span class="st">"500m"</span></span>
<span id="cb11-28"><a href="#cb11-28"></a><span class="at">          </span><span class="fu">ports</span><span class="kw">:</span></span>
<span id="cb11-29"><a href="#cb11-29"></a><span class="at">            </span><span class="kw">-</span><span class="at"> </span><span class="fu">containerPort</span><span class="kw">:</span><span class="at"> </span><span class="dv">80</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="ex">kubectl</span> apply <span class="at">-f</span> deployment.yaml</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="ex">kubectl</span> get deployments</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>https://kubernetes.io/docs/tasks/run-application/run-stateless-application-deployment/</p>
<p>https://kubernetes.io/docs/tutorials/stateless-application/expose-external-ip-address/</p>
<p>https://kubernetes.io/docs/concepts/configuration/manage-resources-containers/</p>
</section>
<section id="expose-the-deployment-no-https" class="level2">
<h2 class="anchored" data-anchor-id="expose-the-deployment-no-https">Expose the deployment (no https)</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="ex">kubectl</span> expose deployment donut <span class="at">--type</span><span class="op">=</span>LoadBalancer <span class="at">--name</span><span class="op">=</span>donut-service</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>then over in my website create a DNS record that points donut.djnavarro.net at the IP address</p>
<p>more detail:</p>
<p>https://kubernetes.io/docs/concepts/services-networking/service/</p>
</section>
<section id="expose-the-deployment-with-https" class="level2">
<h2 class="anchored" data-anchor-id="expose-the-deployment-with-https">Expose the deployment (with https)</h2>
<p>https://cloud.google.com/kubernetes-engine/docs/how-to/managed-certs</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="ex">gcloud</span> compute addresses create donut-ip-address <span class="at">--global</span> <span class="at">--project</span> donut-art</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<pre><code>Created [https://www.googleapis.com/compute/v1/projects/donut-art/global/addresses/donut-ip-address]</code></pre>
<div class="cell">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="ex">gcloud</span> compute addresses describe donut-ip-address <span class="at">--global</span> <span class="at">--project</span> donut-art</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>This prints out the IP address and some other details.</p>
<p>Now create the managed certificate:</p>
<div class="cell">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>managed-cert.yaml</strong></pre>
</div>
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode numberSource yaml number-lines code-with-copy"><code class="sourceCode yaml"><span id="cb18-1"><a href="#cb18-1"></a><span class="fu">apiVersion</span><span class="kw">:</span><span class="at"> networking.gke.io/v1</span></span>
<span id="cb18-2"><a href="#cb18-2"></a><span class="fu">kind</span><span class="kw">:</span><span class="at"> ManagedCertificate</span></span>
<span id="cb18-3"><a href="#cb18-3"></a><span class="fu">metadata</span><span class="kw">:</span></span>
<span id="cb18-4"><a href="#cb18-4"></a><span class="at">  </span><span class="fu">name</span><span class="kw">:</span><span class="at"> managed-cert</span></span>
<span id="cb18-5"><a href="#cb18-5"></a><span class="fu">spec</span><span class="kw">:</span></span>
<span id="cb18-6"><a href="#cb18-6"></a><span class="at">  </span><span class="fu">domains</span><span class="kw">:</span></span>
<span id="cb18-7"><a href="#cb18-7"></a><span class="at">    </span><span class="kw">-</span><span class="at"> donut.djnavarro.net</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<p>Apply it to your cluster:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="ex">kubectl</span> apply <span class="at">-f</span> managed-cert.yaml</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Sometimes when they say “it might take an hour to…” it only takes like 20 seconds. Yeah nah this is one where it actually took about an hour. We’ll come back to it.</p>
<p>NodePort: https://kubernetes.io/docs/concepts/services-networking/service/</p>
<p>Important bit: notice that under <code>spec.selector</code> I’m referring to the name of my deployment (donut-example). That’s what the kubernetes docs tell you to do when setting up a NodePort service, but the help docs on the corresponding GKE page that I linked to at the start of the page are misleading: they make it look like you’re supposed to use the name of the service not the app.</p>
<p>Probably less important bit: I’m doing everything on port 80 regardless of what the GKE docs suggest because there was an issue at some point with hardcoding port 80 somewhere. Pretty certain that’s been properly resolved now but it was one of the tweaks I made on the way to figuring out the problem with spec.selector and fuck it this works so I’m not changing it</p>
<div class="cell">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>mc-service.yaml</strong></pre>
</div>
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode numberSource yaml number-lines code-with-copy"><code class="sourceCode yaml"><span id="cb20-1"><a href="#cb20-1"></a><span class="fu">apiVersion</span><span class="kw">:</span><span class="at"> v1</span></span>
<span id="cb20-2"><a href="#cb20-2"></a><span class="fu">kind</span><span class="kw">:</span><span class="at"> Service</span></span>
<span id="cb20-3"><a href="#cb20-3"></a><span class="fu">metadata</span><span class="kw">:</span></span>
<span id="cb20-4"><a href="#cb20-4"></a><span class="at">  </span><span class="fu">name</span><span class="kw">:</span><span class="at"> mc-service</span></span>
<span id="cb20-5"><a href="#cb20-5"></a><span class="fu">spec</span><span class="kw">:</span></span>
<span id="cb20-6"><a href="#cb20-6"></a><span class="at">  </span><span class="fu">selector</span><span class="kw">:</span></span>
<span id="cb20-7"><a href="#cb20-7"></a><span class="at">    </span><span class="fu">app.kubernetes.io/name</span><span class="kw">:</span><span class="at"> donut-example</span></span>
<span id="cb20-8"><a href="#cb20-8"></a><span class="at">  </span><span class="fu">type</span><span class="kw">:</span><span class="at"> NodePort</span></span>
<span id="cb20-9"><a href="#cb20-9"></a><span class="at">  </span><span class="fu">ports</span><span class="kw">:</span></span>
<span id="cb20-10"><a href="#cb20-10"></a><span class="at">    </span><span class="kw">-</span><span class="at"> </span><span class="fu">protocol</span><span class="kw">:</span><span class="at"> TCP</span></span>
<span id="cb20-11"><a href="#cb20-11"></a><span class="at">      </span><span class="fu">port</span><span class="kw">:</span><span class="at"> </span><span class="dv">80</span></span>
<span id="cb20-12"><a href="#cb20-12"></a><span class="at">      </span><span class="fu">targetPort</span><span class="kw">:</span><span class="at"> </span><span class="dv">80</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<p>Apply it to your cluster:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="ex">kubectl</span> apply <span class="at">-f</span> mc-service.yaml</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Point the DNS record to the right place then…</p>
<p>Create the ingress:</p>
<div class="cell">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>mc-ingress.yaml</strong></pre>
</div>
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode numberSource yaml number-lines code-with-copy"><code class="sourceCode yaml"><span id="cb22-1"><a href="#cb22-1"></a><span class="fu">apiVersion</span><span class="kw">:</span><span class="at"> networking.k8s.io/v1</span></span>
<span id="cb22-2"><a href="#cb22-2"></a><span class="fu">kind</span><span class="kw">:</span><span class="at"> Ingress</span></span>
<span id="cb22-3"><a href="#cb22-3"></a><span class="fu">metadata</span><span class="kw">:</span></span>
<span id="cb22-4"><a href="#cb22-4"></a><span class="at">  </span><span class="fu">name</span><span class="kw">:</span><span class="at"> mc-ingress</span></span>
<span id="cb22-5"><a href="#cb22-5"></a><span class="at">  </span><span class="fu">annotations</span><span class="kw">:</span></span>
<span id="cb22-6"><a href="#cb22-6"></a><span class="at">    </span><span class="fu">kubernetes.io/ingress.global-static-ip-name</span><span class="kw">:</span><span class="at"> donut-ip-address</span></span>
<span id="cb22-7"><a href="#cb22-7"></a><span class="at">    </span><span class="fu">networking.gke.io/managed-certificates</span><span class="kw">:</span><span class="at"> managed-cert</span></span>
<span id="cb22-8"><a href="#cb22-8"></a><span class="at">    </span><span class="fu">kubernetes.io/ingress.class</span><span class="kw">:</span><span class="at"> </span><span class="st">"gce"</span></span>
<span id="cb22-9"><a href="#cb22-9"></a><span class="fu">spec</span><span class="kw">:</span></span>
<span id="cb22-10"><a href="#cb22-10"></a><span class="at">  </span><span class="fu">defaultBackend</span><span class="kw">:</span></span>
<span id="cb22-11"><a href="#cb22-11"></a><span class="at">    </span><span class="fu">service</span><span class="kw">:</span></span>
<span id="cb22-12"><a href="#cb22-12"></a><span class="at">      </span><span class="fu">name</span><span class="kw">:</span><span class="at"> mc-service</span></span>
<span id="cb22-13"><a href="#cb22-13"></a><span class="at">      </span><span class="fu">port</span><span class="kw">:</span></span>
<span id="cb22-14"><a href="#cb22-14"></a><span class="at">        </span><span class="fu">number</span><span class="kw">:</span><span class="at"> </span><span class="dv">80</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="ex">kubectl</span> apply <span class="at">-f</span> mc-ingress.yaml </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now let’s get the results:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="ex">kubectl</span> get ingress</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<pre><code>NAME         CLASS    HOSTS   ADDRESS         PORTS   AGE
mc-ingress   &lt;none&gt;   *       34.149.195.33   80      98s</code></pre>
<p>Might have to wait a bit for provisioning to finish:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="ex">kubectl</span> describe managedcertificate managed-cert</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Relevant bit of the output once it’s all working:</p>
<pre><code>Spec:
  Domains:
    donut.djnavarro.net
Status:
  Certificate Name:    mcrt-b2204ff4-ad92-4811-a56d-f007190bb659
  Certificate Status:  Active
  Domain Status:
    Domain:     donut.djnavarro.net
    Status:     Active</code></pre>
</section>
<section id="where-next" class="level2">
<h2 class="anchored" data-anchor-id="where-next">Where next?</h2>
<ul>
<li>enabling https: https://kubernetes.io/docs/tasks/tls/managing-tls-in-a-cluster/ https://medium.com/avmconsulting-blog/how-to-secure-applications-on-kubernetes-ssl-tls-certificates-8f7f5751d788 https://snyk.io/blog/setting-up-ssl-tls-for-kubernetes-ingress/</li>
<li>storage: the app generates a new image every time it is called. that’s wasteful, especially if you’re going to reuse images. enable google cloud storage and have the plumber app check for the relevant file on gcs before trying to generate a new one https://cloud.google.com/kubernetes-engine/docs/concepts/volumes https://cloud.google.com/kubernetes-engine/docs/how-to/volumes</li>
<li>fancier things like spark-on-kubernetes already have helm charts. so you’d want to install helm and learn how to create deployments from that https://bitnami.com/stack/spark/helm</li>
</ul>
<!--------------- appendices go here ----------------->


</section>

<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents"><h2 class="anchored quarto-appendix-heading">Reuse</h2><div quarto-reuse="quarto-reuse" class="quarto-appendix-contents"><a rel="license" href="https://creativecommons.org/licenses/by/4.0/">https://creativecommons.org/licenses/by/4.0/</a></div></section><section class="quarto-appendix-contents"><h2 class="anchored quarto-appendix-heading">Citation</h2><div><div class="quarto-appendix-secondary-label">BibTeX citation:</div><pre class="sourceCode code-with-copy quarto-appendix-bibtex"><code class="sourceCode bibtex">@online{navarro2023,
  author = {Danielle Navarro},
  title = {Deploying {R} with Kubernetes},
  date = {2023-01-10},
  url = {https://blog.djnavarro.net/posts/2023-01-10_kubernetes},
  langid = {en}
}
</code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre><div class="quarto-appendix-secondary-label">For attribution, please cite this work as:</div><div id="ref-navarro2023" class="csl-entry quarto-appendix-citeas" role="doc-biblioentry">
Danielle Navarro. 2023. <span>“Deploying R with Kubernetes.”</span>
January 10, 2023. <a href="https://blog.djnavarro.net/posts/2023-01-10_kubernetes">https://blog.djnavarro.net/posts/2023-01-10_kubernetes</a>.
</div></div></section></div></main> <!-- /main -->
<!-- plausible -->
<script async="" defer="" data-domain="blog.djnavarro.net" src="https://plausible.io/js/plausible.js"></script>
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>