<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.1.149">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Danielle Navarro">
<meta name="dcterms.date" content="2022-08-28">
<meta name="description" content="A neat trick">

<title>Notes from a data witch - Passing Arrow Tables between R and Python with reticulate</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1.6em;
  vertical-align: middle;
}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>


<link rel="stylesheet" href="../../styles.css">
<meta property="og:title" content="Notes from a data witch - Passing Arrow Tables between R and Python with reticulate">
<meta property="og:description" content="A neat trick">
<meta property="og:image" content="https://blog.djnavarro.net/posts/2022-08-25_zero-copy-data-handover-in-arrow/img/cover.jpg">
<meta property="og:site-name" content="Notes from a data witch">
<meta name="twitter:title" content="Notes from a data witch - Passing Arrow Tables between R and Python with reticulate">
<meta name="twitter:description" content="A neat trick">
<meta name="twitter:image" content="https://blog.djnavarro.net/posts/2022-08-25_zero-copy-data-handover-in-arrow/img/cover.jpg">
<meta name="twitter:creator" content="@djnavarro">
<meta name="twitter:card" content="summary_large_image">
</head>

<body class="floating nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">Notes from a data witch</span>
    </a>
  </div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../about.html">Danielle Navarro</a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://twitter.com/djnavarro"><i class="bi bi-twitter" role="img" aria-label="twitter">
</i> 
 </a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/djnavarro"><i class="bi bi-github" role="img" aria-label="github">
</i> 
 </a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://djnavarro.net"><i class="bi bi-person-circle" role="img" aria-label="website">
</i> 
 </a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://art.djnavarro.net"><i class="bi bi-palette-fill" role="img" aria-label="art">
</i> 
 </a>
  </li>  
</ul>
              <div id="quarto-search" class="" title="Search"></div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default toc-left page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <h1 class="title">Passing Arrow Tables between R and Python with reticulate</h1>
                  <div>
        <div class="description">
          A neat trick
        </div>
      </div>
                          <div class="quarto-categories">
                <div class="quarto-category">Apache Arrow</div>
                <div class="quarto-category">R</div>
                <div class="quarto-category">Python</div>
              </div>
                  </div>
  </div>
    
  <div class="quarto-title-meta-author">
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-heading">Affiliation</div>
    
      <div class="quarto-title-meta-contents">
      <a href="https://djnavarro.net">Danielle Navarro</a> <a href="https://orcid.org/0000-0001-7648-6578" class="quarto-title-author-orcid"> <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAA2ZpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMC1jMDYwIDYxLjEzNDc3NywgMjAxMC8wMi8xMi0xNzozMjowMCAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wTU09Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9tbS8iIHhtbG5zOnN0UmVmPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvc1R5cGUvUmVzb3VyY2VSZWYjIiB4bWxuczp4bXA9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC8iIHhtcE1NOk9yaWdpbmFsRG9jdW1lbnRJRD0ieG1wLmRpZDo1N0NEMjA4MDI1MjA2ODExOTk0QzkzNTEzRjZEQTg1NyIgeG1wTU06RG9jdW1lbnRJRD0ieG1wLmRpZDozM0NDOEJGNEZGNTcxMUUxODdBOEVCODg2RjdCQ0QwOSIgeG1wTU06SW5zdGFuY2VJRD0ieG1wLmlpZDozM0NDOEJGM0ZGNTcxMUUxODdBOEVCODg2RjdCQ0QwOSIgeG1wOkNyZWF0b3JUb29sPSJBZG9iZSBQaG90b3Nob3AgQ1M1IE1hY2ludG9zaCI+IDx4bXBNTTpEZXJpdmVkRnJvbSBzdFJlZjppbnN0YW5jZUlEPSJ4bXAuaWlkOkZDN0YxMTc0MDcyMDY4MTE5NUZFRDc5MUM2MUUwNEREIiBzdFJlZjpkb2N1bWVudElEPSJ4bXAuZGlkOjU3Q0QyMDgwMjUyMDY4MTE5OTRDOTM1MTNGNkRBODU3Ii8+IDwvcmRmOkRlc2NyaXB0aW9uPiA8L3JkZjpSREY+IDwveDp4bXBtZXRhPiA8P3hwYWNrZXQgZW5kPSJyIj8+84NovQAAAR1JREFUeNpiZEADy85ZJgCpeCB2QJM6AMQLo4yOL0AWZETSqACk1gOxAQN+cAGIA4EGPQBxmJA0nwdpjjQ8xqArmczw5tMHXAaALDgP1QMxAGqzAAPxQACqh4ER6uf5MBlkm0X4EGayMfMw/Pr7Bd2gRBZogMFBrv01hisv5jLsv9nLAPIOMnjy8RDDyYctyAbFM2EJbRQw+aAWw/LzVgx7b+cwCHKqMhjJFCBLOzAR6+lXX84xnHjYyqAo5IUizkRCwIENQQckGSDGY4TVgAPEaraQr2a4/24bSuoExcJCfAEJihXkWDj3ZAKy9EJGaEo8T0QSxkjSwORsCAuDQCD+QILmD1A9kECEZgxDaEZhICIzGcIyEyOl2RkgwAAhkmC+eAm0TAAAAABJRU5ErkJggg=="></a>
    </div>
      <div class="quarto-title-meta-contents">
          <p class="affiliation">
              <a href="https://voltrondata.com">
              Voltron Data
              </a>
            </p>
        </div>
      </div>

  <div class="quarto-title-meta">

        
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">August 28, 2022</p>
      </div>
    </div>
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse sidebar-navigation floating overflow-auto">
    <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#data-interchange-in-a-polyglot-world" id="toc-data-interchange-in-a-polyglot-world" class="nav-link active" data-scroll-target="#data-interchange-in-a-polyglot-world">Data interchange in a polyglot world</a></li>
  <li><a href="#using-reticulate-to-call-python-from-r" id="toc-using-reticulate-to-call-python-from-r" class="nav-link" data-scroll-target="#using-reticulate-to-call-python-from-r">Using reticulate to call Python from R</a></li>
  <li><a href="#r-to-pandas" id="toc-r-to-pandas" class="nav-link" data-scroll-target="#r-to-pandas">R to Pandas</a></li>
  <li><a href="#lets-bring-apache-arrow-into-the-mix" id="toc-lets-bring-apache-arrow-into-the-mix" class="nav-link" data-scroll-target="#lets-bring-apache-arrow-into-the-mix">Let‚Äôs bring Apache Arrow into the mix</a></li>
  <li><a href="#installing-pyarrow" id="toc-installing-pyarrow" class="nav-link" data-scroll-target="#installing-pyarrow">Installing pyarrow</a></li>
  <li><a href="#passing-tables-to-python" id="toc-passing-tables-to-python" class="nav-link" data-scroll-target="#passing-tables-to-python">Passing Tables to Python</a></li>
  <li><a href="#passing-tables-back-to-r" id="toc-passing-tables-back-to-r" class="nav-link" data-scroll-target="#passing-tables-back-to-r">Passing Tables back to R</a></li>
  <li><a href="#is-there-a-more-pythonic-solution" id="toc-is-there-a-more-pythonic-solution" class="nav-link" data-scroll-target="#is-there-a-more-pythonic-solution">Is there a more pythonic solution?</a></li>
  </ul>
</nav>
</nav>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
    </div>
<!-- main -->
<main class="content quarto-banner-title-block" id="quarto-document-content">




<!-- 
cover img: https://unsplash.com/photos/k39RGHmLoV8
artist: Claudio Schwarz
licence: unsplash free-to-use 
-->
<!--------------- my typical setup ----------------->
<!-- 
the default python environment is this one:
/home/danielle/.local/share/r-miniconda/envs/r-reticulate/bin/python
--->
<p>As the 21st century gears up for its quarter-life crisis, the trend in data science is toward multi-language tools. I use <a href="https://quarto.org/">quarto</a> to write this blog, a document preparation system that supports code evaluation in R, Python, Julia, and more. My work revolves around <a href="https://arrow.apache.org/">Apache Arrow</a>, a toolbox for data analysis and interchange with implementations in multiple languages. You get the idea. In one sense this new development is fantastic ‚Äì your language of choice is much more likely to be supported in the future than it ever was in the past. In another sense it is daunting ‚Äì it sometimes feels like we need to learn <em>all the things</em> in order to get by in this brave new world. Meanwhile we all have our actual jobs to do and we don‚Äôt have the time. In the <a href="https://www.youtube.com/watch?v=1i739SyCu9I">immortal words of Bob Katter</a>,</p>
<blockquote class="blockquote">
<p>I mean, you know, people are entitled to their sexual proclivities. Let there be a thousand blossoms bloom as far as I‚Äôm concerned, you know‚Ä¶</p>
<p>&nbsp; &nbsp; &nbsp; [<em>pauses, expression turns dark</em>]</p>
<p>‚Ä¶but I ain‚Äôt spending any time on it because, in the meantime, every three months a person is torn to pieces by a crocodile in North Queensland</p>
</blockquote>
<p>I mean, he makes a good point?<a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a> There‚Äôs a lot going on in the data science world, none of us can keep pace with all of it, and we‚Äôre all trying our best not to be eaten by crocodiles.</p>
<section id="data-interchange-in-a-polyglot-world" class="level2">
<h2 class="anchored" data-anchor-id="data-interchange-in-a-polyglot-world">Data interchange in a polyglot world</h2>
<p>In the spirit of saving you from at least one reptilian threat, this post is a quick primer on how to efficiently pass control of a large data set between R and Python <em>without</em> making any wasteful copies of the data. The idea to write this post came from a <a href="https://twitter.com/mxcatnap/status/1559991199494279169">twitter thread by Cass Wilkinson Salda√±a</a>, and in particular a <a href="https://twitter.com/jonkeane/status/1560016227824721920">reply by Jon Keane</a> who mentioned that Apache Arrow provides a handy toolkit for doing this that isn‚Äôt as widely known as it perhaps deserves to be!</p>
</section>
<section id="using-reticulate-to-call-python-from-r" class="level2">
<h2 class="anchored" data-anchor-id="using-reticulate-to-call-python-from-r">Using reticulate to call Python from R</h2>
<p>The solution to the problem relies fundamentally on <a href="https://rstudio.github.io/reticulate/">the {reticulate} package</a>‚Ä¶</p>
<div class="cell">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>[R code]</strong></pre>
</div>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(reticulate)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<p>The {reticulate} package has an elaborate lookup mechanism that it uses to find a python environment. In this post and the next I want to make sure that I‚Äôm always using the <em>same</em> python environment regardless of whether my underlying quarto engine is knitr or jupyter. This is tricky because ‚Äì thanks to the nightmare that is python environment management ‚Äì I‚Äôve managed to accrue four different versions of python on my machine, and (don‚Äôt ask me how) two separate copies of miniconda!</p>
<p>Rather than mess with paths, what I‚Äôm going to do in this post is be extremely specific. I‚Äôm going to make a point of <em>always</em> telling {reticulate} where to look in order to find python and miniconda.</p>
<p>Okay, so the specific python environment I want to use is managed by miniconda, so I‚Äôm going to use the <code>use_miniconda()</code> command to tell {reticulate} to use it. To avoid all ambiguity I‚Äôm going to use the <code>condaenv</code> argument to explicitly specify the path to the python executable:</p>
<div class="cell">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>[R code]</strong></pre>
</div>
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="fu">use_miniconda</span>(</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">condaenv =</span> <span class="st">"/home/danielle/miniconda3/bin/python"</span>, </span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">required =</span> <span class="cn">TRUE</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<p>When calling python code from within R, some translation is necessary. As a simple example, let‚Äôs say I have my regular python session open and I want to check what version of python I am running and show the path to the python executable. To do this in native python code I‚Äôd use the {sys} library:</p>
<div class="cell">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>[python code]</strong></pre>
</div>
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> sys</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(sys.version)</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(sys.executable)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>3.9.12 (main, Apr  5 2022, 07:05:27) 
[GCC 7.5.0]
/home/danielle/miniconda3/bin/python</code></pre>
</div>
</div>
<p>To do this in R, the code is essentially the same except that the <code>import()</code> function supplied by {reticulate} replaces the <code>import</code> keyword, and <code>$</code> replaces <code>.</code> as the accessor:</p>
<div class="cell">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>[R code]</strong></pre>
</div>
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>sys <span class="ot">&lt;-</span> <span class="fu">import</span>(<span class="st">"sys"</span>)</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>sys<span class="sc">$</span>version</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>sys<span class="sc">$</span>executable</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "3.9.12 (main, Apr  5 2022, 07:05:27) \n[GCC 7.5.0]"
[1] "/home/danielle/miniconda3/bin/python"</code></pre>
</div>
</div>
<p>Python functions supplied through reticulate can be used in conjunction with regular R code. As a simple example, let‚Äôs say I wanted to use the <a href="https://pypi.org/project/art/">python {art} library</a> to generate text decorations. It contains a <code>decor()</code> function that creates cute glyphs like this:</p>
<div class="cell">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>[R code]</strong></pre>
</div>
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>art <span class="ot">&lt;-</span> <span class="fu">import</span>(<span class="st">"art"</span>)</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>art<span class="sc">$</span><span class="fu">decor</span>(<span class="st">"heart9"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "¬¥*‚Ä¢.¬∏(*‚Ä¢.¬∏‚ô•¬∏.‚Ä¢*¬¥)¬∏.‚Ä¢*¬¥"</code></pre>
</div>
</div>
<p>To illustrate the interoperability between R and Python, let‚Äôs say I want to create a modified version of the <code>decor()</code> function. The original <code>decor()</code> function takes a single string specifying the name of a glyph. That string could be <code>"heart9"</code>, <code>"wave3"</code>, or anything other pattern known to the <code>decor()</code> function. You can only pass one string: it does not accept vectors. What I‚Äôd like to do in a modified version is pass a numeric vector as input, and receive a vector of heart glyphs as output. Although the original <code>decor()</code> function is written in Python, I can do this entirely on the R side: I don‚Äôt have to write any Python code.</p>
<div class="cell">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>[R code]</strong></pre>
</div>
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>decor_heart <span class="ot">&lt;-</span> <span class="cf">function</span>(x) {</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>  purrr<span class="sc">::</span><span class="fu">map_chr</span>(x, <span class="sc">~</span> art<span class="sc">$</span><span class="fu">decor</span>(<span class="fu">paste0</span>(<span class="st">"heart"</span>, .x)))</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a><span class="fu">decor_heart</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">9</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "~~&lt;üíö&gt;~~"               "~~&gt;&lt;~~&gt;üíñ"              "‚îÄ‚ïê⁄ø⁄ø€£⁄ø‚ïê‚îÄüíñ‚îÄ‚ïê⁄ø⁄ø€£⁄ø‚ïê‚îÄ"      
[4] "‡º∫‚ô•‡ºª‚ùÄ‡º∫‚ô•‡ºªüíïÔªø"              "üíóüíú.¬∏¬∏.‚Ä¢¬¥¬Ø`‚òÜ¬∫‡Æá‚Ä¢¬¥‚ô•"     "-‚ô•-‚ô°--^["              
[7] "*‚Ä¢.¬∏‚ô°"                  "‚ïö¬ª‚ô°¬´‚ïù"                  "¬¥*‚Ä¢.¬∏(*‚Ä¢.¬∏‚ô•¬∏.‚Ä¢*¬¥)¬∏.‚Ä¢*¬¥"</code></pre>
</div>
</div>
<p>Prettiness! üòç</p>
</section>
<section id="r-to-pandas" class="level2">
<h2 class="anchored" data-anchor-id="r-to-pandas">R to Pandas</h2>
<p>Okay, now that we understand the basics of {reticulate}, let‚Äôs move on to the task of transferring data between R and Python.</p>
<div class="cell">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>[R code]</strong></pre>
</div>
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>py_iris <span class="ot">&lt;-</span> <span class="fu">r_to_py</span>(iris)</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>py_iris</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>     Sepal.Length  Sepal.Width  Petal.Length  Petal.Width    Species
0             5.1          3.5           1.4          0.2     setosa
1             4.9          3.0           1.4          0.2     setosa
2             4.7          3.2           1.3          0.2     setosa
3             4.6          3.1           1.5          0.2     setosa
4             5.0          3.6           1.4          0.2     setosa
..            ...          ...           ...          ...        ...
145           6.7          3.0           5.2          2.3  virginica
146           6.3          2.5           5.0          1.9  virginica
147           6.5          3.0           5.2          2.0  virginica
148           6.2          3.4           5.4          2.3  virginica
149           5.9          3.0           5.1          1.8  virginica

[150 rows x 5 columns]</code></pre>
</div>
</div>
<p>https://pandas.pydata.org/</p>
<p>Within the Python session, an object called <code>r</code> has been created: the Pandas DataFrame object is stored as <code>r.py_iris</code></p>
<div class="cell">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>[python code]</strong></pre>
</div>
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>iris_means <span class="op">=</span> r.py_iris.groupby(<span class="st">"Species"</span>).mean()</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>iris_means</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>            Sepal.Length  Sepal.Width  Petal.Length  Petal.Width
Species                                                         
setosa             5.006        3.428         1.462        0.246
versicolor         5.936        2.770         4.260        1.326
virginica          6.588        2.974         5.552        2.026</code></pre>
</div>
</div>
<p>As you might hope, this data is accessible from the R session. {reticulate} exposes an object named <code>py</code> to the user, and ‚Äì surprise, surprise ‚Äì objects created in the Python session can be accessed using that object‚Ä¶</p>
<div class="cell">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>[R code]</strong></pre>
</div>
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>py<span class="sc">$</span>iris_means</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>  Sepal.Length Sepal.Width Petal.Length Petal.Width
1        5.006       3.428        1.462       0.246
2        5.936       2.770        4.260       1.326
3        6.588       2.974        5.552       2.026</code></pre>
</div>
</div>
<p>‚Ä¶and by the magic of {reticulate} the Pandas DataFrame is magically interpreted as an R data frame.</p>
</section>
<section id="lets-bring-apache-arrow-into-the-mix" class="level2">
<h2 class="anchored" data-anchor-id="lets-bring-apache-arrow-into-the-mix">Let‚Äôs bring Apache Arrow into the mix</h2>
<p>So here‚Äôs the thing about magic, at least when it comes to code. There comes a point where you need to modify the spell. The example in the previous section looks smooth and seamless because the data set is small. However, it is fundamentally inefficient for the simple reason that a Pandas DataFrame looks different in memory to an R data frame. It‚Äôs not possible for the two languages to share a single copy of the data because they don‚Äôt agree on what ‚Äúthe data‚Äù are. To handover data from R to Python (or vice versa) it is necessary to copy the data set and convert it to a more appropriate format.</p>
<p>When the data set is small, this is not a problem. But as your data set grows, it becomes ever more burdensome. These copy-and-convert operations are not cheap.</p>
<p>Wouldn‚Äôt it be nice if R and Python could both agree to represent the data as, oh let‚Äôs say‚Ä¶. an Arrow Table? On the R side we could interact with it using the {arrow} package, and on the Python side we could interact with it using {pyarrow}. But regardless of which language we‚Äôre using, the thing in memory would be <em>exactly</em> the same‚Ä¶ handing over the data set from one language to the other would no longer require any copying. A little metadata would change hands, and that‚Äôs all.</p>
<p>That sounds much nicer.</p>
</section>
<section id="installing-pyarrow" class="level2">
<h2 class="anchored" data-anchor-id="installing-pyarrow">Installing pyarrow</h2>
<p>So let‚Äôs do this.</p>
<p>In the previous example, the R data frame was handled on the Python side by the Pandas module. And as a consequence, you‚Äôd imagine that it was pretty important that my Python environment has Pandas installed right? Well, the same is true when passing an Arrow Table: you need to have {pyarrow} installed on the Python side as well as {arrow} installed on the R side.</p>
<p>As a convenience, the {arrow} package supplies a helper function called <code>install_pyarrow()</code> that calls the relevant {reticulate} functions for you, but for the purposes of this post I‚Äôll show you the {reticulate} functions. The python environment I‚Äôm using in this post is managed by miniconda, so I‚Äôll use <code>conda_install()</code> to do the work:</p>
<div class="cell">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>[R code]</strong></pre>
</div>
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="fu">conda_install</span>(</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">packages =</span> <span class="st">"pyarrow"</span>, </span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">envname =</span> <span class="st">"/home/danielle/miniconda3"</span>, </span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">conda =</span> <span class="st">"/home/danielle/miniconda3/bin/conda"</span></span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<p>In this code, <code>packages</code> is the name of the to-be-installed python module, <code>envname</code> is the path to the conda environment, and <code>conda</code> is the path to the conda executable. As a general rule you don‚Äôt need to be this explicit: {reticulate} will find the environment and conda executable for you. I‚Äôm being unusually particular in this post, for reasons that will be a little more obvious in the next post.</p>
<p>Next let‚Äôs import {pyarrow} and check the version:</p>
<div class="cell">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>[python code]</strong></pre>
</div>
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pyarrow</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>pyarrow.__version__</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>'8.0.0'</code></pre>
</div>
</div>
<p>Because life on linux is dark and full of terrors, this didn‚Äôt actually work for me the first time I tried it and naturally I was filled with despair. Instead of the nice output above, I got an error saying:</p>
<pre><code>libstdc++.so.6: version `GLIBCXX_3.4.22' not found</code></pre>
<p>As usual, googling the error message led me to discover I needed to update the relevant library. It turned out to be an easy fix with this command:</p>
<div class="cell">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>[at the terminal]</strong></pre>
</div>
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> apt-get update</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> apt-get install libstdc++6</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</section>
<section id="passing-tables-to-python" class="level2">
<h2 class="anchored" data-anchor-id="passing-tables-to-python">Passing Tables to Python</h2>
<div class="cell">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>[R code]</strong></pre>
</div>
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="co"># R</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>arr <span class="ot">&lt;-</span> arrow<span class="sc">::</span><span class="fu">arrow_table</span>(iris)</span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>arr</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Table
150 rows x 5 columns
$Sepal.Length &lt;double&gt;
$Sepal.Width &lt;double&gt;
$Petal.Length &lt;double&gt;
$Petal.Width &lt;double&gt;
$Species &lt;dictionary&lt;values=string, indices=int8&gt;&gt;

See $metadata for additional Schema metadata</code></pre>
</div>
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>py_arr <span class="ot">&lt;-</span> reticulate<span class="sc">::</span><span class="fu">r_to_py</span>(arr)</span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>py_arr</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>pyarrow.Table
Sepal.Length: double
Sepal.Width: double
Petal.Length: double
Petal.Width: double
Species: dictionary&lt;values=string, indices=int8, ordered=0&gt;
----
Sepal.Length: [[5.1,4.9,4.7,4.6,5,...,6.7,6.3,6.5,6.2,5.9]]
Sepal.Width: [[3.5,3,3.2,3.1,3.6,...,3,2.5,3,3.4,3]]
Petal.Length: [[1.4,1.4,1.3,1.5,1.4,...,5.2,5,5.2,5.4,5.1]]
Petal.Width: [[0.2,0.2,0.2,0.2,0.2,...,2.3,1.9,2,2.3,1.8]]
Species: [  -- dictionary:
["setosa","versicolor","virginica"]  -- indices:
[0,0,0,0,0,...,2,2,2,2,2]]</code></pre>
</div>
</div>
<div class="cell">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>[python code]</strong></pre>
</div>
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="co"># python</span></span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>r.py_arr</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>pyarrow.Table
Sepal.Length: double
Sepal.Width: double
Petal.Length: double
Petal.Width: double
Species: dictionary&lt;values=string, indices=int8, ordered=0&gt;
----
Sepal.Length: [[5.1,4.9,4.7,4.6,5,...,6.7,6.3,6.5,6.2,5.9]]
Sepal.Width: [[3.5,3,3.2,3.1,3.6,...,3,2.5,3,3.4,3]]
Petal.Length: [[1.4,1.4,1.3,1.5,1.4,...,5.2,5,5.2,5.4,5.1]]
Petal.Width: [[0.2,0.2,0.2,0.2,0.2,...,2.3,1.9,2,2.3,1.8]]
Species: [  -- dictionary:
["setosa","versicolor","virginica"]  -- indices:
[0,0,0,0,0,...,2,2,2,2,2]]</code></pre>
</div>
</div>
</section>
<section id="passing-tables-back-to-r" class="level2">
<h2 class="anchored" data-anchor-id="passing-tables-back-to-r">Passing Tables back to R</h2>
<div class="cell">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>[python code]</strong></pre>
</div>
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>boring <span class="op">=</span> pyarrow.array([<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">3</span>])</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>boring</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;pyarrow.lib.Int64Array object at 0x7f2c2fb11d60&gt;
[
  1,
  2,
  3
]</code></pre>
</div>
</div>
<div class="cell">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>[R code]</strong></pre>
</div>
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>reticulate<span class="sc">::</span>py<span class="sc">$</span>boring</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Array
&lt;int64&gt;
[
  1,
  2,
  3
]</code></pre>
</div>
</div>
</section>
<section id="is-there-a-more-pythonic-solution" class="level2">
<h2 class="anchored" data-anchor-id="is-there-a-more-pythonic-solution">Is there a more pythonic solution?</h2>
<p>One thing you‚Äôll notice about the framing throughout this post is that</p>
<p><br><br></p>
<!--------------- appendices go here ----------------->
<div class="cell">

</div>


</section>


<div id="quarto-appendix" class="default"><section id="footnotes" class="footnotes footnotes-end-of-document" role="doc-endnotes"><h2 class="anchored quarto-appendix-heading">Footnotes</h2>

<ol>
<li id="fn1"><p>A good point about data science, that is. I‚Äôm not convinced it was a stellar contribution to the discussion of LGBT rights in the antipodes. Although frankly it wasn‚Äôt the worst comment on same sex marriage I saw an Australian politician make at the time, not by a loooooong margin.<a href="#fnref1" class="footnote-back" role="doc-backlink">‚Ü©Ô∏é</a></p></li>
</ol>
</section><section class="quarto-appendix-contents"><h2 class="anchored quarto-appendix-heading">Reuse</h2><div quarto-reuse="quarto-reuse" class="quarto-appendix-contents"><a rel="license" href="https://creativecommons.org/licenses/by/4.0/">https://creativecommons.org/licenses/by/4.0/</a></div></section><section class="quarto-appendix-contents"><h2 class="anchored quarto-appendix-heading">Citation</h2><div><div class="quarto-appendix-secondary-label">BibTeX citation:</div><pre class="sourceCode code-with-copy quarto-appendix-bibtex"><code class="sourceCode bibtex">@online{navarro2022,
  author = {Danielle Navarro},
  editor = {},
  title = {Passing {Arrow} {Tables} Between {R} and {Python} with
    Reticulate},
  date = {2022-08-28},
  url = {https://blog.djnavarro.net/posts/2022-08-25_zero-copy-data-handover-in-arrow},
  langid = {en}
}
</code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre><div class="quarto-appendix-secondary-label">For attribution, please cite this work as:</div><div id="ref-navarro2022" class="csl-entry quarto-appendix-citeas" role="doc-biblioentry">
Danielle Navarro. 2022. <span>‚ÄúPassing Arrow Tables Between R and Python
with Reticulate.‚Äù</span> August 28, 2022. <a href="https://blog.djnavarro.net/posts/2022-08-25_zero-copy-data-handover-in-arrow">https://blog.djnavarro.net/posts/2022-08-25_zero-copy-data-handover-in-arrow</a>.
</div></div></section></div></main> <!-- /main -->
<!-- plausible -->
<script async="" defer="" data-domain="blog.djnavarro.net" src="https://plausible.io/js/plausible.js"></script>
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "Óßã";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    setTimeout(function() {
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const cites = ref.parentNode.getAttribute('data-cites').split(' ');
    tippyHover(ref, function() {
      var popup = window.document.createElement('div');
      cites.forEach(function(cite) {
        var citeDiv = window.document.createElement('div');
        citeDiv.classList.add('hanging-indent');
        citeDiv.classList.add('csl-entry');
        var biblioDiv = window.document.getElementById('ref-' + cite);
        if (biblioDiv) {
          citeDiv.innerHTML = biblioDiv.innerHTML;
        }
        popup.appendChild(citeDiv);
      });
      return popup.innerHTML;
    });
  }
});
</script>
</div> <!-- /content -->



</body></html>