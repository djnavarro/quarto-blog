<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.2.280">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Danielle Navarro">
<meta name="dcterms.date" content="2022-12-22">
<meta name="description" content="Something something something">

<title>Notes from a data witch - Queue</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1.6em;
  vertical-align: middle;
}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>
<style>
    .quarto-title-block .quarto-title-banner {
      background: #eeeeee;
    }
    </style>


<link rel="stylesheet" href="../../styles.css">
<meta property="og:title" content="Notes from a data witch - Queue">
<meta property="og:description" content="Something something something">
<meta property="og:image" content="">
<meta property="og:site-name" content="Notes from a data witch">
<meta name="twitter:title" content="Notes from a data witch - Queue">
<meta name="twitter:description" content="Something something something">
<meta name="twitter:image" content="">
<meta name="twitter:creator" content="@djnavarro">
<meta name="twitter:card" content="summary_large_image">
</head>

<body class="floating nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">Notes from a data witch</span>
    </a>
  </div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../about.html">
 <span class="menu-text">Danielle Navarro</span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://fosstodon.org/@djnavarro"><i class="bi bi-mastodon" role="img" aria-label="mastodon">
</i> 
 <span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/djnavarro"><i class="bi bi-github" role="img" aria-label="github">
</i> 
 <span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://djnavarro.net"><i class="bi bi-person-circle" role="img" aria-label="website">
</i> 
 <span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://art.djnavarro.net"><i class="bi bi-palette-fill" role="img" aria-label="art">
</i> 
 <span class="menu-text"></span></a>
  </li>  
</ul>
              <div id="quarto-search" class="" title="Search"></div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default toc-left page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <h1 class="title">Queue</h1>
                  <div>
        <div class="description">
          Something something something
        </div>
      </div>
                          <div class="quarto-categories">
                <div class="quarto-category">Parallel Computing</div>
                <div class="quarto-category">R</div>
                <div class="quarto-category">Object-Oriented Programming</div>
              </div>
                  </div>
  </div>
    
  <div class="quarto-title-meta-author">
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-heading">Affiliation</div>
    
      <div class="quarto-title-meta-contents">
      <a href="https://djnavarro.net">Danielle Navarro</a> <a href="https://orcid.org/0000-0001-7648-6578" class="quarto-title-author-orcid"> <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAA2ZpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMC1jMDYwIDYxLjEzNDc3NywgMjAxMC8wMi8xMi0xNzozMjowMCAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wTU09Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9tbS8iIHhtbG5zOnN0UmVmPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvc1R5cGUvUmVzb3VyY2VSZWYjIiB4bWxuczp4bXA9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC8iIHhtcE1NOk9yaWdpbmFsRG9jdW1lbnRJRD0ieG1wLmRpZDo1N0NEMjA4MDI1MjA2ODExOTk0QzkzNTEzRjZEQTg1NyIgeG1wTU06RG9jdW1lbnRJRD0ieG1wLmRpZDozM0NDOEJGNEZGNTcxMUUxODdBOEVCODg2RjdCQ0QwOSIgeG1wTU06SW5zdGFuY2VJRD0ieG1wLmlpZDozM0NDOEJGM0ZGNTcxMUUxODdBOEVCODg2RjdCQ0QwOSIgeG1wOkNyZWF0b3JUb29sPSJBZG9iZSBQaG90b3Nob3AgQ1M1IE1hY2ludG9zaCI+IDx4bXBNTTpEZXJpdmVkRnJvbSBzdFJlZjppbnN0YW5jZUlEPSJ4bXAuaWlkOkZDN0YxMTc0MDcyMDY4MTE5NUZFRDc5MUM2MUUwNEREIiBzdFJlZjpkb2N1bWVudElEPSJ4bXAuZGlkOjU3Q0QyMDgwMjUyMDY4MTE5OTRDOTM1MTNGNkRBODU3Ii8+IDwvcmRmOkRlc2NyaXB0aW9uPiA8L3JkZjpSREY+IDwveDp4bXBtZXRhPiA8P3hwYWNrZXQgZW5kPSJyIj8+84NovQAAAR1JREFUeNpiZEADy85ZJgCpeCB2QJM6AMQLo4yOL0AWZETSqACk1gOxAQN+cAGIA4EGPQBxmJA0nwdpjjQ8xqArmczw5tMHXAaALDgP1QMxAGqzAAPxQACqh4ER6uf5MBlkm0X4EGayMfMw/Pr7Bd2gRBZogMFBrv01hisv5jLsv9nLAPIOMnjy8RDDyYctyAbFM2EJbRQw+aAWw/LzVgx7b+cwCHKqMhjJFCBLOzAR6+lXX84xnHjYyqAo5IUizkRCwIENQQckGSDGY4TVgAPEaraQr2a4/24bSuoExcJCfAEJihXkWDj3ZAKy9EJGaEo8T0QSxkjSwORsCAuDQCD+QILmD1A9kECEZgxDaEZhICIzGcIyEyOl2RkgwAAhkmC+eAm0TAAAAABJRU5ErkJggg=="></a>
    </div>
      <div class="quarto-title-meta-contents">
          <p class="affiliation">
              <a href="https://www.youtube.com/watch?v=j58V2vC9EPc">
              I’m on smoko
              </a>
            </p>
        </div>
      </div>

  <div class="quarto-title-meta">

        
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">December 22, 2022</p>
      </div>
    </div>
    
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse sidebar-navigation floating overflow-auto">
    <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#what-does-it-do-and-why" id="toc-what-does-it-do-and-why" class="nav-link active" data-scroll-target="#what-does-it-do-and-why">What does it do, and why?</a></li>
  <li><a href="#what-does-it-store" id="toc-what-does-it-store" class="nav-link" data-scroll-target="#what-does-it-store">What does it store?</a></li>
  <li><a href="#surviving-a-crash" id="toc-surviving-a-crash" class="nav-link" data-scroll-target="#surviving-a-crash">Surviving a crash</a></li>
  </ul>
</nav>
</nav>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
    </div>
<!-- main -->
<main class="content quarto-banner-title-block page-columns page-full" id="quarto-document-content">




<!--------------- my typical setup ----------------->
<!--------------- post begins here ----------------->
<p>Okay. So I wrote a simple package for <a href="https://queue.djnavarro.net">multi-threaded tasks queues in R</a> this week. It wasn’t intentional, I swear. I was just trying to teach myself how to use the <a href="https://callr.r-lib.org/">callr</a> package, and making sure I had a solid grasp of encapsulated object-oriented programming with <a href="https://r6.r-lib.org/">R6</a>. Things got a little out of hand. Sorry.</p>
<p>And let’s be very clear about something at the outset. If you want to do parallel computing in R correctly, you go look at <a href="https://www.futureverse.org/">futureverse.org</a>. The <a href="https://future.futureverse.org/">future</a> package provides a fabulous way to execute R code asynchronously and in parallel. And there are many excellent packages built on top of that, so there’s a whole lovely ecosystem there just waiting for you.<a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a> Relatedly, if the reason you’re thinking about parallel computing is that you’ve found yourself with a burning need to analyze terabytes of data with R then babe it might be time to start learning some R workflows using <a href="https://therinspark.com/">Spark</a>, <a href="https://blog.djnavarro.net/category/apachearrow">Arrow</a>, <a href="https://www.r-bloggers.com/2022/04/wtf-is-kubernetes-and-should-i-care-as-r-user/">Kubernetes</a>. It may be time to learn about some of those other eldritch words of power that have figured rather more prominently in my life than one might expect for a simple country girl.<a href="#fn2" class="footnote-ref" id="fnref2" role="doc-noteref"><sup>2</sup></a></p>
<p>My little queue package is a personal project. I happen to like it, but you should not be looking at it as an alternative to serious tools.</p>
<p>That’s been said now. Good. We can put aside all pretension.</p>
<section id="what-does-it-do-and-why" class="level2 page-columns page-full">
<h2 class="anchored" data-anchor-id="what-does-it-do-and-why">What does it do, and why?</h2>
<p>Let’s say I have a generative art function called <code>donut()</code>, based loosely on a <a href="https://art-from-code.netlify.app/day-1/session-1/#composition">teaching example from my art from code workshop</a>. The <code>donut()</code> function takes an input <code>seed</code>, creates a piece of generative art using ggplot2, and writes the output to an image file. This process takes several seconds to complete on my laptop:</p>
<div class="cell" data-hash="index_cache/html/my-first-donut_78cc3a9337022adc6a85a72fd51f194e">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tictoc)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">tic</span>()</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">donut</span>(<span class="at">seed =</span> <span class="dv">100</span>)</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="fu">toc</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>8.524 sec elapsed</code></pre>
</div>
</div>
<p>Here’s the piece, by the way:</p>
<p><img src="donut_100.png" class="img-fluid"></p>
<p>That’s nice and I do like this piece, but generative art is an iterative process and I like to make many pieces at once to help me get a feel for the statistical properties of the system. Waiting 8.5 seconds for one piece to render is one thing: waiting 15 minutes for 100 pieces to render is quite another. So it’s helpful if I can do this in parallel.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(queue)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Here’s how I might do that with queue:</p>
<div class="cell" data-hash="index_cache/html/my-first-queue_51d6e56fc7fadd364fa03a6a5df69f41">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>q1 <span class="ot">&lt;-</span> Queue<span class="sc">$</span><span class="fu">new</span>(<span class="at">workers =</span> <span class="dv">6</span>)</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(seed <span class="cf">in</span> <span class="dv">101</span><span class="sc">:</span><span class="dv">108</span>) q1<span class="sc">$</span><span class="fu">add</span>(donut, <span class="fu">list</span>(seed))</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>out1 <span class="ot">&lt;-</span> q1<span class="sc">$</span><span class="fu">run</span>(<span class="at">message =</span> <span class="st">"verbose"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>→ Done: task_4 finished in 4.26 secs</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>→ Done: task_1 finished in 5.28 secs</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>→ Done: task_5 finished in 6.37 secs</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>→ Done: task_3 finished in 7.28 secs</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>→ Done: task_2 finished in 7.44 secs</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>→ Done: task_6 finished in 8.11 secs</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>→ Done: task_7 finished in 6.19 secs</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>→ Done: task_8 finished in 5.58 secs</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>✔ Queue complete: 8 tasks done in 10.9 secs</code></pre>
</div>
</div>
<p>It doesn’t run six times faster. There’s overhead: R sessions have to be initialised, the scheduler needs to assign the tasks, data have to be serialised and passed between R sessions and so on. Perhaps most importantly, my little laptop doesn’t really have six cores to spare. There’s reason why the sixth worker took 20 seconds to finish – the operating system didn’t have any spare resources to allocate.</p>
<div class="column-screen-inset">
<div class="quarto-layout-panel">
<div class="quarto-layout-row quarto-layout-valign-top">
<div class="quarto-layout-cell" style="flex-basis: 25.0%;justify-content: center;">
<p><img src="donut_101.png" class="img-fluid"></p>
</div>
<div class="quarto-layout-cell" style="flex-basis: 25.0%;justify-content: center;">
<p><img src="donut_102.png" class="img-fluid"></p>
</div>
<div class="quarto-layout-cell" style="flex-basis: 25.0%;justify-content: center;">
<p><img src="donut_103.png" class="img-fluid"></p>
</div>
<div class="quarto-layout-cell" style="flex-basis: 25.0%;justify-content: center;">
<p><img src="donut_104.png" class="img-fluid"></p>
</div>
</div>
<div class="quarto-layout-row quarto-layout-valign-top">
<div class="quarto-layout-cell" style="flex-basis: 25.0%;justify-content: center;">
<p><img src="donut_105.png" class="img-fluid"></p>
</div>
<div class="quarto-layout-cell" style="flex-basis: 25.0%;justify-content: center;">
<p><img src="donut_106.png" class="img-fluid"></p>
</div>
<div class="quarto-layout-cell" style="flex-basis: 25.0%;justify-content: center;">
<p><img src="donut_107.png" class="img-fluid"></p>
</div>
<div class="quarto-layout-cell" style="flex-basis: 25.0%;justify-content: center;">
<p><img src="donut_108.png" class="img-fluid"></p>
</div>
</div>
</div>
</div>
<p>For comparison, let’s make another eight pieces, this time with only three workers:</p>
<div class="cell" data-hash="index_cache/html/my-second-queue_7060f58bf9582296917f2558a0d7aa36">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>q2 <span class="ot">&lt;-</span> Queue<span class="sc">$</span><span class="fu">new</span>(<span class="at">workers =</span> <span class="dv">3</span>)</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(seed <span class="cf">in</span> <span class="dv">109</span><span class="sc">:</span><span class="dv">116</span>) q2<span class="sc">$</span><span class="fu">add</span>(donut, <span class="fu">list</span>(seed))</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>out2 <span class="ot">&lt;-</span> q2<span class="sc">$</span><span class="fu">run</span>(<span class="at">message =</span> <span class="st">"verbose"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>→ Done: task_1 finished in 10.7 secs</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>→ Done: task_2 finished in 10.8 secs</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>→ Done: task_3 finished in 11.4 secs</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>→ Done: task_4 finished in 4.92 secs</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>→ Done: task_5 finished in 4.8 secs</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>→ Done: task_6 finished in 9.06 secs</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>→ Done: task_7 finished in 9 secs</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>→ Done: task_8 finished in 10.8 secs</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>✔ Queue complete: 8 tasks done in 26.4 secs</code></pre>
</div>
</div>
<p>The completion time is essentially the same. Ultimately, whenever you’re using multithreading as your mechanism for parallel computing, you’re relying on the operating system to do the work for you. The queue package doesn’t do any clever scheduling. All it does is set the R process running and polls them intermittently to see if they’ve finished their assigned tasks. The operating system tasks care of low level details. If you create 100 workers but your machine only has 3 cores free, well, the operating system isn’t a magic wand. It can’t make computing resources appear if they don’t exist.</p>
<p>By default, queue sets the concurrency to 4 workers, on the – thorougly unscientific – logic that this usually speeds things up on my laptop without being absurd, and pushing any higher than that rarely does anything useful.</p>
<div class="column-screen-inset">
<div class="quarto-layout-panel">
<div class="quarto-layout-row quarto-layout-valign-top">
<div class="quarto-layout-cell" style="flex-basis: 25.0%;justify-content: center;">
<p><img src="donut_109.png" class="img-fluid"></p>
</div>
<div class="quarto-layout-cell" style="flex-basis: 25.0%;justify-content: center;">
<p><img src="donut_110.png" class="img-fluid"></p>
</div>
<div class="quarto-layout-cell" style="flex-basis: 25.0%;justify-content: center;">
<p><img src="donut_111.png" class="img-fluid"></p>
</div>
<div class="quarto-layout-cell" style="flex-basis: 25.0%;justify-content: center;">
<p><img src="donut_112.png" class="img-fluid"></p>
</div>
</div>
<div class="quarto-layout-row quarto-layout-valign-top">
<div class="quarto-layout-cell" style="flex-basis: 25.0%;justify-content: center;">
<p><img src="donut_113.png" class="img-fluid"></p>
</div>
<div class="quarto-layout-cell" style="flex-basis: 25.0%;justify-content: center;">
<p><img src="donut_114.png" class="img-fluid"></p>
</div>
<div class="quarto-layout-cell" style="flex-basis: 25.0%;justify-content: center;">
<p><img src="donut_115.png" class="img-fluid"></p>
</div>
<div class="quarto-layout-cell" style="flex-basis: 25.0%;justify-content: center;">
<p><img src="donut_116.png" class="img-fluid"></p>
</div>
</div>
</div>
</div>
</section>
<section id="what-does-it-store" class="level2 page-columns page-full">
<h2 class="anchored" data-anchor-id="what-does-it-store">What does it store?</h2>
<p>Okay, so let’s take a look at what it actually stores</p>
<div class="cell column-page">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>out1</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  task_id worker_id state        result       runtime
1  task_1    555843  done donut_101.png 5.282254 secs
2  task_2    555855  done donut_102.png 7.442093 secs
3  task_3    555867  done donut_103.png 7.276114 secs
4  task_4    555879  done donut_104.png 4.259732 secs
5  task_5    555892  done donut_105.png 6.365720 secs
6  task_6    555904  done donut_106.png 8.114676 secs
7  task_7    555879  done donut_107.png 6.190101 secs
8  task_8    555843  done donut_108.png 5.578790 secs
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   fun
1 function (seed, filename = paste0("donut_", seed, ".png"), width = 2000, ,     height = 2000, dpi = 300, units = "px", ...) , {,     sample_canva &lt;- function(seed = NULL) {,         if (!is.null(seed)) ,             set.seed(seed),         sample(ggthemes::canva_palettes, 1)[[1]],     },     sample_data &lt;- function(seed = NULL, n = 100) {,         if (!is.null(seed)) ,             set.seed(seed),         dat &lt;- tibble::tibble(x0 = stats::runif(n), y0 = stats::runif(n), ,             x1 = x0 + stats::runif(n, min = -0.2, max = 0.2), ,             y1 = y0 + stats::runif(n, min = -0.2, max = 0.2), ,             shade = stats::runif(n), size = stats::runif(n), ,             shape = factor(sample(0:22, size = n, replace = TRUE))),     },     donut_style &lt;- function(data = NULL, palette) {,         ggplot2::ggplot(data = data, mapping = ggplot2::aes(x = x0, ,             y = y0, xend = x1, yend = y1, colour = shade, linewidth = size)) + ,             ggplot2::coord_polar(clip = "off") + ggplot2::scale_y_continuous(expand = c(0, ,             0), limits = c(-1, 1), oob = scales::oob_keep) + ,             ggplot2::scale_x_continuous(expand = c(0, 0), limits = c(0, ,                 1), oob = scales::oob_keep) + ggplot2::scale_colour_gradientn(colours = palette) + ,             ggplot2::scale_linewidth(range = c(0, 4)) + ggplot2::theme_void() + ,             ggplot2::theme(panel.background = ggplot2::element_rect(fill = palette[1], ,                 colour = palette[1])) + ggplot2::guides(colour = ggplot2::guide_none(), ,             linewidth = ggplot2::guide_none(), fill = ggplot2::guide_none(), ,             shape = ggplot2::guide_none()),     },     dat &lt;- dplyr::mutate(sample_data(n = 10000, seed = seed), ,         y1 = y0, size = size/4),     line_spec &lt;- sample(c("331311", "11", "111115"), 1),     pic &lt;- donut_style(palette = sample_canva(seed = seed)) + ,         ggplot2::geom_segment(data = dat, linetype = line_spec),     if (stats::runif(1) &lt; 0.5) {,         pic &lt;- pic + ggplot2::geom_segment(data = dplyr::mutate(dat, ,             y1 = y1 - 0.2, y0 = y0 - 0.2), linetype = line_spec),     },     if (stats::runif(1) &lt; 0.5) {,         pic &lt;- pic + ggplot2::geom_segment(data = dplyr::mutate(dat, ,             y1 = y1 - 0.4, y0 = y0 - 0.4), linetype = line_spec),     },     ggplot2::ggsave(filename = filename, plot = pic, width = width, ,         height = height, dpi = dpi, units = units, ...), }
2 function (seed, filename = paste0("donut_", seed, ".png"), width = 2000, ,     height = 2000, dpi = 300, units = "px", ...) , {,     sample_canva &lt;- function(seed = NULL) {,         if (!is.null(seed)) ,             set.seed(seed),         sample(ggthemes::canva_palettes, 1)[[1]],     },     sample_data &lt;- function(seed = NULL, n = 100) {,         if (!is.null(seed)) ,             set.seed(seed),         dat &lt;- tibble::tibble(x0 = stats::runif(n), y0 = stats::runif(n), ,             x1 = x0 + stats::runif(n, min = -0.2, max = 0.2), ,             y1 = y0 + stats::runif(n, min = -0.2, max = 0.2), ,             shade = stats::runif(n), size = stats::runif(n), ,             shape = factor(sample(0:22, size = n, replace = TRUE))),     },     donut_style &lt;- function(data = NULL, palette) {,         ggplot2::ggplot(data = data, mapping = ggplot2::aes(x = x0, ,             y = y0, xend = x1, yend = y1, colour = shade, linewidth = size)) + ,             ggplot2::coord_polar(clip = "off") + ggplot2::scale_y_continuous(expand = c(0, ,             0), limits = c(-1, 1), oob = scales::oob_keep) + ,             ggplot2::scale_x_continuous(expand = c(0, 0), limits = c(0, ,                 1), oob = scales::oob_keep) + ggplot2::scale_colour_gradientn(colours = palette) + ,             ggplot2::scale_linewidth(range = c(0, 4)) + ggplot2::theme_void() + ,             ggplot2::theme(panel.background = ggplot2::element_rect(fill = palette[1], ,                 colour = palette[1])) + ggplot2::guides(colour = ggplot2::guide_none(), ,             linewidth = ggplot2::guide_none(), fill = ggplot2::guide_none(), ,             shape = ggplot2::guide_none()),     },     dat &lt;- dplyr::mutate(sample_data(n = 10000, seed = seed), ,         y1 = y0, size = size/4),     line_spec &lt;- sample(c("331311", "11", "111115"), 1),     pic &lt;- donut_style(palette = sample_canva(seed = seed)) + ,         ggplot2::geom_segment(data = dat, linetype = line_spec),     if (stats::runif(1) &lt; 0.5) {,         pic &lt;- pic + ggplot2::geom_segment(data = dplyr::mutate(dat, ,             y1 = y1 - 0.2, y0 = y0 - 0.2), linetype = line_spec),     },     if (stats::runif(1) &lt; 0.5) {,         pic &lt;- pic + ggplot2::geom_segment(data = dplyr::mutate(dat, ,             y1 = y1 - 0.4, y0 = y0 - 0.4), linetype = line_spec),     },     ggplot2::ggsave(filename = filename, plot = pic, width = width, ,         height = height, dpi = dpi, units = units, ...), }
3 function (seed, filename = paste0("donut_", seed, ".png"), width = 2000, ,     height = 2000, dpi = 300, units = "px", ...) , {,     sample_canva &lt;- function(seed = NULL) {,         if (!is.null(seed)) ,             set.seed(seed),         sample(ggthemes::canva_palettes, 1)[[1]],     },     sample_data &lt;- function(seed = NULL, n = 100) {,         if (!is.null(seed)) ,             set.seed(seed),         dat &lt;- tibble::tibble(x0 = stats::runif(n), y0 = stats::runif(n), ,             x1 = x0 + stats::runif(n, min = -0.2, max = 0.2), ,             y1 = y0 + stats::runif(n, min = -0.2, max = 0.2), ,             shade = stats::runif(n), size = stats::runif(n), ,             shape = factor(sample(0:22, size = n, replace = TRUE))),     },     donut_style &lt;- function(data = NULL, palette) {,         ggplot2::ggplot(data = data, mapping = ggplot2::aes(x = x0, ,             y = y0, xend = x1, yend = y1, colour = shade, linewidth = size)) + ,             ggplot2::coord_polar(clip = "off") + ggplot2::scale_y_continuous(expand = c(0, ,             0), limits = c(-1, 1), oob = scales::oob_keep) + ,             ggplot2::scale_x_continuous(expand = c(0, 0), limits = c(0, ,                 1), oob = scales::oob_keep) + ggplot2::scale_colour_gradientn(colours = palette) + ,             ggplot2::scale_linewidth(range = c(0, 4)) + ggplot2::theme_void() + ,             ggplot2::theme(panel.background = ggplot2::element_rect(fill = palette[1], ,                 colour = palette[1])) + ggplot2::guides(colour = ggplot2::guide_none(), ,             linewidth = ggplot2::guide_none(), fill = ggplot2::guide_none(), ,             shape = ggplot2::guide_none()),     },     dat &lt;- dplyr::mutate(sample_data(n = 10000, seed = seed), ,         y1 = y0, size = size/4),     line_spec &lt;- sample(c("331311", "11", "111115"), 1),     pic &lt;- donut_style(palette = sample_canva(seed = seed)) + ,         ggplot2::geom_segment(data = dat, linetype = line_spec),     if (stats::runif(1) &lt; 0.5) {,         pic &lt;- pic + ggplot2::geom_segment(data = dplyr::mutate(dat, ,             y1 = y1 - 0.2, y0 = y0 - 0.2), linetype = line_spec),     },     if (stats::runif(1) &lt; 0.5) {,         pic &lt;- pic + ggplot2::geom_segment(data = dplyr::mutate(dat, ,             y1 = y1 - 0.4, y0 = y0 - 0.4), linetype = line_spec),     },     ggplot2::ggsave(filename = filename, plot = pic, width = width, ,         height = height, dpi = dpi, units = units, ...), }
4 function (seed, filename = paste0("donut_", seed, ".png"), width = 2000, ,     height = 2000, dpi = 300, units = "px", ...) , {,     sample_canva &lt;- function(seed = NULL) {,         if (!is.null(seed)) ,             set.seed(seed),         sample(ggthemes::canva_palettes, 1)[[1]],     },     sample_data &lt;- function(seed = NULL, n = 100) {,         if (!is.null(seed)) ,             set.seed(seed),         dat &lt;- tibble::tibble(x0 = stats::runif(n), y0 = stats::runif(n), ,             x1 = x0 + stats::runif(n, min = -0.2, max = 0.2), ,             y1 = y0 + stats::runif(n, min = -0.2, max = 0.2), ,             shade = stats::runif(n), size = stats::runif(n), ,             shape = factor(sample(0:22, size = n, replace = TRUE))),     },     donut_style &lt;- function(data = NULL, palette) {,         ggplot2::ggplot(data = data, mapping = ggplot2::aes(x = x0, ,             y = y0, xend = x1, yend = y1, colour = shade, linewidth = size)) + ,             ggplot2::coord_polar(clip = "off") + ggplot2::scale_y_continuous(expand = c(0, ,             0), limits = c(-1, 1), oob = scales::oob_keep) + ,             ggplot2::scale_x_continuous(expand = c(0, 0), limits = c(0, ,                 1), oob = scales::oob_keep) + ggplot2::scale_colour_gradientn(colours = palette) + ,             ggplot2::scale_linewidth(range = c(0, 4)) + ggplot2::theme_void() + ,             ggplot2::theme(panel.background = ggplot2::element_rect(fill = palette[1], ,                 colour = palette[1])) + ggplot2::guides(colour = ggplot2::guide_none(), ,             linewidth = ggplot2::guide_none(), fill = ggplot2::guide_none(), ,             shape = ggplot2::guide_none()),     },     dat &lt;- dplyr::mutate(sample_data(n = 10000, seed = seed), ,         y1 = y0, size = size/4),     line_spec &lt;- sample(c("331311", "11", "111115"), 1),     pic &lt;- donut_style(palette = sample_canva(seed = seed)) + ,         ggplot2::geom_segment(data = dat, linetype = line_spec),     if (stats::runif(1) &lt; 0.5) {,         pic &lt;- pic + ggplot2::geom_segment(data = dplyr::mutate(dat, ,             y1 = y1 - 0.2, y0 = y0 - 0.2), linetype = line_spec),     },     if (stats::runif(1) &lt; 0.5) {,         pic &lt;- pic + ggplot2::geom_segment(data = dplyr::mutate(dat, ,             y1 = y1 - 0.4, y0 = y0 - 0.4), linetype = line_spec),     },     ggplot2::ggsave(filename = filename, plot = pic, width = width, ,         height = height, dpi = dpi, units = units, ...), }
5 function (seed, filename = paste0("donut_", seed, ".png"), width = 2000, ,     height = 2000, dpi = 300, units = "px", ...) , {,     sample_canva &lt;- function(seed = NULL) {,         if (!is.null(seed)) ,             set.seed(seed),         sample(ggthemes::canva_palettes, 1)[[1]],     },     sample_data &lt;- function(seed = NULL, n = 100) {,         if (!is.null(seed)) ,             set.seed(seed),         dat &lt;- tibble::tibble(x0 = stats::runif(n), y0 = stats::runif(n), ,             x1 = x0 + stats::runif(n, min = -0.2, max = 0.2), ,             y1 = y0 + stats::runif(n, min = -0.2, max = 0.2), ,             shade = stats::runif(n), size = stats::runif(n), ,             shape = factor(sample(0:22, size = n, replace = TRUE))),     },     donut_style &lt;- function(data = NULL, palette) {,         ggplot2::ggplot(data = data, mapping = ggplot2::aes(x = x0, ,             y = y0, xend = x1, yend = y1, colour = shade, linewidth = size)) + ,             ggplot2::coord_polar(clip = "off") + ggplot2::scale_y_continuous(expand = c(0, ,             0), limits = c(-1, 1), oob = scales::oob_keep) + ,             ggplot2::scale_x_continuous(expand = c(0, 0), limits = c(0, ,                 1), oob = scales::oob_keep) + ggplot2::scale_colour_gradientn(colours = palette) + ,             ggplot2::scale_linewidth(range = c(0, 4)) + ggplot2::theme_void() + ,             ggplot2::theme(panel.background = ggplot2::element_rect(fill = palette[1], ,                 colour = palette[1])) + ggplot2::guides(colour = ggplot2::guide_none(), ,             linewidth = ggplot2::guide_none(), fill = ggplot2::guide_none(), ,             shape = ggplot2::guide_none()),     },     dat &lt;- dplyr::mutate(sample_data(n = 10000, seed = seed), ,         y1 = y0, size = size/4),     line_spec &lt;- sample(c("331311", "11", "111115"), 1),     pic &lt;- donut_style(palette = sample_canva(seed = seed)) + ,         ggplot2::geom_segment(data = dat, linetype = line_spec),     if (stats::runif(1) &lt; 0.5) {,         pic &lt;- pic + ggplot2::geom_segment(data = dplyr::mutate(dat, ,             y1 = y1 - 0.2, y0 = y0 - 0.2), linetype = line_spec),     },     if (stats::runif(1) &lt; 0.5) {,         pic &lt;- pic + ggplot2::geom_segment(data = dplyr::mutate(dat, ,             y1 = y1 - 0.4, y0 = y0 - 0.4), linetype = line_spec),     },     ggplot2::ggsave(filename = filename, plot = pic, width = width, ,         height = height, dpi = dpi, units = units, ...), }
6 function (seed, filename = paste0("donut_", seed, ".png"), width = 2000, ,     height = 2000, dpi = 300, units = "px", ...) , {,     sample_canva &lt;- function(seed = NULL) {,         if (!is.null(seed)) ,             set.seed(seed),         sample(ggthemes::canva_palettes, 1)[[1]],     },     sample_data &lt;- function(seed = NULL, n = 100) {,         if (!is.null(seed)) ,             set.seed(seed),         dat &lt;- tibble::tibble(x0 = stats::runif(n), y0 = stats::runif(n), ,             x1 = x0 + stats::runif(n, min = -0.2, max = 0.2), ,             y1 = y0 + stats::runif(n, min = -0.2, max = 0.2), ,             shade = stats::runif(n), size = stats::runif(n), ,             shape = factor(sample(0:22, size = n, replace = TRUE))),     },     donut_style &lt;- function(data = NULL, palette) {,         ggplot2::ggplot(data = data, mapping = ggplot2::aes(x = x0, ,             y = y0, xend = x1, yend = y1, colour = shade, linewidth = size)) + ,             ggplot2::coord_polar(clip = "off") + ggplot2::scale_y_continuous(expand = c(0, ,             0), limits = c(-1, 1), oob = scales::oob_keep) + ,             ggplot2::scale_x_continuous(expand = c(0, 0), limits = c(0, ,                 1), oob = scales::oob_keep) + ggplot2::scale_colour_gradientn(colours = palette) + ,             ggplot2::scale_linewidth(range = c(0, 4)) + ggplot2::theme_void() + ,             ggplot2::theme(panel.background = ggplot2::element_rect(fill = palette[1], ,                 colour = palette[1])) + ggplot2::guides(colour = ggplot2::guide_none(), ,             linewidth = ggplot2::guide_none(), fill = ggplot2::guide_none(), ,             shape = ggplot2::guide_none()),     },     dat &lt;- dplyr::mutate(sample_data(n = 10000, seed = seed), ,         y1 = y0, size = size/4),     line_spec &lt;- sample(c("331311", "11", "111115"), 1),     pic &lt;- donut_style(palette = sample_canva(seed = seed)) + ,         ggplot2::geom_segment(data = dat, linetype = line_spec),     if (stats::runif(1) &lt; 0.5) {,         pic &lt;- pic + ggplot2::geom_segment(data = dplyr::mutate(dat, ,             y1 = y1 - 0.2, y0 = y0 - 0.2), linetype = line_spec),     },     if (stats::runif(1) &lt; 0.5) {,         pic &lt;- pic + ggplot2::geom_segment(data = dplyr::mutate(dat, ,             y1 = y1 - 0.4, y0 = y0 - 0.4), linetype = line_spec),     },     ggplot2::ggsave(filename = filename, plot = pic, width = width, ,         height = height, dpi = dpi, units = units, ...), }
7 function (seed, filename = paste0("donut_", seed, ".png"), width = 2000, ,     height = 2000, dpi = 300, units = "px", ...) , {,     sample_canva &lt;- function(seed = NULL) {,         if (!is.null(seed)) ,             set.seed(seed),         sample(ggthemes::canva_palettes, 1)[[1]],     },     sample_data &lt;- function(seed = NULL, n = 100) {,         if (!is.null(seed)) ,             set.seed(seed),         dat &lt;- tibble::tibble(x0 = stats::runif(n), y0 = stats::runif(n), ,             x1 = x0 + stats::runif(n, min = -0.2, max = 0.2), ,             y1 = y0 + stats::runif(n, min = -0.2, max = 0.2), ,             shade = stats::runif(n), size = stats::runif(n), ,             shape = factor(sample(0:22, size = n, replace = TRUE))),     },     donut_style &lt;- function(data = NULL, palette) {,         ggplot2::ggplot(data = data, mapping = ggplot2::aes(x = x0, ,             y = y0, xend = x1, yend = y1, colour = shade, linewidth = size)) + ,             ggplot2::coord_polar(clip = "off") + ggplot2::scale_y_continuous(expand = c(0, ,             0), limits = c(-1, 1), oob = scales::oob_keep) + ,             ggplot2::scale_x_continuous(expand = c(0, 0), limits = c(0, ,                 1), oob = scales::oob_keep) + ggplot2::scale_colour_gradientn(colours = palette) + ,             ggplot2::scale_linewidth(range = c(0, 4)) + ggplot2::theme_void() + ,             ggplot2::theme(panel.background = ggplot2::element_rect(fill = palette[1], ,                 colour = palette[1])) + ggplot2::guides(colour = ggplot2::guide_none(), ,             linewidth = ggplot2::guide_none(), fill = ggplot2::guide_none(), ,             shape = ggplot2::guide_none()),     },     dat &lt;- dplyr::mutate(sample_data(n = 10000, seed = seed), ,         y1 = y0, size = size/4),     line_spec &lt;- sample(c("331311", "11", "111115"), 1),     pic &lt;- donut_style(palette = sample_canva(seed = seed)) + ,         ggplot2::geom_segment(data = dat, linetype = line_spec),     if (stats::runif(1) &lt; 0.5) {,         pic &lt;- pic + ggplot2::geom_segment(data = dplyr::mutate(dat, ,             y1 = y1 - 0.2, y0 = y0 - 0.2), linetype = line_spec),     },     if (stats::runif(1) &lt; 0.5) {,         pic &lt;- pic + ggplot2::geom_segment(data = dplyr::mutate(dat, ,             y1 = y1 - 0.4, y0 = y0 - 0.4), linetype = line_spec),     },     ggplot2::ggsave(filename = filename, plot = pic, width = width, ,         height = height, dpi = dpi, units = units, ...), }
8 function (seed, filename = paste0("donut_", seed, ".png"), width = 2000, ,     height = 2000, dpi = 300, units = "px", ...) , {,     sample_canva &lt;- function(seed = NULL) {,         if (!is.null(seed)) ,             set.seed(seed),         sample(ggthemes::canva_palettes, 1)[[1]],     },     sample_data &lt;- function(seed = NULL, n = 100) {,         if (!is.null(seed)) ,             set.seed(seed),         dat &lt;- tibble::tibble(x0 = stats::runif(n), y0 = stats::runif(n), ,             x1 = x0 + stats::runif(n, min = -0.2, max = 0.2), ,             y1 = y0 + stats::runif(n, min = -0.2, max = 0.2), ,             shade = stats::runif(n), size = stats::runif(n), ,             shape = factor(sample(0:22, size = n, replace = TRUE))),     },     donut_style &lt;- function(data = NULL, palette) {,         ggplot2::ggplot(data = data, mapping = ggplot2::aes(x = x0, ,             y = y0, xend = x1, yend = y1, colour = shade, linewidth = size)) + ,             ggplot2::coord_polar(clip = "off") + ggplot2::scale_y_continuous(expand = c(0, ,             0), limits = c(-1, 1), oob = scales::oob_keep) + ,             ggplot2::scale_x_continuous(expand = c(0, 0), limits = c(0, ,                 1), oob = scales::oob_keep) + ggplot2::scale_colour_gradientn(colours = palette) + ,             ggplot2::scale_linewidth(range = c(0, 4)) + ggplot2::theme_void() + ,             ggplot2::theme(panel.background = ggplot2::element_rect(fill = palette[1], ,                 colour = palette[1])) + ggplot2::guides(colour = ggplot2::guide_none(), ,             linewidth = ggplot2::guide_none(), fill = ggplot2::guide_none(), ,             shape = ggplot2::guide_none()),     },     dat &lt;- dplyr::mutate(sample_data(n = 10000, seed = seed), ,         y1 = y0, size = size/4),     line_spec &lt;- sample(c("331311", "11", "111115"), 1),     pic &lt;- donut_style(palette = sample_canva(seed = seed)) + ,         ggplot2::geom_segment(data = dat, linetype = line_spec),     if (stats::runif(1) &lt; 0.5) {,         pic &lt;- pic + ggplot2::geom_segment(data = dplyr::mutate(dat, ,             y1 = y1 - 0.2, y0 = y0 - 0.2), linetype = line_spec),     },     if (stats::runif(1) &lt; 0.5) {,         pic &lt;- pic + ggplot2::geom_segment(data = dplyr::mutate(dat, ,             y1 = y1 - 0.4, y0 = y0 - 0.4), linetype = line_spec),     },     ggplot2::ggsave(filename = filename, plot = pic, width = width, ,         height = height, dpi = dpi, units = units, ...), }
  args             created              queued            assigned             started            finished code
1  101 2022-12-23 10:39:33 2022-12-23 10:39:33 2022-12-23 10:39:33 2022-12-23 10:39:33 2022-12-23 10:39:38  200
2  102 2022-12-23 10:39:33 2022-12-23 10:39:33 2022-12-23 10:39:33 2022-12-23 10:39:33 2022-12-23 10:39:41  200
3  103 2022-12-23 10:39:33 2022-12-23 10:39:33 2022-12-23 10:39:33 2022-12-23 10:39:33 2022-12-23 10:39:40  200
4  104 2022-12-23 10:39:33 2022-12-23 10:39:33 2022-12-23 10:39:33 2022-12-23 10:39:33 2022-12-23 10:39:37  200
5  105 2022-12-23 10:39:33 2022-12-23 10:39:33 2022-12-23 10:39:33 2022-12-23 10:39:33 2022-12-23 10:39:39  200
6  106 2022-12-23 10:39:33 2022-12-23 10:39:33 2022-12-23 10:39:33 2022-12-23 10:39:33 2022-12-23 10:39:41  200
7  107 2022-12-23 10:39:33 2022-12-23 10:39:33 2022-12-23 10:39:37 2022-12-23 10:39:37 2022-12-23 10:39:44  200
8  108 2022-12-23 10:39:33 2022-12-23 10:39:33 2022-12-23 10:39:38 2022-12-23 10:39:38 2022-12-23 10:39:44  200
                             message stdout stderr error
1 done callr-rs-result-87aeb5146b87f                NULL
2  done callr-rs-result-87aebe2a6bca                NULL
3 done callr-rs-result-87aeb360ce35f                NULL
4 done callr-rs-result-87aeb362a486c                NULL
5 done callr-rs-result-87aeb1135ee5f                NULL
6 done callr-rs-result-87aeb3774510b                NULL
7 done callr-rs-result-87aeb3f296b7c                NULL
8 done callr-rs-result-87aeb614b634c                NULL</code></pre>
</div>
</div>
</section>
<section id="surviving-a-crash" class="level2">
<h2 class="anchored" data-anchor-id="surviving-a-crash">Surviving a crash</h2>
<p>I’m going to be honest. Sometimes<a href="#fn3" class="footnote-ref" id="fnref3" role="doc-noteref"><sup>3</sup></a> I write bad code when I am exploring a new generative art system. Code that crashes the R session unpredictably. So it would be nice if the queue had a little bit of robustness for that. To be honest, the queue package isn’t very sophisticated in detecting sessions that have crashed,<a href="#fn4" class="footnote-ref" id="fnref4" role="doc-noteref"><sup>4</sup></a> but it does have some ability to recover when a task crashes its thread. Let’s keep this simple. I’ll define a perfectly safe function that waits for a moment and then returns, and another function that always crashes the R session as soon as it is called:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>wait <span class="ot">&lt;-</span> <span class="cf">function</span>(x) {</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">Sys.sleep</span>(x)</span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>  x</span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a>crash <span class="ot">&lt;-</span> <span class="cf">function</span>(x) <span class="fu">.Call</span>(<span class="st">"abort"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now let’s define a queue that has only two workers, but has no less than three tasks that are guaranteed to crash the worker the moment the tasks are started:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>queue <span class="ot">&lt;-</span> Queue<span class="sc">$</span><span class="fu">new</span>(<span class="at">workers =</span> <span class="dv">2</span>)</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>queue<span class="sc">$</span><span class="fu">add</span>(wait, <span class="fu">list</span>(<span class="at">x =</span> .<span class="dv">1</span>))</span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>queue<span class="sc">$</span><span class="fu">add</span>(crash)</span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>queue<span class="sc">$</span><span class="fu">add</span>(crash)</span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a>queue<span class="sc">$</span><span class="fu">add</span>(crash)</span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a>queue<span class="sc">$</span><span class="fu">add</span>(wait, <span class="fu">list</span>(<span class="at">x =</span> .<span class="dv">1</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The queue allocates task in a first-in first-out order, so the three “crash tasks” are guaranteed to be allocated before the final “wait task”. Let’s take a look at what happens when the queue runs:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>queue<span class="sc">$</span><span class="fu">run</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>✔ Queue complete: 5 tasks done in 0.727 secs</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 5 × 17
  task_id worker_id state result    runtime        fun    args            
  &lt;chr&gt;       &lt;int&gt; &lt;chr&gt; &lt;list&gt;    &lt;drtn&gt;         &lt;list&gt; &lt;list&gt;          
1 task_1     558929 done  &lt;dbl [1]&gt; 0.1243110 secs &lt;fn&gt;   &lt;named list [1]&gt;
2 task_2     558941 done  &lt;NULL&gt;    0.1252213 secs &lt;fn&gt;   &lt;list [0]&gt;      
3 task_3     558929 done  &lt;NULL&gt;    0.1040988 secs &lt;fn&gt;   &lt;list [0]&gt;      
4 task_4     558968 done  &lt;NULL&gt;    0.1041272 secs &lt;fn&gt;   &lt;list [0]&gt;      
5 task_5     558982 done  &lt;dbl [1]&gt; 0.1575069 secs &lt;fn&gt;   &lt;named list [1]&gt;
# … with 10 more variables: created &lt;dttm&gt;, queued &lt;dttm&gt;, assigned &lt;dttm&gt;,
#   started &lt;dttm&gt;, finished &lt;dttm&gt;, code &lt;dbl&gt;, message &lt;chr&gt;,
#   stdout &lt;list&gt;, stderr &lt;list&gt;, error &lt;list&gt;</code></pre>
</div>
</div>
<p>It’s a little slower than we’d hope, but it does finish both valid tasks and returns nothing for the tasks that crashed their R sessions. What has happened in the background is that the queue runs a simple check to see if any of the R sessions have crashed, and attempts to replace them with a new worker whenever it detects that this has happened. It’s not in any sense optimised, but it does sort of work.</p>
<!--------------- appendices go here ----------------->


</section>


<div id="quarto-appendix" class="default"><section id="footnotes" class="footnotes footnotes-end-of-document" role="doc-endnotes"><h2 class="anchored quarto-appendix-heading">Footnotes</h2>

<ol>
<li id="fn1"><p>Note to self: Learn <a href="https://www.jottr.org/2022/12/05/avoid-detectcores/">parallelly</a><a href="#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn2"><p><code>kubectl auth can-i create occult-chaos</code><a href="#fnref2" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn3"><p>Often<a href="#fnref3" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn4"><p>I mean, it was just a fun side project I did over the weekend because I found myself unexpectedly unemployed all of a sudden and Stella needs to get her groove back okay?<a href="#fnref4" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
</ol>
</section><section class="quarto-appendix-contents"><h2 class="anchored quarto-appendix-heading">Reuse</h2><div quarto-reuse="quarto-reuse" class="quarto-appendix-contents"><a rel="license" href="https://creativecommons.org/licenses/by/4.0/">https://creativecommons.org/licenses/by/4.0/</a></div></section><section class="quarto-appendix-contents"><h2 class="anchored quarto-appendix-heading">Citation</h2><div><div class="quarto-appendix-secondary-label">BibTeX citation:</div><pre class="sourceCode code-with-copy quarto-appendix-bibtex"><code class="sourceCode bibtex">@online{navarro2022,
  author = {Danielle Navarro},
  title = {Queue},
  date = {2022-12-22},
  url = {https://blog.djnavarro.net/posts/2022-12-22_queue},
  langid = {en}
}
</code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre><div class="quarto-appendix-secondary-label">For attribution, please cite this work as:</div><div id="ref-navarro2022" class="csl-entry quarto-appendix-citeas" role="doc-biblioentry">
Danielle Navarro. 2022. <span>“Queue.”</span> December 22, 2022. <a href="https://blog.djnavarro.net/posts/2022-12-22_queue">https://blog.djnavarro.net/posts/2022-12-22_queue</a>.
</div></div></section></div></main> <!-- /main -->
<!-- plausible -->
<script async="" defer="" data-domain="blog.djnavarro.net" src="https://plausible.io/js/plausible.js"></script>
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>