---
title: "Deploying R with kubernetes"
author:
  - name: Danielle Navarro
    url: https://djnavarro.net
    affiliation: I'm on smoko
    affiliation-url: https://www.youtube.com/watch?v=j58V2vC9EPc
    orcid: 0000-0001-7648-6578
description: "In which it is painfully clear that the author is trying to figure it all out as she goes"
date: "2023-01-10"
categories: [R, Docker, Kubernetes, plumber]
image: "donut.png"
---

<!--------------- my typical setup ----------------->

```{r setup, include=FALSE}
set.seed(8)
long_slug <- "2023-01-10_kubernetes"
#renv::use(lockfile = "renv.lock")
wide <- 136
narrow <- 76
options(width = narrow)
```

<!--------------- post begins here ----------------->

## Write the R code



## Wrap the R code in a plumber api

## Containerise it

## Push the container to the registry

## Create a google cloud project

First create a project from the console https://console.cloud.google.com/

Give it a fancy name like `donut-art`

Your project will need to enable google kubernetes engine


# do you want to be able to connect to your cluster?

This is a bit of a digression but I promise it's a useful one. click on the "connect" button and it will reveal a command you can use to connect to your cluster from the command line. you can do it right away by selecting the "run in cloud shell" option: that will execute the fancy little command in a terminal that google has already configured to have the tools you need to directly interact with your kubernetes cluster. however, there's nothing stopping you from doing it yourself from the pretty little bash terminal on your machine.

The tools you need to install first are gcloud (the google cloud software development kit) and kubectl (tools for interacting with kubernetes). you'll also need the "google kubernetes engine gcloud auth plugin":

- install gcloud sdk (on ubuntu: https://cloud.google.com/sdk/docs/install#deb)
- install gke-gcloud-auth-plugin (`sudo apt-get install google-cloud-sdk-gke-gcloud-auth-plugin`)
- install kubectl (you can install with snap or apt-get); https://kubernetes.io/docs/reference/kubectl/

https://kubernetes.io/docs/reference/kubectl/

https://kubernetes.io/docs/tasks/tools/install-kubectl-linux/

Footnote: Autocompletion for kubectl https://kubernetes.io/docs/reference/kubectl/cheatsheet/
(thank you to @jan@toot.io for the hint)

don't forget: `gcloud auth login` to authenticate 

# create the cluster using autopilot

I called mine `donut-cluster`, region `australia-southeast1`

now connect:

```
export USE_GKE_GCLOUD_AUTH_PLUGIN=True
gcloud container clusters get-credentials donut-cluster --zone australia-southeast1 --project donut-art
```

check that we can connect:

```
kubectl cluster-info
```

## deploy 

```
kubectl apply -f deployment.yaml
```

```
kubectl get deployments
```

https://kubernetes.io/docs/tutorials/stateless-application/expose-external-ip-address/

https://kubernetes.io/docs/concepts/configuration/manage-resources-containers/

## expose 

```
kubectl expose deployment donut --type=LoadBalancer --name=donut-service
```

then over in my website create a DNS record that points donut.djnavarro.net at the IP address

## where next?

- enabling https: https://kubernetes.io/docs/tasks/tls/managing-tls-in-a-cluster/ https://medium.com/avmconsulting-blog/how-to-secure-applications-on-kubernetes-ssl-tls-certificates-8f7f5751d788
- storage: the app generates a new image every time it is called. that's wasteful, especially if you're going to reuse images. enable google cloud storage and have the plumber app check for the relevant file on gcs before trying to generate a new one
- multiple containers: once storage is in the mix you probably want to split this into a server (pulls files from storage to display files to user) and a generator (creates image files and writes to storage), each with their own container. you could choose run both of these containers in one pod, or have two single-container pods. i have no idea which is better yet.
- fancier things like spark-on-kubernetes already have helm charts. so you'd want to install helm and learn how to create deployments from that

<!--------------- appendices go here ----------------->
