---
title: "Zero-copy data handover between R and Python, using Arrow and rpy2"
description: ""
date: "2022-08-28"
categories: [Apache Arrow, R, Python]
image: "img/cover.jpg"
jupyter: python3
---

<!-- 
cover img: https://unsplash.com/photos/k39RGHmLoV8
artist: Claudio Schwarz
licence: unsplash free-to-use 
-->

<!-- 
AT A TERMINAL NOT TIED TO THE RSTUDIO SESSION:

quarto render ~/GitHub/sites/quarto-blog/posts/2022-08-25_zero-copy-data-handover-in-arrow-part-2/index.qmd --execute-daemon-restart

-->

https://rpy2.github.io/

https://rviews.rstudio.com/2022/05/25/calling-r-from-python-with-rpy2/

https://arrow.apache.org/docs/python/integration/python_r.html

installing rpy2

``` 
pip install rpy2
pip install rpy2-arrow
```

installing pyarrow

```
conda install pyarrow
```

```
conda install pandas
```


## Check my pyarrow

```{python check-version}
# python
import sys
print(sys.version)
print(sys.executable)
```

```{python check-pyarrow}
# python
import pyarrow
pyarrow.__version__
```


## Panda to Arrow Table

https://cdhrdatasys.anu.edu.au/tobecontinued/ 

```{python import-panda}
import pandas
pandas.__version__
```

```{python panda-read-csv}
fiction = pandas.read_csv("newspaper-fiction.csv", low_memory = False)
fiction.head()
```

```{python arrow-fiction}
pyarrow_fiction = pyarrow.Table.from_pandas(fiction)
pyarrow_fiction
```

## Introducing rpy2

```{python use-rpy2}
import rpy2.robjects as robjects
from rpy2.robjects.packages import importr, data
```


```{python use-rarrow}
base = importr('base')
base.R_version_string
```


## Passing Tables from Python to R

https://rpy2.github.io/rpy2-arrow/version/main/html/index.html

```{python use-rpy2-arrow}
import rpy2_arrow.pyarrow_rarrow as pyra

rarrow_fiction = pyra.pyarrow_to_r_table(pyarrow_fiction)
rarrow_fiction
```

## Calling R code 

```{python py-dplyr}
%load_ext rpy2.ipython
```

```{python call-r}
%%R
suppressMessages({
  library(dplyr)
  library(arrow)
})
```

```{python more-r, results='asis'}
%%R -i rarrow_fiction
gender <- rarrow_fiction |> 
  count(Gender) |>
  compute()
  
gender
```


## Passing Tables from R to Python

```{python return-r-to-python}
import rpy2.robjects as robjects
r_gender = robjects.r('gender')
r_gender
```

```{python convert-gender}
py_gender = pyra.rarrow_to_py_table(r_gender)
py_gender
```

## Back to Pandas

```{python pygender-to-panda}
panda_gender = pyarrow.Table.to_pandas(py_gender)
panda_gender
```
