---
title: "Playing with docker and the GitHub container registry"
author:
  - name: Danielle Navarro
    url: https://djnavarro.net
    affiliation: I'm on smoko
    affiliation-url: https://www.youtube.com/watch?v=j58V2vC9EPc
    orcid: 0000-0001-7648-6578
description: "There is no reason for this."
date: "2023-01-01"
categories: [Linux, R, Docker]
image: "containers.jpg"
---

<!-- image credit: 
  Teng Yuhong
  https://unsplash.com/photos/qMehmIyaXvY
-->

<!--------------- my typical setup ----------------->

```{r setup, include=FALSE}
set.seed(8)
long_slug <- "2023-01-01_playing-with-docker"
#renv::use(lockfile = "renv.lock")
wide <- 136
narrow <- 76
options(width = narrow)
```

<!--------------- post begins here ----------------->

## Minimal example

Here is the entire contents of the dockerfile:

``` dockerfile
FROM ghcr.io/djnavarro/arch-r:main
COPY script.R /home/script.R
CMD Rscript /home/script.R
```

This is the script:

``` r
cat(c("Running on:", osVersion), sep = "\n  ")
cat(c("With locale:", strsplit(Sys.getlocale(), ";")[[1]]), sep = "\n  ")
```

Build it:

``` bash
cd system-check
docker build --tag my-system-check .
```

```
Sending build context to Docker daemon  3.072kB
Step 1/3 : FROM ghcr.io/djnavarro/arch-r:main
 ---> 2f63d1340889
Step 2/3 : COPY script.R /home/script.R
 ---> Using cache
 ---> d3661fb470f8
Step 3/3 : CMD Rscript /home/script.R
 ---> Using cache
 ---> 315fd34395f4
Successfully built 315fd34395f4
Successfully tagged my-system-check:latest
```

Next tell docker to run it. Note that I'm referring to the image by name:

``` bash
docker run my-system-check
```

```
Running on:
  Arch Linux
With locale:
  LC_CTYPE=en_US.UTF-8
  LC_NUMERIC=C
  LC_TIME=en_US.UTF-8
  LC_COLLATE=en_US.UTF-8
  LC_MONETARY=en_US.UTF-8
  LC_MESSAGES=en_US.UTF-8
  LC_PAPER=en_US.UTF-8
  LC_NAME=C
  LC_ADDRESS=C
  LC_TELEPHONE=C
  LC_MEASUREMENT=en_US.UTF-8
  LC_IDENTIFICATION=C
````

Compare this to what happens if I run the script outside the docker image:

``` bash
Rscript script.R
```

```
Running on:
  Ubuntu 22.04.1 LTS
With locale:
  LC_CTYPE=en_AU.UTF-8
  LC_NUMERIC=C
  LC_TIME=en_AU.UTF-8
  LC_COLLATE=en_AU.UTF-8
  LC_MONETARY=en_AU.UTF-8
  LC_MESSAGES=en_AU.UTF-8
  LC_PAPER=en_AU.UTF-8
  LC_NAME=C
  LC_ADDRESS=C
  LC_TELEPHONE=C
  LC_MEASUREMENT=en_AU.UTF-8
  LC_IDENTIFICATION=C
```



## Fancier workflows

Edit the github PAT to include the scopes we need. If you've created your PAT using the default scopes provided by `usethis::create_github_token()`, you'll need a few more to run workflows that build and modify docker images:

- `read:packages` scope to download container images and read metadata.
- `write:packages` scope to download and upload container images and read and write metadata.
- `delete:packages` scope to delete container images.

Add the GitHub Actions workflow, commit whatever changes you want to the repo. When you push upstream to main, it will trigger an automatic deployment to the GitHub Container Registry. In fact, if you look at how I set up
[github.com/djnavarro/arch-r](https://github.com/djnavarro/arch-r) you'll notice that's exactly how it works there. You can also take a look at the more sophisticated workflows used by the rocker project: [github.com/rocker-org/rocker](https://github.com/rocker-org/rocker). The workflow I set up for my little side project is very simple by comparison.

## Resources

- The docker reference documentation: [docs.docker.com/reference](https://docs.docker.com/reference/)

- Instructions on giving docker sudo privileges for linux users: [docs.docker.com/engine/install/linux-postinstall](https://docs.docker.com/engine/install/linux-postinstall/)

- The rocker project by Carl Boettiger, Dirk Eddelbuettel, Noam Ross, and Shima Tatsuya: [rocker-project.org](https://rocker-project.org/)

- Source code for the rocker repositories: [github.com/rocker-org/rocker](https://github.com/rocker-org/rocker)

- Blog post on docker by Colin Fay: [colinfay.me/docker-r-reproducibility](https://colinfay.me/docker-r-reproducibility/)

- Slides on docker by Noam Ross: [github.com/noamross/nyhackr-docker-talk](https://github.com/noamross/nyhackr-docker-talk)

- Docker for beginners by Prakhar Srivastav: [docker-curriculum.com](https://docker-curriculum.com/)

- Working with GitHub Container Registry:
[docs.github.com/en/packages/working-with-a-github-packages-registry/working-with-the-container-registry](https://docs.github.com/en/packages/working-with-a-github-packages-registry/working-with-the-container-registry)



<!--------------- appendices go here ----------------->
